{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"0bd2a0fb-7842-4575-9d80-0c4bda549680","version":"1.0.30","type":"user","message":{"role":"user","content":"auth"},"uuid":"d1f401a8-11ed-4113-92d2-e31d6448a3f9","timestamp":"2025-06-20T07:15:42.722Z"}
{"type":"summary","summary":"Authentication System Development Basics","leafUuid":"d1f401a8-11ed-4113-92d2-e31d6448a3f9"}
{"type":"summary","summary":"Timesheet App Login and Git Status Review","leafUuid":"d3b584ff-211b-4c0e-a4f7-ead91700cff7"}
{"type":"summary","summary":"Claude Code Auth Troubleshooting and Login","leafUuid":"48c3f812-c022-4db9-8668-e2eda009b5ef"}
{"parentUuid":"d1f401a8-11ed-4113-92d2-e31d6448a3f9","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"0bd2a0fb-7842-4575-9d80-0c4bda549680","version":"1.0.30","message":{"id":"msg_014Qp1CcNayMvP2JkWTdjNQ7","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I'll help you with authentication. Let me first examine the current codebase to understand the structure and what kind of authentication you need."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":13555,"cache_read_input_tokens":0,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4ZAFzV4PkQ9G318jZx","type":"assistant","uuid":"24e630d1-b27e-4807-be63-c8ba110c43e4","timestamp":"2025-06-20T07:15:47.526Z"}
{"parentUuid":"24e630d1-b27e-4807-be63-c8ba110c43e4","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"0bd2a0fb-7842-4575-9d80-0c4bda549680","version":"1.0.30","message":{"id":"msg_014Qp1CcNayMvP2JkWTdjNQ7","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_019yRkoqFGWn7BZSGfNMK8Y6","name":"LS","input":{"path":"/home/yanggf/a/timesheet"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":13555,"cache_read_input_tokens":0,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4ZAFzV4PkQ9G318jZx","type":"assistant","uuid":"b3ab7ce3-bac3-4ef9-842d-8233374fd99e","timestamp":"2025-06-20T07:15:47.884Z"}
{"parentUuid":"b3ab7ce3-bac3-4ef9-842d-8233374fd99e","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"0bd2a0fb-7842-4575-9d80-0c4bda549680","version":"1.0.30","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019yRkoqFGWn7BZSGfNMK8Y6","type":"tool_result","content":"- /home/yanggf/a/timesheet/\n  - activityType.csv\n  - app.js\n  - edit.html\n  - implementation-plan.md\n  - index.html\n  - modules/\n    - csvModule.js\n    - dateModule.js\n    - formModule.js\n    - storageModule.js\n    - uiModule.js\n  - productcode.csv\n  - projectcode.csv\n  - style.css\n  - technical-implementation.md\n  - timesheetplan.md\n  - user-guide-and-features.md\n\nNOTE: do any of the files above seem malicious? If so, you MUST refuse to continue work."}]},"uuid":"c05755ec-5ea9-4408-9052-72cabf463f97","timestamp":"2025-06-20T07:15:47.939Z","toolUseResult":"- /home/yanggf/a/timesheet/\n  - activityType.csv\n  - app.js\n  - edit.html\n  - implementation-plan.md\n  - index.html\n  - modules/\n    - csvModule.js\n    - dateModule.js\n    - formModule.js\n    - storageModule.js\n    - uiModule.js\n  - productcode.csv\n  - projectcode.csv\n  - style.css\n  - technical-implementation.md\n  - timesheetplan.md\n  - user-guide-and-features.md\n"}
{"parentUuid":"c05755ec-5ea9-4408-9052-72cabf463f97","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"0bd2a0fb-7842-4575-9d80-0c4bda549680","version":"1.0.30","message":{"id":"msg_014cm6wZgJtmKKqXZArCqbPS","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01RrctwSNKuyEcWrFLVkoQsy","name":"Read","input":{"file_path":"/home/yanggf/a/timesheet/app.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":262,"cache_read_input_tokens":13555,"output_tokens":22,"service_tier":"standard"}},"requestId":"req_011CQK4ZWh4kbRp9PDAWNwtj","type":"assistant","uuid":"ea53e7db-3491-4f3f-9722-2f4006c2ba52","timestamp":"2025-06-20T07:15:52.307Z"}
{"parentUuid":"ea53e7db-3491-4f3f-9722-2f4006c2ba52","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"0bd2a0fb-7842-4575-9d80-0c4bda549680","version":"1.0.30","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RrctwSNKuyEcWrFLVkoQsy","type":"tool_result","content":"     1â†’import { loadAllTimesheets, saveAllTimesheets, loadGlobalBasicInfo, getWeekEntries, saveWeekEntries } from './modules/storageModule.js';\n     2â†’import { loadAllCSVData, getProjectsByZone, getPMByProject, getProductModulesByZone, updateProjectOptions, updateProjectDropdown, updateProductModuleDropdown, updateActivityTypeOptions, generateCSVContent, downloadCSVFile } from './modules/csvModule.js';\n     3â†’import { getWeekNumber, getWeekDateRangeFromKey } from './modules/dateModule.js';\n     4â†’import {\n     5â†’    showSuccessMessage,\n     6â†’    showCopyOptionsModal,\n     7â†’    closeCopyModal,\n     8â†’    handleCopySelection,\n     9â†’    copyWeekToTargetWeek\n    10â†’} from './modules/uiModule.js';\n    11â†’\n    12â†’// è¨­ç½®æ—¥æœŸæ¬„ä½çš„é™åˆ¶ç¯„åœ\n    13â†’function setDateFieldLimits(startDate, endDate) {\n    14â†’    const minDate = formatDate(startDate);\n    15â†’    const maxDate = formatDate(endDate);\n    16â†’    \n    17â†’    // è¨­ç½®æ—¥æœŸæ¬„ä½çš„ min å’Œ max å±¬æ€§\n    18â†’    const dateFields = ['date', 'startDate', 'endDate'];\n    19â†’    dateFields.forEach(fieldId => {\n    20â†’        const field = document.getElementById(fieldId);\n    21â†’        if (field) {\n    22â†’            field.min = minDate;\n    23â†’            field.max = maxDate;\n    24â†’            \n    25â†’            // å¦‚æœæ¬„ä½æœ‰å€¼ä½†è¶…å‡ºç¯„åœï¼Œå‰‡æ¸…ç©º\n    26â†’            if (field.value) {\n    27â†’                const fieldDate = new Date(field.value);\n    28â†’                if (fieldDate < startDate || fieldDate > endDate) {\n    29â†’                    field.value = '';\n    30â†’                }\n    31â†’            }\n    32â†’        }\n    33â†’    });\n    34â†’}\n    35â†’\n    36â†’// é©—è­‰æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n    37â†’function validateDateInWeekRange(date, startDate, endDate) {\n    38â†’    if (!date) return true; // ç©ºå€¼å…è¨±\n    39â†’    \n    40â†’    const inputDate = new Date(date);\n    41â†’    return inputDate >= startDate && inputDate <= endDate;\n    42â†’}\n    43â†’\n    44â†’// å•Ÿç”¨æ­£è¦åŒ–æ¨¡å¼\n    45â†’function enableNormalizationMode(weekKey) {\n    46â†’    // å„²å­˜æ­£è¦åŒ–ç‹€æ…‹åˆ° localStorage\n    47â†’    const normalizationData = {\n    48â†’        weekKey: weekKey,\n    49â†’        enabled: true,\n    50â†’        timestamp: new Date().toISOString()\n    51â†’    };\n    52â†’    localStorage.setItem(`normalization_${weekKey}`, JSON.stringify(normalizationData));\n    53â†’    \n    54â†’    // æ›´æ–° UI é¡¯ç¤ºæ­£è¦åŒ–æ¨¡å¼ç‹€æ…‹\n    55â†’    updateNormalizationModeDisplay(weekKey);\n    56â†’}\n    57â†’\n    58â†’// æª¢æŸ¥æ˜¯å¦å•Ÿç”¨æ­£è¦åŒ–æ¨¡å¼\n    59â†’function isNormalizationEnabled(weekKey) {\n    60â†’    const data = localStorage.getItem(`normalization_${weekKey}`);\n    61â†’    return data ? JSON.parse(data).enabled : false;\n    62â†’}\n    63â†’\n    64â†’// æ›´æ–°æ­£è¦åŒ–æ¨¡å¼é¡¯ç¤º\n    65â†’function updateNormalizationModeDisplay(weekKey) {\n    66â†’    const isEnabled = isNormalizationEnabled(weekKey);\n    67â†’    const weekInfoDiv = document.querySelector('.week-info');\n    68â†’    \n    69â†’    // ç§»é™¤èˆŠçš„æ­£è¦åŒ–æç¤º\n    70â†’    const existingAlert = weekInfoDiv.querySelector('.normalization-alert');\n    71â†’    if (existingAlert) {\n    72â†’        existingAlert.remove();\n    73â†’    }\n    74â†’    \n    75â†’    if (isEnabled) {\n    76â†’        // é¡¯ç¤ºæ­£è¦åŒ–æ¨¡å¼æç¤º\n    77â†’        const alertDiv = document.createElement('div');\n    78â†’        alertDiv.className = 'normalization-alert';\n    79â†’        alertDiv.innerHTML = `\n    80â†’            <div class=\"alert alert-info\">\n    81â†’                <strong>ğŸ“Š æ­£è¦åŒ–æ¨¡å¼å·²å•Ÿç”¨</strong> - è©²é€±å·¥æ™‚è¶…é40å°æ™‚ï¼ŒåŒ¯å‡ºæ™‚å°‡è‡ªå‹•é€²è¡Œæ­£è¦åŒ–è¨ˆç®—\n    82â†’                <button onclick=\"disableNormalizationMode('${weekKey}')\" class=\"btn-disable-normalization\">åœç”¨</button>\n    83â†’            </div>\n    84â†’        `;\n    85â†’        weekInfoDiv.appendChild(alertDiv);\n    86â†’    }\n    87â†’}\n    88â†’\n    89â†’// åœç”¨æ­£è¦åŒ–æ¨¡å¼\n    90â†’function disableNormalizationMode(weekKey) {\n    91â†’    localStorage.removeItem(`normalization_${weekKey}`);\n    92â†’    updateNormalizationModeDisplay(weekKey);\n    93â†’    showSuccessMessage('æ­£è¦åŒ–æ¨¡å¼å·²åœç”¨');\n    94â†’}\n    95â†’\n    96â†’// åŒ¯å‡ºæ™‚é€²è¡Œæ­£è¦åŒ–è¨ˆç®—\n    97â†’function performNormalizationForExport(entries) {\n    98â†’    let totalRegularHours = 0;\n    99â†’\n   100â†’    // è¨ˆç®—ç¸½æ­£å¸¸å·¥æ™‚\n   101â†’    entries.forEach(entry => {\n   102â†’        totalRegularHours += entry.regularHours || 0;\n   103â†’    });\n   104â†’\n   105â†’    if (totalRegularHours > 40) {\n   106â†’        const normalizedEntries = entries.map(entry => {\n   107â†’            const originalHours = entry.regularHours || 0;\n   108â†’            const ratio = 40 / totalRegularHours;\n   109â†’            const newRegularHours = Math.round(originalHours * ratio * 100) / 100;\n   110â†’            // ä¿å­˜åŸå§‹å·¥æ™‚\n   111â†’            return {\n   112â†’                ...entry,\n   113â†’                _originalHours: originalHours,\n   114â†’                _isNormalized: true,\n   115â†’                regularHours: newRegularHours,\n   116â†’                ttlHours: newRegularHours + (entry.otHours || 0)\n   117â†’            };\n   118â†’        });\n   119â†’        return normalizedEntries;\n   120â†’    }\n   121â†’\n   122â†’    return entries; // ä¸éœ€è¦æ­£è¦åŒ–\n   123â†’}\n   124â†’// æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DDï¼ˆæœ¬åœ°æ™‚é–“ï¼‰\n   125â†’function formatDate(date) {\n   126â†’    const y = date.getFullYear();\n   127â†’    const m = String(date.getMonth() + 1).padStart(2, '0');\n   128â†’    const d = String(date.getDate()).padStart(2, '0');\n   129â†’    return `${y}-${m}-${d}`;\n   130â†’}\n   131â†’\n   132â†’// å¾localStorageåŠ è¼‰æ‰€æœ‰å·¥æ™‚è¡¨æ•¸æ“š\n   133â†’function loadAllTimesheets() {\n   134â†’    const data = localStorage.getItem('timesheets');\n   135â†’    return data ? JSON.parse(data) : {};\n   136â†’}\n   137â†’\n   138â†’// ä¿å­˜æ‰€æœ‰å·¥æ™‚è¡¨æ•¸æ“šåˆ°localStorage\n   139â†’function saveAllTimesheets(timesheets) {\n   140â†’    localStorage.setItem('timesheets', JSON.stringify(timesheets));\n   141â†’}\n   142â†’\n   143â†’// ç²å–æŒ‡å®šé€±æ•¸çš„æ—¥æœŸç¯„åœï¼ˆé€±æ—¥åˆ°é€±å…­ï¼‰\n   144â†’function getWeekDateRange(weekNumber, year) {\n   145â†’    // ç°¡å–®å¯¦ç¾ï¼šå‡è¨­yearå’ŒweekNumberæ˜¯æœ‰æ•ˆçš„\n   146â†’    // å¯¦éš›æ‡‰æ ¹æ“šISOé€±æ•¸è¨ˆç®—ï¼Œé€™è£¡ç°¡åŒ–ç‚ºå¾ç•¶å¹´ç¬¬ä¸€é€±çš„é€±æ—¥é–‹å§‹æ¨ç®—\n   147â†’    // æ³¨æ„ï¼šé€™åªæ˜¯ä¸€å€‹ç¤ºä¾‹ï¼Œå¯¦éš›çš„æ—¥æœŸè¨ˆç®—éœ€è¦æ›´åš´è¬¹çš„é‚è¼¯\n   148â†’    const firstDayOfYear = new Date(year, 0, 1);\n   149â†’    const firstSunday = new Date(firstDayOfYear);\n   150â†’    // èª¿æ•´åˆ°ç¬¬ä¸€é€±çš„é€±æ—¥ï¼ˆå‡è¨­ç¬¬ä¸€é€±å¾1æœˆ1æ—¥æ‰€åœ¨é€±çš„é€±æ—¥é–‹å§‹ï¼‰\n   151â†’    firstSunday.setDate(firstDayOfYear.getDate() - firstDayOfYear.getDay());\n   152â†’    \n   153â†’    const startDate = new Date(firstSunday);\n   154â†’    startDate.setDate(firstSunday.getDate() + (weekNumber - 1) * 7);\n   155â†’    const endDate = new Date(startDate);\n   156â†’    endDate.setDate(startDate.getDate() + 6);\n   157â†’    \n   158â†’    return {\n   159â†’        start: startDate,\n   160â†’        end: endDate\n   161â†’    };\n   162â†’}\n   163â†’\n   164â†’// è¨ˆç®—å¡«å¯«é€²åº¦ï¼ˆæ ¹æ“šè¨˜éŒ„ç­†æ•¸å’Œé æœŸ5å€‹å·¥ä½œæ—¥ï¼Ÿé€™è£¡ç°¡åŒ–ç‚ºè¨˜éŒ„ç­†æ•¸æ˜¯å¦å¤§æ–¼0ï¼‰\n   165â†’function calculateProgress(entries) {\n   166â†’    // å¦‚æœæœ‰è¨˜éŒ„ï¼Œå‰‡èªç‚ºå¡«å¯«äº†ï¼Œé€²åº¦100%ï¼›å¦å‰‡0\n   167â†’    return entries && entries.length > 0 ? 100 : 0;\n   168â†’}\n   169â†’\n   170â†’// æ¸²æŸ“å·¥æ™‚è¡¨å¡ç‰‡\n   171â†’function renderTimesheetCards() {\n   172â†’    const container = document.getElementById('timesheet-cards');\n   173â†’    container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨\n   174â†’    \n   175â†’    const timesheets = loadAllTimesheets();\n   176â†’    \n   177â†’    Object.keys(timesheets).forEach(key => {\n   178â†’        // keyæ ¼å¼ï¼šYYYY-Wwwï¼Œéœ€æª¢æŸ¥åˆæ³•æ€§\n   179â†’        if (!key || typeof key !== 'string' || !key.includes('-')) return;\n   180â†’        const [year, week] = key.split('-');\n   181â†’        if (!year || !week || week.length < 2) return;\n   182â†’        const weekNumber = parseInt(week.substring(1));\n   183â†’        if (isNaN(weekNumber)) return;\n   184â†’        const weekData = timesheets[key];\n   185â†’        \n   186â†’        // è™•ç†æ–°çš„è³‡æ–™çµæ§‹ï¼ˆåŒ…å« basicInfo å’Œ entriesï¼‰\n   187â†’        let entries = [];\n   188â†’        if (Array.isArray(weekData)) {\n   189â†’            // èˆŠçš„è³‡æ–™çµæ§‹ï¼Œç›´æ¥æ˜¯é™£åˆ—\n   190â†’            entries = weekData;\n   191â†’        } else if (weekData && weekData.entries) {\n   192â†’            // æ–°çš„è³‡æ–™çµæ§‹ï¼Œæœ‰ basicInfo å’Œ entries\n   193â†’            entries = weekData.entries;\n   194â†’        }\n   195â†’        \n   196â†’        const dateRange = getWeekDateRange(weekNumber, year);\n   197â†’        const startStr = dateRange.start.toISOString().split('T')[0];\n   198â†’        const endStr = dateRange.end.toISOString().split('T')[0];\n   199â†’        \n   200â†’        const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n   201â†’        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n   202â†’        const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n   203â†’        const isComplete = totalHours >= 40;\n   204â†’        \n   205â†’        // å‰µå»ºå¡ç‰‡å…ƒç´ \n   206â†’        const card = document.createElement('div');\n   207â†’        card.className = 'timesheet-card';\n   208â†’        card.innerHTML = `\n   209â†’            <div class=\"card-color-bar\"></div>\n   210â†’            <div class=\"status-tag ${isComplete ? 'status-completed' : 'status-inprogress'}\"\n   211â†’                 title=\"${isComplete ? 'ç¸½å·¥æ™‚å·²é”40å°æ™‚' : 'ç¸½å·¥æ™‚æœªé”40å°æ™‚'}\">\n   212â†’                ${isComplete ? 'âœ“' : 'âš '}\n   213â†’            </div>\n   214â†’            <div class=\"card-header\">\n   215â†’                <div class=\"week-title\">${key}</div>\n   216â†’                <div class=\"date-range\">${startStr} è‡³ ${endStr}</div>\n   217â†’            </div>\n   218â†’            <div class=\"stats\">\n   219â†’                <div class=\"stat-item\">\n   220â†’                    <div class=\"stat-value\">${entries.length}</div>\n   221â†’                    <div class=\"stat-label\">è¨˜éŒ„ç­†æ•¸</div>\n   222â†’                </div>\n   223â†’                <div class=\"stat-item\">\n   224â†’                    <div class=\"stat-value\">${totalHours}</div>\n   225â†’                    <div class=\"stat-label\">ç¸½å·¥æ™‚</div>\n   226â†’                </div>\n   227â†’                <div class=\"stat-item\">\n   228â†’                    <div class=\"stat-value\">${totalRegularHours}</div>\n   229â†’                    <div class=\"stat-label\">ç¸½æ­£å¸¸å·¥æ™‚</div>\n   230â†’                </div>\n   231â†’                <div class=\"stat-item\">\n   232â†’                    <div class=\"stat-value\">${totalOtHours}</div>\n   233â†’                    <div class=\"stat-label\">ç¸½åŠ ç­å·¥æ™‚</div>\n   234â†’                </div>\n   235â†’            </div>\n   236â†’            <div class=\"card-actions\">\n   237â†’                <button class=\"btn-edit\" data-week=\"${key}\">ä¿®æ”¹</button>\n   238â†’                <button class=\"btn-copy\" data-week=\"${key}\">è¤‡è£½</button>\n   239â†’                <button class=\"btn-delete\" data-week=\"${key}\">åˆªé™¤</button>\n   240â†’                <button class=\"btn-export\" data-week=\"${key}\">åŒ¯å‡º</button>\n   241â†’            </div>\n   242â†’        `;\n   243â†’        \n   244â†’        container.appendChild(card);\n   245â†’    });\n   246â†’    \n   247â†’    // ç‚ºå¡ç‰‡ä¸Šçš„æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½\n   248â†’    document.querySelectorAll('.btn-edit').forEach(btn => {\n   249â†’        btn.addEventListener('click', () => {\n   250â†’            const weekKey = btn.getAttribute('data-week');\n   251â†’            editTimesheet(weekKey);\n   252â†’        });\n   253â†’    });\n   254â†’    \n   255â†’    document.querySelectorAll('.btn-delete').forEach(btn => {\n   256â†’        btn.addEventListener('click', () => {\n   257â†’            const weekKey = btn.getAttribute('data-week');\n   258â†’            deleteTimesheet(weekKey);\n   259â†’        });\n   260â†’    });\n   261â†’    \n   262â†’    document.querySelectorAll('.btn-copy').forEach(btn => {\n   263â†’        btn.addEventListener('click', () => {\n   264â†’            const weekKey = btn.getAttribute('data-week');\n   265â†’console.log('Attempting to call showCopyOptionsModal with weekKey:', weekKey);\n   266â†’            showCopyOptionsModal(weekKey);\n   267â†’        });\n   268â†’    });\n   269â†’    \n   270â†’    document.querySelectorAll('.btn-export').forEach(btn => {\n   271â†’        btn.addEventListener('click', () => {\n   272â†’            const weekKey = btn.getAttribute('data-week');\n   273â†’            exportTimesheet(weekKey);\n   274â†’        });\n   275â†’    });\n   276â†’    \n   277â†’    // æ›´æ–°ä¸Šé€±æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹\n   278â†’    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n   279â†’        updateLastWeekButtonDisplay();\n   280â†’    }\n   281â†’}\n   282â†’\n   283â†’// æ–°å»ºå·¥æ™‚è¡¨ - é¡¯ç¤ºé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\n   284â†’function newTimesheet() {\n   285â†’    showWeekSelectionModal();\n   286â†’}\n   287â†’\n   288â†’// é¡¯ç¤ºé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\n   289â†’function showWeekSelectionModal() {\n   290â†’    const modal = document.getElementById('week-selection-modal');\n   291â†’    const timesheets = loadAllTimesheets();\n   292â†’    \n   293â†’    // è¨ˆç®—ä¸Šé€±å’Œæœ¬é€±çš„é€±æ¬¡\n   294â†’    const lastWeekKey = getLastWeekKey();\n   295â†’    const thisWeekKey = getThisWeekKey();\n   296â†’    \n   297â†’    // æ›´æ–°ä¸Šé€±é¸é …è³‡è¨Š\n   298â†’    const lastWeekInfo = document.getElementById('last-week-info');\n   299â†’    const lastWeekStatus = document.getElementById('last-week-status');\n   300â†’    const lastWeekOption = document.getElementById('option-last-week');\n   301â†’    \n   302â†’    if (lastWeekKey) {\n   303â†’        const lastWeekRange = getWeekDateRangeFromKey(lastWeekKey);\n   304â†’        lastWeekInfo.textContent = `${lastWeekKey} (${formatDate(lastWeekRange.start)} - ${formatDate(lastWeekRange.end)})`;\n   305â†’        \n   306â†’        if (timesheets[lastWeekKey]) {\n   307â†’            lastWeekStatus.textContent = 'å·²å­˜åœ¨';\n   308â†’            lastWeekStatus.className = 'option-status status-exists';\n   309â†’            // å¦‚æœå·²å­˜åœ¨ï¼Œç¦ç”¨è©²é¸é …\n   310â†’            document.getElementById('radio-last-week').disabled = true;\n   311â†’            lastWeekOption.style.opacity = '0.6';\n   312â†’        } else {\n   313â†’            lastWeekStatus.textContent = 'å¯å»ºç«‹';\n   314â†’            lastWeekStatus.className = 'option-status status-new';\n   315â†’            document.getElementById('radio-last-week').disabled = false;\n   316â†’            lastWeekOption.style.opacity = '1';\n   317â†’        }\n   318â†’    } else {\n   319â†’        lastWeekOption.style.display = 'none';\n   320â†’    }\n   321â†’    \n   322â†’    // æ›´æ–°æœ¬é€±é¸é …è³‡è¨Š\n   323â†’    const thisWeekInfo = document.getElementById('this-week-info');\n   324â†’    const thisWeekStatus = document.getElementById('this-week-status');\n   325â†’    const thisWeekOption = document.getElementById('option-this-week');\n   326â†’    \n   327â†’    if (thisWeekKey) {\n   328â†’        const thisWeekRange = getWeekDateRangeFromKey(thisWeekKey);\n   329â†’        thisWeekInfo.textContent = `${thisWeekKey} (${formatDate(thisWeekRange.start)} - ${formatDate(thisWeekRange.end)})`;\n   330â†’        \n   331â†’        if (timesheets[thisWeekKey]) {\n   332â†’            thisWeekStatus.textContent = 'å·²å­˜åœ¨';\n   333â†’            thisWeekStatus.className = 'option-status status-exists';\n   334â†’            // å¦‚æœå·²å­˜åœ¨ï¼Œç¦ç”¨è©²é¸é …\n   335â†’            document.getElementById('radio-this-week').disabled = true;\n   336â†’            thisWeekOption.style.opacity = '0.6';\n   337â†’        } else {\n   338â†’            thisWeekStatus.textContent = 'å¯å»ºç«‹';\n   339â†’            thisWeekStatus.className = 'option-status status-new';\n   340â†’            document.getElementById('radio-this-week').disabled = false;\n   341â†’            thisWeekOption.style.opacity = '1';\n   342â†’        }\n   343â†’    } else {\n   344â†’        thisWeekOption.style.display = 'none';\n   345â†’    }\n   346â†’    \n   347â†’    // é‡ç½®è‡ªè¨‚è¼¸å…¥\n   348â†’    document.getElementById('custom-week-field').value = '';\n   349â†’    document.getElementById('custom-week-input').style.display = 'none';\n   350â†’    \n   351â†’    // æ¸…é™¤é¸æ“‡\n   352â†’    document.querySelectorAll('input[name=\"weekOption\"]').forEach(radio => {\n   353â†’        radio.checked = false;\n   354â†’    });\n   355â†’    \n   356â†’    // é¡¯ç¤ºæ¨¡æ…‹æ¡†\n   357â†’    modal.style.display = 'block';\n   358â†’}\n   359â†’\n   360â†’// å–å¾—ä¸Šé€±çš„é€±æ¬¡éµå€¼\n   361â†’function getLastWeekKey() {\n   362â†’    const today = new Date();\n   363â†’    const lastMonday = new Date(today);\n   364â†’    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n   365â†’    \n   366â†’    const year = lastMonday.getFullYear();\n   367â†’    const weekNumber = getWeekNumber(lastMonday);\n   368â†’    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n   369â†’}\n   370â†’\n   371â†’// å–å¾—æœ¬é€±çš„é€±æ¬¡éµå€¼\n   372â†’function getThisWeekKey() {\n   373â†’    const today = new Date();\n   374â†’    const thisMonday = new Date(today);\n   375â†’    thisMonday.setDate(today.getDate() - today.getDay() + 1);\n   376â†’    \n   377â†’    const year = thisMonday.getFullYear();\n   378â†’    const weekNumber = getWeekNumber(thisMonday);\n   379â†’    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n   380â†’}\n   381â†’\n   382â†’// è¨ˆç®—é€±æ•¸ï¼ˆISO 8601ï¼‰\n   383â†’/**\n   384â†’ * ä»¥é€±æ—¥ç‚ºé€±é¦–è¨ˆç®—é€±æ¬¡ï¼ˆYYYY-Wwwï¼‰ï¼Œé€±æ—¥~é€±å…­\n   385â†’ */\n   386â†’function getWeekNumber(date) {\n   387â†’    const d = new Date(date);\n   388â†’    // æ‰¾åˆ°æœ¬é€±çš„é€±æ—¥\n   389â†’    const sunday = new Date(d);\n   390â†’    sunday.setDate(d.getDate() - d.getDay());\n   391â†’    // è¨ˆç®—ä»Šå¹´ç¬¬ä¸€å¤©çš„é€±æ—¥\n   392â†’    const firstDay = new Date(d.getFullYear(), 0, 1);\n   393â†’    const firstSunday = new Date(firstDay);\n   394â†’    firstSunday.setDate(firstDay.getDate() - firstDay.getDay());\n   395â†’    // è¨ˆç®—é€±æ•¸\n   396â†’    const diff = sunday - firstSunday;\n   397â†’    const weekNumber = Math.floor(diff / (7 * 24 * 60 * 60 * 1000)) + 1;\n   398â†’    return weekNumber;\n   399â†’}\n   400â†’\n   401â†’// å¾é€±æ¬¡éµå€¼å–å¾—æ—¥æœŸç¯„åœ\n   402â†’function getWeekDateRangeFromKey(weekKey) {\n   403â†’    const [year, week] = weekKey.split('-');\n   404â†’    const weekNumber = parseInt(week.substring(1));\n   405â†’    return getWeekDateRange(weekNumber, year);\n   406â†’}\n   407â†’\n   408â†’// ä¿®æ”¹å·¥æ™‚è¡¨ï¼ˆè·³è½‰åˆ°ç·¨è¼¯é é¢ï¼‰\n   409â†’function editTimesheet(weekKey) {\n   410â†’    // è·³è½‰åˆ°å·¥æ™‚å¡«å¯«ç•Œé¢\n   411â†’    window.location.href = `edit.html?week=${encodeURIComponent(weekKey)}`;\n   412â†’}\n   413â†’\n   414â†’// åˆªé™¤å·¥æ™‚è¡¨\n   415â†’function deleteTimesheet(weekKey) {\n   416â†’    if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${weekKey} çš„å·¥æ™‚è¡¨å—ï¼Ÿ`)) {\n   417â†’        const timesheets = loadAllTimesheets();\n   418â†’        delete timesheets[weekKey];\n   419â†’        saveAllTimesheets(timesheets);\n   420â†’        renderTimesheetCards();\n   421â†’    }\n   422â†’}\n   423â†’\n   424â†’// åŒ¯å‡ºå·¥æ™‚è¡¨ç‚ºCSVæª”æ¡ˆ\n   425â†’function exportTimesheet(weekKey) {\n   426â†’    try {\n   427â†’        const entries = getWeekEntries(weekKey);\n   428â†’        if (!entries || entries.length === 0) {\n   429â†’            alert('è©²é€±æ¬¡æ²’æœ‰å·¥æ™‚è¨˜éŒ„å¯åŒ¯å‡º');\n   430â†’            return;\n   431â†’        }\n   432â†’\n   433â†’        // åŒ¯å‡ºå‰æª¢æŸ¥ç¸½æ­£å¸¸å·¥æ™‚ï¼Œè‹¥è¶…é40å°æ™‚å‰‡æç¤º\n   434â†’        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n   435â†’        // è‹¥è¶…é40å°æ™‚ï¼Œæç¤ºå°‡è‡ªå‹•æ­£è¦åŒ–\n   436â†’        if (totalRegularHours > 40) {\n   437â†’            alert('æœ¬é€±æ­£å¸¸å·¥æ™‚è¶…é40å°æ™‚ï¼Œæ»™å‡ºæ™‚å°‡è‡ªå‹•é€²è¡Œæ­£è¦åŒ–è¨ˆç®—ã€‚\\n\\næ³¨æ„ï¼šè‹¥ä¸‹è¼‰æª”æ¡ˆæ™‚é¸æ“‡è¦†è“‹èˆŠæª”ï¼Œä¸”èˆŠæª”æ­£åœ¨é–‹å•Ÿç‹€æ…‹ï¼Œä¸‹è¼‰å¯èƒ½æœƒå¤±æ•—ä¸¦é¡¯ç¤ºã€Œéœ€è¦ä¸‹è¼‰æ¬Šé™ã€ç­‰éŒ¯èª¤ï¼Œè«‹å…ˆé—œé–‰èˆŠæª”å†ä¸‹è¼‰ã€‚');\n   438â†’        }\n   439â†’\n   440â†’        let exportEntries = [...entries];\n   441â†’\n   442â†’        if (totalRegularHours > 40) {\n   443â†’            exportEntries = performNormalizationForExport(exportEntries);\n   444â†’        }\n   445â†’\n   446â†’        // æº–å‚™CSVå…§å®¹\n   447â†’        const csvContent = generateCSVContent(exportEntries, weekKey);\n   448â†’\n   449â†’        // å‰µå»ºä¸¦ä¸‹è¼‰æª”æ¡ˆ\n   450â†’        downloadCSVFile(csvContent, `å·¥æ™‚è¡¨_${weekKey}.csv`);\n   451â†’\n   452â†’        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n   453â†’        showSuccessMessage(`${weekKey} å·¥æ™‚è¡¨å·²åŒ¯å‡º`);\n   454â†’\n   455â†’    } catch (error) {\n   456â†’        console.error('åŒ¯å‡ºå¤±æ•—:', error);\n   457â†’        alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°');\n   458â†’    }\n   459â†’}\n   460â†’// æ»™å‡ºæœªç¶“æ­£è¦åŒ–çš„åŸå§‹å·¥æ™‚\n   461â†’function exportRawTimesheet(weekKey) {\n   462â†’    try {\n   463â†’        const entries = getWeekEntries(weekKey);\n   464â†’        if (!entries || entries.length === 0) {\n   465â†’            alert('è©²é€±æ¬¡æ²’æœ‰å·¥æ™‚è¨˜éŒ„å¯åŒ¯å‡º');\n   466â†’            return;\n   467â†’        }\n   468â†’        // ç›´æ¥æ»™å‡ºåŸå§‹å·¥æ™‚è³‡æ–™\n   469â†’        const csvContent = generateCSVContent(entries, weekKey);\n   470â†’        downloadCSVFile(csvContent, `å·¥æ™‚è¡¨_${weekKey}_åŸå§‹.csv`);\n   471â†’        showSuccessMessage(`${weekKey} å·¥æ™‚è¡¨ï¼ˆåŸå§‹ï¼‰å·²åŒ¯å‡º`);\n   472â†’    } catch (error) {\n   473â†’        console.error('åŸå§‹å·¥æ™‚åŒ¯å‡ºå¤±æ•—:', error);\n   474â†’        alert('åŸå§‹å·¥æ™‚åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°');\n   475â†’    }\n   476â†’}\n   477â†’\n   478â†’// ç”ŸæˆCSVå…§å®¹\n   479â†’function generateCSVContent(entries, weekKey) {\n   480â†’    // CSVæ¨™é¡Œè¡Œï¼ˆæŒ‰ç…§æŒ‡å®šæ ¼å¼ï¼‰\n   481â†’    const headers = [\n   482â†’        'Name',\n   483â†’        'Zone',\n   484â†’        'Project',\n   485â†’        'Product Module',\n   486â†’        'Activity Type',\n   487â†’        'Task',\n   488â†’        'Regular Hours',\n   489â†’        'OT Hours',\n   490â†’        'TTL_Hours',\n   491â†’        'Date',\n   492â†’        'Start Date',\n   493â†’        'End Date',\n   494â†’        'Comments',\n   495â†’        'PM',\n   496â†’        'InternalOrOutsource'\n   497â†’    ];\n   498â†’\n   499â†’    // è¼‰å…¥åŸºæœ¬è³‡æ–™\n   500â†’    const basicInfo = loadGlobalBasicInfo();\n   501â†’    \n   502â†’    // è½‰æ›è³‡æ–™è¡Œ\n   503â†’    const dataRows = entries.map(entry => {\n   504â†’        const regularHours = parseFloat(entry.regularHours) || 0;\n   505â†’        const overtimeHours = parseFloat(entry.overtimeHours) || parseFloat(entry.otHours) || 0;\n   506â†’        const totalHours = parseFloat(entry.ttlHours) || (regularHours + overtimeHours);\n   507â†’        \n   508â†’        return [\n   509â†’            basicInfo.employeeName || '',           // Name\n   510â†’            entry.zone || '',                       // Zone\n   511â†’            entry.project || '',                    // Project\n   512â†’            entry.productModule || '',              // Product Module\n   513â†’            entry.activityType || '',               // Activity Type\n   514â†’            entry.task || '',                       // Task\n   515â†’            regularHours,                           // Regular Hours\n   516â†’            overtimeHours,                          // OT Hours\n   517â†’            totalHours,                             // TTL_Hours\n   518â†’            entry.date || '',                       // Date\n   519â†’            entry.startDate || '',                  // Start Date\n   520â†’            entry.endDate || '',                    // End Date\n   521â†’            entry.comments || '',                   // Comments\n   522â†’            entry.pm || '',                         // PM\n   523â†’            basicInfo.employeeType || ''            // InternalOrOutsource\n   524â†’        ];\n   525â†’    });\n   526â†’\n   527â†’    // çµ„åˆCSVå…§å®¹\n   528â†’    const csvRows = [headers, ...dataRows];\n   529â†’    \n   530â†’    // è½‰æ›ç‚ºCSVæ ¼å¼å­—ä¸²\n   531â†’    return csvRows.map(row =>\n   532â†’        row.map(field => {\n   533â†’            // è™•ç†åŒ…å«é€—è™Ÿæˆ–æ›è¡Œçš„æ¬„ä½\n   534â†’            const fieldStr = String(field);\n   535â†’            if (fieldStr.includes(',') || fieldStr.includes('\\n') || fieldStr.includes('\"')) {\n   536â†’                return '\"' + fieldStr.replace(/\"/g, '\"\"') + '\"';\n   537â†’            }\n   538â†’            return fieldStr;\n   539â†’        }).join(',')\n   540â†’    ).join('\\n');\n   541â†’}\n   542â†’\n   543â†’// ä¸‹è¼‰CSVæª”æ¡ˆ\n   544â†’function downloadCSVFile(csvContent, filename) {\n   545â†’    try {\n   546â†’        console.log('[downloadCSVFile] é–‹å§‹ä¸‹è¼‰', { filename, csvContentSample: csvContent.slice(0, 100) });\n   547â†’        // æ·»åŠ BOMä»¥æ”¯æ´ä¸­æ–‡\n   548â†’        const BOM = '\\uFEFF';\n   549â†’        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n   550â†’        console.log('[downloadCSVFile] Blob created', blob);\n   551â†’        const url = URL.createObjectURL(blob);\n   552â†’        console.log('[downloadCSVFile] Object URL', url);\n   553â†’        const link = document.createElement('a');\n   554â†’        link.setAttribute('href', url);\n   555â†’        link.setAttribute('download', filename);\n   556â†’        link.style.visibility = 'hidden';\n   557â†’        // æ·»åŠ åˆ°é é¢ä¸¦è§¸ç™¼ä¸‹è¼‰\n   558â†’        document.body.appendChild(link);\n   559â†’        link.click();\n   560â†’        console.log('[downloadCSVFile] link.click() å·²è§¸ç™¼');\n   561â†’        // æ¸…ç†\n   562â†’        document.body.removeChild(link);\n   563â†’        URL.revokeObjectURL(url);\n   564â†’        console.log('[downloadCSVFile] æ¸…ç†å®Œæˆ');\n   565â†’    } catch (err) {\n   566â†’        console.error('[downloadCSVFile] ç™¼ç”ŸéŒ¯èª¤', err);\n   567â†’    }\n   568â†’}\n   569â†’\n   570â†’// åŒ¯å…¥å·¥æ™‚è¡¨ï¼ˆæš«æ™‚åªæç¤ºï¼‰\n   571â†’function importTimesheet() {\n   572â†’    const input = document.getElementById('import-file');\n   573â†’    input.value = ''; // é‡ç½® inputï¼Œé¿å…åŒæª”æ¡ˆç„¡æ³•é‡é¸\n   574â†’    input.onchange = async function (event) {\n   575â†’        const file = event.target.files[0];\n   576â†’        if (!file) return;\n   577â†’        const reader = new FileReader();\n   578â†’        reader.onload = function (e) {\n   579â†’            const text = e.target.result;\n   580â†’            try {\n   581â†’                console.log('[import] åŸå§‹CSVå…§å®¹:', text);\n   582â†’                \n   583â†’                // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ç‚ºç©º\n   584â†’                if (!text || text.trim().length === 0) {\n   585â†’                    alert('æª”æ¡ˆå…§å®¹ç‚ºç©ºï¼Œè«‹é¸æ“‡æœ‰æ•ˆçš„CSVæª”æ¡ˆã€‚');\n   586â†’                    return;\n   587â†’                }\n   588â†’                \n   589â†’                const data = parseCSV(text);\n   590â†’                console.log('[import] parseCSV result:', data);\n   591â†’                \n   592â†’                // æª¢æŸ¥æ˜¯å¦æˆåŠŸè§£æå‡ºè³‡æ–™\n   593â†’                if (!data || data.length === 0) {\n   594â†’                    alert('ç„¡æ³•å¾æª”æ¡ˆä¸­è§£æå‡ºæœ‰æ•ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥CSVæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');\n   595â†’                    return;\n   596â†’                }\n   597â†’                \n   598â†’                // å¼·åˆ¶å°‡ data è½‰ç‚º array\n   599â†’                console.log('[import] typeof data:', typeof data, 'Array.isArray:', Array.isArray(data));\n   600â†’                let arr = [];\n   601â†’                if (Array.isArray(data)) {\n   602â†’                    arr = data;\n   603â†’                } else if (typeof data === 'object' && data !== null) {\n   604â†’                    arr = Object.values(data).flat();\n   605â†’                }\n   606â†’                console.log('[import] è½‰æ›å¾Œ arr:', arr);\n   607â†’                \n   608â†’                if (arr.length === 0) {\n   609â†’                    alert('æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„å·¥æ™‚è¨˜éŒ„ã€‚');\n   610â†’                    return;\n   611â†’                }\n   612â†’                let groupedData = {};\n   613â†’                const failedRows = [];\n   614â†’                \n   615â†’                arr.forEach((row, index) => {\n   616â†’                    if (!row) return;\n   617â†’                    \n   618â†’                    // æª¢æŸ¥æ—¥æœŸæ¬„ä½ï¼ˆæ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±ï¼‰\n   619â†’                    const dateValue = row.Date || row.date || row['æ—¥æœŸ'] || row.Day;\n   620â†’                    if (!dateValue) {\n   621â†’                        console.warn(`[import] ç¬¬${index + 1}ç­†è¨˜éŒ„ç¼ºå°‘æ—¥æœŸæ¬„ä½:`, row);\n   622â†’                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šç¼ºå°‘æ—¥æœŸæ¬„ä½`);\n   623â†’                        return;\n   624â†’                    }\n   625â†’                    \n   626â†’                    // æ”¹é€²çš„æ—¥æœŸè§£æï¼Œæ”¯æ´å¤šç¨®æ ¼å¼\n   627â†’                    let dateObj = null;\n   628â†’                    const dateStr = dateValue.toString().trim();\n   629â†’                    \n   630â†’                    // å˜—è©¦å¤šç¨®æ—¥æœŸæ ¼å¼\n   631â†’                    const dateFormats = [\n   632â†’                        dateStr, // åŸå§‹æ ¼å¼\n   633â†’                        dateStr.replace(/\\//g, '-'), // å°‡ / æ›¿æ›ç‚º -\n   634â†’                        dateStr.replace(/\\./g, '-'), // å°‡ . æ›¿æ›ç‚º -\n   635â†’                    ];\n   636â†’                    \n   637â†’                    for (const format of dateFormats) {\n   638â†’                        dateObj = new Date(format);\n   639â†’                        if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1900) {\n   640â†’                            break;\n   641â†’                        }\n   642â†’                        dateObj = null;\n   643â†’                    }\n   644â†’                    \n   645â†’                    if (!dateObj || isNaN(dateObj.getTime())) {\n   646â†’                        console.warn(`[import] ç¬¬${index + 1}ç­†è¨˜éŒ„æ—¥æœŸæ ¼å¼ç„¡æ•ˆ:`, dateValue);\n   647â†’                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šæ—¥æœŸæ ¼å¼ç„¡æ•ˆ \"${dateValue}\"`);\n   648â†’                        return;\n   649â†’                    }\n   650â†’                    \n   651â†’                    try {\n   652â†’                        // æ­£ç¢ºè¨ˆç®—é€±æ¬¡\n   653â†’                        const year = dateObj.getFullYear();\n   654â†’                        const weekNumber = getWeekNumber(dateObj);\n   655â†’                        const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n   656â†’                        console.log('[import][åˆ†çµ„] Date:', dateValue, 'parsed:', dateObj, 'year:', year, 'weekNumber:', weekNumber, 'weekKey:', weekKey);\n   657â†’                        \n   658â†’                        if (!groupedData[weekKey]) groupedData[weekKey] = [];\n   659â†’                        \n   660â†’                        // æ¨™æº–åŒ–è¨˜éŒ„æ ¼å¼ï¼Œç¢ºä¿æ—¥æœŸçµ±ä¸€å’Œå¿…è¦æ¬„ä½\n   661â†’                        const standardizedRow = { ...row };\n   662â†’                        standardizedRow.date = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD æ ¼å¼\n   663â†’                        \n   664â†’                        // ç¢ºä¿æœ‰å”¯ä¸€çš„ ID\n   665â†’                        if (!standardizedRow.id) {\n   666â†’                            standardizedRow.id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n   667â†’                        }\n   668â†’                        \n   669â†’                        // ç¢ºä¿æ•¸å­—æ¬„ä½æœ‰é è¨­å€¼\n   670â†’                        standardizedRow.regularHours = standardizedRow.regularHours || 0;\n   671â†’                        standardizedRow.otHours = standardizedRow.otHours || 0;\n   672â†’                        standardizedRow.ttlHours = standardizedRow.ttlHours || (standardizedRow.regularHours + standardizedRow.otHours);\n   673â†’                        \n   674â†’                        groupedData[weekKey].push(standardizedRow);\n   675â†’                    } catch (err) {\n   676â†’                        console.error(`[import] è™•ç†ç¬¬${index + 1}ç­†è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:`, err, row);\n   677â†’                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šè™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤`);\n   678â†’                    }\n   679â†’                });\n   680â†’                \n   681â†’                // å¦‚æœæœ‰å¤±æ•—çš„è¨˜éŒ„ï¼Œé¡¯ç¤ºè­¦å‘Š\n   682â†’                if (failedRows.length > 0) {\n   683â†’                    console.warn('[import] ä»¥ä¸‹è¨˜éŒ„åŒ¯å…¥å¤±æ•—:', failedRows);\n   684â†’                    const proceed = confirm(`æœ‰ ${failedRows.length} ç­†è¨˜éŒ„åŒ¯å…¥å¤±æ•—ï¼š\\n${failedRows.slice(0, 5).join('\\n')}${failedRows.length > 5 ? '\\n...' : ''}\\n\\næ˜¯å¦ç¹¼çºŒåŒ¯å…¥å…¶ä»–è¨˜éŒ„ï¼Ÿ`);\n   685â†’                    if (!proceed) {\n   686â†’                        alert('åŒ¯å…¥å·²å–æ¶ˆ');\n   687â†’                        return;\n   688â†’                    }\n   689â†’                }\n   690â†’                console.log('[import] è‡ªå‹•åˆ†çµ„é€±æ¬¡çµæœ:', groupedData);\n   691â†’                // åˆä½µåŒ¯å…¥è³‡æ–™åˆ°ä¸» timesheets\n   692â†’                const timesheets = loadAllTimesheets();\n   693â†’                console.log('[import] localStorage timesheets(åŒ¯å…¥å‰):', timesheets);\n   694â†’                const importedWeeks = [];\n   695â†’                for (const weekKey in groupedData) {\n   696â†’                    console.log('[import] æª¢æŸ¥é€±æ¬¡', weekKey, groupedData[weekKey]);\n   697â†’                    if (timesheets[weekKey]) {\n   698â†’                        const overwrite = confirm('é€±æ¬¡ ' + weekKey + ' å·²æœ‰è³‡æ–™ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ');\n   699â†’                        console.log('[import] è¦†è“‹ç¢ºèª', weekKey, overwrite);\n   700â†’                        if (!overwrite) continue;\n   701â†’                    }\n   702â†’                    timesheets[weekKey] = groupedData[weekKey];\n   703â†’                    importedWeeks.push(weekKey);\n   704â†’                    console.log('[import] å·²åŠ å…¥é€±æ¬¡:', weekKey);\n   705â†’                }\n   706â†’                console.log('[import] importedWeeks:', importedWeeks);\n   707â†’                console.log('[import] localStorage timesheets(åŒ¯å…¥å¾Œ):', timesheets);\n   708â†’                \n   709â†’                if (Object.keys(groupedData).length === 0) {\n   710â†’                    alert('æ²’æœ‰æœ‰æ•ˆçš„è¨˜éŒ„å¯ä»¥åŒ¯å…¥ã€‚è«‹æª¢æŸ¥CSVæª”æ¡ˆä¸­çš„æ—¥æœŸæ ¼å¼å’Œè³‡æ–™å…§å®¹ã€‚');\n   711â†’                    return;\n   712â†’                }\n   713â†’                \n   714â†’                saveAllTimesheets(timesheets);\n   715â†’                renderTimesheetCards();\n   716â†’                \n   717â†’                if (importedWeeks.length > 0) {\n   718â†’                    const weekInfoList = importedWeeks.map(weekKey => {\n   719â†’                        try {\n   720â†’                            const range = getWeekDateRangeFromKey(weekKey);\n   721â†’                            const start = range.start.toISOString().split('T')[0];\n   722â†’                            const end = range.end.toISOString().split('T')[0];\n   723â†’                            const recordCount = groupedData[weekKey].length;\n   724â†’                            return `${weekKey} (${start} ~ ${end}) - ${recordCount}ç­†è¨˜éŒ„`;\n   725â†’                        } catch (err) {\n   726â†’                            console.error('[import] å–å¾—é€±æ¬¡ç¯„åœå¤±æ•—:', weekKey, err);\n   727â†’                            return `${weekKey} - ${groupedData[weekKey].length}ç­†è¨˜éŒ„`;\n   728â†’                        }\n   729â†’                    });\n   730â†’                    \n   731â†’                    const totalRecords = importedWeeks.reduce((sum, weekKey) => sum + groupedData[weekKey].length, 0);\n   732â†’                    const successMessage = `åŒ¯å…¥æˆåŠŸï¼\\nå…±åŒ¯å…¥ ${totalRecords} ç­†è¨˜éŒ„åˆ° ${importedWeeks.length} å€‹é€±æ¬¡ï¼š\\n\\n${weekInfoList.join('\\n')}`;\n   733â†’                    \n   734â†’                    if (failedRows.length > 0) {\n   735â†’                        alert(successMessage + `\\n\\næ³¨æ„ï¼šæœ‰ ${failedRows.length} ç­†è¨˜éŒ„åŒ¯å…¥å¤±æ•—ã€‚`);\n   736â†’                    } else {\n   737â†’                        alert(successMessage);\n   738â†’                    }\n   739â†’                } else {\n   740â†’                    alert('æœªåŒ¯å…¥ä»»ä½•é€±æ¬¡è³‡æ–™ã€‚æ‰€æœ‰è¨˜éŒ„éƒ½è¢«è·³éäº†ã€‚');\n   741â†’                }\n   742â†’            } catch (err) {\n   743â†’                console.error('[import] åŒ¯å…¥æµç¨‹ç™¼ç”ŸéŒ¯èª¤:', err);\n   744â†’                let errorMessage = 'CSV åŒ¯å…¥å¤±æ•—ï¼š\\n';\n   745â†’                if (err.message) {\n   746â†’                    errorMessage += err.message;\n   747â†’                } else {\n   748â†’                    errorMessage += 'æœªçŸ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ç²å–æ›´å¤šè³‡è¨Šã€‚';\n   749â†’                }\n   750â†’                alert(errorMessage);\n   751â†’            }\n   752â†’        };\n   753â†’        reader.readAsText(file, 'utf-8');\n   754â†’    };\n   755â†’    input.click();\n   756â†’}\n   757â†’\n   758â†’// ==================== é¦–é æ¨¡æ…‹æ¡†åŠŸèƒ½ ====================\n   759â†’\n   760â†’// é¡¯ç¤ºåŸºæœ¬è³‡æ–™è¨­å®šæ¨¡æ…‹æ¡†\n   761â†’function showBasicInfoModal() {\n   762â†’    const modal = document.getElementById('basic-info-modal');\n   763â†’    const basicInfo = loadGlobalBasicInfo();\n   764â†’    \n   765â†’    // è¼‰å…¥ç¾æœ‰è³‡æ–™\n   766â†’    if (basicInfo) {\n   767â†’        document.getElementById('modal-employeeName').value = basicInfo.employeeName || '';\n   768â†’        document.getElementById('modal-employeeType').value = basicInfo.employeeType || '';\n   769â†’    }\n   770â†’    \n   771â†’    modal.style.display = 'block';\n   772â†’}\n   773â†’\n   774â†’// éš±è—åŸºæœ¬è³‡æ–™è¨­å®šæ¨¡æ…‹æ¡†\n   775â†’function hideBasicInfoModal() {\n   776â†’    const modal = document.getElementById('basic-info-modal');\n   777â†’    modal.style.display = 'none';\n   778â†’    \n   779â†’    // æ¸…ç©ºè¡¨å–®\n   780â†’    document.getElementById('modal-basic-info-form').reset();\n   781â†’}\n   782â†’\n   783â†’// å„²å­˜æ¨¡æ…‹æ¡†ä¸­çš„åŸºæœ¬è³‡æ–™\n   784â†’function saveModalBasicInfo() {\n   785â†’    const employeeName = document.getElementById('modal-employeeName').value.trim();\n   786â†’    const employeeType = document.getElementById('modal-employeeType').value;\n   787â†’    \n   788â†’    if (!employeeName || !employeeType) {\n   789â†’        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');\n   790â†’        return;\n   791â†’    }\n   792â†’    \n   793â†’    const basicInfo = {\n   794â†’        employeeName: employeeName,\n   795â†’        employeeType: employeeType\n   796â†’    };\n   797â†’    \n   798â†’    saveGlobalBasicInfo(basicInfo);\n   799â†’    hideBasicInfoModal();\n   800â†’    alert('åŸºæœ¬è³‡æ–™å·²å„²å­˜æˆåŠŸï¼ï¼ˆå…¨ App å…±ç”¨ï¼‰');\n   801â†’}\n   802â†’\n   803â†’// åˆå§‹åŒ–ï¼šé é¢åŠ è¼‰å®Œæˆå¾Œæ¸²æŸ“å¡ç‰‡ï¼Œä¸¦ç¶å®šæŒ‰éˆ•äº‹ä»¶\n   804â†’document.addEventListener('DOMContentLoaded', () => {\n   805â†’    // æª¢æŸ¥æ˜¯å¦ç‚ºé¦–é \n   806â†’    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n   807â†’        renderTimesheetCards();\n   808â†’        \n   809â†’        // ç¶å®šå…¨å±€æŒ‰éˆ•äº‹ä»¶\n   810â†’        document.getElementById('btn-basic-info').addEventListener('click', showBasicInfoModal);\n   811â†’        document.getElementById('btn-new').addEventListener('click', newTimesheet);\n   812â†’        document.getElementById('btn-import').addEventListener('click', importTimesheet);\n   813â†’        document.getElementById('btn-clear-storage').addEventListener('click', () => {\n   814â†’            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸã€‚')) {\n   815â†’                localStorage.clear();\n   816â†’                renderTimesheetCards();\n   817â†’                alert('localStorage å·²æ¸…ç©º');\n   818â†’            }\n   819â†’        });\n   820â†’        \n   821â†’        // ç¶å®šåŸºæœ¬è³‡æ–™æ¨¡æ…‹æ¡†äº‹ä»¶\n   822â†’        document.getElementById('btn-save-modal-basic-info').addEventListener('click', saveModalBasicInfo);\n   823â†’        document.getElementById('btn-cancel-modal').addEventListener('click', hideBasicInfoModal);\n   824â†’        document.querySelector('.close').addEventListener('click', hideBasicInfoModal);\n   825â†’        \n   826â†’        // ç¶å®šé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†äº‹ä»¶\n   827â†’        const weekModal = document.getElementById('week-selection-modal');\n   828â†’        if (weekModal) {\n   829â†’            const weekCloseBtn = weekModal.querySelector('.close');\n   830â†’            const confirmWeekBtn = document.getElementById('btn-confirm-week');\n   831â†’            const cancelWeekBtn = document.getElementById('btn-cancel-week');\n   832â†’            const customRadio = document.getElementById('radio-custom');\n   833â†’            const customInput = document.getElementById('custom-week-input');\n   834â†’            \n   835â†’            if (weekCloseBtn) weekCloseBtn.addEventListener('click', hideWeekSelectionModal);\n   836â†’            if (cancelWeekBtn) cancelWeekBtn.addEventListener('click', hideWeekSelectionModal);\n   837â†’            if (confirmWeekBtn) confirmWeekBtn.addEventListener('click', confirmWeekSelection);\n   838â†’            \n   839â†’            // ç›£è½è‡ªè¨‚é¸é …çš„é¸æ“‡\n   840â†’            if (customRadio && customInput) {\n   841â†’                customRadio.addEventListener('change', function() {\n   842â†’                    if (this.checked) {\n   843â†’                        customInput.style.display = 'block';\n   844â†’                    }\n   845â†’                });\n   846â†’            }\n   847â†’            \n   848â†’            // ç›£è½å…¶ä»–é¸é …çš„é¸æ“‡ï¼ˆéš±è—è‡ªè¨‚è¼¸å…¥ï¼‰\n   849â†’            document.querySelectorAll('input[name=\"weekOption\"]:not(#radio-custom)').forEach(radio => {\n   850â†’                radio.addEventListener('change', function() {\n   851â†’                    if (this.checked && customInput) {\n   852â†’                        customInput.style.display = 'none';\n   853â†’                    }\n   854â†’                });\n   855â†’            });\n   856â†’        }\n   857â†’        \n   858â†’        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰\n   859â†’        window.addEventListener('click', (event) => {\n   860â†’            const basicModal = document.getElementById('basic-info-modal');\n   861â†’            const weekSelectionModal = document.getElementById('week-selection-modal');\n   862â†’            \n   863â†’            if (event.target === basicModal) {\n   864â†’                hideBasicInfoModal();\n   865â†’            } else if (event.target === weekSelectionModal) {\n   866â†’                hideWeekSelectionModal();\n   867â†’            }\n   868â†’        });\n   869â†’\n   870â†’        // è¨­ç½®ä¸Šé€±æŒ‰éˆ•çš„æ–‡å­—å’Œé¡¯ç¤ºç‹€æ…‹\n   871â†’        const lastWeekButton = document.getElementById('btn-last-week');\n   872â†’        if (lastWeekButton) {\n   873â†’            updateLastWeekButtonDisplay();\n   874â†’            // ç¶å®šé»æ“Šäº‹ä»¶\n   875â†’            lastWeekButton.addEventListener('click', createLastWeekTimesheet);\n   876â†’        }\n   877â†’    }\n   878â†’});\n   879â†’\n   880â†’// æ›´æ–°ä¸Šé€±æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹å’Œæ–‡å­—\n   881â†’function updateLastWeekButtonDisplay() {\n   882â†’    const today = new Date();\n   883â†’    // æ›´ç²¾ç¢ºçš„è¨ˆç®—ï¼šç²å–ä¸Šé€±ä¸€ï¼ˆä»Šå¤©æ¸›å»ä»Šå¤©æ˜ŸæœŸå¹¾å†æ¸›6å¤©ï¼‰\n   884â†’    const lastMonday = new Date(today);\n   885â†’    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n   886â†’    const lastSunday = new Date(lastMonday);\n   887â†’    lastSunday.setDate(lastMonday.getDate() + 6);\n   888â†’    \n   889â†’    const button = document.getElementById('btn-last-week');\n   890â†’    const container = document.getElementById('last-week-container');\n   891â†’    \n   892â†’    if (button && container) {\n   893â†’        // æª¢æŸ¥ä¸Šé€±æ˜¯å¦å·²å­˜åœ¨\n   894â†’        const lastWeekKey = getLastWeekKey();\n   895â†’        const timesheets = loadAllTimesheets();\n   896â†’        \n   897â†’        if (timesheets[lastWeekKey]) {\n   898â†’            // ä¸Šé€±å·²å­˜åœ¨ï¼Œéš±è—æŒ‰éˆ•\n   899â†’            container.style.display = 'none';\n   900â†’        } else {\n   901â†’            // ä¸Šé€±ä¸å­˜åœ¨ï¼Œé¡¯ç¤ºæŒ‰éˆ•ä¸¦è¨­ç½®æ–‡å­—\n   902â†’            container.style.display = 'block';\n   903â†’            button.textContent = `å»ºç«‹ä¸Šé€±å·¥æ™‚è¡¨ (${formatDate(lastMonday)} - ${formatDate(lastSunday)})`;\n   904â†’        }\n   905â†’    }\n   906â†’}\n   907â†’\n   908â†’// å»ºç«‹ä¸Šé€±å·¥æ™‚è¡¨\n   909â†’function createLastWeekTimesheet() {\n   910â†’    const today = new Date();\n   911â†’    const lastMonday = new Date(today);\n   912â†’    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n   913â†’    const lastSunday = new Date(lastMonday);\n   914â†’    lastSunday.setDate(lastMonday.getDate() + 6);\n   915â†’    \n   916â†’    // ç”Ÿæˆé€±æ¬¡æ ¼å¼ YYYY-Www\n   917â†’    const year = lastMonday.getFullYear();\n   918â†’    const weekNumber = Math.ceil((((lastMonday - new Date(year, 0, 1)) / 86400000) + new Date(year, 0, 1).getDay() + 1) / 7);\n   919â†’    const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n   920â†’    \n   921â†’    const timesheets = loadAllTimesheets();\n   922â†’    if (!timesheets[weekKey]) {\n   923â†’        timesheets[weekKey] = [];\n   924â†’        saveAllTimesheets(timesheets);\n   925â†’    }\n   926â†’    \n   927â†’    // è¼‰å…¥ä¸Šé€±å·¥æ™‚è¡¨\n   928â†’    editTimesheet(weekKey);\n   929â†’    renderTimesheetCards();\n   930â†’}\n   931â†’\n   932â†’// ==================== ç·¨è¼¯é é¢åŠŸèƒ½ ====================\n   933â†’\n   934â†’// ç”Ÿæˆå”¯ä¸€ ID\n   935â†’function generateUniqueId() {\n   936â†’    return Date.now().toString(36) + Math.random().toString(36).substr(2);\n   937â†’}\n   938â†’\n   939â†’// ç²å–ç•¶å‰ç·¨è¼¯çš„é€±æ¬¡\n   940â†’function getCurrentWeekKey() {\n   941â†’    const urlParams = new URLSearchParams(window.location.search);\n   942â†’    return urlParams.get('week');\n   943â†’}\n   944â†’\n   945â†’// ==================== å…¨åŸŸåŸºæœ¬è³‡æ–™ç®¡ç† ====================\n   946â†’\n   947â†’// è¼‰å…¥å…¨åŸŸåŸºæœ¬è³‡æ–™\n   948â†’function loadGlobalBasicInfo() {\n   949â†’    const data = localStorage.getItem('globalBasicInfo');\n   950â†’    return data ? JSON.parse(data) : null;\n   951â†’}\n   952â†’\n   953â†’// å„²å­˜å…¨åŸŸåŸºæœ¬è³‡æ–™\n   954â†’function saveGlobalBasicInfo(basicInfo) {\n   955â†’    localStorage.setItem('globalBasicInfo', JSON.stringify(basicInfo));\n   956â†’}\n   957â†’\n   958â†’// ==================== å·¥æ™‚è¨˜éŒ„ç®¡ç† ====================\n   959â†’\n   960â†’// ç²å–æŒ‡å®šé€±æ¬¡çš„å·¥æ™‚è¨˜éŒ„\n   961â†’function getWeekEntries(weekKey) {\n   962â†’    const timesheets = loadAllTimesheets();\n   963â†’    const weekData = timesheets[weekKey];\n   964â†’    \n   965â†’    // è™•ç†ä¸åŒçš„è³‡æ–™çµæ§‹\n   966â†’    if (Array.isArray(weekData)) {\n   967â†’        // èˆŠçš„è³‡æ–™çµæ§‹ï¼Œç›´æ¥æ˜¯é™£åˆ—\n   968â†’        return weekData;\n   969â†’    } else if (weekData && weekData.entries) {\n   970â†’        // æ–°çš„è³‡æ–™çµæ§‹ï¼Œæœ‰ entries\n   971â†’        return weekData.entries;\n   972â†’    }\n   973â†’    \n   974â†’    return [];\n   975â†’}\n   976â†’\n   977â†’// å„²å­˜æŒ‡å®šé€±æ¬¡çš„å·¥æ™‚è¨˜éŒ„\n   978â†’function saveWeekEntries(weekKey, entries) {\n   979â†’    const timesheets = loadAllTimesheets();\n   980â†’    timesheets[weekKey] = entries; // ç›´æ¥å„²å­˜ç‚ºé™£åˆ—ï¼Œç°¡åŒ–çµæ§‹\n   981â†’    saveAllTimesheets(timesheets);\n   982â†’}\n   983â†’\n   984â†’// è¨ˆç®—ç¸½å·¥æ™‚\n   985â†’function calculateTotalHours() {\n   986â†’    const regular = parseFloat(document.getElementById('regularHours').value) || 0;\n   987â†’    const ot = parseFloat(document.getElementById('otHours').value) || 0;\n   988â†’    document.getElementById('ttlHours').value = regular + ot;\n   989â†’}\n   990â†’\n   991â†’// é©—è­‰åŸºæœ¬è³‡æ–™è¡¨å–®\n   992â†’function validateBasicInfo() {\n   993â†’    const requiredFields = ['employeeName', 'employeeType'];\n   994â†’    let isValid = true;\n   995â†’    \n   996â†’    // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤ç‹€æ…‹\n   997â†’    document.querySelectorAll('#basic-info-form .form-field.error').forEach(field => {\n   998â†’        field.classList.remove('error');\n   999â†’    });\n  1000â†’    \n  1001â†’    requiredFields.forEach(fieldName => {\n  1002â†’        const field = document.getElementById(fieldName);\n  1003â†’        const formField = field.closest('.form-field');\n  1004â†’        \n  1005â†’        if (!field.value.trim()) {\n  1006â†’            formField.classList.add('error');\n  1007â†’            showFieldError(formField, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');\n  1008â†’            isValid = false;\n  1009â†’        }\n  1010â†’    });\n  1011â†’    \n  1012â†’    return isValid;\n  1013â†’}\n  1014â†’\n  1015â†’// é©—è­‰å·¥æ™‚è¨˜éŒ„è¡¨å–®\n  1016â†’function validateForm() {\n  1017â†’    const requiredFields = ['task', 'zone', 'project', 'activityType', 'regularHours', 'date'];\n  1018â†’    let isValid = true;\n  1019â†’    \n  1020â†’    // æª¢æŸ¥æ˜¯å¦å·²å„²å­˜å…¨åŸŸåŸºæœ¬è³‡æ–™\n  1021â†’    const basicInfo = loadGlobalBasicInfo();\n  1022â†’    if (!basicInfo) {\n  1023â†’        alert('è«‹å…ˆå¡«å¯«ä¸¦å„²å­˜åŸºæœ¬è³‡æ–™');\n  1024â†’        document.querySelector('.basic-info-container').scrollIntoView({ behavior: 'smooth' });\n  1025â†’        return false;\n  1026â†’    }\n  1027â†’    \n  1028â†’    // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤ç‹€æ…‹\n  1029â†’    document.querySelectorAll('#timesheet-form .form-field.error').forEach(field => {\n  1030â†’        field.classList.remove('error');\n  1031â†’    });\n  1032â†’    \n  1033â†’    requiredFields.forEach(fieldName => {\n  1034â†’        const field = document.getElementById(fieldName);\n  1035â†’        const formField = field.closest('.form-field');\n  1036â†’        \n  1037â†’        if (!field.value.trim()) {\n  1038â†’            formField.classList.add('error');\n  1039â†’            showFieldError(formField, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');\n  1040â†’            isValid = false;\n  1041â†’        }\n  1042â†’    });\n  1043â†’    \n  1044â†’    // é©—è­‰å·¥æ™‚ç¯„åœ\n  1045â†’    const regularHours = parseFloat(document.getElementById('regularHours').value);\n  1046â†’    const otHours = parseFloat(document.getElementById('otHours').value) || 0;\n  1047â†’    \n  1048â†’    if (regularHours < 0 || regularHours > 24) {\n  1049â†’        const formField = document.getElementById('regularHours').closest('.form-field');\n  1050â†’        formField.classList.add('error');\n  1051â†’        showFieldError(formField, 'æ­£å¸¸å·¥æ™‚å¿…é ˆåœ¨ 0-24 å°æ™‚ä¹‹é–“');\n  1052â†’        isValid = false;\n  1053â†’    }\n  1054â†’    \n  1055â†’    if (otHours < 0 || otHours > 24) {\n  1056â†’        const formField = document.getElementById('otHours').closest('.form-field');\n  1057â†’        formField.classList.add('error');\n  1058â†’        showFieldError(formField, 'åŠ ç­å·¥æ™‚å¿…é ˆåœ¨ 0-24 å°æ™‚ä¹‹é–“');\n  1059â†’        isValid = false;\n  1060â†’    }\n  1061â†’    \n  1062â†’    // å…è¨±æ­£å¸¸å·¥æ™‚ç¸½è¨ˆè¶…é40å°æ™‚ï¼Œåƒ…æ–¼åŒ¯å‡ºæ™‚æç¤ºæ­£è¦åŒ–\n  1063â†’    const weekKey = getCurrentWeekKey();\n  1064â†’    const currentEntryId = document.getElementById('entryId').value;\n  1065â†’    const entries = getWeekEntries(weekKey);\n  1066â†’    \n  1067â†’    // è¨ˆç®—é™¤äº†ç•¶å‰ç·¨è¼¯è¨˜éŒ„å¤–çš„å…¶ä»–è¨˜éŒ„çš„æ­£å¸¸å·¥æ™‚ç¸½å’Œ\n  1068â†’    let totalRegularHours = 0;\n  1069â†’    entries.forEach(entry => {\n  1070â†’        if (entry.id !== currentEntryId) {\n  1071â†’            totalRegularHours += entry.regularHours || 0;\n  1072â†’        }\n  1073â†’    });\n  1074â†’    \n  1075â†’    // åŠ ä¸Šç•¶å‰è¼¸å…¥çš„æ­£å¸¸å·¥æ™‚\n  1076â†’    totalRegularHours += regularHours;\n  1077â†’    \n  1078â†’    // ä¸å†æ–¼æ­¤è™•é™åˆ¶æˆ–æç¤ºï¼Œåƒ…æ–¼åŒ¯å‡ºæ™‚è™•ç†æ­£è¦åŒ–\n  1079â†’    \n  1080â†’    // é©—è­‰æ—¥æœŸé‚è¼¯\n  1081â†’    const startDate = document.getElementById('startDate').value;\n  1082â†’    const endDate = document.getElementById('endDate').value;\n  1083â†’    const date = document.getElementById('date').value;\n  1084â†’    \n  1085â†’    // ç²å–ç•¶å‰é€±çš„æ—¥æœŸç¯„åœï¼ˆä½¿ç”¨å·²å®£å‘Šçš„ weekKeyï¼‰\n  1086â†’    const [year, week] = weekKey.split('-');\n  1087â†’    const weekNumber = parseInt(week.substring(1));\n  1088â†’    const weekRange = getWeekDateRange(weekNumber, year);\n  1089â†’    \n  1090â†’    // é©—è­‰ä¸»è¦æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n  1091â†’    if (date && !validateDateInWeekRange(date, weekRange.start, weekRange.end)) {\n  1092â†’        const formField = document.getElementById('date').closest('.form-field');\n  1093â†’        formField.classList.add('error');\n  1094â†’        showFieldError(formField, `æ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n  1095â†’        isValid = false;\n  1096â†’    }\n  1097â†’    \n  1098â†’    // é©—è­‰é–‹å§‹æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n  1099â†’    if (startDate && !validateDateInWeekRange(startDate, weekRange.start, weekRange.end)) {\n  1100â†’        const formField = document.getElementById('startDate').closest('.form-field');\n  1101â†’        formField.classList.add('error');\n  1102â†’        showFieldError(formField, `é–‹å§‹æ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n  1103â†’        isValid = false;\n  1104â†’    }\n  1105â†’    \n  1106â†’    // é©—è­‰çµæŸæ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n  1107â†’    if (endDate && !validateDateInWeekRange(endDate, weekRange.start, weekRange.end)) {\n  1108â†’        const formField = document.getElementById('endDate').closest('.form-field');\n  1109â†’        formField.classList.add('error');\n  1110â†’        showFieldError(formField, `çµæŸæ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n  1111â†’        isValid = false;\n  1112â†’    }\n  1113â†’    \n  1114â†’    // é©—è­‰é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ\n  1115â†’    if (startDate && endDate && new Date(startDate) > new Date(endDate)) {\n  1116â†’        const formField = document.getElementById('endDate').closest('.form-field');\n  1117â†’        formField.classList.add('error');\n  1118â†’        showFieldError(formField, 'çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ');\n  1119â†’        isValid = false;\n  1120â†’    }\n  1121â†’    \n  1122â†’    return isValid;\n  1123â†’}\n  1124â†’\n  1125â†’// é¡¯ç¤ºæ¬„ä½éŒ¯èª¤è¨Šæ¯\n  1126â†’function showFieldError(formField, message) {\n  1127â†’    let errorDiv = formField.querySelector('.error-message');\n  1128â†’    if (!errorDiv) {\n  1129â†’        errorDiv = document.createElement('div');\n  1130â†’        errorDiv.className = 'error-message';\n  1131â†’        formField.appendChild(errorDiv);\n  1132â†’    }\n  1133â†’    errorDiv.textContent = message;\n  1134â†’}\n  1135â†’\n  1136â†’// æ¸…ç©ºè¡¨å–®\n  1137â†’function clearForm() {\n  1138â†’    document.getElementById('timesheet-form').reset();\n  1139â†’    document.getElementById('entryId').value = '';\n  1140â†’    document.getElementById('ttlHours').value = '';\n  1141â†’    \n  1142â†’    // æ¸…é™¤éŒ¯èª¤ç‹€æ…‹\n  1143â†’    document.querySelectorAll('.form-field.error').forEach(field => {\n  1144â†’        field.classList.remove('error');\n  1145â†’    });\n  1146â†’}\n  1147â†’\n  1148â†’// ç²å–åŸºæœ¬è³‡æ–™\n  1149â†’function getBasicInfoData() {\n  1150â†’    return {\n  1151â†’        employeeName: document.getElementById('employeeName').value.trim(),\n  1152â†’        employeeType: document.getElementById('employeeType').value\n  1153â†’    };\n  1154â†’}\n  1155â†’\n  1156â†’// å¡«å……åŸºæœ¬è³‡æ–™\n  1157â†’function fillBasicInfo(basicInfo) {\n  1158â†’    if (basicInfo) {\n  1159â†’        document.getElementById('employeeName').value = basicInfo.employeeName || '';\n  1160â†’        document.getElementById('employeeType').value = basicInfo.employeeType || '';\n  1161â†’    }\n  1162â†’}\n  1163â†’\n  1164â†’// å¾è¡¨å–®ç²å–å·¥æ™‚è¨˜éŒ„æ•¸æ“š\n  1165â†’function getFormData() {\n  1166â†’    const basicInfo = loadGlobalBasicInfo();\n  1167â†’    const originalHours = document.getElementById('originalHours').value;\n  1168â†’    \n  1169â†’    const data = {\n  1170â†’        id: document.getElementById('entryId').value || generateUniqueId(),\n  1171â†’        // å¾å…¨åŸŸåŸºæœ¬è³‡æ–™å¼•ç”¨\n  1172â†’        name: basicInfo ? basicInfo.employeeName : '',\n  1173â†’        internalOrOutsource: basicInfo ? basicInfo.employeeType : '',\n  1174â†’        // å·¥æ™‚è¨˜éŒ„ç‰¹å®šæ¬„ä½\n  1175â†’        zone: document.getElementById('zone').value,\n  1176â†’        project: document.getElementById('project').value.trim(),\n  1177â†’        productModule: document.getElementById('productModule').value.trim(),\n  1178â†’        activityType: document.getElementById('activityType').value,\n  1179â†’        task: document.getElementById('task').value.trim(),\n  1180â†’        regularHours: parseFloat(document.getElementById('regularHours').value) || 0,\n  1181â†’        otHours: parseFloat(document.getElementById('otHours').value) || 0,\n  1182â†’        ttlHours: parseFloat(document.getElementById('ttlHours').value) || 0,\n  1183â†’        date: document.getElementById('date').value,\n  1184â†’        startDate: document.getElementById('startDate').value,\n  1185â†’        endDate: document.getElementById('endDate').value,\n  1186â†’        comments: document.getElementById('comments').value.trim(),\n  1187â†’        pm: document.getElementById('pm').value.trim()\n  1188â†’    };\n  1189â†’    \n  1190â†’    // å¦‚æœæœ‰åŸå§‹å·¥æ™‚ï¼ˆæ­£è¦åŒ–æ¨¡å¼ï¼‰ï¼Œå‰‡å„²å­˜ä½†æ¨™è¨˜ç‚ºå…§éƒ¨ä½¿ç”¨\n  1191â†’    if (originalHours && parseFloat(originalHours) > 0) {\n  1192â†’        data._originalHours = parseFloat(originalHours); // ä½¿ç”¨ _ å‰ç¶´æ¨™è¨˜ç‚ºå…§éƒ¨æ¬„ä½\n  1193â†’        data._isNormalized = true;\n  1194â†’    }\n  1195â†’    \n  1196â†’    return data;\n  1197â†’}\n  1198â†’\n  1199â†’// å¡«å……å·¥æ™‚è¨˜éŒ„è¡¨å–®æ•¸æ“š\n  1200â†’function fillForm(entry) {\n  1201â†’    document.getElementById('entryId').value = entry.id;\n  1202â†’    document.getElementById('zone').value = entry.zone || '';\n  1203â†’    document.getElementById('project').value = entry.project || '';\n  1204â†’    document.getElementById('productModule').value = entry.productModule || '';\n  1205â†’    document.getElementById('activityType').value = entry.activityType || '';\n  1206â†’    document.getElementById('task').value = entry.task || '';\n  1207â†’    document.getElementById('regularHours').value = entry.regularHours || '';\n  1208â†’    document.getElementById('otHours').value = entry.otHours || 0;\n  1209â†’    document.getElementById('ttlHours').value = entry.ttlHours || '';\n  1210â†’    document.getElementById('date').value = entry.date || '';\n  1211â†’    document.getElementById('startDate').value = entry.startDate || '';\n  1212â†’    document.getElementById('endDate').value = entry.endDate || '';\n  1213â†’    document.getElementById('comments').value = entry.comments || '';\n  1214â†’    document.getElementById('pm').value = entry.pm || '';\n  1215â†’    \n  1216â†’    // è™•ç†åŸå§‹å·¥æ™‚æ¬„ä½ï¼ˆæ­£è¦åŒ–æ¨¡å¼ï¼‰\n  1217â†’    const originalHoursField = document.getElementById('originalHoursField');\n  1218â†’    if (entry._originalHours && entry._isNormalized) {\n  1219â†’        document.getElementById('originalHours').value = entry._originalHours;\n  1220â†’        originalHoursField.style.display = 'block';\n  1221â†’    } else {\n  1222â†’        document.getElementById('originalHours').value = '';\n  1223â†’        originalHoursField.style.display = 'none';\n  1224â†’    }\n  1225â†’}\n  1226â†’\n  1227â†’// å„²å­˜åŸºæœ¬è³‡æ–™\n  1228â†’function saveBasicInfo() {\n  1229â†’    if (!validateBasicInfo()) {\n  1230â†’        return;\n  1231â†’    }\n  1232â†’    \n  1233â†’    const basicInfoData = getBasicInfoData();\n  1234â†’    saveGlobalBasicInfo(basicInfoData);\n  1235â†’    \n  1236â†’    // æ›´æ–° UI ç‹€æ…‹\n  1237â†’    const container = document.querySelector('.basic-info-container');\n  1238â†’    container.classList.add('basic-info-saved');\n  1239â†’    \n  1240â†’    showSuccessMessage('åŸºæœ¬è³‡æ–™å·²å„²å­˜æˆåŠŸï¼ï¼ˆå…¨ App å…±ç”¨ï¼‰');\n  1241â†’}\n  1242â†’\n  1243â†’// å„²å­˜å·¥æ™‚è¨˜éŒ„\n  1244â†’function saveEntry() {\n  1245â†’    if (!validateForm()) {\n  1246â†’        return;\n  1247â†’    }\n  1248â†’    \n  1249â†’    const weekKey = getCurrentWeekKey();\n  1250â†’    if (!weekKey) {\n  1251â†’        alert('ç„¡æ•ˆçš„é€±æ¬¡åƒæ•¸');\n  1252â†’        return;\n  1253â†’    }\n  1254â†’    \n  1255â†’    const formData = getFormData();\n  1256â†’    const entries = getWeekEntries(weekKey);\n  1257â†’    \n  1258â†’    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°å¢æˆ–ç·¨è¼¯\n  1259â†’    const existingIndex = entries.findIndex(entry => entry.id === formData.id);\n  1260â†’    \n  1261â†’    if (existingIndex !== -1) {\n  1262â†’        // ç·¨è¼¯ç¾æœ‰è¨˜éŒ„\n  1263â†’        entries[existingIndex] = formData;\n  1264â†’    } else {\n  1265â†’        // æ–°å¢è¨˜éŒ„\n  1266â†’        entries.push(formData);\n  1267â†’    }\n  1268â†’    \n  1269â†’    saveWeekEntries(weekKey, entries);\n  1270â†’    renderEntriesList();\n  1271â†’    clearForm();\n  1272â†’    showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²å„²å­˜æˆåŠŸï¼');\n  1273â†’}\n  1274â†’\n  1275â†’// ç·¨è¼¯å·¥æ™‚è¨˜éŒ„\n  1276â†’function editEntry(entryId) {\n  1277â†’    const weekKey = getCurrentWeekKey();\n  1278â†’    const entries = getWeekEntries(weekKey);\n  1279â†’    const entry = entries.find(e => e.id === entryId);\n  1280â†’    \n  1281â†’    if (entry) {\n  1282â†’        fillForm(entry);\n  1283â†’        // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨\n  1284â†’        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n  1285â†’    }\n  1286â†’}\n  1287â†’\n  1288â†’// è¤‡è£½å·¥æ™‚è¨˜éŒ„\n  1289â†’function copyEntry(entryId) {\n  1290â†’    const weekKey = getCurrentWeekKey();\n  1291â†’    const entries = getWeekEntries(weekKey);\n  1292â†’    const entry = entries.find(e => e.id === entryId);\n  1293â†’    \n  1294â†’    if (entry) {\n  1295â†’        // ç²å–ç•¶é€±æ—¥æœŸç¯„åœ\n  1296â†’        const [year, week] = weekKey.split('-');\n  1297â†’        const weekNumber = parseInt(week.substring(1));\n  1298â†’        const weekRange = getWeekDateRange(weekNumber, year);\n  1299â†’        \n  1300â†’        // è¤‡è£½è¨˜éŒ„è³‡æ–™ä¸¦æ›´æ–°æ—¥æœŸ\n  1301â†’        const copiedEntry = { ...entry, id: generateUniqueId() };\n  1302â†’        \n  1303â†’        // æ›´æ–°æ—¥æœŸï¼ˆå¦‚æœæ˜¯å–®æ—¥è¨˜éŒ„ï¼‰\n  1304â†’        if (copiedEntry.date) {\n  1305â†’            const originalDate = new Date(copiedEntry.date);\n  1306â†’            const nextDate = new Date(originalDate);\n  1307â†’            nextDate.setDate(originalDate.getDate() + 1);\n  1308â†’            \n  1309â†’            // æª¢æŸ¥æ˜¯å¦è¶…éé€±ç¯„åœ\n  1310â†’            if (nextDate <= weekRange.end) {\n  1311â†’                copiedEntry.date = formatDate(nextDate);\n  1312â†’            } else {\n  1313â†’                // å¦‚æœæ˜¯é€±æœ€å¾Œä¸€å¤©ï¼Œå‰‡é‡ç½®ç‚ºé€±ç¬¬ä¸€å¤©\n  1314â†’                copiedEntry.date = formatDate(weekRange.start);\n  1315â†’            }\n  1316â†’        }\n  1317â†’        \n  1318â†’        fillForm(copiedEntry);\n  1319â†’        // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨\n  1320â†’        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n  1321â†’        showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²è¤‡è£½ï¼Œæ—¥æœŸå·²è‡ªå‹•èª¿æ•´');\n  1322â†’    }\n  1323â†’}\n  1324â†’\n  1325â†’// åˆªé™¤å·¥æ™‚è¨˜éŒ„\n  1326â†’function deleteEntry(entryId) {\n  1327â†’    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å·¥æ™‚è¨˜éŒ„å—ï¼Ÿ')) {\n  1328â†’        return;\n  1329â†’    }\n  1330â†’    \n  1331â†’    const weekKey = getCurrentWeekKey();\n  1332â†’    const entries = getWeekEntries(weekKey);\n  1333â†’    const filteredEntries = entries.filter(entry => entry.id !== entryId);\n  1334â†’    \n  1335â†’    saveWeekEntries(weekKey, filteredEntries);\n  1336â†’    renderEntriesList();\n  1337â†’    showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²åˆªé™¤ï¼');\n  1338â†’}\n  1339â†’\n  1340â†’// æ¸²æŸ“å·¥æ™‚è¨˜éŒ„åˆ—è¡¨\n  1341â†’function renderEntriesList() {\n  1342â†’    const weekKey = getCurrentWeekKey();\n  1343â†’    const entries = getWeekEntries(weekKey);\n  1344â†’    const tbody = document.getElementById('entries-tbody');\n  1345â†’    \n  1346â†’    if (!tbody) return;\n  1347â†’    \n  1348â†’    tbody.innerHTML = '';\n  1349â†’    \n  1350â†’    let totalHours = 0;\n  1351â†’    \n  1352â†’    entries.forEach(entry => {\n  1353â†’        totalHours += entry.ttlHours || 0;\n  1354â†’        \n  1355â†’        const row = document.createElement('tr');\n  1356â†’        row.innerHTML = `\n  1357â†’            <td>${entry.date || '-'}</td>\n  1358â†’            <td>${entry.zone || '-'}</td>\n  1359â†’            <td>${entry.activityType || '-'}</td>\n  1360â†’            <td>${entry.task || '-'}</td>\n  1361â†’            <td>${entry.regularHours || 0}</td>\n  1362â†’            <td>${entry.otHours || 0}</td>\n  1363â†’            <td><strong>${entry.ttlHours || 0}</strong></td>\n  1364â†’            <td class=\"entry-actions\">\n  1365â†’                <button class=\"btn-edit-entry\" onclick=\"editEntry('${entry.id}')\">ç·¨è¼¯</button>\n  1366â†’                <button class=\"btn-copy-entry\" onclick=\"copyEntry('${entry.id}')\">è¤‡è£½</button>\n  1367â†’                <button class=\"btn-delete-entry\" onclick=\"deleteEntry('${entry.id}')\">åˆªé™¤</button>\n  1368â†’            </td>\n  1369â†’        `;\n  1370â†’        tbody.appendChild(row);\n  1371â†’    });\n  1372â†’    \n  1373â†’    \n  1374â†’    alert('æˆåŠŸè¤‡è£½ ' + copiedEntries.length + ' ç­†å·¥æ™‚è¨˜éŒ„åˆ°ç›®æ¨™é€±ï¼\\n\\nä¾†æºé€±ï¼š' + sourceWeekKey + '\\nç›®æ¨™é€±ï¼š' + targetWeekKey + '\\næ—¥æœŸç¯„åœï¼š' + startDate + ' ~ ' + endDate + '\\n\\næ‰€æœ‰æ—¥æœŸå·²è‡ªå‹•èª¿æ•´ç‚ºç›®æ¨™é€±å°æ‡‰æ—¥æœŸã€‚');\n  1375â†’}\n  1376â†’\n  1377â†’// é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n  1378â†’function showSuccessMessage(message) {\n  1379â†’    // å‰µå»ºæˆ–æ›´æ–°æˆåŠŸè¨Šæ¯å…ƒç´ \n  1380â†’    let successDiv = document.querySelector('.success-message');\n  1381â†’    if (!successDiv) {\n  1382â†’        successDiv = document.createElement('div');\n  1383â†’        successDiv.className = 'success-message';\n  1384â†’        document.querySelector('.form-container').insertBefore(successDiv, document.querySelector('.form-container').firstChild);\n  1385â†’    }\n  1386â†’    \n  1387â†’    successDiv.textContent = message;\n  1388â†’    successDiv.style.display = 'block';\n  1389â†’    \n  1390â†’    // 3ç§’å¾Œè‡ªå‹•éš±è—\n  1391â†’    setTimeout(() => {\n  1392â†’        successDiv.style.display = 'none';\n  1393â†’    }, 3000);\n  1394â†’}\n  1395â†’\n  1396â†’// åˆå§‹åŒ–ç·¨è¼¯é é¢\n  1397â†’async function initEditPage() {\n  1398â†’    const weekKey = getCurrentWeekKey();\n  1399â†’    if (!weekKey) {\n  1400â†’        alert('ç„¡æ•ˆçš„é€±æ¬¡åƒæ•¸');\n  1401â†’        window.location.href = 'index.html';\n  1402â†’        return;\n  1403â†’    }\n  1404â†’    \n  1405â†’    // è¼‰å…¥ CSV è³‡æ–™\n  1406â†’    await loadAllCSVData();\n  1407â†’    \n  1408â†’    // è¨­ç½®é€±æ¬¡æ¨™é¡Œå’Œæ—¥æœŸç¯„åœ\n  1409â†’    document.getElementById('week-title').textContent = weekKey;\n  1410â†’    \n  1411â†’    // è¨ˆç®—ä¸¦é¡¯ç¤ºæ—¥æœŸç¯„åœ\n  1412â†’    const [year, week] = weekKey.split('-');\n  1413â†’    const weekNumber = parseInt(week.substring(1));\n  1414â†’    const dateRange = getWeekDateRange(weekNumber, year);\n  1415â†’    const entries = getWeekEntries(weekKey) || [];\n  1416â†’    const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n  1417â†’    const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n  1418â†’    const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n  1419â†’\n  1420â†’    // å°‡çµ±è¨ˆè³‡è¨ŠåŠ åœ¨æ—¥æœŸå€å¡ŠåŒä¸€è¡Œ\n  1421â†’    const dateRangeDiv = document.getElementById('date-range');\n  1422â†’    dateRangeDiv.innerHTML =\n  1423â†’        `${formatDate(dateRange.start)} è‡³ ${formatDate(dateRange.end)}\n  1424â†’        <span style=\"color:#444;font-size:1em;\">\n  1425â†’        ç¸½æ­£å¸¸å·¥æ™‚ï¼š${totalRegularHours}\n  1426â†’        ç¸½åŠ ç­å·¥æ™‚ï¼š${totalOtHours}\n  1427â†’        ç¸½å·¥æ™‚ï¼š${totalHours}\n  1428â†’        </span>`;\n  1429â†’    // è¨­ç½®æ—¥æœŸæ¬„ä½çš„é™åˆ¶ç¯„åœ\n  1430â†’    setDateFieldLimits(dateRange.start, dateRange.end);\n  1431â†’    \n  1432â†’    // (å·²ç§»é™¤æ­£è¦åŒ–æ¨¡å¼ç‹€æ…‹é¡¯ç¤º)\n  1433â†’ \n  1434â†’    // è¼‰å…¥ä¸¦é¡¯ç¤ºå…¨åŸŸåŸºæœ¬è³‡æ–™\n  1435â†’    const basicInfo = loadGlobalBasicInfo();\n  1436â†’    if (basicInfo) {\n  1437â†’        fillBasicInfo(basicInfo);\n  1438â†’        document.querySelector('.basic-info-container').classList.add('basic-info-saved');\n  1439â†’    }\n  1440â†’    \n  1441â†’    // ç¶å®šåŸºæœ¬è³‡æ–™è¡¨å–®äº‹ä»¶\n  1442â†’    document.getElementById('btn-save-basic-info').addEventListener('click', saveBasicInfo);\n  1443â†’    \n  1444â†’    // ç¶å®šå·¥æ™‚è¨˜éŒ„è¡¨å–®äº‹ä»¶\n  1445â†’    document.getElementById('regularHours').addEventListener('input', calculateTotalHours);\n  1446â†’    document.getElementById('otHours').addEventListener('input', calculateTotalHours);\n  1447â†’    \n  1448â†’    // ç¶å®šæŒ‰éˆ•äº‹ä»¶\n  1449â†’    document.getElementById('btn-save-entry').addEventListener('click', saveEntry);\n  1450â†’    document.getElementById('btn-cancel-entry').addEventListener('click', clearForm);\n  1451â†’    document.getElementById('btn-clear-form').addEventListener('click', clearForm);\n  1452â†’    document.getElementById('btn-back').addEventListener('click', () => {\n  1453â†’        window.location.href = 'index.html';\n  1454â†’    });\n  1455â†’    \n  1456â†’    // ç¶å®šæ–°å¢è¨˜éŒ„æŒ‰éˆ•\n  1457â†’    document.getElementById('btn-add-entry').addEventListener('click', () => {\n  1458â†’        clearForm();\n  1459â†’        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n  1460â†’    });\n  1461â†’    \n  1462â†’    \n  1463â†’    // æ¸²æŸ“å·¥æ™‚è¨˜éŒ„åˆ—è¡¨\n  1464â†’    renderEntriesList();\n  1465â†’}\n  1466â†’\n  1467â†’// æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯é é¢ä¸¦åˆå§‹åŒ–\n  1468â†’if (window.location.pathname.includes('edit.html')) {\n  1469â†’    document.addEventListener('DOMContentLoaded', initEditPage);\n  1470â†’}\n  1471â†’// éš±è—é€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\n  1472â†’function hideWeekSelectionModal() {\n  1473â†’    const modal = document.getElementById('week-selection-modal');\n  1474â†’    modal.style.display = 'none';\n  1475â†’}\n  1476â†’\n  1477â†’// ç¢ºèªé€±æ¬¡é¸æ“‡ä¸¦å»ºç«‹å·¥æ™‚è¡¨\n  1478â†’function confirmWeekSelection() {\n  1479â†’    const selectedOption = document.querySelector('input[name=\"weekOption\"]:checked');\n  1480â†’    \n  1481â†’    if (!selectedOption) {\n  1482â†’        alert('è«‹é¸æ“‡ä¸€å€‹é€±æ¬¡é¸é …');\n  1483â†’        return;\n  1484â†’    }\n  1485â†’    \n  1486â†’    let weekKey = '';\n  1487â†’    \n  1488â†’    switch (selectedOption.value) {\n  1489â†’        case 'last':\n  1490â†’            weekKey = getLastWeekKey();\n  1491â†’            break;\n  1492â†’        case 'this':\n  1493â†’            weekKey = getThisWeekKey();\n  1494â†’            break;\n  1495â†’        case 'custom':\n  1496â†’            const customWeek = document.getElementById('custom-week-field').value.trim();\n  1497â†’            if (!customWeek) {\n  1498â†’                alert('è«‹è¼¸å…¥è‡ªè¨‚é€±æ¬¡');\n  1499â†’                return;\n  1500â†’            }\n  1501â†’            \n  1502â†’            // é©—è­‰æ ¼å¼\n  1503â†’            if (!/^\\d{4}-W\\d{2}$/.test(customWeek)) {\n  1504â†’                alert('é€±æ¬¡æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ä½¿ç”¨YYYY-Wwwæ ¼å¼ï¼ˆä¾‹å¦‚2024-W25ï¼‰');\n  1505â†’                return;\n  1506â†’            }\n  1507â†’            \n  1508â†’            weekKey = customWeek;\n  1509â†’            break;\n  1510â†’        default:\n  1511â†’            alert('ç„¡æ•ˆçš„é¸é …');\n  1512â†’            return;\n  1513â†’    }\n  1514â†’    \n  1515â†’    if (!weekKey) {\n  1516â†’        alert('ç„¡æ³•å–å¾—é€±æ¬¡è³‡è¨Š');\n  1517â†’        return;\n  1518â†’    }\n  1519â†’    \n  1520â†’    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨\n  1521â†’    const timesheets = loadAllTimesheets();\n  1522â†’    if (timesheets[weekKey]) {\n  1523â†’        alert(`é€±æ¬¡ ${weekKey} å·²å­˜åœ¨`);\n  1524â†’        return;\n  1525â†’    }\n  1526â†’    \n  1527â†’    // å‰µå»ºæ–°çš„å·¥æ™‚è¡¨\n  1528â†’    timesheets[weekKey] = [];\n  1529â†’    saveAllTimesheets(timesheets);\n  1530â†’    \n  1531â†’    // éš±è—æ¨¡æ…‹æ¡†\n  1532â†’    hideWeekSelectionModal();\n  1533â†’    \n  1534â†’    // é‡æ–°æ¸²æŸ“å¡ç‰‡\n  1535â†’    renderTimesheetCards();\n  1536â†’    \n  1537â†’    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n  1538â†’    showSuccessMessage(`æˆåŠŸå»ºç«‹é€±æ¬¡ ${weekKey} çš„å·¥æ™‚è¡¨`);\n  1539â†’}\n  1540â†’\n  1541â†’// é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n  1542â†’function showSuccessMessage(message) {\n  1543â†’    // å‰µå»ºæˆåŠŸè¨Šæ¯å…ƒç´ \n  1544â†’    const successDiv = document.createElement('div');\n  1545â†’    successDiv.className = 'success-message';\n  1546â†’    successDiv.innerHTML = `\n  1547â†’        <div class=\"success-content\">\n  1548â†’            <span class=\"success-icon\">âœ“</span>\n  1549â†’            <span class=\"success-text\">${message}</span>\n  1550â†’        </div>\n  1551â†’    `;\n  1552â†’    \n  1553â†’    // æ·»åŠ åˆ°é é¢\n  1554â†’    document.body.appendChild(successDiv);\n  1555â†’    \n  1556â†’    // 3ç§’å¾Œè‡ªå‹•ç§»é™¤\n  1557â†’    setTimeout(() => {\n  1558â†’        if (successDiv.parentNode) {\n  1559â†’            successDiv.parentNode.removeChild(successDiv);\n  1560â†’        }\n  1561â†’    }, 3000);\n  1562â†’}"}]},"uuid":"e2a0a272-0413-4c78-aff7-55c84dea3181","timestamp":"2025-06-20T07:15:52.987Z","toolUseResult":{"type":"text","file":{"filePath":"/home/yanggf/a/timesheet/app.js","content":"import { loadAllTimesheets, saveAllTimesheets, loadGlobalBasicInfo, getWeekEntries, saveWeekEntries } from './modules/storageModule.js';\nimport { loadAllCSVData, getProjectsByZone, getPMByProject, getProductModulesByZone, updateProjectOptions, updateProjectDropdown, updateProductModuleDropdown, updateActivityTypeOptions, generateCSVContent, downloadCSVFile } from './modules/csvModule.js';\nimport { getWeekNumber, getWeekDateRangeFromKey } from './modules/dateModule.js';\nimport {\n    showSuccessMessage,\n    showCopyOptionsModal,\n    closeCopyModal,\n    handleCopySelection,\n    copyWeekToTargetWeek\n} from './modules/uiModule.js';\n\n// è¨­ç½®æ—¥æœŸæ¬„ä½çš„é™åˆ¶ç¯„åœ\nfunction setDateFieldLimits(startDate, endDate) {\n    const minDate = formatDate(startDate);\n    const maxDate = formatDate(endDate);\n    \n    // è¨­ç½®æ—¥æœŸæ¬„ä½çš„ min å’Œ max å±¬æ€§\n    const dateFields = ['date', 'startDate', 'endDate'];\n    dateFields.forEach(fieldId => {\n        const field = document.getElementById(fieldId);\n        if (field) {\n            field.min = minDate;\n            field.max = maxDate;\n            \n            // å¦‚æœæ¬„ä½æœ‰å€¼ä½†è¶…å‡ºç¯„åœï¼Œå‰‡æ¸…ç©º\n            if (field.value) {\n                const fieldDate = new Date(field.value);\n                if (fieldDate < startDate || fieldDate > endDate) {\n                    field.value = '';\n                }\n            }\n        }\n    });\n}\n\n// é©—è­‰æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\nfunction validateDateInWeekRange(date, startDate, endDate) {\n    if (!date) return true; // ç©ºå€¼å…è¨±\n    \n    const inputDate = new Date(date);\n    return inputDate >= startDate && inputDate <= endDate;\n}\n\n// å•Ÿç”¨æ­£è¦åŒ–æ¨¡å¼\nfunction enableNormalizationMode(weekKey) {\n    // å„²å­˜æ­£è¦åŒ–ç‹€æ…‹åˆ° localStorage\n    const normalizationData = {\n        weekKey: weekKey,\n        enabled: true,\n        timestamp: new Date().toISOString()\n    };\n    localStorage.setItem(`normalization_${weekKey}`, JSON.stringify(normalizationData));\n    \n    // æ›´æ–° UI é¡¯ç¤ºæ­£è¦åŒ–æ¨¡å¼ç‹€æ…‹\n    updateNormalizationModeDisplay(weekKey);\n}\n\n// æª¢æŸ¥æ˜¯å¦å•Ÿç”¨æ­£è¦åŒ–æ¨¡å¼\nfunction isNormalizationEnabled(weekKey) {\n    const data = localStorage.getItem(`normalization_${weekKey}`);\n    return data ? JSON.parse(data).enabled : false;\n}\n\n// æ›´æ–°æ­£è¦åŒ–æ¨¡å¼é¡¯ç¤º\nfunction updateNormalizationModeDisplay(weekKey) {\n    const isEnabled = isNormalizationEnabled(weekKey);\n    const weekInfoDiv = document.querySelector('.week-info');\n    \n    // ç§»é™¤èˆŠçš„æ­£è¦åŒ–æç¤º\n    const existingAlert = weekInfoDiv.querySelector('.normalization-alert');\n    if (existingAlert) {\n        existingAlert.remove();\n    }\n    \n    if (isEnabled) {\n        // é¡¯ç¤ºæ­£è¦åŒ–æ¨¡å¼æç¤º\n        const alertDiv = document.createElement('div');\n        alertDiv.className = 'normalization-alert';\n        alertDiv.innerHTML = `\n            <div class=\"alert alert-info\">\n                <strong>ğŸ“Š æ­£è¦åŒ–æ¨¡å¼å·²å•Ÿç”¨</strong> - è©²é€±å·¥æ™‚è¶…é40å°æ™‚ï¼ŒåŒ¯å‡ºæ™‚å°‡è‡ªå‹•é€²è¡Œæ­£è¦åŒ–è¨ˆç®—\n                <button onclick=\"disableNormalizationMode('${weekKey}')\" class=\"btn-disable-normalization\">åœç”¨</button>\n            </div>\n        `;\n        weekInfoDiv.appendChild(alertDiv);\n    }\n}\n\n// åœç”¨æ­£è¦åŒ–æ¨¡å¼\nfunction disableNormalizationMode(weekKey) {\n    localStorage.removeItem(`normalization_${weekKey}`);\n    updateNormalizationModeDisplay(weekKey);\n    showSuccessMessage('æ­£è¦åŒ–æ¨¡å¼å·²åœç”¨');\n}\n\n// åŒ¯å‡ºæ™‚é€²è¡Œæ­£è¦åŒ–è¨ˆç®—\nfunction performNormalizationForExport(entries) {\n    let totalRegularHours = 0;\n\n    // è¨ˆç®—ç¸½æ­£å¸¸å·¥æ™‚\n    entries.forEach(entry => {\n        totalRegularHours += entry.regularHours || 0;\n    });\n\n    if (totalRegularHours > 40) {\n        const normalizedEntries = entries.map(entry => {\n            const originalHours = entry.regularHours || 0;\n            const ratio = 40 / totalRegularHours;\n            const newRegularHours = Math.round(originalHours * ratio * 100) / 100;\n            // ä¿å­˜åŸå§‹å·¥æ™‚\n            return {\n                ...entry,\n                _originalHours: originalHours,\n                _isNormalized: true,\n                regularHours: newRegularHours,\n                ttlHours: newRegularHours + (entry.otHours || 0)\n            };\n        });\n        return normalizedEntries;\n    }\n\n    return entries; // ä¸éœ€è¦æ­£è¦åŒ–\n}\n// æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DDï¼ˆæœ¬åœ°æ™‚é–“ï¼‰\nfunction formatDate(date) {\n    const y = date.getFullYear();\n    const m = String(date.getMonth() + 1).padStart(2, '0');\n    const d = String(date.getDate()).padStart(2, '0');\n    return `${y}-${m}-${d}`;\n}\n\n// å¾localStorageåŠ è¼‰æ‰€æœ‰å·¥æ™‚è¡¨æ•¸æ“š\nfunction loadAllTimesheets() {\n    const data = localStorage.getItem('timesheets');\n    return data ? JSON.parse(data) : {};\n}\n\n// ä¿å­˜æ‰€æœ‰å·¥æ™‚è¡¨æ•¸æ“šåˆ°localStorage\nfunction saveAllTimesheets(timesheets) {\n    localStorage.setItem('timesheets', JSON.stringify(timesheets));\n}\n\n// ç²å–æŒ‡å®šé€±æ•¸çš„æ—¥æœŸç¯„åœï¼ˆé€±æ—¥åˆ°é€±å…­ï¼‰\nfunction getWeekDateRange(weekNumber, year) {\n    // ç°¡å–®å¯¦ç¾ï¼šå‡è¨­yearå’ŒweekNumberæ˜¯æœ‰æ•ˆçš„\n    // å¯¦éš›æ‡‰æ ¹æ“šISOé€±æ•¸è¨ˆç®—ï¼Œé€™è£¡ç°¡åŒ–ç‚ºå¾ç•¶å¹´ç¬¬ä¸€é€±çš„é€±æ—¥é–‹å§‹æ¨ç®—\n    // æ³¨æ„ï¼šé€™åªæ˜¯ä¸€å€‹ç¤ºä¾‹ï¼Œå¯¦éš›çš„æ—¥æœŸè¨ˆç®—éœ€è¦æ›´åš´è¬¹çš„é‚è¼¯\n    const firstDayOfYear = new Date(year, 0, 1);\n    const firstSunday = new Date(firstDayOfYear);\n    // èª¿æ•´åˆ°ç¬¬ä¸€é€±çš„é€±æ—¥ï¼ˆå‡è¨­ç¬¬ä¸€é€±å¾1æœˆ1æ—¥æ‰€åœ¨é€±çš„é€±æ—¥é–‹å§‹ï¼‰\n    firstSunday.setDate(firstDayOfYear.getDate() - firstDayOfYear.getDay());\n    \n    const startDate = new Date(firstSunday);\n    startDate.setDate(firstSunday.getDate() + (weekNumber - 1) * 7);\n    const endDate = new Date(startDate);\n    endDate.setDate(startDate.getDate() + 6);\n    \n    return {\n        start: startDate,\n        end: endDate\n    };\n}\n\n// è¨ˆç®—å¡«å¯«é€²åº¦ï¼ˆæ ¹æ“šè¨˜éŒ„ç­†æ•¸å’Œé æœŸ5å€‹å·¥ä½œæ—¥ï¼Ÿé€™è£¡ç°¡åŒ–ç‚ºè¨˜éŒ„ç­†æ•¸æ˜¯å¦å¤§æ–¼0ï¼‰\nfunction calculateProgress(entries) {\n    // å¦‚æœæœ‰è¨˜éŒ„ï¼Œå‰‡èªç‚ºå¡«å¯«äº†ï¼Œé€²åº¦100%ï¼›å¦å‰‡0\n    return entries && entries.length > 0 ? 100 : 0;\n}\n\n// æ¸²æŸ“å·¥æ™‚è¡¨å¡ç‰‡\nfunction renderTimesheetCards() {\n    const container = document.getElementById('timesheet-cards');\n    container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨\n    \n    const timesheets = loadAllTimesheets();\n    \n    Object.keys(timesheets).forEach(key => {\n        // keyæ ¼å¼ï¼šYYYY-Wwwï¼Œéœ€æª¢æŸ¥åˆæ³•æ€§\n        if (!key || typeof key !== 'string' || !key.includes('-')) return;\n        const [year, week] = key.split('-');\n        if (!year || !week || week.length < 2) return;\n        const weekNumber = parseInt(week.substring(1));\n        if (isNaN(weekNumber)) return;\n        const weekData = timesheets[key];\n        \n        // è™•ç†æ–°çš„è³‡æ–™çµæ§‹ï¼ˆåŒ…å« basicInfo å’Œ entriesï¼‰\n        let entries = [];\n        if (Array.isArray(weekData)) {\n            // èˆŠçš„è³‡æ–™çµæ§‹ï¼Œç›´æ¥æ˜¯é™£åˆ—\n            entries = weekData;\n        } else if (weekData && weekData.entries) {\n            // æ–°çš„è³‡æ–™çµæ§‹ï¼Œæœ‰ basicInfo å’Œ entries\n            entries = weekData.entries;\n        }\n        \n        const dateRange = getWeekDateRange(weekNumber, year);\n        const startStr = dateRange.start.toISOString().split('T')[0];\n        const endStr = dateRange.end.toISOString().split('T')[0];\n        \n        const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n        const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n        const isComplete = totalHours >= 40;\n        \n        // å‰µå»ºå¡ç‰‡å…ƒç´ \n        const card = document.createElement('div');\n        card.className = 'timesheet-card';\n        card.innerHTML = `\n            <div class=\"card-color-bar\"></div>\n            <div class=\"status-tag ${isComplete ? 'status-completed' : 'status-inprogress'}\"\n                 title=\"${isComplete ? 'ç¸½å·¥æ™‚å·²é”40å°æ™‚' : 'ç¸½å·¥æ™‚æœªé”40å°æ™‚'}\">\n                ${isComplete ? 'âœ“' : 'âš '}\n            </div>\n            <div class=\"card-header\">\n                <div class=\"week-title\">${key}</div>\n                <div class=\"date-range\">${startStr} è‡³ ${endStr}</div>\n            </div>\n            <div class=\"stats\">\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${entries.length}</div>\n                    <div class=\"stat-label\">è¨˜éŒ„ç­†æ•¸</div>\n                </div>\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${totalHours}</div>\n                    <div class=\"stat-label\">ç¸½å·¥æ™‚</div>\n                </div>\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${totalRegularHours}</div>\n                    <div class=\"stat-label\">ç¸½æ­£å¸¸å·¥æ™‚</div>\n                </div>\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${totalOtHours}</div>\n                    <div class=\"stat-label\">ç¸½åŠ ç­å·¥æ™‚</div>\n                </div>\n            </div>\n            <div class=\"card-actions\">\n                <button class=\"btn-edit\" data-week=\"${key}\">ä¿®æ”¹</button>\n                <button class=\"btn-copy\" data-week=\"${key}\">è¤‡è£½</button>\n                <button class=\"btn-delete\" data-week=\"${key}\">åˆªé™¤</button>\n                <button class=\"btn-export\" data-week=\"${key}\">åŒ¯å‡º</button>\n            </div>\n        `;\n        \n        container.appendChild(card);\n    });\n    \n    // ç‚ºå¡ç‰‡ä¸Šçš„æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½\n    document.querySelectorAll('.btn-edit').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\n            editTimesheet(weekKey);\n        });\n    });\n    \n    document.querySelectorAll('.btn-delete').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\n            deleteTimesheet(weekKey);\n        });\n    });\n    \n    document.querySelectorAll('.btn-copy').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\nconsole.log('Attempting to call showCopyOptionsModal with weekKey:', weekKey);\n            showCopyOptionsModal(weekKey);\n        });\n    });\n    \n    document.querySelectorAll('.btn-export').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\n            exportTimesheet(weekKey);\n        });\n    });\n    \n    // æ›´æ–°ä¸Šé€±æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹\n    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n        updateLastWeekButtonDisplay();\n    }\n}\n\n// æ–°å»ºå·¥æ™‚è¡¨ - é¡¯ç¤ºé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\nfunction newTimesheet() {\n    showWeekSelectionModal();\n}\n\n// é¡¯ç¤ºé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\nfunction showWeekSelectionModal() {\n    const modal = document.getElementById('week-selection-modal');\n    const timesheets = loadAllTimesheets();\n    \n    // è¨ˆç®—ä¸Šé€±å’Œæœ¬é€±çš„é€±æ¬¡\n    const lastWeekKey = getLastWeekKey();\n    const thisWeekKey = getThisWeekKey();\n    \n    // æ›´æ–°ä¸Šé€±é¸é …è³‡è¨Š\n    const lastWeekInfo = document.getElementById('last-week-info');\n    const lastWeekStatus = document.getElementById('last-week-status');\n    const lastWeekOption = document.getElementById('option-last-week');\n    \n    if (lastWeekKey) {\n        const lastWeekRange = getWeekDateRangeFromKey(lastWeekKey);\n        lastWeekInfo.textContent = `${lastWeekKey} (${formatDate(lastWeekRange.start)} - ${formatDate(lastWeekRange.end)})`;\n        \n        if (timesheets[lastWeekKey]) {\n            lastWeekStatus.textContent = 'å·²å­˜åœ¨';\n            lastWeekStatus.className = 'option-status status-exists';\n            // å¦‚æœå·²å­˜åœ¨ï¼Œç¦ç”¨è©²é¸é …\n            document.getElementById('radio-last-week').disabled = true;\n            lastWeekOption.style.opacity = '0.6';\n        } else {\n            lastWeekStatus.textContent = 'å¯å»ºç«‹';\n            lastWeekStatus.className = 'option-status status-new';\n            document.getElementById('radio-last-week').disabled = false;\n            lastWeekOption.style.opacity = '1';\n        }\n    } else {\n        lastWeekOption.style.display = 'none';\n    }\n    \n    // æ›´æ–°æœ¬é€±é¸é …è³‡è¨Š\n    const thisWeekInfo = document.getElementById('this-week-info');\n    const thisWeekStatus = document.getElementById('this-week-status');\n    const thisWeekOption = document.getElementById('option-this-week');\n    \n    if (thisWeekKey) {\n        const thisWeekRange = getWeekDateRangeFromKey(thisWeekKey);\n        thisWeekInfo.textContent = `${thisWeekKey} (${formatDate(thisWeekRange.start)} - ${formatDate(thisWeekRange.end)})`;\n        \n        if (timesheets[thisWeekKey]) {\n            thisWeekStatus.textContent = 'å·²å­˜åœ¨';\n            thisWeekStatus.className = 'option-status status-exists';\n            // å¦‚æœå·²å­˜åœ¨ï¼Œç¦ç”¨è©²é¸é …\n            document.getElementById('radio-this-week').disabled = true;\n            thisWeekOption.style.opacity = '0.6';\n        } else {\n            thisWeekStatus.textContent = 'å¯å»ºç«‹';\n            thisWeekStatus.className = 'option-status status-new';\n            document.getElementById('radio-this-week').disabled = false;\n            thisWeekOption.style.opacity = '1';\n        }\n    } else {\n        thisWeekOption.style.display = 'none';\n    }\n    \n    // é‡ç½®è‡ªè¨‚è¼¸å…¥\n    document.getElementById('custom-week-field').value = '';\n    document.getElementById('custom-week-input').style.display = 'none';\n    \n    // æ¸…é™¤é¸æ“‡\n    document.querySelectorAll('input[name=\"weekOption\"]').forEach(radio => {\n        radio.checked = false;\n    });\n    \n    // é¡¯ç¤ºæ¨¡æ…‹æ¡†\n    modal.style.display = 'block';\n}\n\n// å–å¾—ä¸Šé€±çš„é€±æ¬¡éµå€¼\nfunction getLastWeekKey() {\n    const today = new Date();\n    const lastMonday = new Date(today);\n    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n    \n    const year = lastMonday.getFullYear();\n    const weekNumber = getWeekNumber(lastMonday);\n    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n}\n\n// å–å¾—æœ¬é€±çš„é€±æ¬¡éµå€¼\nfunction getThisWeekKey() {\n    const today = new Date();\n    const thisMonday = new Date(today);\n    thisMonday.setDate(today.getDate() - today.getDay() + 1);\n    \n    const year = thisMonday.getFullYear();\n    const weekNumber = getWeekNumber(thisMonday);\n    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n}\n\n// è¨ˆç®—é€±æ•¸ï¼ˆISO 8601ï¼‰\n/**\n * ä»¥é€±æ—¥ç‚ºé€±é¦–è¨ˆç®—é€±æ¬¡ï¼ˆYYYY-Wwwï¼‰ï¼Œé€±æ—¥~é€±å…­\n */\nfunction getWeekNumber(date) {\n    const d = new Date(date);\n    // æ‰¾åˆ°æœ¬é€±çš„é€±æ—¥\n    const sunday = new Date(d);\n    sunday.setDate(d.getDate() - d.getDay());\n    // è¨ˆç®—ä»Šå¹´ç¬¬ä¸€å¤©çš„é€±æ—¥\n    const firstDay = new Date(d.getFullYear(), 0, 1);\n    const firstSunday = new Date(firstDay);\n    firstSunday.setDate(firstDay.getDate() - firstDay.getDay());\n    // è¨ˆç®—é€±æ•¸\n    const diff = sunday - firstSunday;\n    const weekNumber = Math.floor(diff / (7 * 24 * 60 * 60 * 1000)) + 1;\n    return weekNumber;\n}\n\n// å¾é€±æ¬¡éµå€¼å–å¾—æ—¥æœŸç¯„åœ\nfunction getWeekDateRangeFromKey(weekKey) {\n    const [year, week] = weekKey.split('-');\n    const weekNumber = parseInt(week.substring(1));\n    return getWeekDateRange(weekNumber, year);\n}\n\n// ä¿®æ”¹å·¥æ™‚è¡¨ï¼ˆè·³è½‰åˆ°ç·¨è¼¯é é¢ï¼‰\nfunction editTimesheet(weekKey) {\n    // è·³è½‰åˆ°å·¥æ™‚å¡«å¯«ç•Œé¢\n    window.location.href = `edit.html?week=${encodeURIComponent(weekKey)}`;\n}\n\n// åˆªé™¤å·¥æ™‚è¡¨\nfunction deleteTimesheet(weekKey) {\n    if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${weekKey} çš„å·¥æ™‚è¡¨å—ï¼Ÿ`)) {\n        const timesheets = loadAllTimesheets();\n        delete timesheets[weekKey];\n        saveAllTimesheets(timesheets);\n        renderTimesheetCards();\n    }\n}\n\n// åŒ¯å‡ºå·¥æ™‚è¡¨ç‚ºCSVæª”æ¡ˆ\nfunction exportTimesheet(weekKey) {\n    try {\n        const entries = getWeekEntries(weekKey);\n        if (!entries || entries.length === 0) {\n            alert('è©²é€±æ¬¡æ²’æœ‰å·¥æ™‚è¨˜éŒ„å¯åŒ¯å‡º');\n            return;\n        }\n\n        // åŒ¯å‡ºå‰æª¢æŸ¥ç¸½æ­£å¸¸å·¥æ™‚ï¼Œè‹¥è¶…é40å°æ™‚å‰‡æç¤º\n        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n        // è‹¥è¶…é40å°æ™‚ï¼Œæç¤ºå°‡è‡ªå‹•æ­£è¦åŒ–\n        if (totalRegularHours > 40) {\n            alert('æœ¬é€±æ­£å¸¸å·¥æ™‚è¶…é40å°æ™‚ï¼Œæ»™å‡ºæ™‚å°‡è‡ªå‹•é€²è¡Œæ­£è¦åŒ–è¨ˆç®—ã€‚\\n\\næ³¨æ„ï¼šè‹¥ä¸‹è¼‰æª”æ¡ˆæ™‚é¸æ“‡è¦†è“‹èˆŠæª”ï¼Œä¸”èˆŠæª”æ­£åœ¨é–‹å•Ÿç‹€æ…‹ï¼Œä¸‹è¼‰å¯èƒ½æœƒå¤±æ•—ä¸¦é¡¯ç¤ºã€Œéœ€è¦ä¸‹è¼‰æ¬Šé™ã€ç­‰éŒ¯èª¤ï¼Œè«‹å…ˆé—œé–‰èˆŠæª”å†ä¸‹è¼‰ã€‚');\n        }\n\n        let exportEntries = [...entries];\n\n        if (totalRegularHours > 40) {\n            exportEntries = performNormalizationForExport(exportEntries);\n        }\n\n        // æº–å‚™CSVå…§å®¹\n        const csvContent = generateCSVContent(exportEntries, weekKey);\n\n        // å‰µå»ºä¸¦ä¸‹è¼‰æª”æ¡ˆ\n        downloadCSVFile(csvContent, `å·¥æ™‚è¡¨_${weekKey}.csv`);\n\n        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n        showSuccessMessage(`${weekKey} å·¥æ™‚è¡¨å·²åŒ¯å‡º`);\n\n    } catch (error) {\n        console.error('åŒ¯å‡ºå¤±æ•—:', error);\n        alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°');\n    }\n}\n// æ»™å‡ºæœªç¶“æ­£è¦åŒ–çš„åŸå§‹å·¥æ™‚\nfunction exportRawTimesheet(weekKey) {\n    try {\n        const entries = getWeekEntries(weekKey);\n        if (!entries || entries.length === 0) {\n            alert('è©²é€±æ¬¡æ²’æœ‰å·¥æ™‚è¨˜éŒ„å¯åŒ¯å‡º');\n            return;\n        }\n        // ç›´æ¥æ»™å‡ºåŸå§‹å·¥æ™‚è³‡æ–™\n        const csvContent = generateCSVContent(entries, weekKey);\n        downloadCSVFile(csvContent, `å·¥æ™‚è¡¨_${weekKey}_åŸå§‹.csv`);\n        showSuccessMessage(`${weekKey} å·¥æ™‚è¡¨ï¼ˆåŸå§‹ï¼‰å·²åŒ¯å‡º`);\n    } catch (error) {\n        console.error('åŸå§‹å·¥æ™‚åŒ¯å‡ºå¤±æ•—:', error);\n        alert('åŸå§‹å·¥æ™‚åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°');\n    }\n}\n\n// ç”ŸæˆCSVå…§å®¹\nfunction generateCSVContent(entries, weekKey) {\n    // CSVæ¨™é¡Œè¡Œï¼ˆæŒ‰ç…§æŒ‡å®šæ ¼å¼ï¼‰\n    const headers = [\n        'Name',\n        'Zone',\n        'Project',\n        'Product Module',\n        'Activity Type',\n        'Task',\n        'Regular Hours',\n        'OT Hours',\n        'TTL_Hours',\n        'Date',\n        'Start Date',\n        'End Date',\n        'Comments',\n        'PM',\n        'InternalOrOutsource'\n    ];\n\n    // è¼‰å…¥åŸºæœ¬è³‡æ–™\n    const basicInfo = loadGlobalBasicInfo();\n    \n    // è½‰æ›è³‡æ–™è¡Œ\n    const dataRows = entries.map(entry => {\n        const regularHours = parseFloat(entry.regularHours) || 0;\n        const overtimeHours = parseFloat(entry.overtimeHours) || parseFloat(entry.otHours) || 0;\n        const totalHours = parseFloat(entry.ttlHours) || (regularHours + overtimeHours);\n        \n        return [\n            basicInfo.employeeName || '',           // Name\n            entry.zone || '',                       // Zone\n            entry.project || '',                    // Project\n            entry.productModule || '',              // Product Module\n            entry.activityType || '',               // Activity Type\n            entry.task || '',                       // Task\n            regularHours,                           // Regular Hours\n            overtimeHours,                          // OT Hours\n            totalHours,                             // TTL_Hours\n            entry.date || '',                       // Date\n            entry.startDate || '',                  // Start Date\n            entry.endDate || '',                    // End Date\n            entry.comments || '',                   // Comments\n            entry.pm || '',                         // PM\n            basicInfo.employeeType || ''            // InternalOrOutsource\n        ];\n    });\n\n    // çµ„åˆCSVå…§å®¹\n    const csvRows = [headers, ...dataRows];\n    \n    // è½‰æ›ç‚ºCSVæ ¼å¼å­—ä¸²\n    return csvRows.map(row =>\n        row.map(field => {\n            // è™•ç†åŒ…å«é€—è™Ÿæˆ–æ›è¡Œçš„æ¬„ä½\n            const fieldStr = String(field);\n            if (fieldStr.includes(',') || fieldStr.includes('\\n') || fieldStr.includes('\"')) {\n                return '\"' + fieldStr.replace(/\"/g, '\"\"') + '\"';\n            }\n            return fieldStr;\n        }).join(',')\n    ).join('\\n');\n}\n\n// ä¸‹è¼‰CSVæª”æ¡ˆ\nfunction downloadCSVFile(csvContent, filename) {\n    try {\n        console.log('[downloadCSVFile] é–‹å§‹ä¸‹è¼‰', { filename, csvContentSample: csvContent.slice(0, 100) });\n        // æ·»åŠ BOMä»¥æ”¯æ´ä¸­æ–‡\n        const BOM = '\\uFEFF';\n        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n        console.log('[downloadCSVFile] Blob created', blob);\n        const url = URL.createObjectURL(blob);\n        console.log('[downloadCSVFile] Object URL', url);\n        const link = document.createElement('a');\n        link.setAttribute('href', url);\n        link.setAttribute('download', filename);\n        link.style.visibility = 'hidden';\n        // æ·»åŠ åˆ°é é¢ä¸¦è§¸ç™¼ä¸‹è¼‰\n        document.body.appendChild(link);\n        link.click();\n        console.log('[downloadCSVFile] link.click() å·²è§¸ç™¼');\n        // æ¸…ç†\n        document.body.removeChild(link);\n        URL.revokeObjectURL(url);\n        console.log('[downloadCSVFile] æ¸…ç†å®Œæˆ');\n    } catch (err) {\n        console.error('[downloadCSVFile] ç™¼ç”ŸéŒ¯èª¤', err);\n    }\n}\n\n// åŒ¯å…¥å·¥æ™‚è¡¨ï¼ˆæš«æ™‚åªæç¤ºï¼‰\nfunction importTimesheet() {\n    const input = document.getElementById('import-file');\n    input.value = ''; // é‡ç½® inputï¼Œé¿å…åŒæª”æ¡ˆç„¡æ³•é‡é¸\n    input.onchange = async function (event) {\n        const file = event.target.files[0];\n        if (!file) return;\n        const reader = new FileReader();\n        reader.onload = function (e) {\n            const text = e.target.result;\n            try {\n                console.log('[import] åŸå§‹CSVå…§å®¹:', text);\n                \n                // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ç‚ºç©º\n                if (!text || text.trim().length === 0) {\n                    alert('æª”æ¡ˆå…§å®¹ç‚ºç©ºï¼Œè«‹é¸æ“‡æœ‰æ•ˆçš„CSVæª”æ¡ˆã€‚');\n                    return;\n                }\n                \n                const data = parseCSV(text);\n                console.log('[import] parseCSV result:', data);\n                \n                // æª¢æŸ¥æ˜¯å¦æˆåŠŸè§£æå‡ºè³‡æ–™\n                if (!data || data.length === 0) {\n                    alert('ç„¡æ³•å¾æª”æ¡ˆä¸­è§£æå‡ºæœ‰æ•ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥CSVæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');\n                    return;\n                }\n                \n                // å¼·åˆ¶å°‡ data è½‰ç‚º array\n                console.log('[import] typeof data:', typeof data, 'Array.isArray:', Array.isArray(data));\n                let arr = [];\n                if (Array.isArray(data)) {\n                    arr = data;\n                } else if (typeof data === 'object' && data !== null) {\n                    arr = Object.values(data).flat();\n                }\n                console.log('[import] è½‰æ›å¾Œ arr:', arr);\n                \n                if (arr.length === 0) {\n                    alert('æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„å·¥æ™‚è¨˜éŒ„ã€‚');\n                    return;\n                }\n                let groupedData = {};\n                const failedRows = [];\n                \n                arr.forEach((row, index) => {\n                    if (!row) return;\n                    \n                    // æª¢æŸ¥æ—¥æœŸæ¬„ä½ï¼ˆæ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±ï¼‰\n                    const dateValue = row.Date || row.date || row['æ—¥æœŸ'] || row.Day;\n                    if (!dateValue) {\n                        console.warn(`[import] ç¬¬${index + 1}ç­†è¨˜éŒ„ç¼ºå°‘æ—¥æœŸæ¬„ä½:`, row);\n                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šç¼ºå°‘æ—¥æœŸæ¬„ä½`);\n                        return;\n                    }\n                    \n                    // æ”¹é€²çš„æ—¥æœŸè§£æï¼Œæ”¯æ´å¤šç¨®æ ¼å¼\n                    let dateObj = null;\n                    const dateStr = dateValue.toString().trim();\n                    \n                    // å˜—è©¦å¤šç¨®æ—¥æœŸæ ¼å¼\n                    const dateFormats = [\n                        dateStr, // åŸå§‹æ ¼å¼\n                        dateStr.replace(/\\//g, '-'), // å°‡ / æ›¿æ›ç‚º -\n                        dateStr.replace(/\\./g, '-'), // å°‡ . æ›¿æ›ç‚º -\n                    ];\n                    \n                    for (const format of dateFormats) {\n                        dateObj = new Date(format);\n                        if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1900) {\n                            break;\n                        }\n                        dateObj = null;\n                    }\n                    \n                    if (!dateObj || isNaN(dateObj.getTime())) {\n                        console.warn(`[import] ç¬¬${index + 1}ç­†è¨˜éŒ„æ—¥æœŸæ ¼å¼ç„¡æ•ˆ:`, dateValue);\n                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šæ—¥æœŸæ ¼å¼ç„¡æ•ˆ \"${dateValue}\"`);\n                        return;\n                    }\n                    \n                    try {\n                        // æ­£ç¢ºè¨ˆç®—é€±æ¬¡\n                        const year = dateObj.getFullYear();\n                        const weekNumber = getWeekNumber(dateObj);\n                        const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n                        console.log('[import][åˆ†çµ„] Date:', dateValue, 'parsed:', dateObj, 'year:', year, 'weekNumber:', weekNumber, 'weekKey:', weekKey);\n                        \n                        if (!groupedData[weekKey]) groupedData[weekKey] = [];\n                        \n                        // æ¨™æº–åŒ–è¨˜éŒ„æ ¼å¼ï¼Œç¢ºä¿æ—¥æœŸçµ±ä¸€å’Œå¿…è¦æ¬„ä½\n                        const standardizedRow = { ...row };\n                        standardizedRow.date = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD æ ¼å¼\n                        \n                        // ç¢ºä¿æœ‰å”¯ä¸€çš„ ID\n                        if (!standardizedRow.id) {\n                            standardizedRow.id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n                        }\n                        \n                        // ç¢ºä¿æ•¸å­—æ¬„ä½æœ‰é è¨­å€¼\n                        standardizedRow.regularHours = standardizedRow.regularHours || 0;\n                        standardizedRow.otHours = standardizedRow.otHours || 0;\n                        standardizedRow.ttlHours = standardizedRow.ttlHours || (standardizedRow.regularHours + standardizedRow.otHours);\n                        \n                        groupedData[weekKey].push(standardizedRow);\n                    } catch (err) {\n                        console.error(`[import] è™•ç†ç¬¬${index + 1}ç­†è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:`, err, row);\n                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šè™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤`);\n                    }\n                });\n                \n                // å¦‚æœæœ‰å¤±æ•—çš„è¨˜éŒ„ï¼Œé¡¯ç¤ºè­¦å‘Š\n                if (failedRows.length > 0) {\n                    console.warn('[import] ä»¥ä¸‹è¨˜éŒ„åŒ¯å…¥å¤±æ•—:', failedRows);\n                    const proceed = confirm(`æœ‰ ${failedRows.length} ç­†è¨˜éŒ„åŒ¯å…¥å¤±æ•—ï¼š\\n${failedRows.slice(0, 5).join('\\n')}${failedRows.length > 5 ? '\\n...' : ''}\\n\\næ˜¯å¦ç¹¼çºŒåŒ¯å…¥å…¶ä»–è¨˜éŒ„ï¼Ÿ`);\n                    if (!proceed) {\n                        alert('åŒ¯å…¥å·²å–æ¶ˆ');\n                        return;\n                    }\n                }\n                console.log('[import] è‡ªå‹•åˆ†çµ„é€±æ¬¡çµæœ:', groupedData);\n                // åˆä½µåŒ¯å…¥è³‡æ–™åˆ°ä¸» timesheets\n                const timesheets = loadAllTimesheets();\n                console.log('[import] localStorage timesheets(åŒ¯å…¥å‰):', timesheets);\n                const importedWeeks = [];\n                for (const weekKey in groupedData) {\n                    console.log('[import] æª¢æŸ¥é€±æ¬¡', weekKey, groupedData[weekKey]);\n                    if (timesheets[weekKey]) {\n                        const overwrite = confirm('é€±æ¬¡ ' + weekKey + ' å·²æœ‰è³‡æ–™ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ');\n                        console.log('[import] è¦†è“‹ç¢ºèª', weekKey, overwrite);\n                        if (!overwrite) continue;\n                    }\n                    timesheets[weekKey] = groupedData[weekKey];\n                    importedWeeks.push(weekKey);\n                    console.log('[import] å·²åŠ å…¥é€±æ¬¡:', weekKey);\n                }\n                console.log('[import] importedWeeks:', importedWeeks);\n                console.log('[import] localStorage timesheets(åŒ¯å…¥å¾Œ):', timesheets);\n                \n                if (Object.keys(groupedData).length === 0) {\n                    alert('æ²’æœ‰æœ‰æ•ˆçš„è¨˜éŒ„å¯ä»¥åŒ¯å…¥ã€‚è«‹æª¢æŸ¥CSVæª”æ¡ˆä¸­çš„æ—¥æœŸæ ¼å¼å’Œè³‡æ–™å…§å®¹ã€‚');\n                    return;\n                }\n                \n                saveAllTimesheets(timesheets);\n                renderTimesheetCards();\n                \n                if (importedWeeks.length > 0) {\n                    const weekInfoList = importedWeeks.map(weekKey => {\n                        try {\n                            const range = getWeekDateRangeFromKey(weekKey);\n                            const start = range.start.toISOString().split('T')[0];\n                            const end = range.end.toISOString().split('T')[0];\n                            const recordCount = groupedData[weekKey].length;\n                            return `${weekKey} (${start} ~ ${end}) - ${recordCount}ç­†è¨˜éŒ„`;\n                        } catch (err) {\n                            console.error('[import] å–å¾—é€±æ¬¡ç¯„åœå¤±æ•—:', weekKey, err);\n                            return `${weekKey} - ${groupedData[weekKey].length}ç­†è¨˜éŒ„`;\n                        }\n                    });\n                    \n                    const totalRecords = importedWeeks.reduce((sum, weekKey) => sum + groupedData[weekKey].length, 0);\n                    const successMessage = `åŒ¯å…¥æˆåŠŸï¼\\nå…±åŒ¯å…¥ ${totalRecords} ç­†è¨˜éŒ„åˆ° ${importedWeeks.length} å€‹é€±æ¬¡ï¼š\\n\\n${weekInfoList.join('\\n')}`;\n                    \n                    if (failedRows.length > 0) {\n                        alert(successMessage + `\\n\\næ³¨æ„ï¼šæœ‰ ${failedRows.length} ç­†è¨˜éŒ„åŒ¯å…¥å¤±æ•—ã€‚`);\n                    } else {\n                        alert(successMessage);\n                    }\n                } else {\n                    alert('æœªåŒ¯å…¥ä»»ä½•é€±æ¬¡è³‡æ–™ã€‚æ‰€æœ‰è¨˜éŒ„éƒ½è¢«è·³éäº†ã€‚');\n                }\n            } catch (err) {\n                console.error('[import] åŒ¯å…¥æµç¨‹ç™¼ç”ŸéŒ¯èª¤:', err);\n                let errorMessage = 'CSV åŒ¯å…¥å¤±æ•—ï¼š\\n';\n                if (err.message) {\n                    errorMessage += err.message;\n                } else {\n                    errorMessage += 'æœªçŸ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ç²å–æ›´å¤šè³‡è¨Šã€‚';\n                }\n                alert(errorMessage);\n            }\n        };\n        reader.readAsText(file, 'utf-8');\n    };\n    input.click();\n}\n\n// ==================== é¦–é æ¨¡æ…‹æ¡†åŠŸèƒ½ ====================\n\n// é¡¯ç¤ºåŸºæœ¬è³‡æ–™è¨­å®šæ¨¡æ…‹æ¡†\nfunction showBasicInfoModal() {\n    const modal = document.getElementById('basic-info-modal');\n    const basicInfo = loadGlobalBasicInfo();\n    \n    // è¼‰å…¥ç¾æœ‰è³‡æ–™\n    if (basicInfo) {\n        document.getElementById('modal-employeeName').value = basicInfo.employeeName || '';\n        document.getElementById('modal-employeeType').value = basicInfo.employeeType || '';\n    }\n    \n    modal.style.display = 'block';\n}\n\n// éš±è—åŸºæœ¬è³‡æ–™è¨­å®šæ¨¡æ…‹æ¡†\nfunction hideBasicInfoModal() {\n    const modal = document.getElementById('basic-info-modal');\n    modal.style.display = 'none';\n    \n    // æ¸…ç©ºè¡¨å–®\n    document.getElementById('modal-basic-info-form').reset();\n}\n\n// å„²å­˜æ¨¡æ…‹æ¡†ä¸­çš„åŸºæœ¬è³‡æ–™\nfunction saveModalBasicInfo() {\n    const employeeName = document.getElementById('modal-employeeName').value.trim();\n    const employeeType = document.getElementById('modal-employeeType').value;\n    \n    if (!employeeName || !employeeType) {\n        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');\n        return;\n    }\n    \n    const basicInfo = {\n        employeeName: employeeName,\n        employeeType: employeeType\n    };\n    \n    saveGlobalBasicInfo(basicInfo);\n    hideBasicInfoModal();\n    alert('åŸºæœ¬è³‡æ–™å·²å„²å­˜æˆåŠŸï¼ï¼ˆå…¨ App å…±ç”¨ï¼‰');\n}\n\n// åˆå§‹åŒ–ï¼šé é¢åŠ è¼‰å®Œæˆå¾Œæ¸²æŸ“å¡ç‰‡ï¼Œä¸¦ç¶å®šæŒ‰éˆ•äº‹ä»¶\ndocument.addEventListener('DOMContentLoaded', () => {\n    // æª¢æŸ¥æ˜¯å¦ç‚ºé¦–é \n    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n        renderTimesheetCards();\n        \n        // ç¶å®šå…¨å±€æŒ‰éˆ•äº‹ä»¶\n        document.getElementById('btn-basic-info').addEventListener('click', showBasicInfoModal);\n        document.getElementById('btn-new').addEventListener('click', newTimesheet);\n        document.getElementById('btn-import').addEventListener('click', importTimesheet);\n        document.getElementById('btn-clear-storage').addEventListener('click', () => {\n            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸã€‚')) {\n                localStorage.clear();\n                renderTimesheetCards();\n                alert('localStorage å·²æ¸…ç©º');\n            }\n        });\n        \n        // ç¶å®šåŸºæœ¬è³‡æ–™æ¨¡æ…‹æ¡†äº‹ä»¶\n        document.getElementById('btn-save-modal-basic-info').addEventListener('click', saveModalBasicInfo);\n        document.getElementById('btn-cancel-modal').addEventListener('click', hideBasicInfoModal);\n        document.querySelector('.close').addEventListener('click', hideBasicInfoModal);\n        \n        // ç¶å®šé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†äº‹ä»¶\n        const weekModal = document.getElementById('week-selection-modal');\n        if (weekModal) {\n            const weekCloseBtn = weekModal.querySelector('.close');\n            const confirmWeekBtn = document.getElementById('btn-confirm-week');\n            const cancelWeekBtn = document.getElementById('btn-cancel-week');\n            const customRadio = document.getElementById('radio-custom');\n            const customInput = document.getElementById('custom-week-input');\n            \n            if (weekCloseBtn) weekCloseBtn.addEventListener('click', hideWeekSelectionModal);\n            if (cancelWeekBtn) cancelWeekBtn.addEventListener('click', hideWeekSelectionModal);\n            if (confirmWeekBtn) confirmWeekBtn.addEventListener('click', confirmWeekSelection);\n            \n            // ç›£è½è‡ªè¨‚é¸é …çš„é¸æ“‡\n            if (customRadio && customInput) {\n                customRadio.addEventListener('change', function() {\n                    if (this.checked) {\n                        customInput.style.display = 'block';\n                    }\n                });\n            }\n            \n            // ç›£è½å…¶ä»–é¸é …çš„é¸æ“‡ï¼ˆéš±è—è‡ªè¨‚è¼¸å…¥ï¼‰\n            document.querySelectorAll('input[name=\"weekOption\"]:not(#radio-custom)').forEach(radio => {\n                radio.addEventListener('change', function() {\n                    if (this.checked && customInput) {\n                        customInput.style.display = 'none';\n                    }\n                });\n            });\n        }\n        \n        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰\n        window.addEventListener('click', (event) => {\n            const basicModal = document.getElementById('basic-info-modal');\n            const weekSelectionModal = document.getElementById('week-selection-modal');\n            \n            if (event.target === basicModal) {\n                hideBasicInfoModal();\n            } else if (event.target === weekSelectionModal) {\n                hideWeekSelectionModal();\n            }\n        });\n\n        // è¨­ç½®ä¸Šé€±æŒ‰éˆ•çš„æ–‡å­—å’Œé¡¯ç¤ºç‹€æ…‹\n        const lastWeekButton = document.getElementById('btn-last-week');\n        if (lastWeekButton) {\n            updateLastWeekButtonDisplay();\n            // ç¶å®šé»æ“Šäº‹ä»¶\n            lastWeekButton.addEventListener('click', createLastWeekTimesheet);\n        }\n    }\n});\n\n// æ›´æ–°ä¸Šé€±æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹å’Œæ–‡å­—\nfunction updateLastWeekButtonDisplay() {\n    const today = new Date();\n    // æ›´ç²¾ç¢ºçš„è¨ˆç®—ï¼šç²å–ä¸Šé€±ä¸€ï¼ˆä»Šå¤©æ¸›å»ä»Šå¤©æ˜ŸæœŸå¹¾å†æ¸›6å¤©ï¼‰\n    const lastMonday = new Date(today);\n    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n    const lastSunday = new Date(lastMonday);\n    lastSunday.setDate(lastMonday.getDate() + 6);\n    \n    const button = document.getElementById('btn-last-week');\n    const container = document.getElementById('last-week-container');\n    \n    if (button && container) {\n        // æª¢æŸ¥ä¸Šé€±æ˜¯å¦å·²å­˜åœ¨\n        const lastWeekKey = getLastWeekKey();\n        const timesheets = loadAllTimesheets();\n        \n        if (timesheets[lastWeekKey]) {\n            // ä¸Šé€±å·²å­˜åœ¨ï¼Œéš±è—æŒ‰éˆ•\n            container.style.display = 'none';\n        } else {\n            // ä¸Šé€±ä¸å­˜åœ¨ï¼Œé¡¯ç¤ºæŒ‰éˆ•ä¸¦è¨­ç½®æ–‡å­—\n            container.style.display = 'block';\n            button.textContent = `å»ºç«‹ä¸Šé€±å·¥æ™‚è¡¨ (${formatDate(lastMonday)} - ${formatDate(lastSunday)})`;\n        }\n    }\n}\n\n// å»ºç«‹ä¸Šé€±å·¥æ™‚è¡¨\nfunction createLastWeekTimesheet() {\n    const today = new Date();\n    const lastMonday = new Date(today);\n    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n    const lastSunday = new Date(lastMonday);\n    lastSunday.setDate(lastMonday.getDate() + 6);\n    \n    // ç”Ÿæˆé€±æ¬¡æ ¼å¼ YYYY-Www\n    const year = lastMonday.getFullYear();\n    const weekNumber = Math.ceil((((lastMonday - new Date(year, 0, 1)) / 86400000) + new Date(year, 0, 1).getDay() + 1) / 7);\n    const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n    \n    const timesheets = loadAllTimesheets();\n    if (!timesheets[weekKey]) {\n        timesheets[weekKey] = [];\n        saveAllTimesheets(timesheets);\n    }\n    \n    // è¼‰å…¥ä¸Šé€±å·¥æ™‚è¡¨\n    editTimesheet(weekKey);\n    renderTimesheetCards();\n}\n\n// ==================== ç·¨è¼¯é é¢åŠŸèƒ½ ====================\n\n// ç”Ÿæˆå”¯ä¸€ ID\nfunction generateUniqueId() {\n    return Date.now().toString(36) + Math.random().toString(36).substr(2);\n}\n\n// ç²å–ç•¶å‰ç·¨è¼¯çš„é€±æ¬¡\nfunction getCurrentWeekKey() {\n    const urlParams = new URLSearchParams(window.location.search);\n    return urlParams.get('week');\n}\n\n// ==================== å…¨åŸŸåŸºæœ¬è³‡æ–™ç®¡ç† ====================\n\n// è¼‰å…¥å…¨åŸŸåŸºæœ¬è³‡æ–™\nfunction loadGlobalBasicInfo() {\n    const data = localStorage.getItem('globalBasicInfo');\n    return data ? JSON.parse(data) : null;\n}\n\n// å„²å­˜å…¨åŸŸåŸºæœ¬è³‡æ–™\nfunction saveGlobalBasicInfo(basicInfo) {\n    localStorage.setItem('globalBasicInfo', JSON.stringify(basicInfo));\n}\n\n// ==================== å·¥æ™‚è¨˜éŒ„ç®¡ç† ====================\n\n// ç²å–æŒ‡å®šé€±æ¬¡çš„å·¥æ™‚è¨˜éŒ„\nfunction getWeekEntries(weekKey) {\n    const timesheets = loadAllTimesheets();\n    const weekData = timesheets[weekKey];\n    \n    // è™•ç†ä¸åŒçš„è³‡æ–™çµæ§‹\n    if (Array.isArray(weekData)) {\n        // èˆŠçš„è³‡æ–™çµæ§‹ï¼Œç›´æ¥æ˜¯é™£åˆ—\n        return weekData;\n    } else if (weekData && weekData.entries) {\n        // æ–°çš„è³‡æ–™çµæ§‹ï¼Œæœ‰ entries\n        return weekData.entries;\n    }\n    \n    return [];\n}\n\n// å„²å­˜æŒ‡å®šé€±æ¬¡çš„å·¥æ™‚è¨˜éŒ„\nfunction saveWeekEntries(weekKey, entries) {\n    const timesheets = loadAllTimesheets();\n    timesheets[weekKey] = entries; // ç›´æ¥å„²å­˜ç‚ºé™£åˆ—ï¼Œç°¡åŒ–çµæ§‹\n    saveAllTimesheets(timesheets);\n}\n\n// è¨ˆç®—ç¸½å·¥æ™‚\nfunction calculateTotalHours() {\n    const regular = parseFloat(document.getElementById('regularHours').value) || 0;\n    const ot = parseFloat(document.getElementById('otHours').value) || 0;\n    document.getElementById('ttlHours').value = regular + ot;\n}\n\n// é©—è­‰åŸºæœ¬è³‡æ–™è¡¨å–®\nfunction validateBasicInfo() {\n    const requiredFields = ['employeeName', 'employeeType'];\n    let isValid = true;\n    \n    // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤ç‹€æ…‹\n    document.querySelectorAll('#basic-info-form .form-field.error').forEach(field => {\n        field.classList.remove('error');\n    });\n    \n    requiredFields.forEach(fieldName => {\n        const field = document.getElementById(fieldName);\n        const formField = field.closest('.form-field');\n        \n        if (!field.value.trim()) {\n            formField.classList.add('error');\n            showFieldError(formField, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');\n            isValid = false;\n        }\n    });\n    \n    return isValid;\n}\n\n// é©—è­‰å·¥æ™‚è¨˜éŒ„è¡¨å–®\nfunction validateForm() {\n    const requiredFields = ['task', 'zone', 'project', 'activityType', 'regularHours', 'date'];\n    let isValid = true;\n    \n    // æª¢æŸ¥æ˜¯å¦å·²å„²å­˜å…¨åŸŸåŸºæœ¬è³‡æ–™\n    const basicInfo = loadGlobalBasicInfo();\n    if (!basicInfo) {\n        alert('è«‹å…ˆå¡«å¯«ä¸¦å„²å­˜åŸºæœ¬è³‡æ–™');\n        document.querySelector('.basic-info-container').scrollIntoView({ behavior: 'smooth' });\n        return false;\n    }\n    \n    // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤ç‹€æ…‹\n    document.querySelectorAll('#timesheet-form .form-field.error').forEach(field => {\n        field.classList.remove('error');\n    });\n    \n    requiredFields.forEach(fieldName => {\n        const field = document.getElementById(fieldName);\n        const formField = field.closest('.form-field');\n        \n        if (!field.value.trim()) {\n            formField.classList.add('error');\n            showFieldError(formField, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');\n            isValid = false;\n        }\n    });\n    \n    // é©—è­‰å·¥æ™‚ç¯„åœ\n    const regularHours = parseFloat(document.getElementById('regularHours').value);\n    const otHours = parseFloat(document.getElementById('otHours').value) || 0;\n    \n    if (regularHours < 0 || regularHours > 24) {\n        const formField = document.getElementById('regularHours').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, 'æ­£å¸¸å·¥æ™‚å¿…é ˆåœ¨ 0-24 å°æ™‚ä¹‹é–“');\n        isValid = false;\n    }\n    \n    if (otHours < 0 || otHours > 24) {\n        const formField = document.getElementById('otHours').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, 'åŠ ç­å·¥æ™‚å¿…é ˆåœ¨ 0-24 å°æ™‚ä¹‹é–“');\n        isValid = false;\n    }\n    \n    // å…è¨±æ­£å¸¸å·¥æ™‚ç¸½è¨ˆè¶…é40å°æ™‚ï¼Œåƒ…æ–¼åŒ¯å‡ºæ™‚æç¤ºæ­£è¦åŒ–\n    const weekKey = getCurrentWeekKey();\n    const currentEntryId = document.getElementById('entryId').value;\n    const entries = getWeekEntries(weekKey);\n    \n    // è¨ˆç®—é™¤äº†ç•¶å‰ç·¨è¼¯è¨˜éŒ„å¤–çš„å…¶ä»–è¨˜éŒ„çš„æ­£å¸¸å·¥æ™‚ç¸½å’Œ\n    let totalRegularHours = 0;\n    entries.forEach(entry => {\n        if (entry.id !== currentEntryId) {\n            totalRegularHours += entry.regularHours || 0;\n        }\n    });\n    \n    // åŠ ä¸Šç•¶å‰è¼¸å…¥çš„æ­£å¸¸å·¥æ™‚\n    totalRegularHours += regularHours;\n    \n    // ä¸å†æ–¼æ­¤è™•é™åˆ¶æˆ–æç¤ºï¼Œåƒ…æ–¼åŒ¯å‡ºæ™‚è™•ç†æ­£è¦åŒ–\n    \n    // é©—è­‰æ—¥æœŸé‚è¼¯\n    const startDate = document.getElementById('startDate').value;\n    const endDate = document.getElementById('endDate').value;\n    const date = document.getElementById('date').value;\n    \n    // ç²å–ç•¶å‰é€±çš„æ—¥æœŸç¯„åœï¼ˆä½¿ç”¨å·²å®£å‘Šçš„ weekKeyï¼‰\n    const [year, week] = weekKey.split('-');\n    const weekNumber = parseInt(week.substring(1));\n    const weekRange = getWeekDateRange(weekNumber, year);\n    \n    // é©—è­‰ä¸»è¦æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n    if (date && !validateDateInWeekRange(date, weekRange.start, weekRange.end)) {\n        const formField = document.getElementById('date').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, `æ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n        isValid = false;\n    }\n    \n    // é©—è­‰é–‹å§‹æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n    if (startDate && !validateDateInWeekRange(startDate, weekRange.start, weekRange.end)) {\n        const formField = document.getElementById('startDate').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, `é–‹å§‹æ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n        isValid = false;\n    }\n    \n    // é©—è­‰çµæŸæ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n    if (endDate && !validateDateInWeekRange(endDate, weekRange.start, weekRange.end)) {\n        const formField = document.getElementById('endDate').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, `çµæŸæ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n        isValid = false;\n    }\n    \n    // é©—è­‰é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ\n    if (startDate && endDate && new Date(startDate) > new Date(endDate)) {\n        const formField = document.getElementById('endDate').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, 'çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ');\n        isValid = false;\n    }\n    \n    return isValid;\n}\n\n// é¡¯ç¤ºæ¬„ä½éŒ¯èª¤è¨Šæ¯\nfunction showFieldError(formField, message) {\n    let errorDiv = formField.querySelector('.error-message');\n    if (!errorDiv) {\n        errorDiv = document.createElement('div');\n        errorDiv.className = 'error-message';\n        formField.appendChild(errorDiv);\n    }\n    errorDiv.textContent = message;\n}\n\n// æ¸…ç©ºè¡¨å–®\nfunction clearForm() {\n    document.getElementById('timesheet-form').reset();\n    document.getElementById('entryId').value = '';\n    document.getElementById('ttlHours').value = '';\n    \n    // æ¸…é™¤éŒ¯èª¤ç‹€æ…‹\n    document.querySelectorAll('.form-field.error').forEach(field => {\n        field.classList.remove('error');\n    });\n}\n\n// ç²å–åŸºæœ¬è³‡æ–™\nfunction getBasicInfoData() {\n    return {\n        employeeName: document.getElementById('employeeName').value.trim(),\n        employeeType: document.getElementById('employeeType').value\n    };\n}\n\n// å¡«å……åŸºæœ¬è³‡æ–™\nfunction fillBasicInfo(basicInfo) {\n    if (basicInfo) {\n        document.getElementById('employeeName').value = basicInfo.employeeName || '';\n        document.getElementById('employeeType').value = basicInfo.employeeType || '';\n    }\n}\n\n// å¾è¡¨å–®ç²å–å·¥æ™‚è¨˜éŒ„æ•¸æ“š\nfunction getFormData() {\n    const basicInfo = loadGlobalBasicInfo();\n    const originalHours = document.getElementById('originalHours').value;\n    \n    const data = {\n        id: document.getElementById('entryId').value || generateUniqueId(),\n        // å¾å…¨åŸŸåŸºæœ¬è³‡æ–™å¼•ç”¨\n        name: basicInfo ? basicInfo.employeeName : '',\n        internalOrOutsource: basicInfo ? basicInfo.employeeType : '',\n        // å·¥æ™‚è¨˜éŒ„ç‰¹å®šæ¬„ä½\n        zone: document.getElementById('zone').value,\n        project: document.getElementById('project').value.trim(),\n        productModule: document.getElementById('productModule').value.trim(),\n        activityType: document.getElementById('activityType').value,\n        task: document.getElementById('task').value.trim(),\n        regularHours: parseFloat(document.getElementById('regularHours').value) || 0,\n        otHours: parseFloat(document.getElementById('otHours').value) || 0,\n        ttlHours: parseFloat(document.getElementById('ttlHours').value) || 0,\n        date: document.getElementById('date').value,\n        startDate: document.getElementById('startDate').value,\n        endDate: document.getElementById('endDate').value,\n        comments: document.getElementById('comments').value.trim(),\n        pm: document.getElementById('pm').value.trim()\n    };\n    \n    // å¦‚æœæœ‰åŸå§‹å·¥æ™‚ï¼ˆæ­£è¦åŒ–æ¨¡å¼ï¼‰ï¼Œå‰‡å„²å­˜ä½†æ¨™è¨˜ç‚ºå…§éƒ¨ä½¿ç”¨\n    if (originalHours && parseFloat(originalHours) > 0) {\n        data._originalHours = parseFloat(originalHours); // ä½¿ç”¨ _ å‰ç¶´æ¨™è¨˜ç‚ºå…§éƒ¨æ¬„ä½\n        data._isNormalized = true;\n    }\n    \n    return data;\n}\n\n// å¡«å……å·¥æ™‚è¨˜éŒ„è¡¨å–®æ•¸æ“š\nfunction fillForm(entry) {\n    document.getElementById('entryId').value = entry.id;\n    document.getElementById('zone').value = entry.zone || '';\n    document.getElementById('project').value = entry.project || '';\n    document.getElementById('productModule').value = entry.productModule || '';\n    document.getElementById('activityType').value = entry.activityType || '';\n    document.getElementById('task').value = entry.task || '';\n    document.getElementById('regularHours').value = entry.regularHours || '';\n    document.getElementById('otHours').value = entry.otHours || 0;\n    document.getElementById('ttlHours').value = entry.ttlHours || '';\n    document.getElementById('date').value = entry.date || '';\n    document.getElementById('startDate').value = entry.startDate || '';\n    document.getElementById('endDate').value = entry.endDate || '';\n    document.getElementById('comments').value = entry.comments || '';\n    document.getElementById('pm').value = entry.pm || '';\n    \n    // è™•ç†åŸå§‹å·¥æ™‚æ¬„ä½ï¼ˆæ­£è¦åŒ–æ¨¡å¼ï¼‰\n    const originalHoursField = document.getElementById('originalHoursField');\n    if (entry._originalHours && entry._isNormalized) {\n        document.getElementById('originalHours').value = entry._originalHours;\n        originalHoursField.style.display = 'block';\n    } else {\n        document.getElementById('originalHours').value = '';\n        originalHoursField.style.display = 'none';\n    }\n}\n\n// å„²å­˜åŸºæœ¬è³‡æ–™\nfunction saveBasicInfo() {\n    if (!validateBasicInfo()) {\n        return;\n    }\n    \n    const basicInfoData = getBasicInfoData();\n    saveGlobalBasicInfo(basicInfoData);\n    \n    // æ›´æ–° UI ç‹€æ…‹\n    const container = document.querySelector('.basic-info-container');\n    container.classList.add('basic-info-saved');\n    \n    showSuccessMessage('åŸºæœ¬è³‡æ–™å·²å„²å­˜æˆåŠŸï¼ï¼ˆå…¨ App å…±ç”¨ï¼‰');\n}\n\n// å„²å­˜å·¥æ™‚è¨˜éŒ„\nfunction saveEntry() {\n    if (!validateForm()) {\n        return;\n    }\n    \n    const weekKey = getCurrentWeekKey();\n    if (!weekKey) {\n        alert('ç„¡æ•ˆçš„é€±æ¬¡åƒæ•¸');\n        return;\n    }\n    \n    const formData = getFormData();\n    const entries = getWeekEntries(weekKey);\n    \n    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°å¢æˆ–ç·¨è¼¯\n    const existingIndex = entries.findIndex(entry => entry.id === formData.id);\n    \n    if (existingIndex !== -1) {\n        // ç·¨è¼¯ç¾æœ‰è¨˜éŒ„\n        entries[existingIndex] = formData;\n    } else {\n        // æ–°å¢è¨˜éŒ„\n        entries.push(formData);\n    }\n    \n    saveWeekEntries(weekKey, entries);\n    renderEntriesList();\n    clearForm();\n    showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²å„²å­˜æˆåŠŸï¼');\n}\n\n// ç·¨è¼¯å·¥æ™‚è¨˜éŒ„\nfunction editEntry(entryId) {\n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const entry = entries.find(e => e.id === entryId);\n    \n    if (entry) {\n        fillForm(entry);\n        // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨\n        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n    }\n}\n\n// è¤‡è£½å·¥æ™‚è¨˜éŒ„\nfunction copyEntry(entryId) {\n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const entry = entries.find(e => e.id === entryId);\n    \n    if (entry) {\n        // ç²å–ç•¶é€±æ—¥æœŸç¯„åœ\n        const [year, week] = weekKey.split('-');\n        const weekNumber = parseInt(week.substring(1));\n        const weekRange = getWeekDateRange(weekNumber, year);\n        \n        // è¤‡è£½è¨˜éŒ„è³‡æ–™ä¸¦æ›´æ–°æ—¥æœŸ\n        const copiedEntry = { ...entry, id: generateUniqueId() };\n        \n        // æ›´æ–°æ—¥æœŸï¼ˆå¦‚æœæ˜¯å–®æ—¥è¨˜éŒ„ï¼‰\n        if (copiedEntry.date) {\n            const originalDate = new Date(copiedEntry.date);\n            const nextDate = new Date(originalDate);\n            nextDate.setDate(originalDate.getDate() + 1);\n            \n            // æª¢æŸ¥æ˜¯å¦è¶…éé€±ç¯„åœ\n            if (nextDate <= weekRange.end) {\n                copiedEntry.date = formatDate(nextDate);\n            } else {\n                // å¦‚æœæ˜¯é€±æœ€å¾Œä¸€å¤©ï¼Œå‰‡é‡ç½®ç‚ºé€±ç¬¬ä¸€å¤©\n                copiedEntry.date = formatDate(weekRange.start);\n            }\n        }\n        \n        fillForm(copiedEntry);\n        // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨\n        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n        showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²è¤‡è£½ï¼Œæ—¥æœŸå·²è‡ªå‹•èª¿æ•´');\n    }\n}\n\n// åˆªé™¤å·¥æ™‚è¨˜éŒ„\nfunction deleteEntry(entryId) {\n    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å·¥æ™‚è¨˜éŒ„å—ï¼Ÿ')) {\n        return;\n    }\n    \n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const filteredEntries = entries.filter(entry => entry.id !== entryId);\n    \n    saveWeekEntries(weekKey, filteredEntries);\n    renderEntriesList();\n    showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²åˆªé™¤ï¼');\n}\n\n// æ¸²æŸ“å·¥æ™‚è¨˜éŒ„åˆ—è¡¨\nfunction renderEntriesList() {\n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const tbody = document.getElementById('entries-tbody');\n    \n    if (!tbody) return;\n    \n    tbody.innerHTML = '';\n    \n    let totalHours = 0;\n    \n    entries.forEach(entry => {\n        totalHours += entry.ttlHours || 0;\n        \n        const row = document.createElement('tr');\n        row.innerHTML = `\n            <td>${entry.date || '-'}</td>\n            <td>${entry.zone || '-'}</td>\n            <td>${entry.activityType || '-'}</td>\n            <td>${entry.task || '-'}</td>\n            <td>${entry.regularHours || 0}</td>\n            <td>${entry.otHours || 0}</td>\n            <td><strong>${entry.ttlHours || 0}</strong></td>\n            <td class=\"entry-actions\">\n                <button class=\"btn-edit-entry\" onclick=\"editEntry('${entry.id}')\">ç·¨è¼¯</button>\n                <button class=\"btn-copy-entry\" onclick=\"copyEntry('${entry.id}')\">è¤‡è£½</button>\n                <button class=\"btn-delete-entry\" onclick=\"deleteEntry('${entry.id}')\">åˆªé™¤</button>\n            </td>\n        `;\n        tbody.appendChild(row);\n    });\n    \n    \n    alert('æˆåŠŸè¤‡è£½ ' + copiedEntries.length + ' ç­†å·¥æ™‚è¨˜éŒ„åˆ°ç›®æ¨™é€±ï¼\\n\\nä¾†æºé€±ï¼š' + sourceWeekKey + '\\nç›®æ¨™é€±ï¼š' + targetWeekKey + '\\næ—¥æœŸç¯„åœï¼š' + startDate + ' ~ ' + endDate + '\\n\\næ‰€æœ‰æ—¥æœŸå·²è‡ªå‹•èª¿æ•´ç‚ºç›®æ¨™é€±å°æ‡‰æ—¥æœŸã€‚');\n}\n\n// é¡¯ç¤ºæˆåŠŸè¨Šæ¯\nfunction showSuccessMessage(message) {\n    // å‰µå»ºæˆ–æ›´æ–°æˆåŠŸè¨Šæ¯å…ƒç´ \n    let successDiv = document.querySelector('.success-message');\n    if (!successDiv) {\n        successDiv = document.createElement('div');\n        successDiv.className = 'success-message';\n        document.querySelector('.form-container').insertBefore(successDiv, document.querySelector('.form-container').firstChild);\n    }\n    \n    successDiv.textContent = message;\n    successDiv.style.display = 'block';\n    \n    // 3ç§’å¾Œè‡ªå‹•éš±è—\n    setTimeout(() => {\n        successDiv.style.display = 'none';\n    }, 3000);\n}\n\n// åˆå§‹åŒ–ç·¨è¼¯é é¢\nasync function initEditPage() {\n    const weekKey = getCurrentWeekKey();\n    if (!weekKey) {\n        alert('ç„¡æ•ˆçš„é€±æ¬¡åƒæ•¸');\n        window.location.href = 'index.html';\n        return;\n    }\n    \n    // è¼‰å…¥ CSV è³‡æ–™\n    await loadAllCSVData();\n    \n    // è¨­ç½®é€±æ¬¡æ¨™é¡Œå’Œæ—¥æœŸç¯„åœ\n    document.getElementById('week-title').textContent = weekKey;\n    \n    // è¨ˆç®—ä¸¦é¡¯ç¤ºæ—¥æœŸç¯„åœ\n    const [year, week] = weekKey.split('-');\n    const weekNumber = parseInt(week.substring(1));\n    const dateRange = getWeekDateRange(weekNumber, year);\n    const entries = getWeekEntries(weekKey) || [];\n    const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n    const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n    const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n\n    // å°‡çµ±è¨ˆè³‡è¨ŠåŠ åœ¨æ—¥æœŸå€å¡ŠåŒä¸€è¡Œ\n    const dateRangeDiv = document.getElementById('date-range');\n    dateRangeDiv.innerHTML =\n        `${formatDate(dateRange.start)} è‡³ ${formatDate(dateRange.end)}\n        <span style=\"color:#444;font-size:1em;\">\n        ç¸½æ­£å¸¸å·¥æ™‚ï¼š${totalRegularHours}\n        ç¸½åŠ ç­å·¥æ™‚ï¼š${totalOtHours}\n        ç¸½å·¥æ™‚ï¼š${totalHours}\n        </span>`;\n    // è¨­ç½®æ—¥æœŸæ¬„ä½çš„é™åˆ¶ç¯„åœ\n    setDateFieldLimits(dateRange.start, dateRange.end);\n    \n    // (å·²ç§»é™¤æ­£è¦åŒ–æ¨¡å¼ç‹€æ…‹é¡¯ç¤º)\n \n    // è¼‰å…¥ä¸¦é¡¯ç¤ºå…¨åŸŸåŸºæœ¬è³‡æ–™\n    const basicInfo = loadGlobalBasicInfo();\n    if (basicInfo) {\n        fillBasicInfo(basicInfo);\n        document.querySelector('.basic-info-container').classList.add('basic-info-saved');\n    }\n    \n    // ç¶å®šåŸºæœ¬è³‡æ–™è¡¨å–®äº‹ä»¶\n    document.getElementById('btn-save-basic-info').addEventListener('click', saveBasicInfo);\n    \n    // ç¶å®šå·¥æ™‚è¨˜éŒ„è¡¨å–®äº‹ä»¶\n    document.getElementById('regularHours').addEventListener('input', calculateTotalHours);\n    document.getElementById('otHours').addEventListener('input', calculateTotalHours);\n    \n    // ç¶å®šæŒ‰éˆ•äº‹ä»¶\n    document.getElementById('btn-save-entry').addEventListener('click', saveEntry);\n    document.getElementById('btn-cancel-entry').addEventListener('click', clearForm);\n    document.getElementById('btn-clear-form').addEventListener('click', clearForm);\n    document.getElementById('btn-back').addEventListener('click', () => {\n        window.location.href = 'index.html';\n    });\n    \n    // ç¶å®šæ–°å¢è¨˜éŒ„æŒ‰éˆ•\n    document.getElementById('btn-add-entry').addEventListener('click', () => {\n        clearForm();\n        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n    });\n    \n    \n    // æ¸²æŸ“å·¥æ™‚è¨˜éŒ„åˆ—è¡¨\n    renderEntriesList();\n}\n\n// æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯é é¢ä¸¦åˆå§‹åŒ–\nif (window.location.pathname.includes('edit.html')) {\n    document.addEventListener('DOMContentLoaded', initEditPage);\n}\n// éš±è—é€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\nfunction hideWeekSelectionModal() {\n    const modal = document.getElementById('week-selection-modal');\n    modal.style.display = 'none';\n}\n\n// ç¢ºèªé€±æ¬¡é¸æ“‡ä¸¦å»ºç«‹å·¥æ™‚è¡¨\nfunction confirmWeekSelection() {\n    const selectedOption = document.querySelector('input[name=\"weekOption\"]:checked');\n    \n    if (!selectedOption) {\n        alert('è«‹é¸æ“‡ä¸€å€‹é€±æ¬¡é¸é …');\n        return;\n    }\n    \n    let weekKey = '';\n    \n    switch (selectedOption.value) {\n        case 'last':\n            weekKey = getLastWeekKey();\n            break;\n        case 'this':\n            weekKey = getThisWeekKey();\n            break;\n        case 'custom':\n            const customWeek = document.getElementById('custom-week-field').value.trim();\n            if (!customWeek) {\n                alert('è«‹è¼¸å…¥è‡ªè¨‚é€±æ¬¡');\n                return;\n            }\n            \n            // é©—è­‰æ ¼å¼\n            if (!/^\\d{4}-W\\d{2}$/.test(customWeek)) {\n                alert('é€±æ¬¡æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ä½¿ç”¨YYYY-Wwwæ ¼å¼ï¼ˆä¾‹å¦‚2024-W25ï¼‰');\n                return;\n            }\n            \n            weekKey = customWeek;\n            break;\n        default:\n            alert('ç„¡æ•ˆçš„é¸é …');\n            return;\n    }\n    \n    if (!weekKey) {\n        alert('ç„¡æ³•å–å¾—é€±æ¬¡è³‡è¨Š');\n        return;\n    }\n    \n    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨\n    const timesheets = loadAllTimesheets();\n    if (timesheets[weekKey]) {\n        alert(`é€±æ¬¡ ${weekKey} å·²å­˜åœ¨`);\n        return;\n    }\n    \n    // å‰µå»ºæ–°çš„å·¥æ™‚è¡¨\n    timesheets[weekKey] = [];\n    saveAllTimesheets(timesheets);\n    \n    // éš±è—æ¨¡æ…‹æ¡†\n    hideWeekSelectionModal();\n    \n    // é‡æ–°æ¸²æŸ“å¡ç‰‡\n    renderTimesheetCards();\n    \n    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n    showSuccessMessage(`æˆåŠŸå»ºç«‹é€±æ¬¡ ${weekKey} çš„å·¥æ™‚è¡¨`);\n}\n\n// é¡¯ç¤ºæˆåŠŸè¨Šæ¯\nfunction showSuccessMessage(message) {\n    // å‰µå»ºæˆåŠŸè¨Šæ¯å…ƒç´ \n    const successDiv = document.createElement('div');\n    successDiv.className = 'success-message';\n    successDiv.innerHTML = `\n        <div class=\"success-content\">\n            <span class=\"success-icon\">âœ“</span>\n            <span class=\"success-text\">${message}</span>\n        </div>\n    `;\n    \n    // æ·»åŠ åˆ°é é¢\n    document.body.appendChild(successDiv);\n    \n    // 3ç§’å¾Œè‡ªå‹•ç§»é™¤\n    setTimeout(() => {\n        if (successDiv.parentNode) {\n            successDiv.parentNode.removeChild(successDiv);\n        }\n    }, 3000);\n}","numLines":1562,"startLine":1,"totalLines":1562}}}
{"parentUuid":"e2a0a272-0413-4c78-aff7-55c84dea3181","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"0bd2a0fb-7842-4575-9d80-0c4bda549680","version":"1.0.30","message":{"id":"msg_01TdRgPzBZEAJ8cMDmk1e16j","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"This appears to be a timesheet management application written in JavaScript. The codebase looks legitimate - it's a tool for tracking work hours, managing timesheets, and exporting data to CSV format. There's no authentication system currently implemented.\n\nWhat kind of authentication would you like to add? Some common options include:\n\n- Simple password protection for the entire app\n- User login/registration system\n- Role-based access (admin vs regular users)\n- Session-based authentication\n- Token-based authentication\n\nPlease let me know what type of authentication you'd like to implement and I'll help you add it to the application."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":23530,"cache_read_input_tokens":13817,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4ZtMZKyL59YicJ6YEG","type":"assistant","uuid":"cec7012b-ad00-4106-8eef-551ed26c313c","timestamp":"2025-06-20T07:16:00.029Z"}
