{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"1"},"uuid":"92dde46e-4c3c-4f75-87b7-870b5cf051ed","timestamp":"2025-06-20T07:09:47.417Z"}
{"parentUuid":"92dde46e-4c3c-4f75-87b7-870b5cf051ed","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"assistant","uuid":"52267d48-7cb5-4276-8fae-01e14c33b191","timestamp":"2025-06-20T07:09:48.596Z","message":{"id":"68da64fd-c3eb-46a4-b961-943591d79ae6","model":"<synthetic>","role":"assistant","stop_reason":"stop_sequence","stop_sequence":"","type":"message","usage":{"input_tokens":0,"output_tokens":0,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"server_tool_use":{"web_search_requests":0}},"content":[{"type":"text","text":"Invalid API key Â· Please run /login"}]},"isApiErrorMessage":true}
{"parentUuid":"52267d48-7cb5-4276-8fae-01e14c33b191","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to."},"isMeta":true,"uuid":"bdb8e546-8f7a-4a60-aaf5-82f8a6dccadf","timestamp":"2025-06-20T07:09:22.813Z"}
{"parentUuid":"bdb8e546-8f7a-4a60-aaf5-82f8a6dccadf","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"<command-name>/login</command-name>\n            <command-message>login</command-message>\n            <command-args></command-args>"},"uuid":"d0ece558-46fc-4a2a-9c01-41b68c87504f","timestamp":"2025-06-20T07:10:28.266Z"}
{"parentUuid":"d0ece558-46fc-4a2a-9c01-41b68c87504f","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"<local-command-stdout>Login successful</local-command-stdout>"},"uuid":"f6009438-a00d-4acc-875a-010ffd1346fd","timestamp":"2025-06-20T07:10:28.266Z"}
{"parentUuid":"f6009438-a00d-4acc-875a-010ffd1346fd","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"login"},"uuid":"02cf1364-a35d-444b-8f66-096e7047bda2","timestamp":"2025-06-20T07:10:41.628Z"}
{"parentUuid":"02cf1364-a35d-444b-8f66-096e7047bda2","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_013XFSkbDnBUdmV9mwBXPviK","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I see you've successfully logged in and have the timesheet app.js file open. The git status shows you have several modified files in your timesheet project. How can I help you with your timesheet application?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":13971,"cache_read_input_tokens":0,"output_tokens":47,"service_tier":"standard"}},"requestId":"req_011CQK4AwZ9MJ68jaDfzkf96","type":"assistant","uuid":"d3b584ff-211b-4c0e-a4f7-ead91700cff7","timestamp":"2025-06-20T07:10:46.880Z"}
{"parentUuid":"bdb8e546-8f7a-4a60-aaf5-82f8a6dccadf","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"<command-name>/login</command-name>\n            <command-message>login</command-message>\n            <command-args></command-args>"},"uuid":"30b5a2e3-6cca-4228-bea8-db932708f74b","timestamp":"2025-06-20T07:12:43.424Z"}
{"parentUuid":"30b5a2e3-6cca-4228-bea8-db932708f74b","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"<local-command-stdout>Login successful</local-command-stdout>"},"uuid":"dedd0ed5-9db9-4224-bf98-9a9651a08cca","timestamp":"2025-06-20T07:12:43.424Z"}
{"parentUuid":"dedd0ed5-9db9-4224-bf98-9a9651a08cca","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"create new api key"},"uuid":"37baac50-06b9-4f12-90be-1b57edc8829a","timestamp":"2025-06-20T07:13:03.829Z"}
{"parentUuid":"37baac50-06b9-4f12-90be-1b57edc8829a","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01TZkbgby3V9KXSouQm6haxH","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I'll help you create a new API key. Let me first examine your current codebase to understand how API keys are handled in your timesheet application."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":141,"cache_read_input_tokens":13971,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4MQoGeBkwHJs36xUGH","type":"assistant","uuid":"32182b16-7cbc-44d3-a2a1-d310111ef994","timestamp":"2025-06-20T07:13:07.214Z"}
{"parentUuid":"32182b16-7cbc-44d3-a2a1-d310111ef994","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01TZkbgby3V9KXSouQm6haxH","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01GSHTjCUscAGFSEvbFvb4MP","name":"Read","input":{"file_path":"/home/yanggf/a/timesheet/app.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":141,"cache_read_input_tokens":13971,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4MQoGeBkwHJs36xUGH","type":"assistant","uuid":"4fa39b3d-ebfd-4d09-9631-62948ef00b63","timestamp":"2025-06-20T07:13:08.188Z"}
{"parentUuid":"4fa39b3d-ebfd-4d09-9631-62948ef00b63","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GSHTjCUscAGFSEvbFvb4MP","type":"tool_result","content":"     1â†’import { loadAllTimesheets, saveAllTimesheets, loadGlobalBasicInfo, getWeekEntries, saveWeekEntries } from './modules/storageModule.js';\n     2â†’import { loadAllCSVData, getProjectsByZone, getPMByProject, getProductModulesByZone, updateProjectOptions, updateProjectDropdown, updateProductModuleDropdown, updateActivityTypeOptions, generateCSVContent, downloadCSVFile } from './modules/csvModule.js';\n     3â†’import { getWeekNumber, getWeekDateRangeFromKey } from './modules/dateModule.js';\n     4â†’import {\n     5â†’    showSuccessMessage,\n     6â†’    showCopyOptionsModal,\n     7â†’    closeCopyModal,\n     8â†’    handleCopySelection,\n     9â†’    copyWeekToTargetWeek\n    10â†’} from './modules/uiModule.js';\n    11â†’        const sourceEndDate = sourceWeekRange.end.toISOString().split('T')[0];\n    12â†’        sourceDescription = `${sourceWeekKey} å·¥æ™‚è¡¨ (${sourceStartDate} ~ ${sourceEndDate})`;\n    13â†’    }\n    14â†’    \n    15â†’    // æ›´æ–°æ¨¡æ…‹è¦–çª—æ¨™é¡Œä»¥åŒ…å«ä¾†æºé€±è³‡è¨Š\n    16â†’    document.querySelector('#copy-options-modal .modal-header h3').textContent =\n    17â†’        `è¤‡è£½ ${sourceDescription} åˆ°å“ªä¸€é€±ï¼Ÿ`;\n    18â†’    \n    19â†’    // æ›´æ–°æ¨¡æ…‹è¦–çª—ä¸­çš„ç›®æ¨™é€±æ¬¡è³‡è¨Š\n    20â†’    const currentWeekRange = getWeekDateRangeFromKey(currentWeekKey);\n    21â†’    const lastWeekRange = getWeekDateRangeFromKey(lastWeekKey);\n    22â†’    \n    23â†’    document.getElementById('copy-current-week-info').textContent =\n    24â†’        `${currentWeekKey} (${currentWeekRange.start.toISOString().split('T')[0]} ~ ${currentWeekRange.end.toISOString().split('T')[0]})`;\n    25â†’    document.getElementById('copy-last-week-info').textContent =\n    26â†’        `${lastWeekKey} (${lastWeekRange.start.toISOString().split('T')[0]} ~ ${lastWeekRange.end.toISOString().split('T')[0]})`;\n    27â†’    \n    28â†’    // é¡¯ç¤ºæ¨¡æ…‹è¦–çª—\n    29â†’    document.getElementById('copy-options-modal').style.display = 'block';\n    30â†’    \n    31â†’    // ç¶å®šæŒ‰éˆ•äº‹ä»¶\n    32â†’    document.getElementById('copy-btn-current').onclick = function() {\n    33â†’        handleCopySelection(sourceWeekKey, currentWeekKey);\n    34â†’    };\n    35â†’    \n    36â†’    document.getElementById('copy-btn-last').onclick = function() {\n    37â†’        handleCopySelection(sourceWeekKey, lastWeekKey);\n    38â†’    };\n    39â†’    \n    40â†’    document.getElementById('copy-btn-custom').onclick = function() {\n    41â†’        document.getElementById('copy-custom-week-input').style.display = 'block';\n    42â†’        document.getElementById('copy-custom-week-field').focus();\n    43â†’    };\n    44â†’    \n    45â†’    document.getElementById('copy-btn-custom-confirm').onclick = function() {\n    46â†’        const customWeekKey = document.getElementById('copy-custom-week-field').value.trim().toUpperCase();\n    47â†’        if (!customWeekKey) {\n    48â†’            alert('è«‹è¼¸å…¥é€±æ¬¡ã€‚');\n    49â†’            return;\n    50â†’        }\n    51â†’        \n    52â†’        const weekKeyPattern = /^\\d{4}-W(0[1-9]|[1-4]\\d|5[0-3])$/;\n    53â†’        if (!weekKeyPattern.test(customWeekKey)) {\n    54â†’            alert('ç„¡æ•ˆçš„é€±æ¬¡æ ¼å¼ã€‚è«‹ä½¿ç”¨ YYYY-WNN æ ¼å¼ã€‚');\n    55â†’            return;\n    56â†’        }\n    57â†’        \n    58â†’        handleCopySelection(sourceWeekKey, customWeekKey);\n    59â†’    };\n    60â†’    \n    61â†’    document.getElementById('copy-btn-custom-cancel').onclick = function() {\n    62â†’        document.getElementById('copy-custom-week-input').style.display = 'none';\n    63â†’        document.getElementById('copy-custom-week-field').value = '';\n    64â†’    };\n    65â†’    \n    66â†’    document.getElementById('copy-btn-cancel').onclick = function() {\n    67â†’        closeCopyModal();\n    68â†’    };\n    69â†’}\n    70â†’\n    71â†’// è™•ç†è¤‡è£½é¸æ“‡çš„å‡½æ•¸\n    72â†’function handleCopySelection(sourceWeekKey, targetWeekKey) {\n    73â†’    // é¡¯ç¤ºç¢ºèªå°è©±æ¡†\n    74â†’    const sourceWeekRange = getWeekDateRangeFromKey(sourceWeekKey);\n    75â†’    const targetWeekRange = getWeekDateRangeFromKey(targetWeekKey);\n    76â†’    const sourceStartDate = sourceWeekRange.start.toISOString().split('T')[0];\n    77â†’    const sourceEndDate = sourceWeekRange.end.toISOString().split('T')[0];\n    78â†’    const targetStartDate = targetWeekRange.start.toISOString().split('T')[0];\n    79â†’    const targetEndDate = targetWeekRange.end.toISOString().split('T')[0];\n    80â†’    \n    81â†’    // å–å¾—ä¾†æºé€±çš„å·¥æ™‚è¨˜éŒ„æ•¸é‡\n    82â†’    const timesheets = loadAllTimesheets();\n    83â†’    let sourceEntries = [];\n    84â†’    const sourceWeekData = timesheets[sourceWeekKey];\n    85â†’    if (Array.isArray(sourceWeekData)) {\n    86â†’        sourceEntries = sourceWeekData;\n    87â†’    } else if (sourceWeekData && sourceWeekData.entries) {\n    88â†’        sourceEntries = sourceWeekData.entries;\n    89â†’    }\n    90â†’    \n    91â†’    const confirmMessage = `ç¢ºèªè¦è¤‡è£½å·¥æ™‚è¨˜éŒ„å—ï¼Ÿ\\n\\n` +\n    92â†’                           `ä¾†æºé€±ï¼š${sourceWeekKey}\\n` +\n    93â†’                           `æ—¥æœŸç¯„åœï¼š${sourceStartDate} ~ ${sourceEndDate}\\n` +\n    94â†’                           `è¨˜éŒ„ç­†æ•¸ï¼š${sourceEntries.length} ç­†\\n\\n` +\n    95â†’                           `ç›®æ¨™é€±ï¼š${targetWeekKey}\\n` +\n    96â†’                           `æ—¥æœŸç¯„åœï¼š${targetStartDate} ~ ${targetEndDate}\\n\\n` +\n    97â†’                           `æ‰€æœ‰æ—¥æœŸå°‡è‡ªå‹•èª¿æ•´ç‚ºç›®æ¨™é€±å°æ‡‰æ—¥æœŸã€‚`;\n    98â†’    \n    99â†’    if (confirm(confirmMessage)) {\n   100â†’        copyWeekToTargetWeek(sourceWeekKey, targetWeekKey);\n   101â†’        closeCopyModal();\n   102â†’    }\n   103â†’}\n   104â†’\n   105â†’// é—œé–‰è¤‡è£½æ¨¡æ…‹è¦–çª—çš„å‡½æ•¸\n   106â†’function closeCopyModal() {\n   107â†’    document.getElementById('copy-options-modal').style.display = 'none';\n   108â†’    document.getElementById('copy-custom-week-input').style.display = 'none';\n   109â†’    document.getElementById('copy-custom-week-field').value = '';\n   110â†’}\n   111â†’\n   112â†’// è¨­ç½®æ—¥æœŸæ¬„ä½çš„é™åˆ¶ç¯„åœ\n   113â†’function setDateFieldLimits(startDate, endDate) {\n   114â†’    const minDate = formatDate(startDate);\n   115â†’    const maxDate = formatDate(endDate);\n   116â†’    \n   117â†’    // è¨­ç½®æ—¥æœŸæ¬„ä½çš„ min å’Œ max å±¬æ€§\n   118â†’    const dateFields = ['date', 'startDate', 'endDate'];\n   119â†’    dateFields.forEach(fieldId => {\n   120â†’        const field = document.getElementById(fieldId);\n   121â†’        if (field) {\n   122â†’            field.min = minDate;\n   123â†’            field.max = maxDate;\n   124â†’            \n   125â†’            // å¦‚æœæ¬„ä½æœ‰å€¼ä½†è¶…å‡ºç¯„åœï¼Œå‰‡æ¸…ç©º\n   126â†’            if (field.value) {\n   127â†’                const fieldDate = new Date(field.value);\n   128â†’                if (fieldDate < startDate || fieldDate > endDate) {\n   129â†’                    field.value = '';\n   130â†’                }\n   131â†’            }\n   132â†’        }\n   133â†’    });\n   134â†’}\n   135â†’\n   136â†’// é©—è­‰æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n   137â†’function validateDateInWeekRange(date, startDate, endDate) {\n   138â†’    if (!date) return true; // ç©ºå€¼å…è¨±\n   139â†’    \n   140â†’    const inputDate = new Date(date);\n   141â†’    return inputDate >= startDate && inputDate <= endDate;\n   142â†’}\n   143â†’\n   144â†’// å•Ÿç”¨æ­£è¦åŒ–æ¨¡å¼\n   145â†’function enableNormalizationMode(weekKey) {\n   146â†’    // å„²å­˜æ­£è¦åŒ–ç‹€æ…‹åˆ° localStorage\n   147â†’    const normalizationData = {\n   148â†’        weekKey: weekKey,\n   149â†’        enabled: true,\n   150â†’        timestamp: new Date().toISOString()\n   151â†’    };\n   152â†’    localStorage.setItem(`normalization_${weekKey}`, JSON.stringify(normalizationData));\n   153â†’    \n   154â†’    // æ›´æ–° UI é¡¯ç¤ºæ­£è¦åŒ–æ¨¡å¼ç‹€æ…‹\n   155â†’    updateNormalizationModeDisplay(weekKey);\n   156â†’}\n   157â†’\n   158â†’// æª¢æŸ¥æ˜¯å¦å•Ÿç”¨æ­£è¦åŒ–æ¨¡å¼\n   159â†’function isNormalizationEnabled(weekKey) {\n   160â†’    const data = localStorage.getItem(`normalization_${weekKey}`);\n   161â†’    return data ? JSON.parse(data).enabled : false;\n   162â†’}\n   163â†’\n   164â†’// æ›´æ–°æ­£è¦åŒ–æ¨¡å¼é¡¯ç¤º\n   165â†’function updateNormalizationModeDisplay(weekKey) {\n   166â†’    const isEnabled = isNormalizationEnabled(weekKey);\n   167â†’    const weekInfoDiv = document.querySelector('.week-info');\n   168â†’    \n   169â†’    // ç§»é™¤èˆŠçš„æ­£è¦åŒ–æç¤º\n   170â†’    const existingAlert = weekInfoDiv.querySelector('.normalization-alert');\n   171â†’    if (existingAlert) {\n   172â†’        existingAlert.remove();\n   173â†’    }\n   174â†’    \n   175â†’    if (isEnabled) {\n   176â†’        // é¡¯ç¤ºæ­£è¦åŒ–æ¨¡å¼æç¤º\n   177â†’        const alertDiv = document.createElement('div');\n   178â†’        alertDiv.className = 'normalization-alert';\n   179â†’        alertDiv.innerHTML = `\n   180â†’            <div class=\"alert alert-info\">\n   181â†’                <strong>ğŸ“Š æ­£è¦åŒ–æ¨¡å¼å·²å•Ÿç”¨</strong> - è©²é€±å·¥æ™‚è¶…é40å°æ™‚ï¼ŒåŒ¯å‡ºæ™‚å°‡è‡ªå‹•é€²è¡Œæ­£è¦åŒ–è¨ˆç®—\n   182â†’                <button onclick=\"disableNormalizationMode('${weekKey}')\" class=\"btn-disable-normalization\">åœç”¨</button>\n   183â†’            </div>\n   184â†’        `;\n   185â†’        weekInfoDiv.appendChild(alertDiv);\n   186â†’    }\n   187â†’}\n   188â†’\n   189â†’// åœç”¨æ­£è¦åŒ–æ¨¡å¼\n   190â†’function disableNormalizationMode(weekKey) {\n   191â†’    localStorage.removeItem(`normalization_${weekKey}`);\n   192â†’    updateNormalizationModeDisplay(weekKey);\n   193â†’    showSuccessMessage('æ­£è¦åŒ–æ¨¡å¼å·²åœç”¨');\n   194â†’}\n   195â†’\n   196â†’// åŒ¯å‡ºæ™‚é€²è¡Œæ­£è¦åŒ–è¨ˆç®—\n   197â†’function performNormalizationForExport(entries) {\n   198â†’    let totalRegularHours = 0;\n   199â†’\n   200â†’    // è¨ˆç®—ç¸½æ­£å¸¸å·¥æ™‚\n   201â†’    entries.forEach(entry => {\n   202â†’        totalRegularHours += entry.regularHours || 0;\n   203â†’    });\n   204â†’\n   205â†’    if (totalRegularHours > 40) {\n   206â†’        const normalizedEntries = entries.map(entry => {\n   207â†’            const originalHours = entry.regularHours || 0;\n   208â†’            const ratio = 40 / totalRegularHours;\n   209â†’            const newRegularHours = Math.round(originalHours * ratio * 100) / 100;\n   210â†’            // ä¿å­˜åŸå§‹å·¥æ™‚\n   211â†’            return {\n   212â†’                ...entry,\n   213â†’                _originalHours: originalHours,\n   214â†’                _isNormalized: true,\n   215â†’                regularHours: newRegularHours,\n   216â†’                ttlHours: newRegularHours + (entry.otHours || 0)\n   217â†’            };\n   218â†’        });\n   219â†’        return normalizedEntries;\n   220â†’    }\n   221â†’\n   222â†’    return entries; // ä¸éœ€è¦æ­£è¦åŒ–\n   223â†’}\n   224â†’// æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DDï¼ˆæœ¬åœ°æ™‚é–“ï¼‰\n   225â†’function formatDate(date) {\n   226â†’    const y = date.getFullYear();\n   227â†’    const m = String(date.getMonth() + 1).padStart(2, '0');\n   228â†’    const d = String(date.getDate()).padStart(2, '0');\n   229â†’    return `${y}-${m}-${d}`;\n   230â†’}\n   231â†’\n   232â†’// å¾localStorageåŠ è¼‰æ‰€æœ‰å·¥æ™‚è¡¨æ•¸æ“š\n   233â†’function loadAllTimesheets() {\n   234â†’    const data = localStorage.getItem('timesheets');\n   235â†’    return data ? JSON.parse(data) : {};\n   236â†’}\n   237â†’\n   238â†’// ä¿å­˜æ‰€æœ‰å·¥æ™‚è¡¨æ•¸æ“šåˆ°localStorage\n   239â†’function saveAllTimesheets(timesheets) {\n   240â†’    localStorage.setItem('timesheets', JSON.stringify(timesheets));\n   241â†’}\n   242â†’\n   243â†’// ç²å–æŒ‡å®šé€±æ•¸çš„æ—¥æœŸç¯„åœï¼ˆé€±æ—¥åˆ°é€±å…­ï¼‰\n   244â†’function getWeekDateRange(weekNumber, year) {\n   245â†’    // ç°¡å–®å¯¦ç¾ï¼šå‡è¨­yearå’ŒweekNumberæ˜¯æœ‰æ•ˆçš„\n   246â†’    // å¯¦éš›æ‡‰æ ¹æ“šISOé€±æ•¸è¨ˆç®—ï¼Œé€™è£¡ç°¡åŒ–ç‚ºå¾ç•¶å¹´ç¬¬ä¸€é€±çš„é€±æ—¥é–‹å§‹æ¨ç®—\n   247â†’    // æ³¨æ„ï¼šé€™åªæ˜¯ä¸€å€‹ç¤ºä¾‹ï¼Œå¯¦éš›çš„æ—¥æœŸè¨ˆç®—éœ€è¦æ›´åš´è¬¹çš„é‚è¼¯\n   248â†’    const firstDayOfYear = new Date(year, 0, 1);\n   249â†’    const firstSunday = new Date(firstDayOfYear);\n   250â†’    // èª¿æ•´åˆ°ç¬¬ä¸€é€±çš„é€±æ—¥ï¼ˆå‡è¨­ç¬¬ä¸€é€±å¾1æœˆ1æ—¥æ‰€åœ¨é€±çš„é€±æ—¥é–‹å§‹ï¼‰\n   251â†’    firstSunday.setDate(firstDayOfYear.getDate() - firstDayOfYear.getDay());\n   252â†’    \n   253â†’    const startDate = new Date(firstSunday);\n   254â†’    startDate.setDate(firstSunday.getDate() + (weekNumber - 1) * 7);\n   255â†’    const endDate = new Date(startDate);\n   256â†’    endDate.setDate(startDate.getDate() + 6);\n   257â†’    \n   258â†’    return {\n   259â†’        start: startDate,\n   260â†’        end: endDate\n   261â†’    };\n   262â†’}\n   263â†’\n   264â†’// è¨ˆç®—å¡«å¯«é€²åº¦ï¼ˆæ ¹æ“šè¨˜éŒ„ç­†æ•¸å’Œé æœŸ5å€‹å·¥ä½œæ—¥ï¼Ÿé€™è£¡ç°¡åŒ–ç‚ºè¨˜éŒ„ç­†æ•¸æ˜¯å¦å¤§æ–¼0ï¼‰\n   265â†’function calculateProgress(entries) {\n   266â†’    // å¦‚æœæœ‰è¨˜éŒ„ï¼Œå‰‡èªç‚ºå¡«å¯«äº†ï¼Œé€²åº¦100%ï¼›å¦å‰‡0\n   267â†’    return entries && entries.length > 0 ? 100 : 0;\n   268â†’}\n   269â†’\n   270â†’// æ¸²æŸ“å·¥æ™‚è¡¨å¡ç‰‡\n   271â†’function renderTimesheetCards() {\n   272â†’    const container = document.getElementById('timesheet-cards');\n   273â†’    container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨\n   274â†’    \n   275â†’    const timesheets = loadAllTimesheets();\n   276â†’    \n   277â†’    Object.keys(timesheets).forEach(key => {\n   278â†’        // keyæ ¼å¼ï¼šYYYY-Wwwï¼Œéœ€æª¢æŸ¥åˆæ³•æ€§\n   279â†’        if (!key || typeof key !== 'string' || !key.includes('-')) return;\n   280â†’        const [year, week] = key.split('-');\n   281â†’        if (!year || !week || week.length < 2) return;\n   282â†’        const weekNumber = parseInt(week.substring(1));\n   283â†’        if (isNaN(weekNumber)) return;\n   284â†’        const weekData = timesheets[key];\n   285â†’        \n   286â†’        // è™•ç†æ–°çš„è³‡æ–™çµæ§‹ï¼ˆåŒ…å« basicInfo å’Œ entriesï¼‰\n   287â†’        let entries = [];\n   288â†’        if (Array.isArray(weekData)) {\n   289â†’            // èˆŠçš„è³‡æ–™çµæ§‹ï¼Œç›´æ¥æ˜¯é™£åˆ—\n   290â†’            entries = weekData;\n   291â†’        } else if (weekData && weekData.entries) {\n   292â†’            // æ–°çš„è³‡æ–™çµæ§‹ï¼Œæœ‰ basicInfo å’Œ entries\n   293â†’            entries = weekData.entries;\n   294â†’        }\n   295â†’        \n   296â†’        const dateRange = getWeekDateRange(weekNumber, year);\n   297â†’        const startStr = dateRange.start.toISOString().split('T')[0];\n   298â†’        const endStr = dateRange.end.toISOString().split('T')[0];\n   299â†’        \n   300â†’        const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n   301â†’        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n   302â†’        const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n   303â†’        const isComplete = totalHours >= 40;\n   304â†’        \n   305â†’        // å‰µå»ºå¡ç‰‡å…ƒç´ \n   306â†’        const card = document.createElement('div');\n   307â†’        card.className = 'timesheet-card';\n   308â†’        card.innerHTML = `\n   309â†’            <div class=\"card-color-bar\"></div>\n   310â†’            <div class=\"status-tag ${isComplete ? 'status-completed' : 'status-inprogress'}\"\n   311â†’                 title=\"${isComplete ? 'ç¸½å·¥æ™‚å·²é”40å°æ™‚' : 'ç¸½å·¥æ™‚æœªé”40å°æ™‚'}\">\n   312â†’                ${isComplete ? 'âœ“' : 'âš '}\n   313â†’            </div>\n   314â†’            <div class=\"card-header\">\n   315â†’                <div class=\"week-title\">${key}</div>\n   316â†’                <div class=\"date-range\">${startStr} è‡³ ${endStr}</div>\n   317â†’            </div>\n   318â†’            <div class=\"stats\">\n   319â†’                <div class=\"stat-item\">\n   320â†’                    <div class=\"stat-value\">${entries.length}</div>\n   321â†’                    <div class=\"stat-label\">è¨˜éŒ„ç­†æ•¸</div>\n   322â†’                </div>\n   323â†’                <div class=\"stat-item\">\n   324â†’                    <div class=\"stat-value\">${totalHours}</div>\n   325â†’                    <div class=\"stat-label\">ç¸½å·¥æ™‚</div>\n   326â†’                </div>\n   327â†’                <div class=\"stat-item\">\n   328â†’                    <div class=\"stat-value\">${totalRegularHours}</div>\n   329â†’                    <div class=\"stat-label\">ç¸½æ­£å¸¸å·¥æ™‚</div>\n   330â†’                </div>\n   331â†’                <div class=\"stat-item\">\n   332â†’                    <div class=\"stat-value\">${totalOtHours}</div>\n   333â†’                    <div class=\"stat-label\">ç¸½åŠ ç­å·¥æ™‚</div>\n   334â†’                </div>\n   335â†’            </div>\n   336â†’            <div class=\"card-actions\">\n   337â†’                <button class=\"btn-edit\" data-week=\"${key}\">ä¿®æ”¹</button>\n   338â†’                <button class=\"btn-copy\" data-week=\"${key}\">è¤‡è£½</button>\n   339â†’                <button class=\"btn-delete\" data-week=\"${key}\">åˆªé™¤</button>\n   340â†’                <button class=\"btn-export\" data-week=\"${key}\">åŒ¯å‡º</button>\n   341â†’            </div>\n   342â†’        `;\n   343â†’        \n   344â†’        container.appendChild(card);\n   345â†’    });\n   346â†’    \n   347â†’    // ç‚ºå¡ç‰‡ä¸Šçš„æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½\n   348â†’    document.querySelectorAll('.btn-edit').forEach(btn => {\n   349â†’        btn.addEventListener('click', () => {\n   350â†’            const weekKey = btn.getAttribute('data-week');\n   351â†’            editTimesheet(weekKey);\n   352â†’        });\n   353â†’    });\n   354â†’    \n   355â†’    document.querySelectorAll('.btn-delete').forEach(btn => {\n   356â†’        btn.addEventListener('click', () => {\n   357â†’            const weekKey = btn.getAttribute('data-week');\n   358â†’            deleteTimesheet(weekKey);\n   359â†’        });\n   360â†’    });\n   361â†’    \n   362â†’    document.querySelectorAll('.btn-copy').forEach(btn => {\n   363â†’        btn.addEventListener('click', () => {\n   364â†’            const weekKey = btn.getAttribute('data-week');\n   365â†’console.log('Attempting to call showCopyOptionsModal with weekKey:', weekKey);\n   366â†’            showCopyOptionsModal(weekKey);\n   367â†’        });\n   368â†’    });\n   369â†’    \n   370â†’    document.querySelectorAll('.btn-export').forEach(btn => {\n   371â†’        btn.addEventListener('click', () => {\n   372â†’            const weekKey = btn.getAttribute('data-week');\n   373â†’            exportTimesheet(weekKey);\n   374â†’        });\n   375â†’    });\n   376â†’    \n   377â†’    // æ›´æ–°ä¸Šé€±æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹\n   378â†’    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n   379â†’        updateLastWeekButtonDisplay();\n   380â†’    }\n   381â†’}\n   382â†’\n   383â†’// æ–°å»ºå·¥æ™‚è¡¨ - é¡¯ç¤ºé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\n   384â†’function newTimesheet() {\n   385â†’    showWeekSelectionModal();\n   386â†’}\n   387â†’\n   388â†’// é¡¯ç¤ºé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\n   389â†’function showWeekSelectionModal() {\n   390â†’    const modal = document.getElementById('week-selection-modal');\n   391â†’    const timesheets = loadAllTimesheets();\n   392â†’    \n   393â†’    // è¨ˆç®—ä¸Šé€±å’Œæœ¬é€±çš„é€±æ¬¡\n   394â†’    const lastWeekKey = getLastWeekKey();\n   395â†’    const thisWeekKey = getThisWeekKey();\n   396â†’    \n   397â†’    // æ›´æ–°ä¸Šé€±é¸é …è³‡è¨Š\n   398â†’    const lastWeekInfo = document.getElementById('last-week-info');\n   399â†’    const lastWeekStatus = document.getElementById('last-week-status');\n   400â†’    const lastWeekOption = document.getElementById('option-last-week');\n   401â†’    \n   402â†’    if (lastWeekKey) {\n   403â†’        const lastWeekRange = getWeekDateRangeFromKey(lastWeekKey);\n   404â†’        lastWeekInfo.textContent = `${lastWeekKey} (${formatDate(lastWeekRange.start)} - ${formatDate(lastWeekRange.end)})`;\n   405â†’        \n   406â†’        if (timesheets[lastWeekKey]) {\n   407â†’            lastWeekStatus.textContent = 'å·²å­˜åœ¨';\n   408â†’            lastWeekStatus.className = 'option-status status-exists';\n   409â†’            // å¦‚æœå·²å­˜åœ¨ï¼Œç¦ç”¨è©²é¸é …\n   410â†’            document.getElementById('radio-last-week').disabled = true;\n   411â†’            lastWeekOption.style.opacity = '0.6';\n   412â†’        } else {\n   413â†’            lastWeekStatus.textContent = 'å¯å»ºç«‹';\n   414â†’            lastWeekStatus.className = 'option-status status-new';\n   415â†’            document.getElementById('radio-last-week').disabled = false;\n   416â†’            lastWeekOption.style.opacity = '1';\n   417â†’        }\n   418â†’    } else {\n   419â†’        lastWeekOption.style.display = 'none';\n   420â†’    }\n   421â†’    \n   422â†’    // æ›´æ–°æœ¬é€±é¸é …è³‡è¨Š\n   423â†’    const thisWeekInfo = document.getElementById('this-week-info');\n   424â†’    const thisWeekStatus = document.getElementById('this-week-status');\n   425â†’    const thisWeekOption = document.getElementById('option-this-week');\n   426â†’    \n   427â†’    if (thisWeekKey) {\n   428â†’        const thisWeekRange = getWeekDateRangeFromKey(thisWeekKey);\n   429â†’        thisWeekInfo.textContent = `${thisWeekKey} (${formatDate(thisWeekRange.start)} - ${formatDate(thisWeekRange.end)})`;\n   430â†’        \n   431â†’        if (timesheets[thisWeekKey]) {\n   432â†’            thisWeekStatus.textContent = 'å·²å­˜åœ¨';\n   433â†’            thisWeekStatus.className = 'option-status status-exists';\n   434â†’            // å¦‚æœå·²å­˜åœ¨ï¼Œç¦ç”¨è©²é¸é …\n   435â†’            document.getElementById('radio-this-week').disabled = true;\n   436â†’            thisWeekOption.style.opacity = '0.6';\n   437â†’        } else {\n   438â†’            thisWeekStatus.textContent = 'å¯å»ºç«‹';\n   439â†’            thisWeekStatus.className = 'option-status status-new';\n   440â†’            document.getElementById('radio-this-week').disabled = false;\n   441â†’            thisWeekOption.style.opacity = '1';\n   442â†’        }\n   443â†’    } else {\n   444â†’        thisWeekOption.style.display = 'none';\n   445â†’    }\n   446â†’    \n   447â†’    // é‡ç½®è‡ªè¨‚è¼¸å…¥\n   448â†’    document.getElementById('custom-week-field').value = '';\n   449â†’    document.getElementById('custom-week-input').style.display = 'none';\n   450â†’    \n   451â†’    // æ¸…é™¤é¸æ“‡\n   452â†’    document.querySelectorAll('input[name=\"weekOption\"]').forEach(radio => {\n   453â†’        radio.checked = false;\n   454â†’    });\n   455â†’    \n   456â†’    // é¡¯ç¤ºæ¨¡æ…‹æ¡†\n   457â†’    modal.style.display = 'block';\n   458â†’}\n   459â†’\n   460â†’// å–å¾—ä¸Šé€±çš„é€±æ¬¡éµå€¼\n   461â†’function getLastWeekKey() {\n   462â†’    const today = new Date();\n   463â†’    const lastMonday = new Date(today);\n   464â†’    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n   465â†’    \n   466â†’    const year = lastMonday.getFullYear();\n   467â†’    const weekNumber = getWeekNumber(lastMonday);\n   468â†’    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n   469â†’}\n   470â†’\n   471â†’// å–å¾—æœ¬é€±çš„é€±æ¬¡éµå€¼\n   472â†’function getThisWeekKey() {\n   473â†’    const today = new Date();\n   474â†’    const thisMonday = new Date(today);\n   475â†’    thisMonday.setDate(today.getDate() - today.getDay() + 1);\n   476â†’    \n   477â†’    const year = thisMonday.getFullYear();\n   478â†’    const weekNumber = getWeekNumber(thisMonday);\n   479â†’    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n   480â†’}\n   481â†’\n   482â†’// è¨ˆç®—é€±æ•¸ï¼ˆISO 8601ï¼‰\n   483â†’/**\n   484â†’ * ä»¥é€±æ—¥ç‚ºé€±é¦–è¨ˆç®—é€±æ¬¡ï¼ˆYYYY-Wwwï¼‰ï¼Œé€±æ—¥~é€±å…­\n   485â†’ */\n   486â†’function getWeekNumber(date) {\n   487â†’    const d = new Date(date);\n   488â†’    // æ‰¾åˆ°æœ¬é€±çš„é€±æ—¥\n   489â†’    const sunday = new Date(d);\n   490â†’    sunday.setDate(d.getDate() - d.getDay());\n   491â†’    // è¨ˆç®—ä»Šå¹´ç¬¬ä¸€å¤©çš„é€±æ—¥\n   492â†’    const firstDay = new Date(d.getFullYear(), 0, 1);\n   493â†’    const firstSunday = new Date(firstDay);\n   494â†’    firstSunday.setDate(firstDay.getDate() - firstDay.getDay());\n   495â†’    // è¨ˆç®—é€±æ•¸\n   496â†’    const diff = sunday - firstSunday;\n   497â†’    const weekNumber = Math.floor(diff / (7 * 24 * 60 * 60 * 1000)) + 1;\n   498â†’    return weekNumber;\n   499â†’}\n   500â†’\n   501â†’// å¾é€±æ¬¡éµå€¼å–å¾—æ—¥æœŸç¯„åœ\n   502â†’function getWeekDateRangeFromKey(weekKey) {\n   503â†’    const [year, week] = weekKey.split('-');\n   504â†’    const weekNumber = parseInt(week.substring(1));\n   505â†’    return getWeekDateRange(weekNumber, year);\n   506â†’}\n   507â†’\n   508â†’// ä¿®æ”¹å·¥æ™‚è¡¨ï¼ˆè·³è½‰åˆ°ç·¨è¼¯é é¢ï¼‰\n   509â†’function editTimesheet(weekKey) {\n   510â†’    // è·³è½‰åˆ°å·¥æ™‚å¡«å¯«ç•Œé¢\n   511â†’    window.location.href = `edit.html?week=${encodeURIComponent(weekKey)}`;\n   512â†’}\n   513â†’\n   514â†’// åˆªé™¤å·¥æ™‚è¡¨\n   515â†’function deleteTimesheet(weekKey) {\n   516â†’    if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${weekKey} çš„å·¥æ™‚è¡¨å—ï¼Ÿ`)) {\n   517â†’        const timesheets = loadAllTimesheets();\n   518â†’        delete timesheets[weekKey];\n   519â†’        saveAllTimesheets(timesheets);\n   520â†’        renderTimesheetCards();\n   521â†’    }\n   522â†’}\n   523â†’\n   524â†’// åŒ¯å‡ºå·¥æ™‚è¡¨ç‚ºCSVæª”æ¡ˆ\n   525â†’function exportTimesheet(weekKey) {\n   526â†’    try {\n   527â†’        const entries = getWeekEntries(weekKey);\n   528â†’        if (!entries || entries.length === 0) {\n   529â†’            alert('è©²é€±æ¬¡æ²’æœ‰å·¥æ™‚è¨˜éŒ„å¯åŒ¯å‡º');\n   530â†’            return;\n   531â†’        }\n   532â†’\n   533â†’        // åŒ¯å‡ºå‰æª¢æŸ¥ç¸½æ­£å¸¸å·¥æ™‚ï¼Œè‹¥è¶…é40å°æ™‚å‰‡æç¤º\n   534â†’        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n   535â†’        // è‹¥è¶…é40å°æ™‚ï¼Œæç¤ºå°‡è‡ªå‹•æ­£è¦åŒ–\n   536â†’        if (totalRegularHours > 40) {\n   537â†’            alert('æœ¬é€±æ­£å¸¸å·¥æ™‚è¶…é40å°æ™‚ï¼Œæ»™å‡ºæ™‚å°‡è‡ªå‹•é€²è¡Œæ­£è¦åŒ–è¨ˆç®—ã€‚\\n\\næ³¨æ„ï¼šè‹¥ä¸‹è¼‰æª”æ¡ˆæ™‚é¸æ“‡è¦†è“‹èˆŠæª”ï¼Œä¸”èˆŠæª”æ­£åœ¨é–‹å•Ÿç‹€æ…‹ï¼Œä¸‹è¼‰å¯èƒ½æœƒå¤±æ•—ä¸¦é¡¯ç¤ºã€Œéœ€è¦ä¸‹è¼‰æ¬Šé™ã€ç­‰éŒ¯èª¤ï¼Œè«‹å…ˆé—œé–‰èˆŠæª”å†ä¸‹è¼‰ã€‚');\n   538â†’        }\n   539â†’\n   540â†’        let exportEntries = [...entries];\n   541â†’\n   542â†’        if (totalRegularHours > 40) {\n   543â†’            exportEntries = performNormalizationForExport(exportEntries);\n   544â†’        }\n   545â†’\n   546â†’        // æº–å‚™CSVå…§å®¹\n   547â†’        const csvContent = generateCSVContent(exportEntries, weekKey);\n   548â†’\n   549â†’        // å‰µå»ºä¸¦ä¸‹è¼‰æª”æ¡ˆ\n   550â†’        downloadCSVFile(csvContent, `å·¥æ™‚è¡¨_${weekKey}.csv`);\n   551â†’\n   552â†’        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n   553â†’        showSuccessMessage(`${weekKey} å·¥æ™‚è¡¨å·²åŒ¯å‡º`);\n   554â†’\n   555â†’    } catch (error) {\n   556â†’        console.error('åŒ¯å‡ºå¤±æ•—:', error);\n   557â†’        alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°');\n   558â†’    }\n   559â†’}\n   560â†’// æ»™å‡ºæœªç¶“æ­£è¦åŒ–çš„åŸå§‹å·¥æ™‚\n   561â†’function exportRawTimesheet(weekKey) {\n   562â†’    try {\n   563â†’        const entries = getWeekEntries(weekKey);\n   564â†’        if (!entries || entries.length === 0) {\n   565â†’            alert('è©²é€±æ¬¡æ²’æœ‰å·¥æ™‚è¨˜éŒ„å¯åŒ¯å‡º');\n   566â†’            return;\n   567â†’        }\n   568â†’        // ç›´æ¥æ»™å‡ºåŸå§‹å·¥æ™‚è³‡æ–™\n   569â†’        const csvContent = generateCSVContent(entries, weekKey);\n   570â†’        downloadCSVFile(csvContent, `å·¥æ™‚è¡¨_${weekKey}_åŸå§‹.csv`);\n   571â†’        showSuccessMessage(`${weekKey} å·¥æ™‚è¡¨ï¼ˆåŸå§‹ï¼‰å·²åŒ¯å‡º`);\n   572â†’    } catch (error) {\n   573â†’        console.error('åŸå§‹å·¥æ™‚åŒ¯å‡ºå¤±æ•—:', error);\n   574â†’        alert('åŸå§‹å·¥æ™‚åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°');\n   575â†’    }\n   576â†’}\n   577â†’\n   578â†’// ç”ŸæˆCSVå…§å®¹\n   579â†’function generateCSVContent(entries, weekKey) {\n   580â†’    // CSVæ¨™é¡Œè¡Œï¼ˆæŒ‰ç…§æŒ‡å®šæ ¼å¼ï¼‰\n   581â†’    const headers = [\n   582â†’        'Name',\n   583â†’        'Zone',\n   584â†’        'Project',\n   585â†’        'Product Module',\n   586â†’        'Activity Type',\n   587â†’        'Task',\n   588â†’        'Regular Hours',\n   589â†’        'OT Hours',\n   590â†’        'TTL_Hours',\n   591â†’        'Date',\n   592â†’        'Start Date',\n   593â†’        'End Date',\n   594â†’        'Comments',\n   595â†’        'PM',\n   596â†’        'InternalOrOutsource'\n   597â†’    ];\n   598â†’\n   599â†’    // è¼‰å…¥åŸºæœ¬è³‡æ–™\n   600â†’    const basicInfo = loadGlobalBasicInfo();\n   601â†’    \n   602â†’    // è½‰æ›è³‡æ–™è¡Œ\n   603â†’    const dataRows = entries.map(entry => {\n   604â†’        const regularHours = parseFloat(entry.regularHours) || 0;\n   605â†’        const overtimeHours = parseFloat(entry.overtimeHours) || parseFloat(entry.otHours) || 0;\n   606â†’        const totalHours = parseFloat(entry.ttlHours) || (regularHours + overtimeHours);\n   607â†’        \n   608â†’        return [\n   609â†’            basicInfo.employeeName || '',           // Name\n   610â†’            entry.zone || '',                       // Zone\n   611â†’            entry.project || '',                    // Project\n   612â†’            entry.productModule || '',              // Product Module\n   613â†’            entry.activityType || '',               // Activity Type\n   614â†’            entry.task || '',                       // Task\n   615â†’            regularHours,                           // Regular Hours\n   616â†’            overtimeHours,                          // OT Hours\n   617â†’            totalHours,                             // TTL_Hours\n   618â†’            entry.date || '',                       // Date\n   619â†’            entry.startDate || '',                  // Start Date\n   620â†’            entry.endDate || '',                    // End Date\n   621â†’            entry.comments || '',                   // Comments\n   622â†’            entry.pm || '',                         // PM\n   623â†’            basicInfo.employeeType || ''            // InternalOrOutsource\n   624â†’        ];\n   625â†’    });\n   626â†’\n   627â†’    // çµ„åˆCSVå…§å®¹\n   628â†’    const csvRows = [headers, ...dataRows];\n   629â†’    \n   630â†’    // è½‰æ›ç‚ºCSVæ ¼å¼å­—ä¸²\n   631â†’    return csvRows.map(row =>\n   632â†’        row.map(field => {\n   633â†’            // è™•ç†åŒ…å«é€—è™Ÿæˆ–æ›è¡Œçš„æ¬„ä½\n   634â†’            const fieldStr = String(field);\n   635â†’            if (fieldStr.includes(',') || fieldStr.includes('\\n') || fieldStr.includes('\"')) {\n   636â†’                return '\"' + fieldStr.replace(/\"/g, '\"\"') + '\"';\n   637â†’            }\n   638â†’            return fieldStr;\n   639â†’        }).join(',')\n   640â†’    ).join('\\n');\n   641â†’}\n   642â†’\n   643â†’// ä¸‹è¼‰CSVæª”æ¡ˆ\n   644â†’function downloadCSVFile(csvContent, filename) {\n   645â†’    try {\n   646â†’        console.log('[downloadCSVFile] é–‹å§‹ä¸‹è¼‰', { filename, csvContentSample: csvContent.slice(0, 100) });\n   647â†’        // æ·»åŠ BOMä»¥æ”¯æ´ä¸­æ–‡\n   648â†’        const BOM = '\\uFEFF';\n   649â†’        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n   650â†’        console.log('[downloadCSVFile] Blob created', blob);\n   651â†’        const url = URL.createObjectURL(blob);\n   652â†’        console.log('[downloadCSVFile] Object URL', url);\n   653â†’        const link = document.createElement('a');\n   654â†’        link.setAttribute('href', url);\n   655â†’        link.setAttribute('download', filename);\n   656â†’        link.style.visibility = 'hidden';\n   657â†’        // æ·»åŠ åˆ°é é¢ä¸¦è§¸ç™¼ä¸‹è¼‰\n   658â†’        document.body.appendChild(link);\n   659â†’        link.click();\n   660â†’        console.log('[downloadCSVFile] link.click() å·²è§¸ç™¼');\n   661â†’        // æ¸…ç†\n   662â†’        document.body.removeChild(link);\n   663â†’        URL.revokeObjectURL(url);\n   664â†’        console.log('[downloadCSVFile] æ¸…ç†å®Œæˆ');\n   665â†’    } catch (err) {\n   666â†’        console.error('[downloadCSVFile] ç™¼ç”ŸéŒ¯èª¤', err);\n   667â†’    }\n   668â†’}\n   669â†’\n   670â†’// åŒ¯å…¥å·¥æ™‚è¡¨ï¼ˆæš«æ™‚åªæç¤ºï¼‰\n   671â†’function importTimesheet() {\n   672â†’    const input = document.getElementById('import-file');\n   673â†’    input.value = ''; // é‡ç½® inputï¼Œé¿å…åŒæª”æ¡ˆç„¡æ³•é‡é¸\n   674â†’    input.onchange = async function (event) {\n   675â†’        const file = event.target.files[0];\n   676â†’        if (!file) return;\n   677â†’        const reader = new FileReader();\n   678â†’        reader.onload = function (e) {\n   679â†’            const text = e.target.result;\n   680â†’            try {\n   681â†’                console.log('[import] åŸå§‹CSVå…§å®¹:', text);\n   682â†’                \n   683â†’                // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ç‚ºç©º\n   684â†’                if (!text || text.trim().length === 0) {\n   685â†’                    alert('æª”æ¡ˆå…§å®¹ç‚ºç©ºï¼Œè«‹é¸æ“‡æœ‰æ•ˆçš„CSVæª”æ¡ˆã€‚');\n   686â†’                    return;\n   687â†’                }\n   688â†’                \n   689â†’                const data = parseCSV(text);\n   690â†’                console.log('[import] parseCSV result:', data);\n   691â†’                \n   692â†’                // æª¢æŸ¥æ˜¯å¦æˆåŠŸè§£æå‡ºè³‡æ–™\n   693â†’                if (!data || data.length === 0) {\n   694â†’                    alert('ç„¡æ³•å¾æª”æ¡ˆä¸­è§£æå‡ºæœ‰æ•ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥CSVæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');\n   695â†’                    return;\n   696â†’                }\n   697â†’                \n   698â†’                // å¼·åˆ¶å°‡ data è½‰ç‚º array\n   699â†’                console.log('[import] typeof data:', typeof data, 'Array.isArray:', Array.isArray(data));\n   700â†’                let arr = [];\n   701â†’                if (Array.isArray(data)) {\n   702â†’                    arr = data;\n   703â†’                } else if (typeof data === 'object' && data !== null) {\n   704â†’                    arr = Object.values(data).flat();\n   705â†’                }\n   706â†’                console.log('[import] è½‰æ›å¾Œ arr:', arr);\n   707â†’                \n   708â†’                if (arr.length === 0) {\n   709â†’                    alert('æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„å·¥æ™‚è¨˜éŒ„ã€‚');\n   710â†’                    return;\n   711â†’                }\n   712â†’                let groupedData = {};\n   713â†’                const failedRows = [];\n   714â†’                \n   715â†’                arr.forEach((row, index) => {\n   716â†’                    if (!row) return;\n   717â†’                    \n   718â†’                    // æª¢æŸ¥æ—¥æœŸæ¬„ä½ï¼ˆæ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±ï¼‰\n   719â†’                    const dateValue = row.Date || row.date || row['æ—¥æœŸ'] || row.Day;\n   720â†’                    if (!dateValue) {\n   721â†’                        console.warn(`[import] ç¬¬${index + 1}ç­†è¨˜éŒ„ç¼ºå°‘æ—¥æœŸæ¬„ä½:`, row);\n   722â†’                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šç¼ºå°‘æ—¥æœŸæ¬„ä½`);\n   723â†’                        return;\n   724â†’                    }\n   725â†’                    \n   726â†’                    // æ”¹é€²çš„æ—¥æœŸè§£æï¼Œæ”¯æ´å¤šç¨®æ ¼å¼\n   727â†’                    let dateObj = null;\n   728â†’                    const dateStr = dateValue.toString().trim();\n   729â†’                    \n   730â†’                    // å˜—è©¦å¤šç¨®æ—¥æœŸæ ¼å¼\n   731â†’                    const dateFormats = [\n   732â†’                        dateStr, // åŸå§‹æ ¼å¼\n   733â†’                        dateStr.replace(/\\//g, '-'), // å°‡ / æ›¿æ›ç‚º -\n   734â†’                        dateStr.replace(/\\./g, '-'), // å°‡ . æ›¿æ›ç‚º -\n   735â†’                    ];\n   736â†’                    \n   737â†’                    for (const format of dateFormats) {\n   738â†’                        dateObj = new Date(format);\n   739â†’                        if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1900) {\n   740â†’                            break;\n   741â†’                        }\n   742â†’                        dateObj = null;\n   743â†’                    }\n   744â†’                    \n   745â†’                    if (!dateObj || isNaN(dateObj.getTime())) {\n   746â†’                        console.warn(`[import] ç¬¬${index + 1}ç­†è¨˜éŒ„æ—¥æœŸæ ¼å¼ç„¡æ•ˆ:`, dateValue);\n   747â†’                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šæ—¥æœŸæ ¼å¼ç„¡æ•ˆ \"${dateValue}\"`);\n   748â†’                        return;\n   749â†’                    }\n   750â†’                    \n   751â†’                    try {\n   752â†’                        // æ­£ç¢ºè¨ˆç®—é€±æ¬¡\n   753â†’                        const year = dateObj.getFullYear();\n   754â†’                        const weekNumber = getWeekNumber(dateObj);\n   755â†’                        const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n   756â†’                        console.log('[import][åˆ†çµ„] Date:', dateValue, 'parsed:', dateObj, 'year:', year, 'weekNumber:', weekNumber, 'weekKey:', weekKey);\n   757â†’                        \n   758â†’                        if (!groupedData[weekKey]) groupedData[weekKey] = [];\n   759â†’                        \n   760â†’                        // æ¨™æº–åŒ–è¨˜éŒ„æ ¼å¼ï¼Œç¢ºä¿æ—¥æœŸçµ±ä¸€å’Œå¿…è¦æ¬„ä½\n   761â†’                        const standardizedRow = { ...row };\n   762â†’                        standardizedRow.date = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD æ ¼å¼\n   763â†’                        \n   764â†’                        // ç¢ºä¿æœ‰å”¯ä¸€çš„ ID\n   765â†’                        if (!standardizedRow.id) {\n   766â†’                            standardizedRow.id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n   767â†’                        }\n   768â†’                        \n   769â†’                        // ç¢ºä¿æ•¸å­—æ¬„ä½æœ‰é è¨­å€¼\n   770â†’                        standardizedRow.regularHours = standardizedRow.regularHours || 0;\n   771â†’                        standardizedRow.otHours = standardizedRow.otHours || 0;\n   772â†’                        standardizedRow.ttlHours = standardizedRow.ttlHours || (standardizedRow.regularHours + standardizedRow.otHours);\n   773â†’                        \n   774â†’                        groupedData[weekKey].push(standardizedRow);\n   775â†’                    } catch (err) {\n   776â†’                        console.error(`[import] è™•ç†ç¬¬${index + 1}ç­†è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:`, err, row);\n   777â†’                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šè™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤`);\n   778â†’                    }\n   779â†’                });\n   780â†’                \n   781â†’                // å¦‚æœæœ‰å¤±æ•—çš„è¨˜éŒ„ï¼Œé¡¯ç¤ºè­¦å‘Š\n   782â†’                if (failedRows.length > 0) {\n   783â†’                    console.warn('[import] ä»¥ä¸‹è¨˜éŒ„åŒ¯å…¥å¤±æ•—:', failedRows);\n   784â†’                    const proceed = confirm(`æœ‰ ${failedRows.length} ç­†è¨˜éŒ„åŒ¯å…¥å¤±æ•—ï¼š\\n${failedRows.slice(0, 5).join('\\n')}${failedRows.length > 5 ? '\\n...' : ''}\\n\\næ˜¯å¦ç¹¼çºŒåŒ¯å…¥å…¶ä»–è¨˜éŒ„ï¼Ÿ`);\n   785â†’                    if (!proceed) {\n   786â†’                        alert('åŒ¯å…¥å·²å–æ¶ˆ');\n   787â†’                        return;\n   788â†’                    }\n   789â†’                }\n   790â†’                console.log('[import] è‡ªå‹•åˆ†çµ„é€±æ¬¡çµæœ:', groupedData);\n   791â†’                // åˆä½µåŒ¯å…¥è³‡æ–™åˆ°ä¸» timesheets\n   792â†’                const timesheets = loadAllTimesheets();\n   793â†’                console.log('[import] localStorage timesheets(åŒ¯å…¥å‰):', timesheets);\n   794â†’                const importedWeeks = [];\n   795â†’                for (const weekKey in groupedData) {\n   796â†’                    console.log('[import] æª¢æŸ¥é€±æ¬¡', weekKey, groupedData[weekKey]);\n   797â†’                    if (timesheets[weekKey]) {\n   798â†’                        const overwrite = confirm('é€±æ¬¡ ' + weekKey + ' å·²æœ‰è³‡æ–™ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ');\n   799â†’                        console.log('[import] è¦†è“‹ç¢ºèª', weekKey, overwrite);\n   800â†’                        if (!overwrite) continue;\n   801â†’                    }\n   802â†’                    timesheets[weekKey] = groupedData[weekKey];\n   803â†’                    importedWeeks.push(weekKey);\n   804â†’                    console.log('[import] å·²åŠ å…¥é€±æ¬¡:', weekKey);\n   805â†’                }\n   806â†’                console.log('[import] importedWeeks:', importedWeeks);\n   807â†’                console.log('[import] localStorage timesheets(åŒ¯å…¥å¾Œ):', timesheets);\n   808â†’                \n   809â†’                if (Object.keys(groupedData).length === 0) {\n   810â†’                    alert('æ²’æœ‰æœ‰æ•ˆçš„è¨˜éŒ„å¯ä»¥åŒ¯å…¥ã€‚è«‹æª¢æŸ¥CSVæª”æ¡ˆä¸­çš„æ—¥æœŸæ ¼å¼å’Œè³‡æ–™å…§å®¹ã€‚');\n   811â†’                    return;\n   812â†’                }\n   813â†’                \n   814â†’                saveAllTimesheets(timesheets);\n   815â†’                renderTimesheetCards();\n   816â†’                \n   817â†’                if (importedWeeks.length > 0) {\n   818â†’                    const weekInfoList = importedWeeks.map(weekKey => {\n   819â†’                        try {\n   820â†’                            const range = getWeekDateRangeFromKey(weekKey);\n   821â†’                            const start = range.start.toISOString().split('T')[0];\n   822â†’                            const end = range.end.toISOString().split('T')[0];\n   823â†’                            const recordCount = groupedData[weekKey].length;\n   824â†’                            return `${weekKey} (${start} ~ ${end}) - ${recordCount}ç­†è¨˜éŒ„`;\n   825â†’                        } catch (err) {\n   826â†’                            console.error('[import] å–å¾—é€±æ¬¡ç¯„åœå¤±æ•—:', weekKey, err);\n   827â†’                            return `${weekKey} - ${groupedData[weekKey].length}ç­†è¨˜éŒ„`;\n   828â†’                        }\n   829â†’                    });\n   830â†’                    \n   831â†’                    const totalRecords = importedWeeks.reduce((sum, weekKey) => sum + groupedData[weekKey].length, 0);\n   832â†’                    const successMessage = `åŒ¯å…¥æˆåŠŸï¼\\nå…±åŒ¯å…¥ ${totalRecords} ç­†è¨˜éŒ„åˆ° ${importedWeeks.length} å€‹é€±æ¬¡ï¼š\\n\\n${weekInfoList.join('\\n')}`;\n   833â†’                    \n   834â†’                    if (failedRows.length > 0) {\n   835â†’                        alert(successMessage + `\\n\\næ³¨æ„ï¼šæœ‰ ${failedRows.length} ç­†è¨˜éŒ„åŒ¯å…¥å¤±æ•—ã€‚`);\n   836â†’                    } else {\n   837â†’                        alert(successMessage);\n   838â†’                    }\n   839â†’                } else {\n   840â†’                    alert('æœªåŒ¯å…¥ä»»ä½•é€±æ¬¡è³‡æ–™ã€‚æ‰€æœ‰è¨˜éŒ„éƒ½è¢«è·³éäº†ã€‚');\n   841â†’                }\n   842â†’            } catch (err) {\n   843â†’                console.error('[import] åŒ¯å…¥æµç¨‹ç™¼ç”ŸéŒ¯èª¤:', err);\n   844â†’                let errorMessage = 'CSV åŒ¯å…¥å¤±æ•—ï¼š\\n';\n   845â†’                if (err.message) {\n   846â†’                    errorMessage += err.message;\n   847â†’                } else {\n   848â†’                    errorMessage += 'æœªçŸ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ç²å–æ›´å¤šè³‡è¨Šã€‚';\n   849â†’                }\n   850â†’                alert(errorMessage);\n   851â†’            }\n   852â†’        };\n   853â†’        reader.readAsText(file, 'utf-8');\n   854â†’    };\n   855â†’    input.click();\n   856â†’}\n   857â†’\n   858â†’// ==================== é¦–é æ¨¡æ…‹æ¡†åŠŸèƒ½ ====================\n   859â†’\n   860â†’// é¡¯ç¤ºåŸºæœ¬è³‡æ–™è¨­å®šæ¨¡æ…‹æ¡†\n   861â†’function showBasicInfoModal() {\n   862â†’    const modal = document.getElementById('basic-info-modal');\n   863â†’    const basicInfo = loadGlobalBasicInfo();\n   864â†’    \n   865â†’    // è¼‰å…¥ç¾æœ‰è³‡æ–™\n   866â†’    if (basicInfo) {\n   867â†’        document.getElementById('modal-employeeName').value = basicInfo.employeeName || '';\n   868â†’        document.getElementById('modal-employeeType').value = basicInfo.employeeType || '';\n   869â†’    }\n   870â†’    \n   871â†’    modal.style.display = 'block';\n   872â†’}\n   873â†’\n   874â†’// éš±è—åŸºæœ¬è³‡æ–™è¨­å®šæ¨¡æ…‹æ¡†\n   875â†’function hideBasicInfoModal() {\n   876â†’    const modal = document.getElementById('basic-info-modal');\n   877â†’    modal.style.display = 'none';\n   878â†’    \n   879â†’    // æ¸…ç©ºè¡¨å–®\n   880â†’    document.getElementById('modal-basic-info-form').reset();\n   881â†’}\n   882â†’\n   883â†’// å„²å­˜æ¨¡æ…‹æ¡†ä¸­çš„åŸºæœ¬è³‡æ–™\n   884â†’function saveModalBasicInfo() {\n   885â†’    const employeeName = document.getElementById('modal-employeeName').value.trim();\n   886â†’    const employeeType = document.getElementById('modal-employeeType').value;\n   887â†’    \n   888â†’    if (!employeeName || !employeeType) {\n   889â†’        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');\n   890â†’        return;\n   891â†’    }\n   892â†’    \n   893â†’    const basicInfo = {\n   894â†’        employeeName: employeeName,\n   895â†’        employeeType: employeeType\n   896â†’    };\n   897â†’    \n   898â†’    saveGlobalBasicInfo(basicInfo);\n   899â†’    hideBasicInfoModal();\n   900â†’    alert('åŸºæœ¬è³‡æ–™å·²å„²å­˜æˆåŠŸï¼ï¼ˆå…¨ App å…±ç”¨ï¼‰');\n   901â†’}\n   902â†’\n   903â†’// åˆå§‹åŒ–ï¼šé é¢åŠ è¼‰å®Œæˆå¾Œæ¸²æŸ“å¡ç‰‡ï¼Œä¸¦ç¶å®šæŒ‰éˆ•äº‹ä»¶\n   904â†’document.addEventListener('DOMContentLoaded', () => {\n   905â†’    // æª¢æŸ¥æ˜¯å¦ç‚ºé¦–é \n   906â†’    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n   907â†’        renderTimesheetCards();\n   908â†’        \n   909â†’        // ç¶å®šå…¨å±€æŒ‰éˆ•äº‹ä»¶\n   910â†’        document.getElementById('btn-basic-info').addEventListener('click', showBasicInfoModal);\n   911â†’        document.getElementById('btn-new').addEventListener('click', newTimesheet);\n   912â†’        document.getElementById('btn-import').addEventListener('click', importTimesheet);\n   913â†’        document.getElementById('btn-clear-storage').addEventListener('click', () => {\n   914â†’            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸã€‚')) {\n   915â†’                localStorage.clear();\n   916â†’                renderTimesheetCards();\n   917â†’                alert('localStorage å·²æ¸…ç©º');\n   918â†’            }\n   919â†’        });\n   920â†’        \n   921â†’        // ç¶å®šåŸºæœ¬è³‡æ–™æ¨¡æ…‹æ¡†äº‹ä»¶\n   922â†’        document.getElementById('btn-save-modal-basic-info').addEventListener('click', saveModalBasicInfo);\n   923â†’        document.getElementById('btn-cancel-modal').addEventListener('click', hideBasicInfoModal);\n   924â†’        document.querySelector('.close').addEventListener('click', hideBasicInfoModal);\n   925â†’        \n   926â†’        // ç¶å®šé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†äº‹ä»¶\n   927â†’        const weekModal = document.getElementById('week-selection-modal');\n   928â†’        if (weekModal) {\n   929â†’            const weekCloseBtn = weekModal.querySelector('.close');\n   930â†’            const confirmWeekBtn = document.getElementById('btn-confirm-week');\n   931â†’            const cancelWeekBtn = document.getElementById('btn-cancel-week');\n   932â†’            const customRadio = document.getElementById('radio-custom');\n   933â†’            const customInput = document.getElementById('custom-week-input');\n   934â†’            \n   935â†’            if (weekCloseBtn) weekCloseBtn.addEventListener('click', hideWeekSelectionModal);\n   936â†’            if (cancelWeekBtn) cancelWeekBtn.addEventListener('click', hideWeekSelectionModal);\n   937â†’            if (confirmWeekBtn) confirmWeekBtn.addEventListener('click', confirmWeekSelection);\n   938â†’            \n   939â†’            // ç›£è½è‡ªè¨‚é¸é …çš„é¸æ“‡\n   940â†’            if (customRadio && customInput) {\n   941â†’                customRadio.addEventListener('change', function() {\n   942â†’                    if (this.checked) {\n   943â†’                        customInput.style.display = 'block';\n   944â†’                    }\n   945â†’                });\n   946â†’            }\n   947â†’            \n   948â†’            // ç›£è½å…¶ä»–é¸é …çš„é¸æ“‡ï¼ˆéš±è—è‡ªè¨‚è¼¸å…¥ï¼‰\n   949â†’            document.querySelectorAll('input[name=\"weekOption\"]:not(#radio-custom)').forEach(radio => {\n   950â†’                radio.addEventListener('change', function() {\n   951â†’                    if (this.checked && customInput) {\n   952â†’                        customInput.style.display = 'none';\n   953â†’                    }\n   954â†’                });\n   955â†’            });\n   956â†’        }\n   957â†’        \n   958â†’        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰\n   959â†’        window.addEventListener('click', (event) => {\n   960â†’            const basicModal = document.getElementById('basic-info-modal');\n   961â†’            const weekSelectionModal = document.getElementById('week-selection-modal');\n   962â†’            \n   963â†’            if (event.target === basicModal) {\n   964â†’                hideBasicInfoModal();\n   965â†’            } else if (event.target === weekSelectionModal) {\n   966â†’                hideWeekSelectionModal();\n   967â†’            }\n   968â†’        });\n   969â†’\n   970â†’        // è¨­ç½®ä¸Šé€±æŒ‰éˆ•çš„æ–‡å­—å’Œé¡¯ç¤ºç‹€æ…‹\n   971â†’        const lastWeekButton = document.getElementById('btn-last-week');\n   972â†’        if (lastWeekButton) {\n   973â†’            updateLastWeekButtonDisplay();\n   974â†’            // ç¶å®šé»æ“Šäº‹ä»¶\n   975â†’            lastWeekButton.addEventListener('click', createLastWeekTimesheet);\n   976â†’        }\n   977â†’    }\n   978â†’});\n   979â†’\n   980â†’// æ›´æ–°ä¸Šé€±æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹å’Œæ–‡å­—\n   981â†’function updateLastWeekButtonDisplay() {\n   982â†’    const today = new Date();\n   983â†’    // æ›´ç²¾ç¢ºçš„è¨ˆç®—ï¼šç²å–ä¸Šé€±ä¸€ï¼ˆä»Šå¤©æ¸›å»ä»Šå¤©æ˜ŸæœŸå¹¾å†æ¸›6å¤©ï¼‰\n   984â†’    const lastMonday = new Date(today);\n   985â†’    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n   986â†’    const lastSunday = new Date(lastMonday);\n   987â†’    lastSunday.setDate(lastMonday.getDate() + 6);\n   988â†’    \n   989â†’    const button = document.getElementById('btn-last-week');\n   990â†’    const container = document.getElementById('last-week-container');\n   991â†’    \n   992â†’    if (button && container) {\n   993â†’        // æª¢æŸ¥ä¸Šé€±æ˜¯å¦å·²å­˜åœ¨\n   994â†’        const lastWeekKey = getLastWeekKey();\n   995â†’        const timesheets = loadAllTimesheets();\n   996â†’        \n   997â†’        if (timesheets[lastWeekKey]) {\n   998â†’            // ä¸Šé€±å·²å­˜åœ¨ï¼Œéš±è—æŒ‰éˆ•\n   999â†’            container.style.display = 'none';\n  1000â†’        } else {\n  1001â†’            // ä¸Šé€±ä¸å­˜åœ¨ï¼Œé¡¯ç¤ºæŒ‰éˆ•ä¸¦è¨­ç½®æ–‡å­—\n  1002â†’            container.style.display = 'block';\n  1003â†’            button.textContent = `å»ºç«‹ä¸Šé€±å·¥æ™‚è¡¨ (${formatDate(lastMonday)} - ${formatDate(lastSunday)})`;\n  1004â†’        }\n  1005â†’    }\n  1006â†’}\n  1007â†’\n  1008â†’// å»ºç«‹ä¸Šé€±å·¥æ™‚è¡¨\n  1009â†’function createLastWeekTimesheet() {\n  1010â†’    const today = new Date();\n  1011â†’    const lastMonday = new Date(today);\n  1012â†’    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n  1013â†’    const lastSunday = new Date(lastMonday);\n  1014â†’    lastSunday.setDate(lastMonday.getDate() + 6);\n  1015â†’    \n  1016â†’    // ç”Ÿæˆé€±æ¬¡æ ¼å¼ YYYY-Www\n  1017â†’    const year = lastMonday.getFullYear();\n  1018â†’    const weekNumber = Math.ceil((((lastMonday - new Date(year, 0, 1)) / 86400000) + new Date(year, 0, 1).getDay() + 1) / 7);\n  1019â†’    const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n  1020â†’    \n  1021â†’    const timesheets = loadAllTimesheets();\n  1022â†’    if (!timesheets[weekKey]) {\n  1023â†’        timesheets[weekKey] = [];\n  1024â†’        saveAllTimesheets(timesheets);\n  1025â†’    }\n  1026â†’    \n  1027â†’    // è¼‰å…¥ä¸Šé€±å·¥æ™‚è¡¨\n  1028â†’    editTimesheet(weekKey);\n  1029â†’    renderTimesheetCards();\n  1030â†’}\n  1031â†’\n  1032â†’// ==================== ç·¨è¼¯é é¢åŠŸèƒ½ ====================\n  1033â†’\n  1034â†’// ç”Ÿæˆå”¯ä¸€ ID\n  1035â†’function generateUniqueId() {\n  1036â†’    return Date.now().toString(36) + Math.random().toString(36).substr(2);\n  1037â†’}\n  1038â†’\n  1039â†’// ç²å–ç•¶å‰ç·¨è¼¯çš„é€±æ¬¡\n  1040â†’function getCurrentWeekKey() {\n  1041â†’    const urlParams = new URLSearchParams(window.location.search);\n  1042â†’    return urlParams.get('week');\n  1043â†’}\n  1044â†’\n  1045â†’// ==================== å…¨åŸŸåŸºæœ¬è³‡æ–™ç®¡ç† ====================\n  1046â†’\n  1047â†’// è¼‰å…¥å…¨åŸŸåŸºæœ¬è³‡æ–™\n  1048â†’function loadGlobalBasicInfo() {\n  1049â†’    const data = localStorage.getItem('globalBasicInfo');\n  1050â†’    return data ? JSON.parse(data) : null;\n  1051â†’}\n  1052â†’\n  1053â†’// å„²å­˜å…¨åŸŸåŸºæœ¬è³‡æ–™\n  1054â†’function saveGlobalBasicInfo(basicInfo) {\n  1055â†’    localStorage.setItem('globalBasicInfo', JSON.stringify(basicInfo));\n  1056â†’}\n  1057â†’\n  1058â†’// ==================== å·¥æ™‚è¨˜éŒ„ç®¡ç† ====================\n  1059â†’\n  1060â†’// ç²å–æŒ‡å®šé€±æ¬¡çš„å·¥æ™‚è¨˜éŒ„\n  1061â†’function getWeekEntries(weekKey) {\n  1062â†’    const timesheets = loadAllTimesheets();\n  1063â†’    const weekData = timesheets[weekKey];\n  1064â†’    \n  1065â†’    // è™•ç†ä¸åŒçš„è³‡æ–™çµæ§‹\n  1066â†’    if (Array.isArray(weekData)) {\n  1067â†’        // èˆŠçš„è³‡æ–™çµæ§‹ï¼Œç›´æ¥æ˜¯é™£åˆ—\n  1068â†’        return weekData;\n  1069â†’    } else if (weekData && weekData.entries) {\n  1070â†’        // æ–°çš„è³‡æ–™çµæ§‹ï¼Œæœ‰ entries\n  1071â†’        return weekData.entries;\n  1072â†’    }\n  1073â†’    \n  1074â†’    return [];\n  1075â†’}\n  1076â†’\n  1077â†’// å„²å­˜æŒ‡å®šé€±æ¬¡çš„å·¥æ™‚è¨˜éŒ„\n  1078â†’function saveWeekEntries(weekKey, entries) {\n  1079â†’    const timesheets = loadAllTimesheets();\n  1080â†’    timesheets[weekKey] = entries; // ç›´æ¥å„²å­˜ç‚ºé™£åˆ—ï¼Œç°¡åŒ–çµæ§‹\n  1081â†’    saveAllTimesheets(timesheets);\n  1082â†’}\n  1083â†’\n  1084â†’// è¨ˆç®—ç¸½å·¥æ™‚\n  1085â†’function calculateTotalHours() {\n  1086â†’    const regular = parseFloat(document.getElementById('regularHours').value) || 0;\n  1087â†’    const ot = parseFloat(document.getElementById('otHours').value) || 0;\n  1088â†’    document.getElementById('ttlHours').value = regular + ot;\n  1089â†’}\n  1090â†’\n  1091â†’// é©—è­‰åŸºæœ¬è³‡æ–™è¡¨å–®\n  1092â†’function validateBasicInfo() {\n  1093â†’    const requiredFields = ['employeeName', 'employeeType'];\n  1094â†’    let isValid = true;\n  1095â†’    \n  1096â†’    // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤ç‹€æ…‹\n  1097â†’    document.querySelectorAll('#basic-info-form .form-field.error').forEach(field => {\n  1098â†’        field.classList.remove('error');\n  1099â†’    });\n  1100â†’    \n  1101â†’    requiredFields.forEach(fieldName => {\n  1102â†’        const field = document.getElementById(fieldName);\n  1103â†’        const formField = field.closest('.form-field');\n  1104â†’        \n  1105â†’        if (!field.value.trim()) {\n  1106â†’            formField.classList.add('error');\n  1107â†’            showFieldError(formField, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');\n  1108â†’            isValid = false;\n  1109â†’        }\n  1110â†’    });\n  1111â†’    \n  1112â†’    return isValid;\n  1113â†’}\n  1114â†’\n  1115â†’// é©—è­‰å·¥æ™‚è¨˜éŒ„è¡¨å–®\n  1116â†’function validateForm() {\n  1117â†’    const requiredFields = ['task', 'zone', 'project', 'activityType', 'regularHours', 'date'];\n  1118â†’    let isValid = true;\n  1119â†’    \n  1120â†’    // æª¢æŸ¥æ˜¯å¦å·²å„²å­˜å…¨åŸŸåŸºæœ¬è³‡æ–™\n  1121â†’    const basicInfo = loadGlobalBasicInfo();\n  1122â†’    if (!basicInfo) {\n  1123â†’        alert('è«‹å…ˆå¡«å¯«ä¸¦å„²å­˜åŸºæœ¬è³‡æ–™');\n  1124â†’        document.querySelector('.basic-info-container').scrollIntoView({ behavior: 'smooth' });\n  1125â†’        return false;\n  1126â†’    }\n  1127â†’    \n  1128â†’    // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤ç‹€æ…‹\n  1129â†’    document.querySelectorAll('#timesheet-form .form-field.error').forEach(field => {\n  1130â†’        field.classList.remove('error');\n  1131â†’    });\n  1132â†’    \n  1133â†’    requiredFields.forEach(fieldName => {\n  1134â†’        const field = document.getElementById(fieldName);\n  1135â†’        const formField = field.closest('.form-field');\n  1136â†’        \n  1137â†’        if (!field.value.trim()) {\n  1138â†’            formField.classList.add('error');\n  1139â†’            showFieldError(formField, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');\n  1140â†’            isValid = false;\n  1141â†’        }\n  1142â†’    });\n  1143â†’    \n  1144â†’    // é©—è­‰å·¥æ™‚ç¯„åœ\n  1145â†’    const regularHours = parseFloat(document.getElementById('regularHours').value);\n  1146â†’    const otHours = parseFloat(document.getElementById('otHours').value) || 0;\n  1147â†’    \n  1148â†’    if (regularHours < 0 || regularHours > 24) {\n  1149â†’        const formField = document.getElementById('regularHours').closest('.form-field');\n  1150â†’        formField.classList.add('error');\n  1151â†’        showFieldError(formField, 'æ­£å¸¸å·¥æ™‚å¿…é ˆåœ¨ 0-24 å°æ™‚ä¹‹é–“');\n  1152â†’        isValid = false;\n  1153â†’    }\n  1154â†’    \n  1155â†’    if (otHours < 0 || otHours > 24) {\n  1156â†’        const formField = document.getElementById('otHours').closest('.form-field');\n  1157â†’        formField.classList.add('error');\n  1158â†’        showFieldError(formField, 'åŠ ç­å·¥æ™‚å¿…é ˆåœ¨ 0-24 å°æ™‚ä¹‹é–“');\n  1159â†’        isValid = false;\n  1160â†’    }\n  1161â†’    \n  1162â†’    // å…è¨±æ­£å¸¸å·¥æ™‚ç¸½è¨ˆè¶…é40å°æ™‚ï¼Œåƒ…æ–¼åŒ¯å‡ºæ™‚æç¤ºæ­£è¦åŒ–\n  1163â†’    const weekKey = getCurrentWeekKey();\n  1164â†’    const currentEntryId = document.getElementById('entryId').value;\n  1165â†’    const entries = getWeekEntries(weekKey);\n  1166â†’    \n  1167â†’    // è¨ˆç®—é™¤äº†ç•¶å‰ç·¨è¼¯è¨˜éŒ„å¤–çš„å…¶ä»–è¨˜éŒ„çš„æ­£å¸¸å·¥æ™‚ç¸½å’Œ\n  1168â†’    let totalRegularHours = 0;\n  1169â†’    entries.forEach(entry => {\n  1170â†’        if (entry.id !== currentEntryId) {\n  1171â†’            totalRegularHours += entry.regularHours || 0;\n  1172â†’        }\n  1173â†’    });\n  1174â†’    \n  1175â†’    // åŠ ä¸Šç•¶å‰è¼¸å…¥çš„æ­£å¸¸å·¥æ™‚\n  1176â†’    totalRegularHours += regularHours;\n  1177â†’    \n  1178â†’    // ä¸å†æ–¼æ­¤è™•é™åˆ¶æˆ–æç¤ºï¼Œåƒ…æ–¼åŒ¯å‡ºæ™‚è™•ç†æ­£è¦åŒ–\n  1179â†’    \n  1180â†’    // é©—è­‰æ—¥æœŸé‚è¼¯\n  1181â†’    const startDate = document.getElementById('startDate').value;\n  1182â†’    const endDate = document.getElementById('endDate').value;\n  1183â†’    const date = document.getElementById('date').value;\n  1184â†’    \n  1185â†’    // ç²å–ç•¶å‰é€±çš„æ—¥æœŸç¯„åœï¼ˆä½¿ç”¨å·²å®£å‘Šçš„ weekKeyï¼‰\n  1186â†’    const [year, week] = weekKey.split('-');\n  1187â†’    const weekNumber = parseInt(week.substring(1));\n  1188â†’    const weekRange = getWeekDateRange(weekNumber, year);\n  1189â†’    \n  1190â†’    // é©—è­‰ä¸»è¦æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n  1191â†’    if (date && !validateDateInWeekRange(date, weekRange.start, weekRange.end)) {\n  1192â†’        const formField = document.getElementById('date').closest('.form-field');\n  1193â†’        formField.classList.add('error');\n  1194â†’        showFieldError(formField, `æ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n  1195â†’        isValid = false;\n  1196â†’    }\n  1197â†’    \n  1198â†’    // é©—è­‰é–‹å§‹æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n  1199â†’    if (startDate && !validateDateInWeekRange(startDate, weekRange.start, weekRange.end)) {\n  1200â†’        const formField = document.getElementById('startDate').closest('.form-field');\n  1201â†’        formField.classList.add('error');\n  1202â†’        showFieldError(formField, `é–‹å§‹æ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n  1203â†’        isValid = false;\n  1204â†’    }\n  1205â†’    \n  1206â†’    // é©—è­‰çµæŸæ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n  1207â†’    if (endDate && !validateDateInWeekRange(endDate, weekRange.start, weekRange.end)) {\n  1208â†’        const formField = document.getElementById('endDate').closest('.form-field');\n  1209â†’        formField.classList.add('error');\n  1210â†’        showFieldError(formField, `çµæŸæ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n  1211â†’        isValid = false;\n  1212â†’    }\n  1213â†’    \n  1214â†’    // é©—è­‰é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ\n  1215â†’    if (startDate && endDate && new Date(startDate) > new Date(endDate)) {\n  1216â†’        const formField = document.getElementById('endDate').closest('.form-field');\n  1217â†’        formField.classList.add('error');\n  1218â†’        showFieldError(formField, 'çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ');\n  1219â†’        isValid = false;\n  1220â†’    }\n  1221â†’    \n  1222â†’    return isValid;\n  1223â†’}\n  1224â†’\n  1225â†’// é¡¯ç¤ºæ¬„ä½éŒ¯èª¤è¨Šæ¯\n  1226â†’function showFieldError(formField, message) {\n  1227â†’    let errorDiv = formField.querySelector('.error-message');\n  1228â†’    if (!errorDiv) {\n  1229â†’        errorDiv = document.createElement('div');\n  1230â†’        errorDiv.className = 'error-message';\n  1231â†’        formField.appendChild(errorDiv);\n  1232â†’    }\n  1233â†’    errorDiv.textContent = message;\n  1234â†’}\n  1235â†’\n  1236â†’// æ¸…ç©ºè¡¨å–®\n  1237â†’function clearForm() {\n  1238â†’    document.getElementById('timesheet-form').reset();\n  1239â†’    document.getElementById('entryId').value = '';\n  1240â†’    document.getElementById('ttlHours').value = '';\n  1241â†’    \n  1242â†’    // æ¸…é™¤éŒ¯èª¤ç‹€æ…‹\n  1243â†’    document.querySelectorAll('.form-field.error').forEach(field => {\n  1244â†’        field.classList.remove('error');\n  1245â†’    });\n  1246â†’}\n  1247â†’\n  1248â†’// ç²å–åŸºæœ¬è³‡æ–™\n  1249â†’function getBasicInfoData() {\n  1250â†’    return {\n  1251â†’        employeeName: document.getElementById('employeeName').value.trim(),\n  1252â†’        employeeType: document.getElementById('employeeType').value\n  1253â†’    };\n  1254â†’}\n  1255â†’\n  1256â†’// å¡«å……åŸºæœ¬è³‡æ–™\n  1257â†’function fillBasicInfo(basicInfo) {\n  1258â†’    if (basicInfo) {\n  1259â†’        document.getElementById('employeeName').value = basicInfo.employeeName || '';\n  1260â†’        document.getElementById('employeeType').value = basicInfo.employeeType || '';\n  1261â†’    }\n  1262â†’}\n  1263â†’\n  1264â†’// å¾è¡¨å–®ç²å–å·¥æ™‚è¨˜éŒ„æ•¸æ“š\n  1265â†’function getFormData() {\n  1266â†’    const basicInfo = loadGlobalBasicInfo();\n  1267â†’    const originalHours = document.getElementById('originalHours').value;\n  1268â†’    \n  1269â†’    const data = {\n  1270â†’        id: document.getElementById('entryId').value || generateUniqueId(),\n  1271â†’        // å¾å…¨åŸŸåŸºæœ¬è³‡æ–™å¼•ç”¨\n  1272â†’        name: basicInfo ? basicInfo.employeeName : '',\n  1273â†’        internalOrOutsource: basicInfo ? basicInfo.employeeType : '',\n  1274â†’        // å·¥æ™‚è¨˜éŒ„ç‰¹å®šæ¬„ä½\n  1275â†’        zone: document.getElementById('zone').value,\n  1276â†’        project: document.getElementById('project').value.trim(),\n  1277â†’        productModule: document.getElementById('productModule').value.trim(),\n  1278â†’        activityType: document.getElementById('activityType').value,\n  1279â†’        task: document.getElementById('task').value.trim(),\n  1280â†’        regularHours: parseFloat(document.getElementById('regularHours').value) || 0,\n  1281â†’        otHours: parseFloat(document.getElementById('otHours').value) || 0,\n  1282â†’        ttlHours: parseFloat(document.getElementById('ttlHours').value) || 0,\n  1283â†’        date: document.getElementById('date').value,\n  1284â†’        startDate: document.getElementById('startDate').value,\n  1285â†’        endDate: document.getElementById('endDate').value,\n  1286â†’        comments: document.getElementById('comments').value.trim(),\n  1287â†’        pm: document.getElementById('pm').value.trim()\n  1288â†’    };\n  1289â†’    \n  1290â†’    // å¦‚æœæœ‰åŸå§‹å·¥æ™‚ï¼ˆæ­£è¦åŒ–æ¨¡å¼ï¼‰ï¼Œå‰‡å„²å­˜ä½†æ¨™è¨˜ç‚ºå…§éƒ¨ä½¿ç”¨\n  1291â†’    if (originalHours && parseFloat(originalHours) > 0) {\n  1292â†’        data._originalHours = parseFloat(originalHours); // ä½¿ç”¨ _ å‰ç¶´æ¨™è¨˜ç‚ºå…§éƒ¨æ¬„ä½\n  1293â†’        data._isNormalized = true;\n  1294â†’    }\n  1295â†’    \n  1296â†’    return data;\n  1297â†’}\n  1298â†’\n  1299â†’// å¡«å……å·¥æ™‚è¨˜éŒ„è¡¨å–®æ•¸æ“š\n  1300â†’function fillForm(entry) {\n  1301â†’    document.getElementById('entryId').value = entry.id;\n  1302â†’    document.getElementById('zone').value = entry.zone || '';\n  1303â†’    document.getElementById('project').value = entry.project || '';\n  1304â†’    document.getElementById('productModule').value = entry.productModule || '';\n  1305â†’    document.getElementById('activityType').value = entry.activityType || '';\n  1306â†’    document.getElementById('task').value = entry.task || '';\n  1307â†’    document.getElementById('regularHours').value = entry.regularHours || '';\n  1308â†’    document.getElementById('otHours').value = entry.otHours || 0;\n  1309â†’    document.getElementById('ttlHours').value = entry.ttlHours || '';\n  1310â†’    document.getElementById('date').value = entry.date || '';\n  1311â†’    document.getElementById('startDate').value = entry.startDate || '';\n  1312â†’    document.getElementById('endDate').value = entry.endDate || '';\n  1313â†’    document.getElementById('comments').value = entry.comments || '';\n  1314â†’    document.getElementById('pm').value = entry.pm || '';\n  1315â†’    \n  1316â†’    // è™•ç†åŸå§‹å·¥æ™‚æ¬„ä½ï¼ˆæ­£è¦åŒ–æ¨¡å¼ï¼‰\n  1317â†’    const originalHoursField = document.getElementById('originalHoursField');\n  1318â†’    if (entry._originalHours && entry._isNormalized) {\n  1319â†’        document.getElementById('originalHours').value = entry._originalHours;\n  1320â†’        originalHoursField.style.display = 'block';\n  1321â†’    } else {\n  1322â†’        document.getElementById('originalHours').value = '';\n  1323â†’        originalHoursField.style.display = 'none';\n  1324â†’    }\n  1325â†’}\n  1326â†’\n  1327â†’// å„²å­˜åŸºæœ¬è³‡æ–™\n  1328â†’function saveBasicInfo() {\n  1329â†’    if (!validateBasicInfo()) {\n  1330â†’        return;\n  1331â†’    }\n  1332â†’    \n  1333â†’    const basicInfoData = getBasicInfoData();\n  1334â†’    saveGlobalBasicInfo(basicInfoData);\n  1335â†’    \n  1336â†’    // æ›´æ–° UI ç‹€æ…‹\n  1337â†’    const container = document.querySelector('.basic-info-container');\n  1338â†’    container.classList.add('basic-info-saved');\n  1339â†’    \n  1340â†’    showSuccessMessage('åŸºæœ¬è³‡æ–™å·²å„²å­˜æˆåŠŸï¼ï¼ˆå…¨ App å…±ç”¨ï¼‰');\n  1341â†’}\n  1342â†’\n  1343â†’// å„²å­˜å·¥æ™‚è¨˜éŒ„\n  1344â†’function saveEntry() {\n  1345â†’    if (!validateForm()) {\n  1346â†’        return;\n  1347â†’    }\n  1348â†’    \n  1349â†’    const weekKey = getCurrentWeekKey();\n  1350â†’    if (!weekKey) {\n  1351â†’        alert('ç„¡æ•ˆçš„é€±æ¬¡åƒæ•¸');\n  1352â†’        return;\n  1353â†’    }\n  1354â†’    \n  1355â†’    const formData = getFormData();\n  1356â†’    const entries = getWeekEntries(weekKey);\n  1357â†’    \n  1358â†’    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°å¢æˆ–ç·¨è¼¯\n  1359â†’    const existingIndex = entries.findIndex(entry => entry.id === formData.id);\n  1360â†’    \n  1361â†’    if (existingIndex !== -1) {\n  1362â†’        // ç·¨è¼¯ç¾æœ‰è¨˜éŒ„\n  1363â†’        entries[existingIndex] = formData;\n  1364â†’    } else {\n  1365â†’        // æ–°å¢è¨˜éŒ„\n  1366â†’        entries.push(formData);\n  1367â†’    }\n  1368â†’    \n  1369â†’    saveWeekEntries(weekKey, entries);\n  1370â†’    renderEntriesList();\n  1371â†’    clearForm();\n  1372â†’    showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²å„²å­˜æˆåŠŸï¼');\n  1373â†’}\n  1374â†’\n  1375â†’// ç·¨è¼¯å·¥æ™‚è¨˜éŒ„\n  1376â†’function editEntry(entryId) {\n  1377â†’    const weekKey = getCurrentWeekKey();\n  1378â†’    const entries = getWeekEntries(weekKey);\n  1379â†’    const entry = entries.find(e => e.id === entryId);\n  1380â†’    \n  1381â†’    if (entry) {\n  1382â†’        fillForm(entry);\n  1383â†’        // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨\n  1384â†’        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n  1385â†’    }\n  1386â†’}\n  1387â†’\n  1388â†’// è¤‡è£½å·¥æ™‚è¨˜éŒ„\n  1389â†’function copyEntry(entryId) {\n  1390â†’    const weekKey = getCurrentWeekKey();\n  1391â†’    const entries = getWeekEntries(weekKey);\n  1392â†’    const entry = entries.find(e => e.id === entryId);\n  1393â†’    \n  1394â†’    if (entry) {\n  1395â†’        // ç²å–ç•¶é€±æ—¥æœŸç¯„åœ\n  1396â†’        const [year, week] = weekKey.split('-');\n  1397â†’        const weekNumber = parseInt(week.substring(1));\n  1398â†’        const weekRange = getWeekDateRange(weekNumber, year);\n  1399â†’        \n  1400â†’        // è¤‡è£½è¨˜éŒ„è³‡æ–™ä¸¦æ›´æ–°æ—¥æœŸ\n  1401â†’        const copiedEntry = { ...entry, id: generateUniqueId() };\n  1402â†’        \n  1403â†’        // æ›´æ–°æ—¥æœŸï¼ˆå¦‚æœæ˜¯å–®æ—¥è¨˜éŒ„ï¼‰\n  1404â†’        if (copiedEntry.date) {\n  1405â†’            const originalDate = new Date(copiedEntry.date);\n  1406â†’            const nextDate = new Date(originalDate);\n  1407â†’            nextDate.setDate(originalDate.getDate() + 1);\n  1408â†’            \n  1409â†’            // æª¢æŸ¥æ˜¯å¦è¶…éé€±ç¯„åœ\n  1410â†’            if (nextDate <= weekRange.end) {\n  1411â†’                copiedEntry.date = formatDate(nextDate);\n  1412â†’            } else {\n  1413â†’                // å¦‚æœæ˜¯é€±æœ€å¾Œä¸€å¤©ï¼Œå‰‡é‡ç½®ç‚ºé€±ç¬¬ä¸€å¤©\n  1414â†’                copiedEntry.date = formatDate(weekRange.start);\n  1415â†’            }\n  1416â†’        }\n  1417â†’        \n  1418â†’        fillForm(copiedEntry);\n  1419â†’        // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨\n  1420â†’        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n  1421â†’        showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²è¤‡è£½ï¼Œæ—¥æœŸå·²è‡ªå‹•èª¿æ•´');\n  1422â†’    }\n  1423â†’}\n  1424â†’\n  1425â†’// åˆªé™¤å·¥æ™‚è¨˜éŒ„\n  1426â†’function deleteEntry(entryId) {\n  1427â†’    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å·¥æ™‚è¨˜éŒ„å—ï¼Ÿ')) {\n  1428â†’        return;\n  1429â†’    }\n  1430â†’    \n  1431â†’    const weekKey = getCurrentWeekKey();\n  1432â†’    const entries = getWeekEntries(weekKey);\n  1433â†’    const filteredEntries = entries.filter(entry => entry.id !== entryId);\n  1434â†’    \n  1435â†’    saveWeekEntries(weekKey, filteredEntries);\n  1436â†’    renderEntriesList();\n  1437â†’    showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²åˆªé™¤ï¼');\n  1438â†’}\n  1439â†’\n  1440â†’// æ¸²æŸ“å·¥æ™‚è¨˜éŒ„åˆ—è¡¨\n  1441â†’function renderEntriesList() {\n  1442â†’    const weekKey = getCurrentWeekKey();\n  1443â†’    const entries = getWeekEntries(weekKey);\n  1444â†’    const tbody = document.getElementById('entries-tbody');\n  1445â†’    \n  1446â†’    if (!tbody) return;\n  1447â†’    \n  1448â†’    tbody.innerHTML = '';\n  1449â†’    \n  1450â†’    let totalHours = 0;\n  1451â†’    \n  1452â†’    entries.forEach(entry => {\n  1453â†’        totalHours += entry.ttlHours || 0;\n  1454â†’        \n  1455â†’        const row = document.createElement('tr');\n  1456â†’        row.innerHTML = `\n  1457â†’            <td>${entry.date || '-'}</td>\n  1458â†’            <td>${entry.zone || '-'}</td>\n  1459â†’            <td>${entry.activityType || '-'}</td>\n  1460â†’            <td>${entry.task || '-'}</td>\n  1461â†’            <td>${entry.regularHours || 0}</td>\n  1462â†’            <td>${entry.otHours || 0}</td>\n  1463â†’            <td><strong>${entry.ttlHours || 0}</strong></td>\n  1464â†’            <td class=\"entry-actions\">\n  1465â†’                <button class=\"btn-edit-entry\" onclick=\"editEntry('${entry.id}')\">ç·¨è¼¯</button>\n  1466â†’                <button class=\"btn-copy-entry\" onclick=\"copyEntry('${entry.id}')\">è¤‡è£½</button>\n  1467â†’                <button class=\"btn-delete-entry\" onclick=\"deleteEntry('${entry.id}')\">åˆªé™¤</button>\n  1468â†’            </td>\n  1469â†’        `;\n  1470â†’        tbody.appendChild(row);\n  1471â†’    });\n  1472â†’    \n  1473â†’    \n  1474â†’    alert('æˆåŠŸè¤‡è£½ ' + copiedEntries.length + ' ç­†å·¥æ™‚è¨˜éŒ„åˆ°ç›®æ¨™é€±ï¼\\n\\nä¾†æºé€±ï¼š' + sourceWeekKey + '\\nç›®æ¨™é€±ï¼š' + targetWeekKey + '\\næ—¥æœŸç¯„åœï¼š' + startDate + ' ~ ' + endDate + '\\n\\næ‰€æœ‰æ—¥æœŸå·²è‡ªå‹•èª¿æ•´ç‚ºç›®æ¨™é€±å°æ‡‰æ—¥æœŸã€‚');\n  1475â†’}\n  1476â†’\n  1477â†’// é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n  1478â†’function showSuccessMessage(message) {\n  1479â†’    // å‰µå»ºæˆ–æ›´æ–°æˆåŠŸè¨Šæ¯å…ƒç´ \n  1480â†’    let successDiv = document.querySelector('.success-message');\n  1481â†’    if (!successDiv) {\n  1482â†’        successDiv = document.createElement('div');\n  1483â†’        successDiv.className = 'success-message';\n  1484â†’        document.querySelector('.form-container').insertBefore(successDiv, document.querySelector('.form-container').firstChild);\n  1485â†’    }\n  1486â†’    \n  1487â†’    successDiv.textContent = message;\n  1488â†’    successDiv.style.display = 'block';\n  1489â†’    \n  1490â†’    // 3ç§’å¾Œè‡ªå‹•éš±è—\n  1491â†’    setTimeout(() => {\n  1492â†’        successDiv.style.display = 'none';\n  1493â†’    }, 3000);\n  1494â†’}\n  1495â†’\n  1496â†’// åˆå§‹åŒ–ç·¨è¼¯é é¢\n  1497â†’async function initEditPage() {\n  1498â†’    const weekKey = getCurrentWeekKey();\n  1499â†’    if (!weekKey) {\n  1500â†’        alert('ç„¡æ•ˆçš„é€±æ¬¡åƒæ•¸');\n  1501â†’        window.location.href = 'index.html';\n  1502â†’        return;\n  1503â†’    }\n  1504â†’    \n  1505â†’    // è¼‰å…¥ CSV è³‡æ–™\n  1506â†’    await loadAllCSVData();\n  1507â†’    \n  1508â†’    // è¨­ç½®é€±æ¬¡æ¨™é¡Œå’Œæ—¥æœŸç¯„åœ\n  1509â†’    document.getElementById('week-title').textContent = weekKey;\n  1510â†’    \n  1511â†’    // è¨ˆç®—ä¸¦é¡¯ç¤ºæ—¥æœŸç¯„åœ\n  1512â†’    const [year, week] = weekKey.split('-');\n  1513â†’    const weekNumber = parseInt(week.substring(1));\n  1514â†’    const dateRange = getWeekDateRange(weekNumber, year);\n  1515â†’    const entries = getWeekEntries(weekKey) || [];\n  1516â†’    const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n  1517â†’    const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n  1518â†’    const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n  1519â†’\n  1520â†’    // å°‡çµ±è¨ˆè³‡è¨ŠåŠ åœ¨æ—¥æœŸå€å¡ŠåŒä¸€è¡Œ\n  1521â†’    const dateRangeDiv = document.getElementById('date-range');\n  1522â†’    dateRangeDiv.innerHTML =\n  1523â†’        `${formatDate(dateRange.start)} è‡³ ${formatDate(dateRange.end)}\n  1524â†’        <span style=\"color:#444;font-size:1em;\">\n  1525â†’        ç¸½æ­£å¸¸å·¥æ™‚ï¼š${totalRegularHours}\n  1526â†’        ç¸½åŠ ç­å·¥æ™‚ï¼š${totalOtHours}\n  1527â†’        ç¸½å·¥æ™‚ï¼š${totalHours}\n  1528â†’        </span>`;\n  1529â†’    // è¨­ç½®æ—¥æœŸæ¬„ä½çš„é™åˆ¶ç¯„åœ\n  1530â†’    setDateFieldLimits(dateRange.start, dateRange.end);\n  1531â†’    \n  1532â†’    // (å·²ç§»é™¤æ­£è¦åŒ–æ¨¡å¼ç‹€æ…‹é¡¯ç¤º)\n  1533â†’ \n  1534â†’    // è¼‰å…¥ä¸¦é¡¯ç¤ºå…¨åŸŸåŸºæœ¬è³‡æ–™\n  1535â†’    const basicInfo = loadGlobalBasicInfo();\n  1536â†’    if (basicInfo) {\n  1537â†’        fillBasicInfo(basicInfo);\n  1538â†’        document.querySelector('.basic-info-container').classList.add('basic-info-saved');\n  1539â†’    }\n  1540â†’    \n  1541â†’    // ç¶å®šåŸºæœ¬è³‡æ–™è¡¨å–®äº‹ä»¶\n  1542â†’    document.getElementById('btn-save-basic-info').addEventListener('click', saveBasicInfo);\n  1543â†’    \n  1544â†’    // ç¶å®šå·¥æ™‚è¨˜éŒ„è¡¨å–®äº‹ä»¶\n  1545â†’    document.getElementById('regularHours').addEventListener('input', calculateTotalHours);\n  1546â†’    document.getElementById('otHours').addEventListener('input', calculateTotalHours);\n  1547â†’    \n  1548â†’    // ç¶å®šæŒ‰éˆ•äº‹ä»¶\n  1549â†’    document.getElementById('btn-save-entry').addEventListener('click', saveEntry);\n  1550â†’    document.getElementById('btn-cancel-entry').addEventListener('click', clearForm);\n  1551â†’    document.getElementById('btn-clear-form').addEventListener('click', clearForm);\n  1552â†’    document.getElementById('btn-back').addEventListener('click', () => {\n  1553â†’        window.location.href = 'index.html';\n  1554â†’    });\n  1555â†’    \n  1556â†’    // ç¶å®šæ–°å¢è¨˜éŒ„æŒ‰éˆ•\n  1557â†’    document.getElementById('btn-add-entry').addEventListener('click', () => {\n  1558â†’        clearForm();\n  1559â†’        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n  1560â†’    });\n  1561â†’    \n  1562â†’    \n  1563â†’    // æ¸²æŸ“å·¥æ™‚è¨˜éŒ„åˆ—è¡¨\n  1564â†’    renderEntriesList();\n  1565â†’}\n  1566â†’\n  1567â†’// æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯é é¢ä¸¦åˆå§‹åŒ–\n  1568â†’if (window.location.pathname.includes('edit.html')) {\n  1569â†’    document.addEventListener('DOMContentLoaded', initEditPage);\n  1570â†’}\n  1571â†’// éš±è—é€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\n  1572â†’function hideWeekSelectionModal() {\n  1573â†’    const modal = document.getElementById('week-selection-modal');\n  1574â†’    modal.style.display = 'none';\n  1575â†’}\n  1576â†’\n  1577â†’// ç¢ºèªé€±æ¬¡é¸æ“‡ä¸¦å»ºç«‹å·¥æ™‚è¡¨\n  1578â†’function confirmWeekSelection() {\n  1579â†’    const selectedOption = document.querySelector('input[name=\"weekOption\"]:checked');\n  1580â†’    \n  1581â†’    if (!selectedOption) {\n  1582â†’        alert('è«‹é¸æ“‡ä¸€å€‹é€±æ¬¡é¸é …');\n  1583â†’        return;\n  1584â†’    }\n  1585â†’    \n  1586â†’    let weekKey = '';\n  1587â†’    \n  1588â†’    switch (selectedOption.value) {\n  1589â†’        case 'last':\n  1590â†’            weekKey = getLastWeekKey();\n  1591â†’            break;\n  1592â†’        case 'this':\n  1593â†’            weekKey = getThisWeekKey();\n  1594â†’            break;\n  1595â†’        case 'custom':\n  1596â†’            const customWeek = document.getElementById('custom-week-field').value.trim();\n  1597â†’            if (!customWeek) {\n  1598â†’                alert('è«‹è¼¸å…¥è‡ªè¨‚é€±æ¬¡');\n  1599â†’                return;\n  1600â†’            }\n  1601â†’            \n  1602â†’            // é©—è­‰æ ¼å¼\n  1603â†’            if (!/^\\d{4}-W\\d{2}$/.test(customWeek)) {\n  1604â†’                alert('é€±æ¬¡æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ä½¿ç”¨YYYY-Wwwæ ¼å¼ï¼ˆä¾‹å¦‚2024-W25ï¼‰');\n  1605â†’                return;\n  1606â†’            }\n  1607â†’            \n  1608â†’            weekKey = customWeek;\n  1609â†’            break;\n  1610â†’        default:\n  1611â†’            alert('ç„¡æ•ˆçš„é¸é …');\n  1612â†’            return;\n  1613â†’    }\n  1614â†’    \n  1615â†’    if (!weekKey) {\n  1616â†’        alert('ç„¡æ³•å–å¾—é€±æ¬¡è³‡è¨Š');\n  1617â†’        return;\n  1618â†’    }\n  1619â†’    \n  1620â†’    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨\n  1621â†’    const timesheets = loadAllTimesheets();\n  1622â†’    if (timesheets[weekKey]) {\n  1623â†’        alert(`é€±æ¬¡ ${weekKey} å·²å­˜åœ¨`);\n  1624â†’        return;\n  1625â†’    }\n  1626â†’    \n  1627â†’    // å‰µå»ºæ–°çš„å·¥æ™‚è¡¨\n  1628â†’    timesheets[weekKey] = [];\n  1629â†’    saveAllTimesheets(timesheets);\n  1630â†’    \n  1631â†’    // éš±è—æ¨¡æ…‹æ¡†\n  1632â†’    hideWeekSelectionModal();\n  1633â†’    \n  1634â†’    // é‡æ–°æ¸²æŸ“å¡ç‰‡\n  1635â†’    renderTimesheetCards();\n  1636â†’    \n  1637â†’    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n  1638â†’    showSuccessMessage(`æˆåŠŸå»ºç«‹é€±æ¬¡ ${weekKey} çš„å·¥æ™‚è¡¨`);\n  1639â†’}\n  1640â†’\n  1641â†’// é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n  1642â†’function showSuccessMessage(message) {\n  1643â†’    // å‰µå»ºæˆåŠŸè¨Šæ¯å…ƒç´ \n  1644â†’    const successDiv = document.createElement('div');\n  1645â†’    successDiv.className = 'success-message';\n  1646â†’    successDiv.innerHTML = `\n  1647â†’        <div class=\"success-content\">\n  1648â†’            <span class=\"success-icon\">âœ“</span>\n  1649â†’            <span class=\"success-text\">${message}</span>\n  1650â†’        </div>\n  1651â†’    `;\n  1652â†’    \n  1653â†’    // æ·»åŠ åˆ°é é¢\n  1654â†’    document.body.appendChild(successDiv);\n  1655â†’    \n  1656â†’    // 3ç§’å¾Œè‡ªå‹•ç§»é™¤\n  1657â†’    setTimeout(() => {\n  1658â†’        if (successDiv.parentNode) {\n  1659â†’            successDiv.parentNode.removeChild(successDiv);\n  1660â†’        }\n  1661â†’    }, 3000);\n  1662â†’}"}]},"uuid":"9c582497-9478-4891-824f-cc8481507483","timestamp":"2025-06-20T07:13:08.783Z","toolUseResult":{"type":"text","file":{"filePath":"/home/yanggf/a/timesheet/app.js","content":"import { loadAllTimesheets, saveAllTimesheets, loadGlobalBasicInfo, getWeekEntries, saveWeekEntries } from './modules/storageModule.js';\nimport { loadAllCSVData, getProjectsByZone, getPMByProject, getProductModulesByZone, updateProjectOptions, updateProjectDropdown, updateProductModuleDropdown, updateActivityTypeOptions, generateCSVContent, downloadCSVFile } from './modules/csvModule.js';\nimport { getWeekNumber, getWeekDateRangeFromKey } from './modules/dateModule.js';\nimport {\n    showSuccessMessage,\n    showCopyOptionsModal,\n    closeCopyModal,\n    handleCopySelection,\n    copyWeekToTargetWeek\n} from './modules/uiModule.js';\n        const sourceEndDate = sourceWeekRange.end.toISOString().split('T')[0];\n        sourceDescription = `${sourceWeekKey} å·¥æ™‚è¡¨ (${sourceStartDate} ~ ${sourceEndDate})`;\n    }\n    \n    // æ›´æ–°æ¨¡æ…‹è¦–çª—æ¨™é¡Œä»¥åŒ…å«ä¾†æºé€±è³‡è¨Š\n    document.querySelector('#copy-options-modal .modal-header h3').textContent =\n        `è¤‡è£½ ${sourceDescription} åˆ°å“ªä¸€é€±ï¼Ÿ`;\n    \n    // æ›´æ–°æ¨¡æ…‹è¦–çª—ä¸­çš„ç›®æ¨™é€±æ¬¡è³‡è¨Š\n    const currentWeekRange = getWeekDateRangeFromKey(currentWeekKey);\n    const lastWeekRange = getWeekDateRangeFromKey(lastWeekKey);\n    \n    document.getElementById('copy-current-week-info').textContent =\n        `${currentWeekKey} (${currentWeekRange.start.toISOString().split('T')[0]} ~ ${currentWeekRange.end.toISOString().split('T')[0]})`;\n    document.getElementById('copy-last-week-info').textContent =\n        `${lastWeekKey} (${lastWeekRange.start.toISOString().split('T')[0]} ~ ${lastWeekRange.end.toISOString().split('T')[0]})`;\n    \n    // é¡¯ç¤ºæ¨¡æ…‹è¦–çª—\n    document.getElementById('copy-options-modal').style.display = 'block';\n    \n    // ç¶å®šæŒ‰éˆ•äº‹ä»¶\n    document.getElementById('copy-btn-current').onclick = function() {\n        handleCopySelection(sourceWeekKey, currentWeekKey);\n    };\n    \n    document.getElementById('copy-btn-last').onclick = function() {\n        handleCopySelection(sourceWeekKey, lastWeekKey);\n    };\n    \n    document.getElementById('copy-btn-custom').onclick = function() {\n        document.getElementById('copy-custom-week-input').style.display = 'block';\n        document.getElementById('copy-custom-week-field').focus();\n    };\n    \n    document.getElementById('copy-btn-custom-confirm').onclick = function() {\n        const customWeekKey = document.getElementById('copy-custom-week-field').value.trim().toUpperCase();\n        if (!customWeekKey) {\n            alert('è«‹è¼¸å…¥é€±æ¬¡ã€‚');\n            return;\n        }\n        \n        const weekKeyPattern = /^\\d{4}-W(0[1-9]|[1-4]\\d|5[0-3])$/;\n        if (!weekKeyPattern.test(customWeekKey)) {\n            alert('ç„¡æ•ˆçš„é€±æ¬¡æ ¼å¼ã€‚è«‹ä½¿ç”¨ YYYY-WNN æ ¼å¼ã€‚');\n            return;\n        }\n        \n        handleCopySelection(sourceWeekKey, customWeekKey);\n    };\n    \n    document.getElementById('copy-btn-custom-cancel').onclick = function() {\n        document.getElementById('copy-custom-week-input').style.display = 'none';\n        document.getElementById('copy-custom-week-field').value = '';\n    };\n    \n    document.getElementById('copy-btn-cancel').onclick = function() {\n        closeCopyModal();\n    };\n}\n\n// è™•ç†è¤‡è£½é¸æ“‡çš„å‡½æ•¸\nfunction handleCopySelection(sourceWeekKey, targetWeekKey) {\n    // é¡¯ç¤ºç¢ºèªå°è©±æ¡†\n    const sourceWeekRange = getWeekDateRangeFromKey(sourceWeekKey);\n    const targetWeekRange = getWeekDateRangeFromKey(targetWeekKey);\n    const sourceStartDate = sourceWeekRange.start.toISOString().split('T')[0];\n    const sourceEndDate = sourceWeekRange.end.toISOString().split('T')[0];\n    const targetStartDate = targetWeekRange.start.toISOString().split('T')[0];\n    const targetEndDate = targetWeekRange.end.toISOString().split('T')[0];\n    \n    // å–å¾—ä¾†æºé€±çš„å·¥æ™‚è¨˜éŒ„æ•¸é‡\n    const timesheets = loadAllTimesheets();\n    let sourceEntries = [];\n    const sourceWeekData = timesheets[sourceWeekKey];\n    if (Array.isArray(sourceWeekData)) {\n        sourceEntries = sourceWeekData;\n    } else if (sourceWeekData && sourceWeekData.entries) {\n        sourceEntries = sourceWeekData.entries;\n    }\n    \n    const confirmMessage = `ç¢ºèªè¦è¤‡è£½å·¥æ™‚è¨˜éŒ„å—ï¼Ÿ\\n\\n` +\n                           `ä¾†æºé€±ï¼š${sourceWeekKey}\\n` +\n                           `æ—¥æœŸç¯„åœï¼š${sourceStartDate} ~ ${sourceEndDate}\\n` +\n                           `è¨˜éŒ„ç­†æ•¸ï¼š${sourceEntries.length} ç­†\\n\\n` +\n                           `ç›®æ¨™é€±ï¼š${targetWeekKey}\\n` +\n                           `æ—¥æœŸç¯„åœï¼š${targetStartDate} ~ ${targetEndDate}\\n\\n` +\n                           `æ‰€æœ‰æ—¥æœŸå°‡è‡ªå‹•èª¿æ•´ç‚ºç›®æ¨™é€±å°æ‡‰æ—¥æœŸã€‚`;\n    \n    if (confirm(confirmMessage)) {\n        copyWeekToTargetWeek(sourceWeekKey, targetWeekKey);\n        closeCopyModal();\n    }\n}\n\n// é—œé–‰è¤‡è£½æ¨¡æ…‹è¦–çª—çš„å‡½æ•¸\nfunction closeCopyModal() {\n    document.getElementById('copy-options-modal').style.display = 'none';\n    document.getElementById('copy-custom-week-input').style.display = 'none';\n    document.getElementById('copy-custom-week-field').value = '';\n}\n\n// è¨­ç½®æ—¥æœŸæ¬„ä½çš„é™åˆ¶ç¯„åœ\nfunction setDateFieldLimits(startDate, endDate) {\n    const minDate = formatDate(startDate);\n    const maxDate = formatDate(endDate);\n    \n    // è¨­ç½®æ—¥æœŸæ¬„ä½çš„ min å’Œ max å±¬æ€§\n    const dateFields = ['date', 'startDate', 'endDate'];\n    dateFields.forEach(fieldId => {\n        const field = document.getElementById(fieldId);\n        if (field) {\n            field.min = minDate;\n            field.max = maxDate;\n            \n            // å¦‚æœæ¬„ä½æœ‰å€¼ä½†è¶…å‡ºç¯„åœï¼Œå‰‡æ¸…ç©º\n            if (field.value) {\n                const fieldDate = new Date(field.value);\n                if (fieldDate < startDate || fieldDate > endDate) {\n                    field.value = '';\n                }\n            }\n        }\n    });\n}\n\n// é©—è­‰æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\nfunction validateDateInWeekRange(date, startDate, endDate) {\n    if (!date) return true; // ç©ºå€¼å…è¨±\n    \n    const inputDate = new Date(date);\n    return inputDate >= startDate && inputDate <= endDate;\n}\n\n// å•Ÿç”¨æ­£è¦åŒ–æ¨¡å¼\nfunction enableNormalizationMode(weekKey) {\n    // å„²å­˜æ­£è¦åŒ–ç‹€æ…‹åˆ° localStorage\n    const normalizationData = {\n        weekKey: weekKey,\n        enabled: true,\n        timestamp: new Date().toISOString()\n    };\n    localStorage.setItem(`normalization_${weekKey}`, JSON.stringify(normalizationData));\n    \n    // æ›´æ–° UI é¡¯ç¤ºæ­£è¦åŒ–æ¨¡å¼ç‹€æ…‹\n    updateNormalizationModeDisplay(weekKey);\n}\n\n// æª¢æŸ¥æ˜¯å¦å•Ÿç”¨æ­£è¦åŒ–æ¨¡å¼\nfunction isNormalizationEnabled(weekKey) {\n    const data = localStorage.getItem(`normalization_${weekKey}`);\n    return data ? JSON.parse(data).enabled : false;\n}\n\n// æ›´æ–°æ­£è¦åŒ–æ¨¡å¼é¡¯ç¤º\nfunction updateNormalizationModeDisplay(weekKey) {\n    const isEnabled = isNormalizationEnabled(weekKey);\n    const weekInfoDiv = document.querySelector('.week-info');\n    \n    // ç§»é™¤èˆŠçš„æ­£è¦åŒ–æç¤º\n    const existingAlert = weekInfoDiv.querySelector('.normalization-alert');\n    if (existingAlert) {\n        existingAlert.remove();\n    }\n    \n    if (isEnabled) {\n        // é¡¯ç¤ºæ­£è¦åŒ–æ¨¡å¼æç¤º\n        const alertDiv = document.createElement('div');\n        alertDiv.className = 'normalization-alert';\n        alertDiv.innerHTML = `\n            <div class=\"alert alert-info\">\n                <strong>ğŸ“Š æ­£è¦åŒ–æ¨¡å¼å·²å•Ÿç”¨</strong> - è©²é€±å·¥æ™‚è¶…é40å°æ™‚ï¼ŒåŒ¯å‡ºæ™‚å°‡è‡ªå‹•é€²è¡Œæ­£è¦åŒ–è¨ˆç®—\n                <button onclick=\"disableNormalizationMode('${weekKey}')\" class=\"btn-disable-normalization\">åœç”¨</button>\n            </div>\n        `;\n        weekInfoDiv.appendChild(alertDiv);\n    }\n}\n\n// åœç”¨æ­£è¦åŒ–æ¨¡å¼\nfunction disableNormalizationMode(weekKey) {\n    localStorage.removeItem(`normalization_${weekKey}`);\n    updateNormalizationModeDisplay(weekKey);\n    showSuccessMessage('æ­£è¦åŒ–æ¨¡å¼å·²åœç”¨');\n}\n\n// åŒ¯å‡ºæ™‚é€²è¡Œæ­£è¦åŒ–è¨ˆç®—\nfunction performNormalizationForExport(entries) {\n    let totalRegularHours = 0;\n\n    // è¨ˆç®—ç¸½æ­£å¸¸å·¥æ™‚\n    entries.forEach(entry => {\n        totalRegularHours += entry.regularHours || 0;\n    });\n\n    if (totalRegularHours > 40) {\n        const normalizedEntries = entries.map(entry => {\n            const originalHours = entry.regularHours || 0;\n            const ratio = 40 / totalRegularHours;\n            const newRegularHours = Math.round(originalHours * ratio * 100) / 100;\n            // ä¿å­˜åŸå§‹å·¥æ™‚\n            return {\n                ...entry,\n                _originalHours: originalHours,\n                _isNormalized: true,\n                regularHours: newRegularHours,\n                ttlHours: newRegularHours + (entry.otHours || 0)\n            };\n        });\n        return normalizedEntries;\n    }\n\n    return entries; // ä¸éœ€è¦æ­£è¦åŒ–\n}\n// æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DDï¼ˆæœ¬åœ°æ™‚é–“ï¼‰\nfunction formatDate(date) {\n    const y = date.getFullYear();\n    const m = String(date.getMonth() + 1).padStart(2, '0');\n    const d = String(date.getDate()).padStart(2, '0');\n    return `${y}-${m}-${d}`;\n}\n\n// å¾localStorageåŠ è¼‰æ‰€æœ‰å·¥æ™‚è¡¨æ•¸æ“š\nfunction loadAllTimesheets() {\n    const data = localStorage.getItem('timesheets');\n    return data ? JSON.parse(data) : {};\n}\n\n// ä¿å­˜æ‰€æœ‰å·¥æ™‚è¡¨æ•¸æ“šåˆ°localStorage\nfunction saveAllTimesheets(timesheets) {\n    localStorage.setItem('timesheets', JSON.stringify(timesheets));\n}\n\n// ç²å–æŒ‡å®šé€±æ•¸çš„æ—¥æœŸç¯„åœï¼ˆé€±æ—¥åˆ°é€±å…­ï¼‰\nfunction getWeekDateRange(weekNumber, year) {\n    // ç°¡å–®å¯¦ç¾ï¼šå‡è¨­yearå’ŒweekNumberæ˜¯æœ‰æ•ˆçš„\n    // å¯¦éš›æ‡‰æ ¹æ“šISOé€±æ•¸è¨ˆç®—ï¼Œé€™è£¡ç°¡åŒ–ç‚ºå¾ç•¶å¹´ç¬¬ä¸€é€±çš„é€±æ—¥é–‹å§‹æ¨ç®—\n    // æ³¨æ„ï¼šé€™åªæ˜¯ä¸€å€‹ç¤ºä¾‹ï¼Œå¯¦éš›çš„æ—¥æœŸè¨ˆç®—éœ€è¦æ›´åš´è¬¹çš„é‚è¼¯\n    const firstDayOfYear = new Date(year, 0, 1);\n    const firstSunday = new Date(firstDayOfYear);\n    // èª¿æ•´åˆ°ç¬¬ä¸€é€±çš„é€±æ—¥ï¼ˆå‡è¨­ç¬¬ä¸€é€±å¾1æœˆ1æ—¥æ‰€åœ¨é€±çš„é€±æ—¥é–‹å§‹ï¼‰\n    firstSunday.setDate(firstDayOfYear.getDate() - firstDayOfYear.getDay());\n    \n    const startDate = new Date(firstSunday);\n    startDate.setDate(firstSunday.getDate() + (weekNumber - 1) * 7);\n    const endDate = new Date(startDate);\n    endDate.setDate(startDate.getDate() + 6);\n    \n    return {\n        start: startDate,\n        end: endDate\n    };\n}\n\n// è¨ˆç®—å¡«å¯«é€²åº¦ï¼ˆæ ¹æ“šè¨˜éŒ„ç­†æ•¸å’Œé æœŸ5å€‹å·¥ä½œæ—¥ï¼Ÿé€™è£¡ç°¡åŒ–ç‚ºè¨˜éŒ„ç­†æ•¸æ˜¯å¦å¤§æ–¼0ï¼‰\nfunction calculateProgress(entries) {\n    // å¦‚æœæœ‰è¨˜éŒ„ï¼Œå‰‡èªç‚ºå¡«å¯«äº†ï¼Œé€²åº¦100%ï¼›å¦å‰‡0\n    return entries && entries.length > 0 ? 100 : 0;\n}\n\n// æ¸²æŸ“å·¥æ™‚è¡¨å¡ç‰‡\nfunction renderTimesheetCards() {\n    const container = document.getElementById('timesheet-cards');\n    container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨\n    \n    const timesheets = loadAllTimesheets();\n    \n    Object.keys(timesheets).forEach(key => {\n        // keyæ ¼å¼ï¼šYYYY-Wwwï¼Œéœ€æª¢æŸ¥åˆæ³•æ€§\n        if (!key || typeof key !== 'string' || !key.includes('-')) return;\n        const [year, week] = key.split('-');\n        if (!year || !week || week.length < 2) return;\n        const weekNumber = parseInt(week.substring(1));\n        if (isNaN(weekNumber)) return;\n        const weekData = timesheets[key];\n        \n        // è™•ç†æ–°çš„è³‡æ–™çµæ§‹ï¼ˆåŒ…å« basicInfo å’Œ entriesï¼‰\n        let entries = [];\n        if (Array.isArray(weekData)) {\n            // èˆŠçš„è³‡æ–™çµæ§‹ï¼Œç›´æ¥æ˜¯é™£åˆ—\n            entries = weekData;\n        } else if (weekData && weekData.entries) {\n            // æ–°çš„è³‡æ–™çµæ§‹ï¼Œæœ‰ basicInfo å’Œ entries\n            entries = weekData.entries;\n        }\n        \n        const dateRange = getWeekDateRange(weekNumber, year);\n        const startStr = dateRange.start.toISOString().split('T')[0];\n        const endStr = dateRange.end.toISOString().split('T')[0];\n        \n        const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n        const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n        const isComplete = totalHours >= 40;\n        \n        // å‰µå»ºå¡ç‰‡å…ƒç´ \n        const card = document.createElement('div');\n        card.className = 'timesheet-card';\n        card.innerHTML = `\n            <div class=\"card-color-bar\"></div>\n            <div class=\"status-tag ${isComplete ? 'status-completed' : 'status-inprogress'}\"\n                 title=\"${isComplete ? 'ç¸½å·¥æ™‚å·²é”40å°æ™‚' : 'ç¸½å·¥æ™‚æœªé”40å°æ™‚'}\">\n                ${isComplete ? 'âœ“' : 'âš '}\n            </div>\n            <div class=\"card-header\">\n                <div class=\"week-title\">${key}</div>\n                <div class=\"date-range\">${startStr} è‡³ ${endStr}</div>\n            </div>\n            <div class=\"stats\">\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${entries.length}</div>\n                    <div class=\"stat-label\">è¨˜éŒ„ç­†æ•¸</div>\n                </div>\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${totalHours}</div>\n                    <div class=\"stat-label\">ç¸½å·¥æ™‚</div>\n                </div>\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${totalRegularHours}</div>\n                    <div class=\"stat-label\">ç¸½æ­£å¸¸å·¥æ™‚</div>\n                </div>\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${totalOtHours}</div>\n                    <div class=\"stat-label\">ç¸½åŠ ç­å·¥æ™‚</div>\n                </div>\n            </div>\n            <div class=\"card-actions\">\n                <button class=\"btn-edit\" data-week=\"${key}\">ä¿®æ”¹</button>\n                <button class=\"btn-copy\" data-week=\"${key}\">è¤‡è£½</button>\n                <button class=\"btn-delete\" data-week=\"${key}\">åˆªé™¤</button>\n                <button class=\"btn-export\" data-week=\"${key}\">åŒ¯å‡º</button>\n            </div>\n        `;\n        \n        container.appendChild(card);\n    });\n    \n    // ç‚ºå¡ç‰‡ä¸Šçš„æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½\n    document.querySelectorAll('.btn-edit').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\n            editTimesheet(weekKey);\n        });\n    });\n    \n    document.querySelectorAll('.btn-delete').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\n            deleteTimesheet(weekKey);\n        });\n    });\n    \n    document.querySelectorAll('.btn-copy').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\nconsole.log('Attempting to call showCopyOptionsModal with weekKey:', weekKey);\n            showCopyOptionsModal(weekKey);\n        });\n    });\n    \n    document.querySelectorAll('.btn-export').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\n            exportTimesheet(weekKey);\n        });\n    });\n    \n    // æ›´æ–°ä¸Šé€±æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹\n    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n        updateLastWeekButtonDisplay();\n    }\n}\n\n// æ–°å»ºå·¥æ™‚è¡¨ - é¡¯ç¤ºé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\nfunction newTimesheet() {\n    showWeekSelectionModal();\n}\n\n// é¡¯ç¤ºé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\nfunction showWeekSelectionModal() {\n    const modal = document.getElementById('week-selection-modal');\n    const timesheets = loadAllTimesheets();\n    \n    // è¨ˆç®—ä¸Šé€±å’Œæœ¬é€±çš„é€±æ¬¡\n    const lastWeekKey = getLastWeekKey();\n    const thisWeekKey = getThisWeekKey();\n    \n    // æ›´æ–°ä¸Šé€±é¸é …è³‡è¨Š\n    const lastWeekInfo = document.getElementById('last-week-info');\n    const lastWeekStatus = document.getElementById('last-week-status');\n    const lastWeekOption = document.getElementById('option-last-week');\n    \n    if (lastWeekKey) {\n        const lastWeekRange = getWeekDateRangeFromKey(lastWeekKey);\n        lastWeekInfo.textContent = `${lastWeekKey} (${formatDate(lastWeekRange.start)} - ${formatDate(lastWeekRange.end)})`;\n        \n        if (timesheets[lastWeekKey]) {\n            lastWeekStatus.textContent = 'å·²å­˜åœ¨';\n            lastWeekStatus.className = 'option-status status-exists';\n            // å¦‚æœå·²å­˜åœ¨ï¼Œç¦ç”¨è©²é¸é …\n            document.getElementById('radio-last-week').disabled = true;\n            lastWeekOption.style.opacity = '0.6';\n        } else {\n            lastWeekStatus.textContent = 'å¯å»ºç«‹';\n            lastWeekStatus.className = 'option-status status-new';\n            document.getElementById('radio-last-week').disabled = false;\n            lastWeekOption.style.opacity = '1';\n        }\n    } else {\n        lastWeekOption.style.display = 'none';\n    }\n    \n    // æ›´æ–°æœ¬é€±é¸é …è³‡è¨Š\n    const thisWeekInfo = document.getElementById('this-week-info');\n    const thisWeekStatus = document.getElementById('this-week-status');\n    const thisWeekOption = document.getElementById('option-this-week');\n    \n    if (thisWeekKey) {\n        const thisWeekRange = getWeekDateRangeFromKey(thisWeekKey);\n        thisWeekInfo.textContent = `${thisWeekKey} (${formatDate(thisWeekRange.start)} - ${formatDate(thisWeekRange.end)})`;\n        \n        if (timesheets[thisWeekKey]) {\n            thisWeekStatus.textContent = 'å·²å­˜åœ¨';\n            thisWeekStatus.className = 'option-status status-exists';\n            // å¦‚æœå·²å­˜åœ¨ï¼Œç¦ç”¨è©²é¸é …\n            document.getElementById('radio-this-week').disabled = true;\n            thisWeekOption.style.opacity = '0.6';\n        } else {\n            thisWeekStatus.textContent = 'å¯å»ºç«‹';\n            thisWeekStatus.className = 'option-status status-new';\n            document.getElementById('radio-this-week').disabled = false;\n            thisWeekOption.style.opacity = '1';\n        }\n    } else {\n        thisWeekOption.style.display = 'none';\n    }\n    \n    // é‡ç½®è‡ªè¨‚è¼¸å…¥\n    document.getElementById('custom-week-field').value = '';\n    document.getElementById('custom-week-input').style.display = 'none';\n    \n    // æ¸…é™¤é¸æ“‡\n    document.querySelectorAll('input[name=\"weekOption\"]').forEach(radio => {\n        radio.checked = false;\n    });\n    \n    // é¡¯ç¤ºæ¨¡æ…‹æ¡†\n    modal.style.display = 'block';\n}\n\n// å–å¾—ä¸Šé€±çš„é€±æ¬¡éµå€¼\nfunction getLastWeekKey() {\n    const today = new Date();\n    const lastMonday = new Date(today);\n    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n    \n    const year = lastMonday.getFullYear();\n    const weekNumber = getWeekNumber(lastMonday);\n    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n}\n\n// å–å¾—æœ¬é€±çš„é€±æ¬¡éµå€¼\nfunction getThisWeekKey() {\n    const today = new Date();\n    const thisMonday = new Date(today);\n    thisMonday.setDate(today.getDate() - today.getDay() + 1);\n    \n    const year = thisMonday.getFullYear();\n    const weekNumber = getWeekNumber(thisMonday);\n    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n}\n\n// è¨ˆç®—é€±æ•¸ï¼ˆISO 8601ï¼‰\n/**\n * ä»¥é€±æ—¥ç‚ºé€±é¦–è¨ˆç®—é€±æ¬¡ï¼ˆYYYY-Wwwï¼‰ï¼Œé€±æ—¥~é€±å…­\n */\nfunction getWeekNumber(date) {\n    const d = new Date(date);\n    // æ‰¾åˆ°æœ¬é€±çš„é€±æ—¥\n    const sunday = new Date(d);\n    sunday.setDate(d.getDate() - d.getDay());\n    // è¨ˆç®—ä»Šå¹´ç¬¬ä¸€å¤©çš„é€±æ—¥\n    const firstDay = new Date(d.getFullYear(), 0, 1);\n    const firstSunday = new Date(firstDay);\n    firstSunday.setDate(firstDay.getDate() - firstDay.getDay());\n    // è¨ˆç®—é€±æ•¸\n    const diff = sunday - firstSunday;\n    const weekNumber = Math.floor(diff / (7 * 24 * 60 * 60 * 1000)) + 1;\n    return weekNumber;\n}\n\n// å¾é€±æ¬¡éµå€¼å–å¾—æ—¥æœŸç¯„åœ\nfunction getWeekDateRangeFromKey(weekKey) {\n    const [year, week] = weekKey.split('-');\n    const weekNumber = parseInt(week.substring(1));\n    return getWeekDateRange(weekNumber, year);\n}\n\n// ä¿®æ”¹å·¥æ™‚è¡¨ï¼ˆè·³è½‰åˆ°ç·¨è¼¯é é¢ï¼‰\nfunction editTimesheet(weekKey) {\n    // è·³è½‰åˆ°å·¥æ™‚å¡«å¯«ç•Œé¢\n    window.location.href = `edit.html?week=${encodeURIComponent(weekKey)}`;\n}\n\n// åˆªé™¤å·¥æ™‚è¡¨\nfunction deleteTimesheet(weekKey) {\n    if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${weekKey} çš„å·¥æ™‚è¡¨å—ï¼Ÿ`)) {\n        const timesheets = loadAllTimesheets();\n        delete timesheets[weekKey];\n        saveAllTimesheets(timesheets);\n        renderTimesheetCards();\n    }\n}\n\n// åŒ¯å‡ºå·¥æ™‚è¡¨ç‚ºCSVæª”æ¡ˆ\nfunction exportTimesheet(weekKey) {\n    try {\n        const entries = getWeekEntries(weekKey);\n        if (!entries || entries.length === 0) {\n            alert('è©²é€±æ¬¡æ²’æœ‰å·¥æ™‚è¨˜éŒ„å¯åŒ¯å‡º');\n            return;\n        }\n\n        // åŒ¯å‡ºå‰æª¢æŸ¥ç¸½æ­£å¸¸å·¥æ™‚ï¼Œè‹¥è¶…é40å°æ™‚å‰‡æç¤º\n        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n        // è‹¥è¶…é40å°æ™‚ï¼Œæç¤ºå°‡è‡ªå‹•æ­£è¦åŒ–\n        if (totalRegularHours > 40) {\n            alert('æœ¬é€±æ­£å¸¸å·¥æ™‚è¶…é40å°æ™‚ï¼Œæ»™å‡ºæ™‚å°‡è‡ªå‹•é€²è¡Œæ­£è¦åŒ–è¨ˆç®—ã€‚\\n\\næ³¨æ„ï¼šè‹¥ä¸‹è¼‰æª”æ¡ˆæ™‚é¸æ“‡è¦†è“‹èˆŠæª”ï¼Œä¸”èˆŠæª”æ­£åœ¨é–‹å•Ÿç‹€æ…‹ï¼Œä¸‹è¼‰å¯èƒ½æœƒå¤±æ•—ä¸¦é¡¯ç¤ºã€Œéœ€è¦ä¸‹è¼‰æ¬Šé™ã€ç­‰éŒ¯èª¤ï¼Œè«‹å…ˆé—œé–‰èˆŠæª”å†ä¸‹è¼‰ã€‚');\n        }\n\n        let exportEntries = [...entries];\n\n        if (totalRegularHours > 40) {\n            exportEntries = performNormalizationForExport(exportEntries);\n        }\n\n        // æº–å‚™CSVå…§å®¹\n        const csvContent = generateCSVContent(exportEntries, weekKey);\n\n        // å‰µå»ºä¸¦ä¸‹è¼‰æª”æ¡ˆ\n        downloadCSVFile(csvContent, `å·¥æ™‚è¡¨_${weekKey}.csv`);\n\n        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n        showSuccessMessage(`${weekKey} å·¥æ™‚è¡¨å·²åŒ¯å‡º`);\n\n    } catch (error) {\n        console.error('åŒ¯å‡ºå¤±æ•—:', error);\n        alert('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°');\n    }\n}\n// æ»™å‡ºæœªç¶“æ­£è¦åŒ–çš„åŸå§‹å·¥æ™‚\nfunction exportRawTimesheet(weekKey) {\n    try {\n        const entries = getWeekEntries(weekKey);\n        if (!entries || entries.length === 0) {\n            alert('è©²é€±æ¬¡æ²’æœ‰å·¥æ™‚è¨˜éŒ„å¯åŒ¯å‡º');\n            return;\n        }\n        // ç›´æ¥æ»™å‡ºåŸå§‹å·¥æ™‚è³‡æ–™\n        const csvContent = generateCSVContent(entries, weekKey);\n        downloadCSVFile(csvContent, `å·¥æ™‚è¡¨_${weekKey}_åŸå§‹.csv`);\n        showSuccessMessage(`${weekKey} å·¥æ™‚è¡¨ï¼ˆåŸå§‹ï¼‰å·²åŒ¯å‡º`);\n    } catch (error) {\n        console.error('åŸå§‹å·¥æ™‚åŒ¯å‡ºå¤±æ•—:', error);\n        alert('åŸå§‹å·¥æ™‚åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°');\n    }\n}\n\n// ç”ŸæˆCSVå…§å®¹\nfunction generateCSVContent(entries, weekKey) {\n    // CSVæ¨™é¡Œè¡Œï¼ˆæŒ‰ç…§æŒ‡å®šæ ¼å¼ï¼‰\n    const headers = [\n        'Name',\n        'Zone',\n        'Project',\n        'Product Module',\n        'Activity Type',\n        'Task',\n        'Regular Hours',\n        'OT Hours',\n        'TTL_Hours',\n        'Date',\n        'Start Date',\n        'End Date',\n        'Comments',\n        'PM',\n        'InternalOrOutsource'\n    ];\n\n    // è¼‰å…¥åŸºæœ¬è³‡æ–™\n    const basicInfo = loadGlobalBasicInfo();\n    \n    // è½‰æ›è³‡æ–™è¡Œ\n    const dataRows = entries.map(entry => {\n        const regularHours = parseFloat(entry.regularHours) || 0;\n        const overtimeHours = parseFloat(entry.overtimeHours) || parseFloat(entry.otHours) || 0;\n        const totalHours = parseFloat(entry.ttlHours) || (regularHours + overtimeHours);\n        \n        return [\n            basicInfo.employeeName || '',           // Name\n            entry.zone || '',                       // Zone\n            entry.project || '',                    // Project\n            entry.productModule || '',              // Product Module\n            entry.activityType || '',               // Activity Type\n            entry.task || '',                       // Task\n            regularHours,                           // Regular Hours\n            overtimeHours,                          // OT Hours\n            totalHours,                             // TTL_Hours\n            entry.date || '',                       // Date\n            entry.startDate || '',                  // Start Date\n            entry.endDate || '',                    // End Date\n            entry.comments || '',                   // Comments\n            entry.pm || '',                         // PM\n            basicInfo.employeeType || ''            // InternalOrOutsource\n        ];\n    });\n\n    // çµ„åˆCSVå…§å®¹\n    const csvRows = [headers, ...dataRows];\n    \n    // è½‰æ›ç‚ºCSVæ ¼å¼å­—ä¸²\n    return csvRows.map(row =>\n        row.map(field => {\n            // è™•ç†åŒ…å«é€—è™Ÿæˆ–æ›è¡Œçš„æ¬„ä½\n            const fieldStr = String(field);\n            if (fieldStr.includes(',') || fieldStr.includes('\\n') || fieldStr.includes('\"')) {\n                return '\"' + fieldStr.replace(/\"/g, '\"\"') + '\"';\n            }\n            return fieldStr;\n        }).join(',')\n    ).join('\\n');\n}\n\n// ä¸‹è¼‰CSVæª”æ¡ˆ\nfunction downloadCSVFile(csvContent, filename) {\n    try {\n        console.log('[downloadCSVFile] é–‹å§‹ä¸‹è¼‰', { filename, csvContentSample: csvContent.slice(0, 100) });\n        // æ·»åŠ BOMä»¥æ”¯æ´ä¸­æ–‡\n        const BOM = '\\uFEFF';\n        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n        console.log('[downloadCSVFile] Blob created', blob);\n        const url = URL.createObjectURL(blob);\n        console.log('[downloadCSVFile] Object URL', url);\n        const link = document.createElement('a');\n        link.setAttribute('href', url);\n        link.setAttribute('download', filename);\n        link.style.visibility = 'hidden';\n        // æ·»åŠ åˆ°é é¢ä¸¦è§¸ç™¼ä¸‹è¼‰\n        document.body.appendChild(link);\n        link.click();\n        console.log('[downloadCSVFile] link.click() å·²è§¸ç™¼');\n        // æ¸…ç†\n        document.body.removeChild(link);\n        URL.revokeObjectURL(url);\n        console.log('[downloadCSVFile] æ¸…ç†å®Œæˆ');\n    } catch (err) {\n        console.error('[downloadCSVFile] ç™¼ç”ŸéŒ¯èª¤', err);\n    }\n}\n\n// åŒ¯å…¥å·¥æ™‚è¡¨ï¼ˆæš«æ™‚åªæç¤ºï¼‰\nfunction importTimesheet() {\n    const input = document.getElementById('import-file');\n    input.value = ''; // é‡ç½® inputï¼Œé¿å…åŒæª”æ¡ˆç„¡æ³•é‡é¸\n    input.onchange = async function (event) {\n        const file = event.target.files[0];\n        if (!file) return;\n        const reader = new FileReader();\n        reader.onload = function (e) {\n            const text = e.target.result;\n            try {\n                console.log('[import] åŸå§‹CSVå…§å®¹:', text);\n                \n                // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ç‚ºç©º\n                if (!text || text.trim().length === 0) {\n                    alert('æª”æ¡ˆå…§å®¹ç‚ºç©ºï¼Œè«‹é¸æ“‡æœ‰æ•ˆçš„CSVæª”æ¡ˆã€‚');\n                    return;\n                }\n                \n                const data = parseCSV(text);\n                console.log('[import] parseCSV result:', data);\n                \n                // æª¢æŸ¥æ˜¯å¦æˆåŠŸè§£æå‡ºè³‡æ–™\n                if (!data || data.length === 0) {\n                    alert('ç„¡æ³•å¾æª”æ¡ˆä¸­è§£æå‡ºæœ‰æ•ˆè³‡æ–™ï¼Œè«‹æª¢æŸ¥CSVæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');\n                    return;\n                }\n                \n                // å¼·åˆ¶å°‡ data è½‰ç‚º array\n                console.log('[import] typeof data:', typeof data, 'Array.isArray:', Array.isArray(data));\n                let arr = [];\n                if (Array.isArray(data)) {\n                    arr = data;\n                } else if (typeof data === 'object' && data !== null) {\n                    arr = Object.values(data).flat();\n                }\n                console.log('[import] è½‰æ›å¾Œ arr:', arr);\n                \n                if (arr.length === 0) {\n                    alert('æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„å·¥æ™‚è¨˜éŒ„ã€‚');\n                    return;\n                }\n                let groupedData = {};\n                const failedRows = [];\n                \n                arr.forEach((row, index) => {\n                    if (!row) return;\n                    \n                    // æª¢æŸ¥æ—¥æœŸæ¬„ä½ï¼ˆæ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±ï¼‰\n                    const dateValue = row.Date || row.date || row['æ—¥æœŸ'] || row.Day;\n                    if (!dateValue) {\n                        console.warn(`[import] ç¬¬${index + 1}ç­†è¨˜éŒ„ç¼ºå°‘æ—¥æœŸæ¬„ä½:`, row);\n                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šç¼ºå°‘æ—¥æœŸæ¬„ä½`);\n                        return;\n                    }\n                    \n                    // æ”¹é€²çš„æ—¥æœŸè§£æï¼Œæ”¯æ´å¤šç¨®æ ¼å¼\n                    let dateObj = null;\n                    const dateStr = dateValue.toString().trim();\n                    \n                    // å˜—è©¦å¤šç¨®æ—¥æœŸæ ¼å¼\n                    const dateFormats = [\n                        dateStr, // åŸå§‹æ ¼å¼\n                        dateStr.replace(/\\//g, '-'), // å°‡ / æ›¿æ›ç‚º -\n                        dateStr.replace(/\\./g, '-'), // å°‡ . æ›¿æ›ç‚º -\n                    ];\n                    \n                    for (const format of dateFormats) {\n                        dateObj = new Date(format);\n                        if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1900) {\n                            break;\n                        }\n                        dateObj = null;\n                    }\n                    \n                    if (!dateObj || isNaN(dateObj.getTime())) {\n                        console.warn(`[import] ç¬¬${index + 1}ç­†è¨˜éŒ„æ—¥æœŸæ ¼å¼ç„¡æ•ˆ:`, dateValue);\n                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šæ—¥æœŸæ ¼å¼ç„¡æ•ˆ \"${dateValue}\"`);\n                        return;\n                    }\n                    \n                    try {\n                        // æ­£ç¢ºè¨ˆç®—é€±æ¬¡\n                        const year = dateObj.getFullYear();\n                        const weekNumber = getWeekNumber(dateObj);\n                        const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n                        console.log('[import][åˆ†çµ„] Date:', dateValue, 'parsed:', dateObj, 'year:', year, 'weekNumber:', weekNumber, 'weekKey:', weekKey);\n                        \n                        if (!groupedData[weekKey]) groupedData[weekKey] = [];\n                        \n                        // æ¨™æº–åŒ–è¨˜éŒ„æ ¼å¼ï¼Œç¢ºä¿æ—¥æœŸçµ±ä¸€å’Œå¿…è¦æ¬„ä½\n                        const standardizedRow = { ...row };\n                        standardizedRow.date = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD æ ¼å¼\n                        \n                        // ç¢ºä¿æœ‰å”¯ä¸€çš„ ID\n                        if (!standardizedRow.id) {\n                            standardizedRow.id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n                        }\n                        \n                        // ç¢ºä¿æ•¸å­—æ¬„ä½æœ‰é è¨­å€¼\n                        standardizedRow.regularHours = standardizedRow.regularHours || 0;\n                        standardizedRow.otHours = standardizedRow.otHours || 0;\n                        standardizedRow.ttlHours = standardizedRow.ttlHours || (standardizedRow.regularHours + standardizedRow.otHours);\n                        \n                        groupedData[weekKey].push(standardizedRow);\n                    } catch (err) {\n                        console.error(`[import] è™•ç†ç¬¬${index + 1}ç­†è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:`, err, row);\n                        failedRows.push(`ç¬¬${index + 1}ç­†è¨˜éŒ„ï¼šè™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤`);\n                    }\n                });\n                \n                // å¦‚æœæœ‰å¤±æ•—çš„è¨˜éŒ„ï¼Œé¡¯ç¤ºè­¦å‘Š\n                if (failedRows.length > 0) {\n                    console.warn('[import] ä»¥ä¸‹è¨˜éŒ„åŒ¯å…¥å¤±æ•—:', failedRows);\n                    const proceed = confirm(`æœ‰ ${failedRows.length} ç­†è¨˜éŒ„åŒ¯å…¥å¤±æ•—ï¼š\\n${failedRows.slice(0, 5).join('\\n')}${failedRows.length > 5 ? '\\n...' : ''}\\n\\næ˜¯å¦ç¹¼çºŒåŒ¯å…¥å…¶ä»–è¨˜éŒ„ï¼Ÿ`);\n                    if (!proceed) {\n                        alert('åŒ¯å…¥å·²å–æ¶ˆ');\n                        return;\n                    }\n                }\n                console.log('[import] è‡ªå‹•åˆ†çµ„é€±æ¬¡çµæœ:', groupedData);\n                // åˆä½µåŒ¯å…¥è³‡æ–™åˆ°ä¸» timesheets\n                const timesheets = loadAllTimesheets();\n                console.log('[import] localStorage timesheets(åŒ¯å…¥å‰):', timesheets);\n                const importedWeeks = [];\n                for (const weekKey in groupedData) {\n                    console.log('[import] æª¢æŸ¥é€±æ¬¡', weekKey, groupedData[weekKey]);\n                    if (timesheets[weekKey]) {\n                        const overwrite = confirm('é€±æ¬¡ ' + weekKey + ' å·²æœ‰è³‡æ–™ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ');\n                        console.log('[import] è¦†è“‹ç¢ºèª', weekKey, overwrite);\n                        if (!overwrite) continue;\n                    }\n                    timesheets[weekKey] = groupedData[weekKey];\n                    importedWeeks.push(weekKey);\n                    console.log('[import] å·²åŠ å…¥é€±æ¬¡:', weekKey);\n                }\n                console.log('[import] importedWeeks:', importedWeeks);\n                console.log('[import] localStorage timesheets(åŒ¯å…¥å¾Œ):', timesheets);\n                \n                if (Object.keys(groupedData).length === 0) {\n                    alert('æ²’æœ‰æœ‰æ•ˆçš„è¨˜éŒ„å¯ä»¥åŒ¯å…¥ã€‚è«‹æª¢æŸ¥CSVæª”æ¡ˆä¸­çš„æ—¥æœŸæ ¼å¼å’Œè³‡æ–™å…§å®¹ã€‚');\n                    return;\n                }\n                \n                saveAllTimesheets(timesheets);\n                renderTimesheetCards();\n                \n                if (importedWeeks.length > 0) {\n                    const weekInfoList = importedWeeks.map(weekKey => {\n                        try {\n                            const range = getWeekDateRangeFromKey(weekKey);\n                            const start = range.start.toISOString().split('T')[0];\n                            const end = range.end.toISOString().split('T')[0];\n                            const recordCount = groupedData[weekKey].length;\n                            return `${weekKey} (${start} ~ ${end}) - ${recordCount}ç­†è¨˜éŒ„`;\n                        } catch (err) {\n                            console.error('[import] å–å¾—é€±æ¬¡ç¯„åœå¤±æ•—:', weekKey, err);\n                            return `${weekKey} - ${groupedData[weekKey].length}ç­†è¨˜éŒ„`;\n                        }\n                    });\n                    \n                    const totalRecords = importedWeeks.reduce((sum, weekKey) => sum + groupedData[weekKey].length, 0);\n                    const successMessage = `åŒ¯å…¥æˆåŠŸï¼\\nå…±åŒ¯å…¥ ${totalRecords} ç­†è¨˜éŒ„åˆ° ${importedWeeks.length} å€‹é€±æ¬¡ï¼š\\n\\n${weekInfoList.join('\\n')}`;\n                    \n                    if (failedRows.length > 0) {\n                        alert(successMessage + `\\n\\næ³¨æ„ï¼šæœ‰ ${failedRows.length} ç­†è¨˜éŒ„åŒ¯å…¥å¤±æ•—ã€‚`);\n                    } else {\n                        alert(successMessage);\n                    }\n                } else {\n                    alert('æœªåŒ¯å…¥ä»»ä½•é€±æ¬¡è³‡æ–™ã€‚æ‰€æœ‰è¨˜éŒ„éƒ½è¢«è·³éäº†ã€‚');\n                }\n            } catch (err) {\n                console.error('[import] åŒ¯å…¥æµç¨‹ç™¼ç”ŸéŒ¯èª¤:', err);\n                let errorMessage = 'CSV åŒ¯å…¥å¤±æ•—ï¼š\\n';\n                if (err.message) {\n                    errorMessage += err.message;\n                } else {\n                    errorMessage += 'æœªçŸ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ç²å–æ›´å¤šè³‡è¨Šã€‚';\n                }\n                alert(errorMessage);\n            }\n        };\n        reader.readAsText(file, 'utf-8');\n    };\n    input.click();\n}\n\n// ==================== é¦–é æ¨¡æ…‹æ¡†åŠŸèƒ½ ====================\n\n// é¡¯ç¤ºåŸºæœ¬è³‡æ–™è¨­å®šæ¨¡æ…‹æ¡†\nfunction showBasicInfoModal() {\n    const modal = document.getElementById('basic-info-modal');\n    const basicInfo = loadGlobalBasicInfo();\n    \n    // è¼‰å…¥ç¾æœ‰è³‡æ–™\n    if (basicInfo) {\n        document.getElementById('modal-employeeName').value = basicInfo.employeeName || '';\n        document.getElementById('modal-employeeType').value = basicInfo.employeeType || '';\n    }\n    \n    modal.style.display = 'block';\n}\n\n// éš±è—åŸºæœ¬è³‡æ–™è¨­å®šæ¨¡æ…‹æ¡†\nfunction hideBasicInfoModal() {\n    const modal = document.getElementById('basic-info-modal');\n    modal.style.display = 'none';\n    \n    // æ¸…ç©ºè¡¨å–®\n    document.getElementById('modal-basic-info-form').reset();\n}\n\n// å„²å­˜æ¨¡æ…‹æ¡†ä¸­çš„åŸºæœ¬è³‡æ–™\nfunction saveModalBasicInfo() {\n    const employeeName = document.getElementById('modal-employeeName').value.trim();\n    const employeeType = document.getElementById('modal-employeeType').value;\n    \n    if (!employeeName || !employeeType) {\n        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');\n        return;\n    }\n    \n    const basicInfo = {\n        employeeName: employeeName,\n        employeeType: employeeType\n    };\n    \n    saveGlobalBasicInfo(basicInfo);\n    hideBasicInfoModal();\n    alert('åŸºæœ¬è³‡æ–™å·²å„²å­˜æˆåŠŸï¼ï¼ˆå…¨ App å…±ç”¨ï¼‰');\n}\n\n// åˆå§‹åŒ–ï¼šé é¢åŠ è¼‰å®Œæˆå¾Œæ¸²æŸ“å¡ç‰‡ï¼Œä¸¦ç¶å®šæŒ‰éˆ•äº‹ä»¶\ndocument.addEventListener('DOMContentLoaded', () => {\n    // æª¢æŸ¥æ˜¯å¦ç‚ºé¦–é \n    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n        renderTimesheetCards();\n        \n        // ç¶å®šå…¨å±€æŒ‰éˆ•äº‹ä»¶\n        document.getElementById('btn-basic-info').addEventListener('click', showBasicInfoModal);\n        document.getElementById('btn-new').addEventListener('click', newTimesheet);\n        document.getElementById('btn-import').addEventListener('click', importTimesheet);\n        document.getElementById('btn-clear-storage').addEventListener('click', () => {\n            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸã€‚')) {\n                localStorage.clear();\n                renderTimesheetCards();\n                alert('localStorage å·²æ¸…ç©º');\n            }\n        });\n        \n        // ç¶å®šåŸºæœ¬è³‡æ–™æ¨¡æ…‹æ¡†äº‹ä»¶\n        document.getElementById('btn-save-modal-basic-info').addEventListener('click', saveModalBasicInfo);\n        document.getElementById('btn-cancel-modal').addEventListener('click', hideBasicInfoModal);\n        document.querySelector('.close').addEventListener('click', hideBasicInfoModal);\n        \n        // ç¶å®šé€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†äº‹ä»¶\n        const weekModal = document.getElementById('week-selection-modal');\n        if (weekModal) {\n            const weekCloseBtn = weekModal.querySelector('.close');\n            const confirmWeekBtn = document.getElementById('btn-confirm-week');\n            const cancelWeekBtn = document.getElementById('btn-cancel-week');\n            const customRadio = document.getElementById('radio-custom');\n            const customInput = document.getElementById('custom-week-input');\n            \n            if (weekCloseBtn) weekCloseBtn.addEventListener('click', hideWeekSelectionModal);\n            if (cancelWeekBtn) cancelWeekBtn.addEventListener('click', hideWeekSelectionModal);\n            if (confirmWeekBtn) confirmWeekBtn.addEventListener('click', confirmWeekSelection);\n            \n            // ç›£è½è‡ªè¨‚é¸é …çš„é¸æ“‡\n            if (customRadio && customInput) {\n                customRadio.addEventListener('change', function() {\n                    if (this.checked) {\n                        customInput.style.display = 'block';\n                    }\n                });\n            }\n            \n            // ç›£è½å…¶ä»–é¸é …çš„é¸æ“‡ï¼ˆéš±è—è‡ªè¨‚è¼¸å…¥ï¼‰\n            document.querySelectorAll('input[name=\"weekOption\"]:not(#radio-custom)').forEach(radio => {\n                radio.addEventListener('change', function() {\n                    if (this.checked && customInput) {\n                        customInput.style.display = 'none';\n                    }\n                });\n            });\n        }\n        \n        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰\n        window.addEventListener('click', (event) => {\n            const basicModal = document.getElementById('basic-info-modal');\n            const weekSelectionModal = document.getElementById('week-selection-modal');\n            \n            if (event.target === basicModal) {\n                hideBasicInfoModal();\n            } else if (event.target === weekSelectionModal) {\n                hideWeekSelectionModal();\n            }\n        });\n\n        // è¨­ç½®ä¸Šé€±æŒ‰éˆ•çš„æ–‡å­—å’Œé¡¯ç¤ºç‹€æ…‹\n        const lastWeekButton = document.getElementById('btn-last-week');\n        if (lastWeekButton) {\n            updateLastWeekButtonDisplay();\n            // ç¶å®šé»æ“Šäº‹ä»¶\n            lastWeekButton.addEventListener('click', createLastWeekTimesheet);\n        }\n    }\n});\n\n// æ›´æ–°ä¸Šé€±æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹å’Œæ–‡å­—\nfunction updateLastWeekButtonDisplay() {\n    const today = new Date();\n    // æ›´ç²¾ç¢ºçš„è¨ˆç®—ï¼šç²å–ä¸Šé€±ä¸€ï¼ˆä»Šå¤©æ¸›å»ä»Šå¤©æ˜ŸæœŸå¹¾å†æ¸›6å¤©ï¼‰\n    const lastMonday = new Date(today);\n    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n    const lastSunday = new Date(lastMonday);\n    lastSunday.setDate(lastMonday.getDate() + 6);\n    \n    const button = document.getElementById('btn-last-week');\n    const container = document.getElementById('last-week-container');\n    \n    if (button && container) {\n        // æª¢æŸ¥ä¸Šé€±æ˜¯å¦å·²å­˜åœ¨\n        const lastWeekKey = getLastWeekKey();\n        const timesheets = loadAllTimesheets();\n        \n        if (timesheets[lastWeekKey]) {\n            // ä¸Šé€±å·²å­˜åœ¨ï¼Œéš±è—æŒ‰éˆ•\n            container.style.display = 'none';\n        } else {\n            // ä¸Šé€±ä¸å­˜åœ¨ï¼Œé¡¯ç¤ºæŒ‰éˆ•ä¸¦è¨­ç½®æ–‡å­—\n            container.style.display = 'block';\n            button.textContent = `å»ºç«‹ä¸Šé€±å·¥æ™‚è¡¨ (${formatDate(lastMonday)} - ${formatDate(lastSunday)})`;\n        }\n    }\n}\n\n// å»ºç«‹ä¸Šé€±å·¥æ™‚è¡¨\nfunction createLastWeekTimesheet() {\n    const today = new Date();\n    const lastMonday = new Date(today);\n    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n    const lastSunday = new Date(lastMonday);\n    lastSunday.setDate(lastMonday.getDate() + 6);\n    \n    // ç”Ÿæˆé€±æ¬¡æ ¼å¼ YYYY-Www\n    const year = lastMonday.getFullYear();\n    const weekNumber = Math.ceil((((lastMonday - new Date(year, 0, 1)) / 86400000) + new Date(year, 0, 1).getDay() + 1) / 7);\n    const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n    \n    const timesheets = loadAllTimesheets();\n    if (!timesheets[weekKey]) {\n        timesheets[weekKey] = [];\n        saveAllTimesheets(timesheets);\n    }\n    \n    // è¼‰å…¥ä¸Šé€±å·¥æ™‚è¡¨\n    editTimesheet(weekKey);\n    renderTimesheetCards();\n}\n\n// ==================== ç·¨è¼¯é é¢åŠŸèƒ½ ====================\n\n// ç”Ÿæˆå”¯ä¸€ ID\nfunction generateUniqueId() {\n    return Date.now().toString(36) + Math.random().toString(36).substr(2);\n}\n\n// ç²å–ç•¶å‰ç·¨è¼¯çš„é€±æ¬¡\nfunction getCurrentWeekKey() {\n    const urlParams = new URLSearchParams(window.location.search);\n    return urlParams.get('week');\n}\n\n// ==================== å…¨åŸŸåŸºæœ¬è³‡æ–™ç®¡ç† ====================\n\n// è¼‰å…¥å…¨åŸŸåŸºæœ¬è³‡æ–™\nfunction loadGlobalBasicInfo() {\n    const data = localStorage.getItem('globalBasicInfo');\n    return data ? JSON.parse(data) : null;\n}\n\n// å„²å­˜å…¨åŸŸåŸºæœ¬è³‡æ–™\nfunction saveGlobalBasicInfo(basicInfo) {\n    localStorage.setItem('globalBasicInfo', JSON.stringify(basicInfo));\n}\n\n// ==================== å·¥æ™‚è¨˜éŒ„ç®¡ç† ====================\n\n// ç²å–æŒ‡å®šé€±æ¬¡çš„å·¥æ™‚è¨˜éŒ„\nfunction getWeekEntries(weekKey) {\n    const timesheets = loadAllTimesheets();\n    const weekData = timesheets[weekKey];\n    \n    // è™•ç†ä¸åŒçš„è³‡æ–™çµæ§‹\n    if (Array.isArray(weekData)) {\n        // èˆŠçš„è³‡æ–™çµæ§‹ï¼Œç›´æ¥æ˜¯é™£åˆ—\n        return weekData;\n    } else if (weekData && weekData.entries) {\n        // æ–°çš„è³‡æ–™çµæ§‹ï¼Œæœ‰ entries\n        return weekData.entries;\n    }\n    \n    return [];\n}\n\n// å„²å­˜æŒ‡å®šé€±æ¬¡çš„å·¥æ™‚è¨˜éŒ„\nfunction saveWeekEntries(weekKey, entries) {\n    const timesheets = loadAllTimesheets();\n    timesheets[weekKey] = entries; // ç›´æ¥å„²å­˜ç‚ºé™£åˆ—ï¼Œç°¡åŒ–çµæ§‹\n    saveAllTimesheets(timesheets);\n}\n\n// è¨ˆç®—ç¸½å·¥æ™‚\nfunction calculateTotalHours() {\n    const regular = parseFloat(document.getElementById('regularHours').value) || 0;\n    const ot = parseFloat(document.getElementById('otHours').value) || 0;\n    document.getElementById('ttlHours').value = regular + ot;\n}\n\n// é©—è­‰åŸºæœ¬è³‡æ–™è¡¨å–®\nfunction validateBasicInfo() {\n    const requiredFields = ['employeeName', 'employeeType'];\n    let isValid = true;\n    \n    // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤ç‹€æ…‹\n    document.querySelectorAll('#basic-info-form .form-field.error').forEach(field => {\n        field.classList.remove('error');\n    });\n    \n    requiredFields.forEach(fieldName => {\n        const field = document.getElementById(fieldName);\n        const formField = field.closest('.form-field');\n        \n        if (!field.value.trim()) {\n            formField.classList.add('error');\n            showFieldError(formField, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');\n            isValid = false;\n        }\n    });\n    \n    return isValid;\n}\n\n// é©—è­‰å·¥æ™‚è¨˜éŒ„è¡¨å–®\nfunction validateForm() {\n    const requiredFields = ['task', 'zone', 'project', 'activityType', 'regularHours', 'date'];\n    let isValid = true;\n    \n    // æª¢æŸ¥æ˜¯å¦å·²å„²å­˜å…¨åŸŸåŸºæœ¬è³‡æ–™\n    const basicInfo = loadGlobalBasicInfo();\n    if (!basicInfo) {\n        alert('è«‹å…ˆå¡«å¯«ä¸¦å„²å­˜åŸºæœ¬è³‡æ–™');\n        document.querySelector('.basic-info-container').scrollIntoView({ behavior: 'smooth' });\n        return false;\n    }\n    \n    // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤ç‹€æ…‹\n    document.querySelectorAll('#timesheet-form .form-field.error').forEach(field => {\n        field.classList.remove('error');\n    });\n    \n    requiredFields.forEach(fieldName => {\n        const field = document.getElementById(fieldName);\n        const formField = field.closest('.form-field');\n        \n        if (!field.value.trim()) {\n            formField.classList.add('error');\n            showFieldError(formField, 'æ­¤æ¬„ä½ç‚ºå¿…å¡«');\n            isValid = false;\n        }\n    });\n    \n    // é©—è­‰å·¥æ™‚ç¯„åœ\n    const regularHours = parseFloat(document.getElementById('regularHours').value);\n    const otHours = parseFloat(document.getElementById('otHours').value) || 0;\n    \n    if (regularHours < 0 || regularHours > 24) {\n        const formField = document.getElementById('regularHours').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, 'æ­£å¸¸å·¥æ™‚å¿…é ˆåœ¨ 0-24 å°æ™‚ä¹‹é–“');\n        isValid = false;\n    }\n    \n    if (otHours < 0 || otHours > 24) {\n        const formField = document.getElementById('otHours').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, 'åŠ ç­å·¥æ™‚å¿…é ˆåœ¨ 0-24 å°æ™‚ä¹‹é–“');\n        isValid = false;\n    }\n    \n    // å…è¨±æ­£å¸¸å·¥æ™‚ç¸½è¨ˆè¶…é40å°æ™‚ï¼Œåƒ…æ–¼åŒ¯å‡ºæ™‚æç¤ºæ­£è¦åŒ–\n    const weekKey = getCurrentWeekKey();\n    const currentEntryId = document.getElementById('entryId').value;\n    const entries = getWeekEntries(weekKey);\n    \n    // è¨ˆç®—é™¤äº†ç•¶å‰ç·¨è¼¯è¨˜éŒ„å¤–çš„å…¶ä»–è¨˜éŒ„çš„æ­£å¸¸å·¥æ™‚ç¸½å’Œ\n    let totalRegularHours = 0;\n    entries.forEach(entry => {\n        if (entry.id !== currentEntryId) {\n            totalRegularHours += entry.regularHours || 0;\n        }\n    });\n    \n    // åŠ ä¸Šç•¶å‰è¼¸å…¥çš„æ­£å¸¸å·¥æ™‚\n    totalRegularHours += regularHours;\n    \n    // ä¸å†æ–¼æ­¤è™•é™åˆ¶æˆ–æç¤ºï¼Œåƒ…æ–¼åŒ¯å‡ºæ™‚è™•ç†æ­£è¦åŒ–\n    \n    // é©—è­‰æ—¥æœŸé‚è¼¯\n    const startDate = document.getElementById('startDate').value;\n    const endDate = document.getElementById('endDate').value;\n    const date = document.getElementById('date').value;\n    \n    // ç²å–ç•¶å‰é€±çš„æ—¥æœŸç¯„åœï¼ˆä½¿ç”¨å·²å®£å‘Šçš„ weekKeyï¼‰\n    const [year, week] = weekKey.split('-');\n    const weekNumber = parseInt(week.substring(1));\n    const weekRange = getWeekDateRange(weekNumber, year);\n    \n    // é©—è­‰ä¸»è¦æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n    if (date && !validateDateInWeekRange(date, weekRange.start, weekRange.end)) {\n        const formField = document.getElementById('date').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, `æ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n        isValid = false;\n    }\n    \n    // é©—è­‰é–‹å§‹æ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n    if (startDate && !validateDateInWeekRange(startDate, weekRange.start, weekRange.end)) {\n        const formField = document.getElementById('startDate').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, `é–‹å§‹æ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n        isValid = false;\n    }\n    \n    // é©—è­‰çµæŸæ—¥æœŸæ˜¯å¦åœ¨é€±ç¯„åœå…§\n    if (endDate && !validateDateInWeekRange(endDate, weekRange.start, weekRange.end)) {\n        const formField = document.getElementById('endDate').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, `çµæŸæ—¥æœŸå¿…é ˆåœ¨ ${formatDate(weekRange.start)} è‡³ ${formatDate(weekRange.end)} ç¯„åœå…§`);\n        isValid = false;\n    }\n    \n    // é©—è­‰é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ\n    if (startDate && endDate && new Date(startDate) > new Date(endDate)) {\n        const formField = document.getElementById('endDate').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, 'çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ');\n        isValid = false;\n    }\n    \n    return isValid;\n}\n\n// é¡¯ç¤ºæ¬„ä½éŒ¯èª¤è¨Šæ¯\nfunction showFieldError(formField, message) {\n    let errorDiv = formField.querySelector('.error-message');\n    if (!errorDiv) {\n        errorDiv = document.createElement('div');\n        errorDiv.className = 'error-message';\n        formField.appendChild(errorDiv);\n    }\n    errorDiv.textContent = message;\n}\n\n// æ¸…ç©ºè¡¨å–®\nfunction clearForm() {\n    document.getElementById('timesheet-form').reset();\n    document.getElementById('entryId').value = '';\n    document.getElementById('ttlHours').value = '';\n    \n    // æ¸…é™¤éŒ¯èª¤ç‹€æ…‹\n    document.querySelectorAll('.form-field.error').forEach(field => {\n        field.classList.remove('error');\n    });\n}\n\n// ç²å–åŸºæœ¬è³‡æ–™\nfunction getBasicInfoData() {\n    return {\n        employeeName: document.getElementById('employeeName').value.trim(),\n        employeeType: document.getElementById('employeeType').value\n    };\n}\n\n// å¡«å……åŸºæœ¬è³‡æ–™\nfunction fillBasicInfo(basicInfo) {\n    if (basicInfo) {\n        document.getElementById('employeeName').value = basicInfo.employeeName || '';\n        document.getElementById('employeeType').value = basicInfo.employeeType || '';\n    }\n}\n\n// å¾è¡¨å–®ç²å–å·¥æ™‚è¨˜éŒ„æ•¸æ“š\nfunction getFormData() {\n    const basicInfo = loadGlobalBasicInfo();\n    const originalHours = document.getElementById('originalHours').value;\n    \n    const data = {\n        id: document.getElementById('entryId').value || generateUniqueId(),\n        // å¾å…¨åŸŸåŸºæœ¬è³‡æ–™å¼•ç”¨\n        name: basicInfo ? basicInfo.employeeName : '',\n        internalOrOutsource: basicInfo ? basicInfo.employeeType : '',\n        // å·¥æ™‚è¨˜éŒ„ç‰¹å®šæ¬„ä½\n        zone: document.getElementById('zone').value,\n        project: document.getElementById('project').value.trim(),\n        productModule: document.getElementById('productModule').value.trim(),\n        activityType: document.getElementById('activityType').value,\n        task: document.getElementById('task').value.trim(),\n        regularHours: parseFloat(document.getElementById('regularHours').value) || 0,\n        otHours: parseFloat(document.getElementById('otHours').value) || 0,\n        ttlHours: parseFloat(document.getElementById('ttlHours').value) || 0,\n        date: document.getElementById('date').value,\n        startDate: document.getElementById('startDate').value,\n        endDate: document.getElementById('endDate').value,\n        comments: document.getElementById('comments').value.trim(),\n        pm: document.getElementById('pm').value.trim()\n    };\n    \n    // å¦‚æœæœ‰åŸå§‹å·¥æ™‚ï¼ˆæ­£è¦åŒ–æ¨¡å¼ï¼‰ï¼Œå‰‡å„²å­˜ä½†æ¨™è¨˜ç‚ºå…§éƒ¨ä½¿ç”¨\n    if (originalHours && parseFloat(originalHours) > 0) {\n        data._originalHours = parseFloat(originalHours); // ä½¿ç”¨ _ å‰ç¶´æ¨™è¨˜ç‚ºå…§éƒ¨æ¬„ä½\n        data._isNormalized = true;\n    }\n    \n    return data;\n}\n\n// å¡«å……å·¥æ™‚è¨˜éŒ„è¡¨å–®æ•¸æ“š\nfunction fillForm(entry) {\n    document.getElementById('entryId').value = entry.id;\n    document.getElementById('zone').value = entry.zone || '';\n    document.getElementById('project').value = entry.project || '';\n    document.getElementById('productModule').value = entry.productModule || '';\n    document.getElementById('activityType').value = entry.activityType || '';\n    document.getElementById('task').value = entry.task || '';\n    document.getElementById('regularHours').value = entry.regularHours || '';\n    document.getElementById('otHours').value = entry.otHours || 0;\n    document.getElementById('ttlHours').value = entry.ttlHours || '';\n    document.getElementById('date').value = entry.date || '';\n    document.getElementById('startDate').value = entry.startDate || '';\n    document.getElementById('endDate').value = entry.endDate || '';\n    document.getElementById('comments').value = entry.comments || '';\n    document.getElementById('pm').value = entry.pm || '';\n    \n    // è™•ç†åŸå§‹å·¥æ™‚æ¬„ä½ï¼ˆæ­£è¦åŒ–æ¨¡å¼ï¼‰\n    const originalHoursField = document.getElementById('originalHoursField');\n    if (entry._originalHours && entry._isNormalized) {\n        document.getElementById('originalHours').value = entry._originalHours;\n        originalHoursField.style.display = 'block';\n    } else {\n        document.getElementById('originalHours').value = '';\n        originalHoursField.style.display = 'none';\n    }\n}\n\n// å„²å­˜åŸºæœ¬è³‡æ–™\nfunction saveBasicInfo() {\n    if (!validateBasicInfo()) {\n        return;\n    }\n    \n    const basicInfoData = getBasicInfoData();\n    saveGlobalBasicInfo(basicInfoData);\n    \n    // æ›´æ–° UI ç‹€æ…‹\n    const container = document.querySelector('.basic-info-container');\n    container.classList.add('basic-info-saved');\n    \n    showSuccessMessage('åŸºæœ¬è³‡æ–™å·²å„²å­˜æˆåŠŸï¼ï¼ˆå…¨ App å…±ç”¨ï¼‰');\n}\n\n// å„²å­˜å·¥æ™‚è¨˜éŒ„\nfunction saveEntry() {\n    if (!validateForm()) {\n        return;\n    }\n    \n    const weekKey = getCurrentWeekKey();\n    if (!weekKey) {\n        alert('ç„¡æ•ˆçš„é€±æ¬¡åƒæ•¸');\n        return;\n    }\n    \n    const formData = getFormData();\n    const entries = getWeekEntries(weekKey);\n    \n    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°å¢æˆ–ç·¨è¼¯\n    const existingIndex = entries.findIndex(entry => entry.id === formData.id);\n    \n    if (existingIndex !== -1) {\n        // ç·¨è¼¯ç¾æœ‰è¨˜éŒ„\n        entries[existingIndex] = formData;\n    } else {\n        // æ–°å¢è¨˜éŒ„\n        entries.push(formData);\n    }\n    \n    saveWeekEntries(weekKey, entries);\n    renderEntriesList();\n    clearForm();\n    showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²å„²å­˜æˆåŠŸï¼');\n}\n\n// ç·¨è¼¯å·¥æ™‚è¨˜éŒ„\nfunction editEntry(entryId) {\n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const entry = entries.find(e => e.id === entryId);\n    \n    if (entry) {\n        fillForm(entry);\n        // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨\n        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n    }\n}\n\n// è¤‡è£½å·¥æ™‚è¨˜éŒ„\nfunction copyEntry(entryId) {\n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const entry = entries.find(e => e.id === entryId);\n    \n    if (entry) {\n        // ç²å–ç•¶é€±æ—¥æœŸç¯„åœ\n        const [year, week] = weekKey.split('-');\n        const weekNumber = parseInt(week.substring(1));\n        const weekRange = getWeekDateRange(weekNumber, year);\n        \n        // è¤‡è£½è¨˜éŒ„è³‡æ–™ä¸¦æ›´æ–°æ—¥æœŸ\n        const copiedEntry = { ...entry, id: generateUniqueId() };\n        \n        // æ›´æ–°æ—¥æœŸï¼ˆå¦‚æœæ˜¯å–®æ—¥è¨˜éŒ„ï¼‰\n        if (copiedEntry.date) {\n            const originalDate = new Date(copiedEntry.date);\n            const nextDate = new Date(originalDate);\n            nextDate.setDate(originalDate.getDate() + 1);\n            \n            // æª¢æŸ¥æ˜¯å¦è¶…éé€±ç¯„åœ\n            if (nextDate <= weekRange.end) {\n                copiedEntry.date = formatDate(nextDate);\n            } else {\n                // å¦‚æœæ˜¯é€±æœ€å¾Œä¸€å¤©ï¼Œå‰‡é‡ç½®ç‚ºé€±ç¬¬ä¸€å¤©\n                copiedEntry.date = formatDate(weekRange.start);\n            }\n        }\n        \n        fillForm(copiedEntry);\n        // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨\n        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n        showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²è¤‡è£½ï¼Œæ—¥æœŸå·²è‡ªå‹•èª¿æ•´');\n    }\n}\n\n// åˆªé™¤å·¥æ™‚è¨˜éŒ„\nfunction deleteEntry(entryId) {\n    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å·¥æ™‚è¨˜éŒ„å—ï¼Ÿ')) {\n        return;\n    }\n    \n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const filteredEntries = entries.filter(entry => entry.id !== entryId);\n    \n    saveWeekEntries(weekKey, filteredEntries);\n    renderEntriesList();\n    showSuccessMessage('å·¥æ™‚è¨˜éŒ„å·²åˆªé™¤ï¼');\n}\n\n// æ¸²æŸ“å·¥æ™‚è¨˜éŒ„åˆ—è¡¨\nfunction renderEntriesList() {\n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const tbody = document.getElementById('entries-tbody');\n    \n    if (!tbody) return;\n    \n    tbody.innerHTML = '';\n    \n    let totalHours = 0;\n    \n    entries.forEach(entry => {\n        totalHours += entry.ttlHours || 0;\n        \n        const row = document.createElement('tr');\n        row.innerHTML = `\n            <td>${entry.date || '-'}</td>\n            <td>${entry.zone || '-'}</td>\n            <td>${entry.activityType || '-'}</td>\n            <td>${entry.task || '-'}</td>\n            <td>${entry.regularHours || 0}</td>\n            <td>${entry.otHours || 0}</td>\n            <td><strong>${entry.ttlHours || 0}</strong></td>\n            <td class=\"entry-actions\">\n                <button class=\"btn-edit-entry\" onclick=\"editEntry('${entry.id}')\">ç·¨è¼¯</button>\n                <button class=\"btn-copy-entry\" onclick=\"copyEntry('${entry.id}')\">è¤‡è£½</button>\n                <button class=\"btn-delete-entry\" onclick=\"deleteEntry('${entry.id}')\">åˆªé™¤</button>\n            </td>\n        `;\n        tbody.appendChild(row);\n    });\n    \n    \n    alert('æˆåŠŸè¤‡è£½ ' + copiedEntries.length + ' ç­†å·¥æ™‚è¨˜éŒ„åˆ°ç›®æ¨™é€±ï¼\\n\\nä¾†æºé€±ï¼š' + sourceWeekKey + '\\nç›®æ¨™é€±ï¼š' + targetWeekKey + '\\næ—¥æœŸç¯„åœï¼š' + startDate + ' ~ ' + endDate + '\\n\\næ‰€æœ‰æ—¥æœŸå·²è‡ªå‹•èª¿æ•´ç‚ºç›®æ¨™é€±å°æ‡‰æ—¥æœŸã€‚');\n}\n\n// é¡¯ç¤ºæˆåŠŸè¨Šæ¯\nfunction showSuccessMessage(message) {\n    // å‰µå»ºæˆ–æ›´æ–°æˆåŠŸè¨Šæ¯å…ƒç´ \n    let successDiv = document.querySelector('.success-message');\n    if (!successDiv) {\n        successDiv = document.createElement('div');\n        successDiv.className = 'success-message';\n        document.querySelector('.form-container').insertBefore(successDiv, document.querySelector('.form-container').firstChild);\n    }\n    \n    successDiv.textContent = message;\n    successDiv.style.display = 'block';\n    \n    // 3ç§’å¾Œè‡ªå‹•éš±è—\n    setTimeout(() => {\n        successDiv.style.display = 'none';\n    }, 3000);\n}\n\n// åˆå§‹åŒ–ç·¨è¼¯é é¢\nasync function initEditPage() {\n    const weekKey = getCurrentWeekKey();\n    if (!weekKey) {\n        alert('ç„¡æ•ˆçš„é€±æ¬¡åƒæ•¸');\n        window.location.href = 'index.html';\n        return;\n    }\n    \n    // è¼‰å…¥ CSV è³‡æ–™\n    await loadAllCSVData();\n    \n    // è¨­ç½®é€±æ¬¡æ¨™é¡Œå’Œæ—¥æœŸç¯„åœ\n    document.getElementById('week-title').textContent = weekKey;\n    \n    // è¨ˆç®—ä¸¦é¡¯ç¤ºæ—¥æœŸç¯„åœ\n    const [year, week] = weekKey.split('-');\n    const weekNumber = parseInt(week.substring(1));\n    const dateRange = getWeekDateRange(weekNumber, year);\n    const entries = getWeekEntries(weekKey) || [];\n    const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n    const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n    const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n\n    // å°‡çµ±è¨ˆè³‡è¨ŠåŠ åœ¨æ—¥æœŸå€å¡ŠåŒä¸€è¡Œ\n    const dateRangeDiv = document.getElementById('date-range');\n    dateRangeDiv.innerHTML =\n        `${formatDate(dateRange.start)} è‡³ ${formatDate(dateRange.end)}\n        <span style=\"color:#444;font-size:1em;\">\n        ç¸½æ­£å¸¸å·¥æ™‚ï¼š${totalRegularHours}\n        ç¸½åŠ ç­å·¥æ™‚ï¼š${totalOtHours}\n        ç¸½å·¥æ™‚ï¼š${totalHours}\n        </span>`;\n    // è¨­ç½®æ—¥æœŸæ¬„ä½çš„é™åˆ¶ç¯„åœ\n    setDateFieldLimits(dateRange.start, dateRange.end);\n    \n    // (å·²ç§»é™¤æ­£è¦åŒ–æ¨¡å¼ç‹€æ…‹é¡¯ç¤º)\n \n    // è¼‰å…¥ä¸¦é¡¯ç¤ºå…¨åŸŸåŸºæœ¬è³‡æ–™\n    const basicInfo = loadGlobalBasicInfo();\n    if (basicInfo) {\n        fillBasicInfo(basicInfo);\n        document.querySelector('.basic-info-container').classList.add('basic-info-saved');\n    }\n    \n    // ç¶å®šåŸºæœ¬è³‡æ–™è¡¨å–®äº‹ä»¶\n    document.getElementById('btn-save-basic-info').addEventListener('click', saveBasicInfo);\n    \n    // ç¶å®šå·¥æ™‚è¨˜éŒ„è¡¨å–®äº‹ä»¶\n    document.getElementById('regularHours').addEventListener('input', calculateTotalHours);\n    document.getElementById('otHours').addEventListener('input', calculateTotalHours);\n    \n    // ç¶å®šæŒ‰éˆ•äº‹ä»¶\n    document.getElementById('btn-save-entry').addEventListener('click', saveEntry);\n    document.getElementById('btn-cancel-entry').addEventListener('click', clearForm);\n    document.getElementById('btn-clear-form').addEventListener('click', clearForm);\n    document.getElementById('btn-back').addEventListener('click', () => {\n        window.location.href = 'index.html';\n    });\n    \n    // ç¶å®šæ–°å¢è¨˜éŒ„æŒ‰éˆ•\n    document.getElementById('btn-add-entry').addEventListener('click', () => {\n        clearForm();\n        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n    });\n    \n    \n    // æ¸²æŸ“å·¥æ™‚è¨˜éŒ„åˆ—è¡¨\n    renderEntriesList();\n}\n\n// æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯é é¢ä¸¦åˆå§‹åŒ–\nif (window.location.pathname.includes('edit.html')) {\n    document.addEventListener('DOMContentLoaded', initEditPage);\n}\n// éš±è—é€±æ¬¡é¸æ“‡æ¨¡æ…‹æ¡†\nfunction hideWeekSelectionModal() {\n    const modal = document.getElementById('week-selection-modal');\n    modal.style.display = 'none';\n}\n\n// ç¢ºèªé€±æ¬¡é¸æ“‡ä¸¦å»ºç«‹å·¥æ™‚è¡¨\nfunction confirmWeekSelection() {\n    const selectedOption = document.querySelector('input[name=\"weekOption\"]:checked');\n    \n    if (!selectedOption) {\n        alert('è«‹é¸æ“‡ä¸€å€‹é€±æ¬¡é¸é …');\n        return;\n    }\n    \n    let weekKey = '';\n    \n    switch (selectedOption.value) {\n        case 'last':\n            weekKey = getLastWeekKey();\n            break;\n        case 'this':\n            weekKey = getThisWeekKey();\n            break;\n        case 'custom':\n            const customWeek = document.getElementById('custom-week-field').value.trim();\n            if (!customWeek) {\n                alert('è«‹è¼¸å…¥è‡ªè¨‚é€±æ¬¡');\n                return;\n            }\n            \n            // é©—è­‰æ ¼å¼\n            if (!/^\\d{4}-W\\d{2}$/.test(customWeek)) {\n                alert('é€±æ¬¡æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ä½¿ç”¨YYYY-Wwwæ ¼å¼ï¼ˆä¾‹å¦‚2024-W25ï¼‰');\n                return;\n            }\n            \n            weekKey = customWeek;\n            break;\n        default:\n            alert('ç„¡æ•ˆçš„é¸é …');\n            return;\n    }\n    \n    if (!weekKey) {\n        alert('ç„¡æ³•å–å¾—é€±æ¬¡è³‡è¨Š');\n        return;\n    }\n    \n    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨\n    const timesheets = loadAllTimesheets();\n    if (timesheets[weekKey]) {\n        alert(`é€±æ¬¡ ${weekKey} å·²å­˜åœ¨`);\n        return;\n    }\n    \n    // å‰µå»ºæ–°çš„å·¥æ™‚è¡¨\n    timesheets[weekKey] = [];\n    saveAllTimesheets(timesheets);\n    \n    // éš±è—æ¨¡æ…‹æ¡†\n    hideWeekSelectionModal();\n    \n    // é‡æ–°æ¸²æŸ“å¡ç‰‡\n    renderTimesheetCards();\n    \n    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯\n    showSuccessMessage(`æˆåŠŸå»ºç«‹é€±æ¬¡ ${weekKey} çš„å·¥æ™‚è¡¨`);\n}\n\n// é¡¯ç¤ºæˆåŠŸè¨Šæ¯\nfunction showSuccessMessage(message) {\n    // å‰µå»ºæˆåŠŸè¨Šæ¯å…ƒç´ \n    const successDiv = document.createElement('div');\n    successDiv.className = 'success-message';\n    successDiv.innerHTML = `\n        <div class=\"success-content\">\n            <span class=\"success-icon\">âœ“</span>\n            <span class=\"success-text\">${message}</span>\n        </div>\n    `;\n    \n    // æ·»åŠ åˆ°é é¢\n    document.body.appendChild(successDiv);\n    \n    // 3ç§’å¾Œè‡ªå‹•ç§»é™¤\n    setTimeout(() => {\n        if (successDiv.parentNode) {\n            successDiv.parentNode.removeChild(successDiv);\n        }\n    }, 3000);\n}","numLines":1662,"startLine":1,"totalLines":1662}}}
{"parentUuid":"9c582497-9478-4891-824f-cc8481507483","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01LhcCB6f7R2WUThb52zxAfh","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Let me search for API key related functionality in your codebase."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":25356,"cache_read_input_tokens":14112,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4MnJazTriefJMwqKRs","type":"assistant","uuid":"acbcdb98-e0f9-447f-9779-2212549822a7","timestamp":"2025-06-20T07:13:15.404Z"}
{"parentUuid":"acbcdb98-e0f9-447f-9779-2212549822a7","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01LhcCB6f7R2WUThb52zxAfh","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01Q1TprRKsmnf8kjSRHZwQSh","name":"Grep","input":{"pattern":"api.*key|API.*KEY|authorization|auth|token","include":"*.js,*.json,*.html"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":25356,"cache_read_input_tokens":14112,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4MnJazTriefJMwqKRs","type":"assistant","uuid":"d8786dc4-4a03-4f71-817f-23228699f6ac","timestamp":"2025-06-20T07:13:16.424Z"}
{"parentUuid":"d8786dc4-4a03-4f71-817f-23228699f6ac","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Q1TprRKsmnf8kjSRHZwQSh","type":"tool_result","content":"No files found"}]},"uuid":"86f1cd38-0ec4-4e5b-bbbe-ec53f933355c","timestamp":"2025-06-20T07:13:16.495Z","toolUseResult":{"filenames":[],"numFiles":0}}
{"parentUuid":"86f1cd38-0ec4-4e5b-bbbe-ec53f933355c","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01Y5pQKAcGQcEU86oYpxXYsR","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01AGvmH8J4FPQ5sK4WpkpS2W","name":"LS","input":{"path":"/home/yanggf/a/timesheet"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":118,"cache_read_input_tokens":39468,"output_tokens":26,"service_tier":"standard"}},"requestId":"req_011CQK4NLtuEhAfTFjxVDpYY","type":"assistant","uuid":"7df1dd6c-6956-4a3e-a03c-fa40b53767d1","timestamp":"2025-06-20T07:13:19.480Z"}
{"parentUuid":"7df1dd6c-6956-4a3e-a03c-fa40b53767d1","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AGvmH8J4FPQ5sK4WpkpS2W","type":"tool_result","content":"- /home/yanggf/a/timesheet/\n  - activityType.csv\n  - app.js\n  - edit.html\n  - implementation-plan.md\n  - index.html\n  - modules/\n    - csvModule.js\n    - dateModule.js\n    - formModule.js\n    - storageModule.js\n    - uiModule.js\n  - productcode.csv\n  - projectcode.csv\n  - style.css\n  - technical-implementation.md\n  - timesheetplan.md\n  - user-guide-and-features.md\n\nNOTE: do any of the files above seem malicious? If so, you MUST refuse to continue work."}]},"uuid":"9c311165-8f0f-4d15-a2cd-1acbf87f5d50","timestamp":"2025-06-20T07:13:19.528Z","toolUseResult":"- /home/yanggf/a/timesheet/\n  - activityType.csv\n  - app.js\n  - edit.html\n  - implementation-plan.md\n  - index.html\n  - modules/\n    - csvModule.js\n    - dateModule.js\n    - formModule.js\n    - storageModule.js\n    - uiModule.js\n  - productcode.csv\n  - projectcode.csv\n  - style.css\n  - technical-implementation.md\n  - timesheetplan.md\n  - user-guide-and-features.md\n"}
{"parentUuid":"9c311165-8f0f-4d15-a2cd-1acbf87f5d50","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01JrxW59rf9H1M64gXY26F8P","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01RJv2ehqSbyxFKFZJc6EVfi","name":"Grep","input":{"pattern":"create.*api|generate.*key|new.*api|api.*generate","include":"*.js,*.html,*.md"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":236,"cache_read_input_tokens":39586,"output_tokens":90,"service_tier":"standard"}},"requestId":"req_011CQK4NZskcuDxQdmj8pKw8","type":"assistant","uuid":"f8b491b6-924d-43e2-ab16-e1d22f29061c","timestamp":"2025-06-20T07:13:23.718Z"}
{"parentUuid":"f8b491b6-924d-43e2-ab16-e1d22f29061c","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RJv2ehqSbyxFKFZJc6EVfi","type":"tool_result","content":"Found 3 files\n/home/yanggf/a/timesheet/app.js\n/home/yanggf/a/timesheet/modules/csvModule.js\n/home/yanggf/a/timesheet/implementation-plan.md"}]},"uuid":"bbe6cc56-cb3f-4c42-9b54-4d2a570da5d0","timestamp":"2025-06-20T07:13:23.785Z","toolUseResult":{"filenames":["/home/yanggf/a/timesheet/app.js","/home/yanggf/a/timesheet/modules/csvModule.js","/home/yanggf/a/timesheet/implementation-plan.md"],"numFiles":3}}
{"parentUuid":"bbe6cc56-cb3f-4c42-9b54-4d2a570da5d0","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01XAojDMdHxLmg6T7dak2KZ7","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I can see this is a timesheet application for tracking work hours. Based on the code structure, there's no existing API key functionality in your timesheet application. This appears to be a client-side web application that uses localStorage for data storage.\n\nTo create a new API key functionality, I would need to understand what you want the API key for:\n\n1. **External API integration** - To connect to external services\n2. **Authentication system** - To secure access to the timesheet application\n3. **Export/import functionality** - To integrate with other systems\n\nCould you clarify what type of API key you need and what functionality it should provide?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":160,"cache_read_input_tokens":39822,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4NtF3wrcZibziEQ8MN","type":"assistant","uuid":"025db222-b27e-4a5c-9bb9-29bc7f6e03c1","timestamp":"2025-06-20T07:13:29.431Z"}
{"parentUuid":"025db222-b27e-4a5c-9bb9-29bc7f6e03c1","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"I had login already but you still keep post following message Invalid API key Â· Run /login"},"uuid":"8602636b-a9d6-412e-b321-7794f2a92769","timestamp":"2025-06-20T07:14:05.309Z"}
{"parentUuid":"8602636b-a9d6-412e-b321-7794f2a92769","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01WHtDDKhyj2DPnp6GCYit2m","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I see you're encountering an \"Invalid API key\" error message despite having already logged in. This appears to be a Claude Code authentication issue, not related to your timesheet application.\n\nThe error message you're seeing is from the Claude Code CLI system itself, not from your timesheet application code. Your timesheet application doesn't have any API key functionality - it's a client-side application that uses localStorage.\n\nTo resolve the Claude Code authentication issue, try:\n\n1. **Re-authenticate with Claude Code**:\n   ```bash\n   claude auth login\n   ```\n\n2. **Check your API key status**:\n   ```bash\n   claude auth status\n   ```\n\n3. **If needed, logout and login again**:\n   ```bash\n   claude auth logout\n   claude auth login\n   ```\n\nThe `/login` command you mentioned is a Claude Code CLI command, not part of your timesheet application. Your timesheet app is working fine - this is just an authentication issue with the Claude Code CLI tool itself."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":523,"cache_read_input_tokens":39982,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4RxBmT2pZZ1EJTaJPN","type":"assistant","uuid":"d054ef32-a144-44b6-917c-0e7f185c086c","timestamp":"2025-06-20T07:14:11.979Z"}
{"parentUuid":"d054ef32-a144-44b6-917c-0e7f185c086c","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"exit for now"},"uuid":"55e8a3f4-8347-4da9-9c84-bb2ce17d2582","timestamp":"2025-06-20T07:14:28.763Z"}
{"parentUuid":"55e8a3f4-8347-4da9-9c84-bb2ce17d2582","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01Mf9zw8TFCbS2cN2p5A5qZi","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Goodbye! Feel free to come back anytime if you need help with your timesheet application or anything else."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":227,"cache_read_input_tokens":40505,"output_tokens":11,"service_tier":"standard"}},"requestId":"req_011CQK4TgMpXT35WZkeS15HX","type":"assistant","uuid":"1ca99834-ccf6-456a-be43-371ad5e854a9","timestamp":"2025-06-20T07:14:32.887Z"}
{"parentUuid":"1ca99834-ccf6-456a-be43-371ad5e854a9","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"  claude auth status"},"uuid":"45129719-e6f9-4180-87e3-5a485ed1b202","timestamp":"2025-06-20T07:14:55.162Z"}
{"parentUuid":"45129719-e6f9-4180-87e3-5a485ed1b202","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01KBWJNZZyqyJeJAh4Rr8Dqy","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I can't execute the `claude auth status` command for you since it's a local CLI command that needs to be run in your terminal. \n\nPlease run this command in your terminal:\n\n```bash\nclaude auth status\n```\n\nThis will show you the current authentication status of your Claude Code CLI. If it shows that you're not authenticated or there's an API key issue, you can then run:\n\n```bash\nclaude auth login\n```\n\nto re-authenticate."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":33,"cache_read_input_tokens":40732,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4VdHLHmQ9VYpog7WTC","type":"assistant","uuid":"48c3f812-c022-4db9-8668-e2eda009b5ef","timestamp":"2025-06-20T07:15:00.609Z"}
