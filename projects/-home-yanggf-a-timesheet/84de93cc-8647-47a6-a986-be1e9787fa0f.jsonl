{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"1"},"uuid":"92dde46e-4c3c-4f75-87b7-870b5cf051ed","timestamp":"2025-06-20T07:09:47.417Z"}
{"parentUuid":"92dde46e-4c3c-4f75-87b7-870b5cf051ed","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"assistant","uuid":"52267d48-7cb5-4276-8fae-01e14c33b191","timestamp":"2025-06-20T07:09:48.596Z","message":{"id":"68da64fd-c3eb-46a4-b961-943591d79ae6","model":"<synthetic>","role":"assistant","stop_reason":"stop_sequence","stop_sequence":"","type":"message","usage":{"input_tokens":0,"output_tokens":0,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"server_tool_use":{"web_search_requests":0}},"content":[{"type":"text","text":"Invalid API key · Please run /login"}]},"isApiErrorMessage":true}
{"parentUuid":"52267d48-7cb5-4276-8fae-01e14c33b191","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to."},"isMeta":true,"uuid":"bdb8e546-8f7a-4a60-aaf5-82f8a6dccadf","timestamp":"2025-06-20T07:09:22.813Z"}
{"parentUuid":"bdb8e546-8f7a-4a60-aaf5-82f8a6dccadf","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"<command-name>/login</command-name>\n            <command-message>login</command-message>\n            <command-args></command-args>"},"uuid":"d0ece558-46fc-4a2a-9c01-41b68c87504f","timestamp":"2025-06-20T07:10:28.266Z"}
{"parentUuid":"d0ece558-46fc-4a2a-9c01-41b68c87504f","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"<local-command-stdout>Login successful</local-command-stdout>"},"uuid":"f6009438-a00d-4acc-875a-010ffd1346fd","timestamp":"2025-06-20T07:10:28.266Z"}
{"parentUuid":"f6009438-a00d-4acc-875a-010ffd1346fd","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"login"},"uuid":"02cf1364-a35d-444b-8f66-096e7047bda2","timestamp":"2025-06-20T07:10:41.628Z"}
{"parentUuid":"02cf1364-a35d-444b-8f66-096e7047bda2","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_013XFSkbDnBUdmV9mwBXPviK","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I see you've successfully logged in and have the timesheet app.js file open. The git status shows you have several modified files in your timesheet project. How can I help you with your timesheet application?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":13971,"cache_read_input_tokens":0,"output_tokens":47,"service_tier":"standard"}},"requestId":"req_011CQK4AwZ9MJ68jaDfzkf96","type":"assistant","uuid":"d3b584ff-211b-4c0e-a4f7-ead91700cff7","timestamp":"2025-06-20T07:10:46.880Z"}
{"parentUuid":"bdb8e546-8f7a-4a60-aaf5-82f8a6dccadf","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"<command-name>/login</command-name>\n            <command-message>login</command-message>\n            <command-args></command-args>"},"uuid":"30b5a2e3-6cca-4228-bea8-db932708f74b","timestamp":"2025-06-20T07:12:43.424Z"}
{"parentUuid":"30b5a2e3-6cca-4228-bea8-db932708f74b","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"<local-command-stdout>Login successful</local-command-stdout>"},"uuid":"dedd0ed5-9db9-4224-bf98-9a9651a08cca","timestamp":"2025-06-20T07:12:43.424Z"}
{"parentUuid":"dedd0ed5-9db9-4224-bf98-9a9651a08cca","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"create new api key"},"uuid":"37baac50-06b9-4f12-90be-1b57edc8829a","timestamp":"2025-06-20T07:13:03.829Z"}
{"parentUuid":"37baac50-06b9-4f12-90be-1b57edc8829a","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01TZkbgby3V9KXSouQm6haxH","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I'll help you create a new API key. Let me first examine your current codebase to understand how API keys are handled in your timesheet application."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":141,"cache_read_input_tokens":13971,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4MQoGeBkwHJs36xUGH","type":"assistant","uuid":"32182b16-7cbc-44d3-a2a1-d310111ef994","timestamp":"2025-06-20T07:13:07.214Z"}
{"parentUuid":"32182b16-7cbc-44d3-a2a1-d310111ef994","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01TZkbgby3V9KXSouQm6haxH","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01GSHTjCUscAGFSEvbFvb4MP","name":"Read","input":{"file_path":"/home/yanggf/a/timesheet/app.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":141,"cache_read_input_tokens":13971,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4MQoGeBkwHJs36xUGH","type":"assistant","uuid":"4fa39b3d-ebfd-4d09-9631-62948ef00b63","timestamp":"2025-06-20T07:13:08.188Z"}
{"parentUuid":"4fa39b3d-ebfd-4d09-9631-62948ef00b63","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GSHTjCUscAGFSEvbFvb4MP","type":"tool_result","content":"     1→import { loadAllTimesheets, saveAllTimesheets, loadGlobalBasicInfo, getWeekEntries, saveWeekEntries } from './modules/storageModule.js';\n     2→import { loadAllCSVData, getProjectsByZone, getPMByProject, getProductModulesByZone, updateProjectOptions, updateProjectDropdown, updateProductModuleDropdown, updateActivityTypeOptions, generateCSVContent, downloadCSVFile } from './modules/csvModule.js';\n     3→import { getWeekNumber, getWeekDateRangeFromKey } from './modules/dateModule.js';\n     4→import {\n     5→    showSuccessMessage,\n     6→    showCopyOptionsModal,\n     7→    closeCopyModal,\n     8→    handleCopySelection,\n     9→    copyWeekToTargetWeek\n    10→} from './modules/uiModule.js';\n    11→        const sourceEndDate = sourceWeekRange.end.toISOString().split('T')[0];\n    12→        sourceDescription = `${sourceWeekKey} 工時表 (${sourceStartDate} ~ ${sourceEndDate})`;\n    13→    }\n    14→    \n    15→    // 更新模態視窗標題以包含來源週資訊\n    16→    document.querySelector('#copy-options-modal .modal-header h3').textContent =\n    17→        `複製 ${sourceDescription} 到哪一週？`;\n    18→    \n    19→    // 更新模態視窗中的目標週次資訊\n    20→    const currentWeekRange = getWeekDateRangeFromKey(currentWeekKey);\n    21→    const lastWeekRange = getWeekDateRangeFromKey(lastWeekKey);\n    22→    \n    23→    document.getElementById('copy-current-week-info').textContent =\n    24→        `${currentWeekKey} (${currentWeekRange.start.toISOString().split('T')[0]} ~ ${currentWeekRange.end.toISOString().split('T')[0]})`;\n    25→    document.getElementById('copy-last-week-info').textContent =\n    26→        `${lastWeekKey} (${lastWeekRange.start.toISOString().split('T')[0]} ~ ${lastWeekRange.end.toISOString().split('T')[0]})`;\n    27→    \n    28→    // 顯示模態視窗\n    29→    document.getElementById('copy-options-modal').style.display = 'block';\n    30→    \n    31→    // 綁定按鈕事件\n    32→    document.getElementById('copy-btn-current').onclick = function() {\n    33→        handleCopySelection(sourceWeekKey, currentWeekKey);\n    34→    };\n    35→    \n    36→    document.getElementById('copy-btn-last').onclick = function() {\n    37→        handleCopySelection(sourceWeekKey, lastWeekKey);\n    38→    };\n    39→    \n    40→    document.getElementById('copy-btn-custom').onclick = function() {\n    41→        document.getElementById('copy-custom-week-input').style.display = 'block';\n    42→        document.getElementById('copy-custom-week-field').focus();\n    43→    };\n    44→    \n    45→    document.getElementById('copy-btn-custom-confirm').onclick = function() {\n    46→        const customWeekKey = document.getElementById('copy-custom-week-field').value.trim().toUpperCase();\n    47→        if (!customWeekKey) {\n    48→            alert('請輸入週次。');\n    49→            return;\n    50→        }\n    51→        \n    52→        const weekKeyPattern = /^\\d{4}-W(0[1-9]|[1-4]\\d|5[0-3])$/;\n    53→        if (!weekKeyPattern.test(customWeekKey)) {\n    54→            alert('無效的週次格式。請使用 YYYY-WNN 格式。');\n    55→            return;\n    56→        }\n    57→        \n    58→        handleCopySelection(sourceWeekKey, customWeekKey);\n    59→    };\n    60→    \n    61→    document.getElementById('copy-btn-custom-cancel').onclick = function() {\n    62→        document.getElementById('copy-custom-week-input').style.display = 'none';\n    63→        document.getElementById('copy-custom-week-field').value = '';\n    64→    };\n    65→    \n    66→    document.getElementById('copy-btn-cancel').onclick = function() {\n    67→        closeCopyModal();\n    68→    };\n    69→}\n    70→\n    71→// 處理複製選擇的函數\n    72→function handleCopySelection(sourceWeekKey, targetWeekKey) {\n    73→    // 顯示確認對話框\n    74→    const sourceWeekRange = getWeekDateRangeFromKey(sourceWeekKey);\n    75→    const targetWeekRange = getWeekDateRangeFromKey(targetWeekKey);\n    76→    const sourceStartDate = sourceWeekRange.start.toISOString().split('T')[0];\n    77→    const sourceEndDate = sourceWeekRange.end.toISOString().split('T')[0];\n    78→    const targetStartDate = targetWeekRange.start.toISOString().split('T')[0];\n    79→    const targetEndDate = targetWeekRange.end.toISOString().split('T')[0];\n    80→    \n    81→    // 取得來源週的工時記錄數量\n    82→    const timesheets = loadAllTimesheets();\n    83→    let sourceEntries = [];\n    84→    const sourceWeekData = timesheets[sourceWeekKey];\n    85→    if (Array.isArray(sourceWeekData)) {\n    86→        sourceEntries = sourceWeekData;\n    87→    } else if (sourceWeekData && sourceWeekData.entries) {\n    88→        sourceEntries = sourceWeekData.entries;\n    89→    }\n    90→    \n    91→    const confirmMessage = `確認要複製工時記錄嗎？\\n\\n` +\n    92→                           `來源週：${sourceWeekKey}\\n` +\n    93→                           `日期範圍：${sourceStartDate} ~ ${sourceEndDate}\\n` +\n    94→                           `記錄筆數：${sourceEntries.length} 筆\\n\\n` +\n    95→                           `目標週：${targetWeekKey}\\n` +\n    96→                           `日期範圍：${targetStartDate} ~ ${targetEndDate}\\n\\n` +\n    97→                           `所有日期將自動調整為目標週對應日期。`;\n    98→    \n    99→    if (confirm(confirmMessage)) {\n   100→        copyWeekToTargetWeek(sourceWeekKey, targetWeekKey);\n   101→        closeCopyModal();\n   102→    }\n   103→}\n   104→\n   105→// 關閉複製模態視窗的函數\n   106→function closeCopyModal() {\n   107→    document.getElementById('copy-options-modal').style.display = 'none';\n   108→    document.getElementById('copy-custom-week-input').style.display = 'none';\n   109→    document.getElementById('copy-custom-week-field').value = '';\n   110→}\n   111→\n   112→// 設置日期欄位的限制範圍\n   113→function setDateFieldLimits(startDate, endDate) {\n   114→    const minDate = formatDate(startDate);\n   115→    const maxDate = formatDate(endDate);\n   116→    \n   117→    // 設置日期欄位的 min 和 max 屬性\n   118→    const dateFields = ['date', 'startDate', 'endDate'];\n   119→    dateFields.forEach(fieldId => {\n   120→        const field = document.getElementById(fieldId);\n   121→        if (field) {\n   122→            field.min = minDate;\n   123→            field.max = maxDate;\n   124→            \n   125→            // 如果欄位有值但超出範圍，則清空\n   126→            if (field.value) {\n   127→                const fieldDate = new Date(field.value);\n   128→                if (fieldDate < startDate || fieldDate > endDate) {\n   129→                    field.value = '';\n   130→                }\n   131→            }\n   132→        }\n   133→    });\n   134→}\n   135→\n   136→// 驗證日期是否在週範圍內\n   137→function validateDateInWeekRange(date, startDate, endDate) {\n   138→    if (!date) return true; // 空值允許\n   139→    \n   140→    const inputDate = new Date(date);\n   141→    return inputDate >= startDate && inputDate <= endDate;\n   142→}\n   143→\n   144→// 啟用正規化模式\n   145→function enableNormalizationMode(weekKey) {\n   146→    // 儲存正規化狀態到 localStorage\n   147→    const normalizationData = {\n   148→        weekKey: weekKey,\n   149→        enabled: true,\n   150→        timestamp: new Date().toISOString()\n   151→    };\n   152→    localStorage.setItem(`normalization_${weekKey}`, JSON.stringify(normalizationData));\n   153→    \n   154→    // 更新 UI 顯示正規化模式狀態\n   155→    updateNormalizationModeDisplay(weekKey);\n   156→}\n   157→\n   158→// 檢查是否啟用正規化模式\n   159→function isNormalizationEnabled(weekKey) {\n   160→    const data = localStorage.getItem(`normalization_${weekKey}`);\n   161→    return data ? JSON.parse(data).enabled : false;\n   162→}\n   163→\n   164→// 更新正規化模式顯示\n   165→function updateNormalizationModeDisplay(weekKey) {\n   166→    const isEnabled = isNormalizationEnabled(weekKey);\n   167→    const weekInfoDiv = document.querySelector('.week-info');\n   168→    \n   169→    // 移除舊的正規化提示\n   170→    const existingAlert = weekInfoDiv.querySelector('.normalization-alert');\n   171→    if (existingAlert) {\n   172→        existingAlert.remove();\n   173→    }\n   174→    \n   175→    if (isEnabled) {\n   176→        // 顯示正規化模式提示\n   177→        const alertDiv = document.createElement('div');\n   178→        alertDiv.className = 'normalization-alert';\n   179→        alertDiv.innerHTML = `\n   180→            <div class=\"alert alert-info\">\n   181→                <strong>📊 正規化模式已啟用</strong> - 該週工時超過40小時，匯出時將自動進行正規化計算\n   182→                <button onclick=\"disableNormalizationMode('${weekKey}')\" class=\"btn-disable-normalization\">停用</button>\n   183→            </div>\n   184→        `;\n   185→        weekInfoDiv.appendChild(alertDiv);\n   186→    }\n   187→}\n   188→\n   189→// 停用正規化模式\n   190→function disableNormalizationMode(weekKey) {\n   191→    localStorage.removeItem(`normalization_${weekKey}`);\n   192→    updateNormalizationModeDisplay(weekKey);\n   193→    showSuccessMessage('正規化模式已停用');\n   194→}\n   195→\n   196→// 匯出時進行正規化計算\n   197→function performNormalizationForExport(entries) {\n   198→    let totalRegularHours = 0;\n   199→\n   200→    // 計算總正常工時\n   201→    entries.forEach(entry => {\n   202→        totalRegularHours += entry.regularHours || 0;\n   203→    });\n   204→\n   205→    if (totalRegularHours > 40) {\n   206→        const normalizedEntries = entries.map(entry => {\n   207→            const originalHours = entry.regularHours || 0;\n   208→            const ratio = 40 / totalRegularHours;\n   209→            const newRegularHours = Math.round(originalHours * ratio * 100) / 100;\n   210→            // 保存原始工時\n   211→            return {\n   212→                ...entry,\n   213→                _originalHours: originalHours,\n   214→                _isNormalized: true,\n   215→                regularHours: newRegularHours,\n   216→                ttlHours: newRegularHours + (entry.otHours || 0)\n   217→            };\n   218→        });\n   219→        return normalizedEntries;\n   220→    }\n   221→\n   222→    return entries; // 不需要正規化\n   223→}\n   224→// 格式化日期為 YYYY-MM-DD（本地時間）\n   225→function formatDate(date) {\n   226→    const y = date.getFullYear();\n   227→    const m = String(date.getMonth() + 1).padStart(2, '0');\n   228→    const d = String(date.getDate()).padStart(2, '0');\n   229→    return `${y}-${m}-${d}`;\n   230→}\n   231→\n   232→// 從localStorage加載所有工時表數據\n   233→function loadAllTimesheets() {\n   234→    const data = localStorage.getItem('timesheets');\n   235→    return data ? JSON.parse(data) : {};\n   236→}\n   237→\n   238→// 保存所有工時表數據到localStorage\n   239→function saveAllTimesheets(timesheets) {\n   240→    localStorage.setItem('timesheets', JSON.stringify(timesheets));\n   241→}\n   242→\n   243→// 獲取指定週數的日期範圍（週日到週六）\n   244→function getWeekDateRange(weekNumber, year) {\n   245→    // 簡單實現：假設year和weekNumber是有效的\n   246→    // 實際應根據ISO週數計算，這裡簡化為從當年第一週的週日開始推算\n   247→    // 注意：這只是一個示例，實際的日期計算需要更嚴謹的邏輯\n   248→    const firstDayOfYear = new Date(year, 0, 1);\n   249→    const firstSunday = new Date(firstDayOfYear);\n   250→    // 調整到第一週的週日（假設第一週從1月1日所在週的週日開始）\n   251→    firstSunday.setDate(firstDayOfYear.getDate() - firstDayOfYear.getDay());\n   252→    \n   253→    const startDate = new Date(firstSunday);\n   254→    startDate.setDate(firstSunday.getDate() + (weekNumber - 1) * 7);\n   255→    const endDate = new Date(startDate);\n   256→    endDate.setDate(startDate.getDate() + 6);\n   257→    \n   258→    return {\n   259→        start: startDate,\n   260→        end: endDate\n   261→    };\n   262→}\n   263→\n   264→// 計算填寫進度（根據記錄筆數和預期5個工作日？這裡簡化為記錄筆數是否大於0）\n   265→function calculateProgress(entries) {\n   266→    // 如果有記錄，則認為填寫了，進度100%；否則0\n   267→    return entries && entries.length > 0 ? 100 : 0;\n   268→}\n   269→\n   270→// 渲染工時表卡片\n   271→function renderTimesheetCards() {\n   272→    const container = document.getElementById('timesheet-cards');\n   273→    container.innerHTML = ''; // 清空容器\n   274→    \n   275→    const timesheets = loadAllTimesheets();\n   276→    \n   277→    Object.keys(timesheets).forEach(key => {\n   278→        // key格式：YYYY-Www，需檢查合法性\n   279→        if (!key || typeof key !== 'string' || !key.includes('-')) return;\n   280→        const [year, week] = key.split('-');\n   281→        if (!year || !week || week.length < 2) return;\n   282→        const weekNumber = parseInt(week.substring(1));\n   283→        if (isNaN(weekNumber)) return;\n   284→        const weekData = timesheets[key];\n   285→        \n   286→        // 處理新的資料結構（包含 basicInfo 和 entries）\n   287→        let entries = [];\n   288→        if (Array.isArray(weekData)) {\n   289→            // 舊的資料結構，直接是陣列\n   290→            entries = weekData;\n   291→        } else if (weekData && weekData.entries) {\n   292→            // 新的資料結構，有 basicInfo 和 entries\n   293→            entries = weekData.entries;\n   294→        }\n   295→        \n   296→        const dateRange = getWeekDateRange(weekNumber, year);\n   297→        const startStr = dateRange.start.toISOString().split('T')[0];\n   298→        const endStr = dateRange.end.toISOString().split('T')[0];\n   299→        \n   300→        const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n   301→        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n   302→        const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n   303→        const isComplete = totalHours >= 40;\n   304→        \n   305→        // 創建卡片元素\n   306→        const card = document.createElement('div');\n   307→        card.className = 'timesheet-card';\n   308→        card.innerHTML = `\n   309→            <div class=\"card-color-bar\"></div>\n   310→            <div class=\"status-tag ${isComplete ? 'status-completed' : 'status-inprogress'}\"\n   311→                 title=\"${isComplete ? '總工時已達40小時' : '總工時未達40小時'}\">\n   312→                ${isComplete ? '✓' : '⚠'}\n   313→            </div>\n   314→            <div class=\"card-header\">\n   315→                <div class=\"week-title\">${key}</div>\n   316→                <div class=\"date-range\">${startStr} 至 ${endStr}</div>\n   317→            </div>\n   318→            <div class=\"stats\">\n   319→                <div class=\"stat-item\">\n   320→                    <div class=\"stat-value\">${entries.length}</div>\n   321→                    <div class=\"stat-label\">記錄筆數</div>\n   322→                </div>\n   323→                <div class=\"stat-item\">\n   324→                    <div class=\"stat-value\">${totalHours}</div>\n   325→                    <div class=\"stat-label\">總工時</div>\n   326→                </div>\n   327→                <div class=\"stat-item\">\n   328→                    <div class=\"stat-value\">${totalRegularHours}</div>\n   329→                    <div class=\"stat-label\">總正常工時</div>\n   330→                </div>\n   331→                <div class=\"stat-item\">\n   332→                    <div class=\"stat-value\">${totalOtHours}</div>\n   333→                    <div class=\"stat-label\">總加班工時</div>\n   334→                </div>\n   335→            </div>\n   336→            <div class=\"card-actions\">\n   337→                <button class=\"btn-edit\" data-week=\"${key}\">修改</button>\n   338→                <button class=\"btn-copy\" data-week=\"${key}\">複製</button>\n   339→                <button class=\"btn-delete\" data-week=\"${key}\">刪除</button>\n   340→                <button class=\"btn-export\" data-week=\"${key}\">匯出</button>\n   341→            </div>\n   342→        `;\n   343→        \n   344→        container.appendChild(card);\n   345→    });\n   346→    \n   347→    // 為卡片上的按鈕添加事件監聽\n   348→    document.querySelectorAll('.btn-edit').forEach(btn => {\n   349→        btn.addEventListener('click', () => {\n   350→            const weekKey = btn.getAttribute('data-week');\n   351→            editTimesheet(weekKey);\n   352→        });\n   353→    });\n   354→    \n   355→    document.querySelectorAll('.btn-delete').forEach(btn => {\n   356→        btn.addEventListener('click', () => {\n   357→            const weekKey = btn.getAttribute('data-week');\n   358→            deleteTimesheet(weekKey);\n   359→        });\n   360→    });\n   361→    \n   362→    document.querySelectorAll('.btn-copy').forEach(btn => {\n   363→        btn.addEventListener('click', () => {\n   364→            const weekKey = btn.getAttribute('data-week');\n   365→console.log('Attempting to call showCopyOptionsModal with weekKey:', weekKey);\n   366→            showCopyOptionsModal(weekKey);\n   367→        });\n   368→    });\n   369→    \n   370→    document.querySelectorAll('.btn-export').forEach(btn => {\n   371→        btn.addEventListener('click', () => {\n   372→            const weekKey = btn.getAttribute('data-week');\n   373→            exportTimesheet(weekKey);\n   374→        });\n   375→    });\n   376→    \n   377→    // 更新上週按鈕顯示狀態\n   378→    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n   379→        updateLastWeekButtonDisplay();\n   380→    }\n   381→}\n   382→\n   383→// 新建工時表 - 顯示週次選擇模態框\n   384→function newTimesheet() {\n   385→    showWeekSelectionModal();\n   386→}\n   387→\n   388→// 顯示週次選擇模態框\n   389→function showWeekSelectionModal() {\n   390→    const modal = document.getElementById('week-selection-modal');\n   391→    const timesheets = loadAllTimesheets();\n   392→    \n   393→    // 計算上週和本週的週次\n   394→    const lastWeekKey = getLastWeekKey();\n   395→    const thisWeekKey = getThisWeekKey();\n   396→    \n   397→    // 更新上週選項資訊\n   398→    const lastWeekInfo = document.getElementById('last-week-info');\n   399→    const lastWeekStatus = document.getElementById('last-week-status');\n   400→    const lastWeekOption = document.getElementById('option-last-week');\n   401→    \n   402→    if (lastWeekKey) {\n   403→        const lastWeekRange = getWeekDateRangeFromKey(lastWeekKey);\n   404→        lastWeekInfo.textContent = `${lastWeekKey} (${formatDate(lastWeekRange.start)} - ${formatDate(lastWeekRange.end)})`;\n   405→        \n   406→        if (timesheets[lastWeekKey]) {\n   407→            lastWeekStatus.textContent = '已存在';\n   408→            lastWeekStatus.className = 'option-status status-exists';\n   409→            // 如果已存在，禁用該選項\n   410→            document.getElementById('radio-last-week').disabled = true;\n   411→            lastWeekOption.style.opacity = '0.6';\n   412→        } else {\n   413→            lastWeekStatus.textContent = '可建立';\n   414→            lastWeekStatus.className = 'option-status status-new';\n   415→            document.getElementById('radio-last-week').disabled = false;\n   416→            lastWeekOption.style.opacity = '1';\n   417→        }\n   418→    } else {\n   419→        lastWeekOption.style.display = 'none';\n   420→    }\n   421→    \n   422→    // 更新本週選項資訊\n   423→    const thisWeekInfo = document.getElementById('this-week-info');\n   424→    const thisWeekStatus = document.getElementById('this-week-status');\n   425→    const thisWeekOption = document.getElementById('option-this-week');\n   426→    \n   427→    if (thisWeekKey) {\n   428→        const thisWeekRange = getWeekDateRangeFromKey(thisWeekKey);\n   429→        thisWeekInfo.textContent = `${thisWeekKey} (${formatDate(thisWeekRange.start)} - ${formatDate(thisWeekRange.end)})`;\n   430→        \n   431→        if (timesheets[thisWeekKey]) {\n   432→            thisWeekStatus.textContent = '已存在';\n   433→            thisWeekStatus.className = 'option-status status-exists';\n   434→            // 如果已存在，禁用該選項\n   435→            document.getElementById('radio-this-week').disabled = true;\n   436→            thisWeekOption.style.opacity = '0.6';\n   437→        } else {\n   438→            thisWeekStatus.textContent = '可建立';\n   439→            thisWeekStatus.className = 'option-status status-new';\n   440→            document.getElementById('radio-this-week').disabled = false;\n   441→            thisWeekOption.style.opacity = '1';\n   442→        }\n   443→    } else {\n   444→        thisWeekOption.style.display = 'none';\n   445→    }\n   446→    \n   447→    // 重置自訂輸入\n   448→    document.getElementById('custom-week-field').value = '';\n   449→    document.getElementById('custom-week-input').style.display = 'none';\n   450→    \n   451→    // 清除選擇\n   452→    document.querySelectorAll('input[name=\"weekOption\"]').forEach(radio => {\n   453→        radio.checked = false;\n   454→    });\n   455→    \n   456→    // 顯示模態框\n   457→    modal.style.display = 'block';\n   458→}\n   459→\n   460→// 取得上週的週次鍵值\n   461→function getLastWeekKey() {\n   462→    const today = new Date();\n   463→    const lastMonday = new Date(today);\n   464→    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n   465→    \n   466→    const year = lastMonday.getFullYear();\n   467→    const weekNumber = getWeekNumber(lastMonday);\n   468→    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n   469→}\n   470→\n   471→// 取得本週的週次鍵值\n   472→function getThisWeekKey() {\n   473→    const today = new Date();\n   474→    const thisMonday = new Date(today);\n   475→    thisMonday.setDate(today.getDate() - today.getDay() + 1);\n   476→    \n   477→    const year = thisMonday.getFullYear();\n   478→    const weekNumber = getWeekNumber(thisMonday);\n   479→    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n   480→}\n   481→\n   482→// 計算週數（ISO 8601）\n   483→/**\n   484→ * 以週日為週首計算週次（YYYY-Www），週日~週六\n   485→ */\n   486→function getWeekNumber(date) {\n   487→    const d = new Date(date);\n   488→    // 找到本週的週日\n   489→    const sunday = new Date(d);\n   490→    sunday.setDate(d.getDate() - d.getDay());\n   491→    // 計算今年第一天的週日\n   492→    const firstDay = new Date(d.getFullYear(), 0, 1);\n   493→    const firstSunday = new Date(firstDay);\n   494→    firstSunday.setDate(firstDay.getDate() - firstDay.getDay());\n   495→    // 計算週數\n   496→    const diff = sunday - firstSunday;\n   497→    const weekNumber = Math.floor(diff / (7 * 24 * 60 * 60 * 1000)) + 1;\n   498→    return weekNumber;\n   499→}\n   500→\n   501→// 從週次鍵值取得日期範圍\n   502→function getWeekDateRangeFromKey(weekKey) {\n   503→    const [year, week] = weekKey.split('-');\n   504→    const weekNumber = parseInt(week.substring(1));\n   505→    return getWeekDateRange(weekNumber, year);\n   506→}\n   507→\n   508→// 修改工時表（跳轉到編輯頁面）\n   509→function editTimesheet(weekKey) {\n   510→    // 跳轉到工時填寫界面\n   511→    window.location.href = `edit.html?week=${encodeURIComponent(weekKey)}`;\n   512→}\n   513→\n   514→// 刪除工時表\n   515→function deleteTimesheet(weekKey) {\n   516→    if (confirm(`確定要刪除 ${weekKey} 的工時表嗎？`)) {\n   517→        const timesheets = loadAllTimesheets();\n   518→        delete timesheets[weekKey];\n   519→        saveAllTimesheets(timesheets);\n   520→        renderTimesheetCards();\n   521→    }\n   522→}\n   523→\n   524→// 匯出工時表為CSV檔案\n   525→function exportTimesheet(weekKey) {\n   526→    try {\n   527→        const entries = getWeekEntries(weekKey);\n   528→        if (!entries || entries.length === 0) {\n   529→            alert('該週次沒有工時記錄可匯出');\n   530→            return;\n   531→        }\n   532→\n   533→        // 匯出前檢查總正常工時，若超過40小時則提示\n   534→        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n   535→        // 若超過40小時，提示將自動正規化\n   536→        if (totalRegularHours > 40) {\n   537→            alert('本週正常工時超過40小時，滙出時將自動進行正規化計算。\\n\\n注意：若下載檔案時選擇覆蓋舊檔，且舊檔正在開啟狀態，下載可能會失敗並顯示「需要下載權限」等錯誤，請先關閉舊檔再下載。');\n   538→        }\n   539→\n   540→        let exportEntries = [...entries];\n   541→\n   542→        if (totalRegularHours > 40) {\n   543→            exportEntries = performNormalizationForExport(exportEntries);\n   544→        }\n   545→\n   546→        // 準備CSV內容\n   547→        const csvContent = generateCSVContent(exportEntries, weekKey);\n   548→\n   549→        // 創建並下載檔案\n   550→        downloadCSVFile(csvContent, `工時表_${weekKey}.csv`);\n   551→\n   552→        // 顯示成功訊息\n   553→        showSuccessMessage(`${weekKey} 工時表已匯出`);\n   554→\n   555→    } catch (error) {\n   556→        console.error('匯出失敗:', error);\n   557→        alert('匯出失敗，請檢查瀏覽器控制台');\n   558→    }\n   559→}\n   560→// 滙出未經正規化的原始工時\n   561→function exportRawTimesheet(weekKey) {\n   562→    try {\n   563→        const entries = getWeekEntries(weekKey);\n   564→        if (!entries || entries.length === 0) {\n   565→            alert('該週次沒有工時記錄可匯出');\n   566→            return;\n   567→        }\n   568→        // 直接滙出原始工時資料\n   569→        const csvContent = generateCSVContent(entries, weekKey);\n   570→        downloadCSVFile(csvContent, `工時表_${weekKey}_原始.csv`);\n   571→        showSuccessMessage(`${weekKey} 工時表（原始）已匯出`);\n   572→    } catch (error) {\n   573→        console.error('原始工時匯出失敗:', error);\n   574→        alert('原始工時匯出失敗，請檢查瀏覽器控制台');\n   575→    }\n   576→}\n   577→\n   578→// 生成CSV內容\n   579→function generateCSVContent(entries, weekKey) {\n   580→    // CSV標題行（按照指定格式）\n   581→    const headers = [\n   582→        'Name',\n   583→        'Zone',\n   584→        'Project',\n   585→        'Product Module',\n   586→        'Activity Type',\n   587→        'Task',\n   588→        'Regular Hours',\n   589→        'OT Hours',\n   590→        'TTL_Hours',\n   591→        'Date',\n   592→        'Start Date',\n   593→        'End Date',\n   594→        'Comments',\n   595→        'PM',\n   596→        'InternalOrOutsource'\n   597→    ];\n   598→\n   599→    // 載入基本資料\n   600→    const basicInfo = loadGlobalBasicInfo();\n   601→    \n   602→    // 轉換資料行\n   603→    const dataRows = entries.map(entry => {\n   604→        const regularHours = parseFloat(entry.regularHours) || 0;\n   605→        const overtimeHours = parseFloat(entry.overtimeHours) || parseFloat(entry.otHours) || 0;\n   606→        const totalHours = parseFloat(entry.ttlHours) || (regularHours + overtimeHours);\n   607→        \n   608→        return [\n   609→            basicInfo.employeeName || '',           // Name\n   610→            entry.zone || '',                       // Zone\n   611→            entry.project || '',                    // Project\n   612→            entry.productModule || '',              // Product Module\n   613→            entry.activityType || '',               // Activity Type\n   614→            entry.task || '',                       // Task\n   615→            regularHours,                           // Regular Hours\n   616→            overtimeHours,                          // OT Hours\n   617→            totalHours,                             // TTL_Hours\n   618→            entry.date || '',                       // Date\n   619→            entry.startDate || '',                  // Start Date\n   620→            entry.endDate || '',                    // End Date\n   621→            entry.comments || '',                   // Comments\n   622→            entry.pm || '',                         // PM\n   623→            basicInfo.employeeType || ''            // InternalOrOutsource\n   624→        ];\n   625→    });\n   626→\n   627→    // 組合CSV內容\n   628→    const csvRows = [headers, ...dataRows];\n   629→    \n   630→    // 轉換為CSV格式字串\n   631→    return csvRows.map(row =>\n   632→        row.map(field => {\n   633→            // 處理包含逗號或換行的欄位\n   634→            const fieldStr = String(field);\n   635→            if (fieldStr.includes(',') || fieldStr.includes('\\n') || fieldStr.includes('\"')) {\n   636→                return '\"' + fieldStr.replace(/\"/g, '\"\"') + '\"';\n   637→            }\n   638→            return fieldStr;\n   639→        }).join(',')\n   640→    ).join('\\n');\n   641→}\n   642→\n   643→// 下載CSV檔案\n   644→function downloadCSVFile(csvContent, filename) {\n   645→    try {\n   646→        console.log('[downloadCSVFile] 開始下載', { filename, csvContentSample: csvContent.slice(0, 100) });\n   647→        // 添加BOM以支援中文\n   648→        const BOM = '\\uFEFF';\n   649→        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n   650→        console.log('[downloadCSVFile] Blob created', blob);\n   651→        const url = URL.createObjectURL(blob);\n   652→        console.log('[downloadCSVFile] Object URL', url);\n   653→        const link = document.createElement('a');\n   654→        link.setAttribute('href', url);\n   655→        link.setAttribute('download', filename);\n   656→        link.style.visibility = 'hidden';\n   657→        // 添加到頁面並觸發下載\n   658→        document.body.appendChild(link);\n   659→        link.click();\n   660→        console.log('[downloadCSVFile] link.click() 已觸發');\n   661→        // 清理\n   662→        document.body.removeChild(link);\n   663→        URL.revokeObjectURL(url);\n   664→        console.log('[downloadCSVFile] 清理完成');\n   665→    } catch (err) {\n   666→        console.error('[downloadCSVFile] 發生錯誤', err);\n   667→    }\n   668→}\n   669→\n   670→// 匯入工時表（暫時只提示）\n   671→function importTimesheet() {\n   672→    const input = document.getElementById('import-file');\n   673→    input.value = ''; // 重置 input，避免同檔案無法重選\n   674→    input.onchange = async function (event) {\n   675→        const file = event.target.files[0];\n   676→        if (!file) return;\n   677→        const reader = new FileReader();\n   678→        reader.onload = function (e) {\n   679→            const text = e.target.result;\n   680→            try {\n   681→                console.log('[import] 原始CSV內容:', text);\n   682→                \n   683→                // 檢查檔案是否為空\n   684→                if (!text || text.trim().length === 0) {\n   685→                    alert('檔案內容為空，請選擇有效的CSV檔案。');\n   686→                    return;\n   687→                }\n   688→                \n   689→                const data = parseCSV(text);\n   690→                console.log('[import] parseCSV result:', data);\n   691→                \n   692→                // 檢查是否成功解析出資料\n   693→                if (!data || data.length === 0) {\n   694→                    alert('無法從檔案中解析出有效資料，請檢查CSV格式是否正確。');\n   695→                    return;\n   696→                }\n   697→                \n   698→                // 強制將 data 轉為 array\n   699→                console.log('[import] typeof data:', typeof data, 'Array.isArray:', Array.isArray(data));\n   700→                let arr = [];\n   701→                if (Array.isArray(data)) {\n   702→                    arr = data;\n   703→                } else if (typeof data === 'object' && data !== null) {\n   704→                    arr = Object.values(data).flat();\n   705→                }\n   706→                console.log('[import] 轉換後 arr:', arr);\n   707→                \n   708→                if (arr.length === 0) {\n   709→                    alert('檔案中沒有有效的工時記錄。');\n   710→                    return;\n   711→                }\n   712→                let groupedData = {};\n   713→                const failedRows = [];\n   714→                \n   715→                arr.forEach((row, index) => {\n   716→                    if (!row) return;\n   717→                    \n   718→                    // 檢查日期欄位（支援多種可能的欄位名稱）\n   719→                    const dateValue = row.Date || row.date || row['日期'] || row.Day;\n   720→                    if (!dateValue) {\n   721→                        console.warn(`[import] 第${index + 1}筆記錄缺少日期欄位:`, row);\n   722→                        failedRows.push(`第${index + 1}筆記錄：缺少日期欄位`);\n   723→                        return;\n   724→                    }\n   725→                    \n   726→                    // 改進的日期解析，支援多種格式\n   727→                    let dateObj = null;\n   728→                    const dateStr = dateValue.toString().trim();\n   729→                    \n   730→                    // 嘗試多種日期格式\n   731→                    const dateFormats = [\n   732→                        dateStr, // 原始格式\n   733→                        dateStr.replace(/\\//g, '-'), // 將 / 替換為 -\n   734→                        dateStr.replace(/\\./g, '-'), // 將 . 替換為 -\n   735→                    ];\n   736→                    \n   737→                    for (const format of dateFormats) {\n   738→                        dateObj = new Date(format);\n   739→                        if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1900) {\n   740→                            break;\n   741→                        }\n   742→                        dateObj = null;\n   743→                    }\n   744→                    \n   745→                    if (!dateObj || isNaN(dateObj.getTime())) {\n   746→                        console.warn(`[import] 第${index + 1}筆記錄日期格式無效:`, dateValue);\n   747→                        failedRows.push(`第${index + 1}筆記錄：日期格式無效 \"${dateValue}\"`);\n   748→                        return;\n   749→                    }\n   750→                    \n   751→                    try {\n   752→                        // 正確計算週次\n   753→                        const year = dateObj.getFullYear();\n   754→                        const weekNumber = getWeekNumber(dateObj);\n   755→                        const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n   756→                        console.log('[import][分組] Date:', dateValue, 'parsed:', dateObj, 'year:', year, 'weekNumber:', weekNumber, 'weekKey:', weekKey);\n   757→                        \n   758→                        if (!groupedData[weekKey]) groupedData[weekKey] = [];\n   759→                        \n   760→                        // 標準化記錄格式，確保日期統一和必要欄位\n   761→                        const standardizedRow = { ...row };\n   762→                        standardizedRow.date = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD 格式\n   763→                        \n   764→                        // 確保有唯一的 ID\n   765→                        if (!standardizedRow.id) {\n   766→                            standardizedRow.id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n   767→                        }\n   768→                        \n   769→                        // 確保數字欄位有預設值\n   770→                        standardizedRow.regularHours = standardizedRow.regularHours || 0;\n   771→                        standardizedRow.otHours = standardizedRow.otHours || 0;\n   772→                        standardizedRow.ttlHours = standardizedRow.ttlHours || (standardizedRow.regularHours + standardizedRow.otHours);\n   773→                        \n   774→                        groupedData[weekKey].push(standardizedRow);\n   775→                    } catch (err) {\n   776→                        console.error(`[import] 處理第${index + 1}筆記錄時發生錯誤:`, err, row);\n   777→                        failedRows.push(`第${index + 1}筆記錄：處理時發生錯誤`);\n   778→                    }\n   779→                });\n   780→                \n   781→                // 如果有失敗的記錄，顯示警告\n   782→                if (failedRows.length > 0) {\n   783→                    console.warn('[import] 以下記錄匯入失敗:', failedRows);\n   784→                    const proceed = confirm(`有 ${failedRows.length} 筆記錄匯入失敗：\\n${failedRows.slice(0, 5).join('\\n')}${failedRows.length > 5 ? '\\n...' : ''}\\n\\n是否繼續匯入其他記錄？`);\n   785→                    if (!proceed) {\n   786→                        alert('匯入已取消');\n   787→                        return;\n   788→                    }\n   789→                }\n   790→                console.log('[import] 自動分組週次結果:', groupedData);\n   791→                // 合併匯入資料到主 timesheets\n   792→                const timesheets = loadAllTimesheets();\n   793→                console.log('[import] localStorage timesheets(匯入前):', timesheets);\n   794→                const importedWeeks = [];\n   795→                for (const weekKey in groupedData) {\n   796→                    console.log('[import] 檢查週次', weekKey, groupedData[weekKey]);\n   797→                    if (timesheets[weekKey]) {\n   798→                        const overwrite = confirm('週次 ' + weekKey + ' 已有資料，是否覆蓋？');\n   799→                        console.log('[import] 覆蓋確認', weekKey, overwrite);\n   800→                        if (!overwrite) continue;\n   801→                    }\n   802→                    timesheets[weekKey] = groupedData[weekKey];\n   803→                    importedWeeks.push(weekKey);\n   804→                    console.log('[import] 已加入週次:', weekKey);\n   805→                }\n   806→                console.log('[import] importedWeeks:', importedWeeks);\n   807→                console.log('[import] localStorage timesheets(匯入後):', timesheets);\n   808→                \n   809→                if (Object.keys(groupedData).length === 0) {\n   810→                    alert('沒有有效的記錄可以匯入。請檢查CSV檔案中的日期格式和資料內容。');\n   811→                    return;\n   812→                }\n   813→                \n   814→                saveAllTimesheets(timesheets);\n   815→                renderTimesheetCards();\n   816→                \n   817→                if (importedWeeks.length > 0) {\n   818→                    const weekInfoList = importedWeeks.map(weekKey => {\n   819→                        try {\n   820→                            const range = getWeekDateRangeFromKey(weekKey);\n   821→                            const start = range.start.toISOString().split('T')[0];\n   822→                            const end = range.end.toISOString().split('T')[0];\n   823→                            const recordCount = groupedData[weekKey].length;\n   824→                            return `${weekKey} (${start} ~ ${end}) - ${recordCount}筆記錄`;\n   825→                        } catch (err) {\n   826→                            console.error('[import] 取得週次範圍失敗:', weekKey, err);\n   827→                            return `${weekKey} - ${groupedData[weekKey].length}筆記錄`;\n   828→                        }\n   829→                    });\n   830→                    \n   831→                    const totalRecords = importedWeeks.reduce((sum, weekKey) => sum + groupedData[weekKey].length, 0);\n   832→                    const successMessage = `匯入成功！\\n共匯入 ${totalRecords} 筆記錄到 ${importedWeeks.length} 個週次：\\n\\n${weekInfoList.join('\\n')}`;\n   833→                    \n   834→                    if (failedRows.length > 0) {\n   835→                        alert(successMessage + `\\n\\n注意：有 ${failedRows.length} 筆記錄匯入失敗。`);\n   836→                    } else {\n   837→                        alert(successMessage);\n   838→                    }\n   839→                } else {\n   840→                    alert('未匯入任何週次資料。所有記錄都被跳過了。');\n   841→                }\n   842→            } catch (err) {\n   843→                console.error('[import] 匯入流程發生錯誤:', err);\n   844→                let errorMessage = 'CSV 匯入失敗：\\n';\n   845→                if (err.message) {\n   846→                    errorMessage += err.message;\n   847→                } else {\n   848→                    errorMessage += '未知錯誤，請檢查瀏覽器控制台獲取更多資訊。';\n   849→                }\n   850→                alert(errorMessage);\n   851→            }\n   852→        };\n   853→        reader.readAsText(file, 'utf-8');\n   854→    };\n   855→    input.click();\n   856→}\n   857→\n   858→// ==================== 首頁模態框功能 ====================\n   859→\n   860→// 顯示基本資料設定模態框\n   861→function showBasicInfoModal() {\n   862→    const modal = document.getElementById('basic-info-modal');\n   863→    const basicInfo = loadGlobalBasicInfo();\n   864→    \n   865→    // 載入現有資料\n   866→    if (basicInfo) {\n   867→        document.getElementById('modal-employeeName').value = basicInfo.employeeName || '';\n   868→        document.getElementById('modal-employeeType').value = basicInfo.employeeType || '';\n   869→    }\n   870→    \n   871→    modal.style.display = 'block';\n   872→}\n   873→\n   874→// 隱藏基本資料設定模態框\n   875→function hideBasicInfoModal() {\n   876→    const modal = document.getElementById('basic-info-modal');\n   877→    modal.style.display = 'none';\n   878→    \n   879→    // 清空表單\n   880→    document.getElementById('modal-basic-info-form').reset();\n   881→}\n   882→\n   883→// 儲存模態框中的基本資料\n   884→function saveModalBasicInfo() {\n   885→    const employeeName = document.getElementById('modal-employeeName').value.trim();\n   886→    const employeeType = document.getElementById('modal-employeeType').value;\n   887→    \n   888→    if (!employeeName || !employeeType) {\n   889→        alert('請填寫所有必填欄位');\n   890→        return;\n   891→    }\n   892→    \n   893→    const basicInfo = {\n   894→        employeeName: employeeName,\n   895→        employeeType: employeeType\n   896→    };\n   897→    \n   898→    saveGlobalBasicInfo(basicInfo);\n   899→    hideBasicInfoModal();\n   900→    alert('基本資料已儲存成功！（全 App 共用）');\n   901→}\n   902→\n   903→// 初始化：頁面加載完成後渲染卡片，並綁定按鈕事件\n   904→document.addEventListener('DOMContentLoaded', () => {\n   905→    // 檢查是否為首頁\n   906→    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n   907→        renderTimesheetCards();\n   908→        \n   909→        // 綁定全局按鈕事件\n   910→        document.getElementById('btn-basic-info').addEventListener('click', showBasicInfoModal);\n   911→        document.getElementById('btn-new').addEventListener('click', newTimesheet);\n   912→        document.getElementById('btn-import').addEventListener('click', importTimesheet);\n   913→        document.getElementById('btn-clear-storage').addEventListener('click', () => {\n   914→            if (confirm('確定要清空所有資料嗎？此操作無法還原。')) {\n   915→                localStorage.clear();\n   916→                renderTimesheetCards();\n   917→                alert('localStorage 已清空');\n   918→            }\n   919→        });\n   920→        \n   921→        // 綁定基本資料模態框事件\n   922→        document.getElementById('btn-save-modal-basic-info').addEventListener('click', saveModalBasicInfo);\n   923→        document.getElementById('btn-cancel-modal').addEventListener('click', hideBasicInfoModal);\n   924→        document.querySelector('.close').addEventListener('click', hideBasicInfoModal);\n   925→        \n   926→        // 綁定週次選擇模態框事件\n   927→        const weekModal = document.getElementById('week-selection-modal');\n   928→        if (weekModal) {\n   929→            const weekCloseBtn = weekModal.querySelector('.close');\n   930→            const confirmWeekBtn = document.getElementById('btn-confirm-week');\n   931→            const cancelWeekBtn = document.getElementById('btn-cancel-week');\n   932→            const customRadio = document.getElementById('radio-custom');\n   933→            const customInput = document.getElementById('custom-week-input');\n   934→            \n   935→            if (weekCloseBtn) weekCloseBtn.addEventListener('click', hideWeekSelectionModal);\n   936→            if (cancelWeekBtn) cancelWeekBtn.addEventListener('click', hideWeekSelectionModal);\n   937→            if (confirmWeekBtn) confirmWeekBtn.addEventListener('click', confirmWeekSelection);\n   938→            \n   939→            // 監聽自訂選項的選擇\n   940→            if (customRadio && customInput) {\n   941→                customRadio.addEventListener('change', function() {\n   942→                    if (this.checked) {\n   943→                        customInput.style.display = 'block';\n   944→                    }\n   945→                });\n   946→            }\n   947→            \n   948→            // 監聽其他選項的選擇（隱藏自訂輸入）\n   949→            document.querySelectorAll('input[name=\"weekOption\"]:not(#radio-custom)').forEach(radio => {\n   950→                radio.addEventListener('change', function() {\n   951→                    if (this.checked && customInput) {\n   952→                        customInput.style.display = 'none';\n   953→                    }\n   954→                });\n   955→            });\n   956→        }\n   957→        \n   958→        // 點擊模態框外部關閉\n   959→        window.addEventListener('click', (event) => {\n   960→            const basicModal = document.getElementById('basic-info-modal');\n   961→            const weekSelectionModal = document.getElementById('week-selection-modal');\n   962→            \n   963→            if (event.target === basicModal) {\n   964→                hideBasicInfoModal();\n   965→            } else if (event.target === weekSelectionModal) {\n   966→                hideWeekSelectionModal();\n   967→            }\n   968→        });\n   969→\n   970→        // 設置上週按鈕的文字和顯示狀態\n   971→        const lastWeekButton = document.getElementById('btn-last-week');\n   972→        if (lastWeekButton) {\n   973→            updateLastWeekButtonDisplay();\n   974→            // 綁定點擊事件\n   975→            lastWeekButton.addEventListener('click', createLastWeekTimesheet);\n   976→        }\n   977→    }\n   978→});\n   979→\n   980→// 更新上週按鈕顯示狀態和文字\n   981→function updateLastWeekButtonDisplay() {\n   982→    const today = new Date();\n   983→    // 更精確的計算：獲取上週一（今天減去今天星期幾再減6天）\n   984→    const lastMonday = new Date(today);\n   985→    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n   986→    const lastSunday = new Date(lastMonday);\n   987→    lastSunday.setDate(lastMonday.getDate() + 6);\n   988→    \n   989→    const button = document.getElementById('btn-last-week');\n   990→    const container = document.getElementById('last-week-container');\n   991→    \n   992→    if (button && container) {\n   993→        // 檢查上週是否已存在\n   994→        const lastWeekKey = getLastWeekKey();\n   995→        const timesheets = loadAllTimesheets();\n   996→        \n   997→        if (timesheets[lastWeekKey]) {\n   998→            // 上週已存在，隱藏按鈕\n   999→            container.style.display = 'none';\n  1000→        } else {\n  1001→            // 上週不存在，顯示按鈕並設置文字\n  1002→            container.style.display = 'block';\n  1003→            button.textContent = `建立上週工時表 (${formatDate(lastMonday)} - ${formatDate(lastSunday)})`;\n  1004→        }\n  1005→    }\n  1006→}\n  1007→\n  1008→// 建立上週工時表\n  1009→function createLastWeekTimesheet() {\n  1010→    const today = new Date();\n  1011→    const lastMonday = new Date(today);\n  1012→    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n  1013→    const lastSunday = new Date(lastMonday);\n  1014→    lastSunday.setDate(lastMonday.getDate() + 6);\n  1015→    \n  1016→    // 生成週次格式 YYYY-Www\n  1017→    const year = lastMonday.getFullYear();\n  1018→    const weekNumber = Math.ceil((((lastMonday - new Date(year, 0, 1)) / 86400000) + new Date(year, 0, 1).getDay() + 1) / 7);\n  1019→    const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n  1020→    \n  1021→    const timesheets = loadAllTimesheets();\n  1022→    if (!timesheets[weekKey]) {\n  1023→        timesheets[weekKey] = [];\n  1024→        saveAllTimesheets(timesheets);\n  1025→    }\n  1026→    \n  1027→    // 載入上週工時表\n  1028→    editTimesheet(weekKey);\n  1029→    renderTimesheetCards();\n  1030→}\n  1031→\n  1032→// ==================== 編輯頁面功能 ====================\n  1033→\n  1034→// 生成唯一 ID\n  1035→function generateUniqueId() {\n  1036→    return Date.now().toString(36) + Math.random().toString(36).substr(2);\n  1037→}\n  1038→\n  1039→// 獲取當前編輯的週次\n  1040→function getCurrentWeekKey() {\n  1041→    const urlParams = new URLSearchParams(window.location.search);\n  1042→    return urlParams.get('week');\n  1043→}\n  1044→\n  1045→// ==================== 全域基本資料管理 ====================\n  1046→\n  1047→// 載入全域基本資料\n  1048→function loadGlobalBasicInfo() {\n  1049→    const data = localStorage.getItem('globalBasicInfo');\n  1050→    return data ? JSON.parse(data) : null;\n  1051→}\n  1052→\n  1053→// 儲存全域基本資料\n  1054→function saveGlobalBasicInfo(basicInfo) {\n  1055→    localStorage.setItem('globalBasicInfo', JSON.stringify(basicInfo));\n  1056→}\n  1057→\n  1058→// ==================== 工時記錄管理 ====================\n  1059→\n  1060→// 獲取指定週次的工時記錄\n  1061→function getWeekEntries(weekKey) {\n  1062→    const timesheets = loadAllTimesheets();\n  1063→    const weekData = timesheets[weekKey];\n  1064→    \n  1065→    // 處理不同的資料結構\n  1066→    if (Array.isArray(weekData)) {\n  1067→        // 舊的資料結構，直接是陣列\n  1068→        return weekData;\n  1069→    } else if (weekData && weekData.entries) {\n  1070→        // 新的資料結構，有 entries\n  1071→        return weekData.entries;\n  1072→    }\n  1073→    \n  1074→    return [];\n  1075→}\n  1076→\n  1077→// 儲存指定週次的工時記錄\n  1078→function saveWeekEntries(weekKey, entries) {\n  1079→    const timesheets = loadAllTimesheets();\n  1080→    timesheets[weekKey] = entries; // 直接儲存為陣列，簡化結構\n  1081→    saveAllTimesheets(timesheets);\n  1082→}\n  1083→\n  1084→// 計算總工時\n  1085→function calculateTotalHours() {\n  1086→    const regular = parseFloat(document.getElementById('regularHours').value) || 0;\n  1087→    const ot = parseFloat(document.getElementById('otHours').value) || 0;\n  1088→    document.getElementById('ttlHours').value = regular + ot;\n  1089→}\n  1090→\n  1091→// 驗證基本資料表單\n  1092→function validateBasicInfo() {\n  1093→    const requiredFields = ['employeeName', 'employeeType'];\n  1094→    let isValid = true;\n  1095→    \n  1096→    // 清除之前的錯誤狀態\n  1097→    document.querySelectorAll('#basic-info-form .form-field.error').forEach(field => {\n  1098→        field.classList.remove('error');\n  1099→    });\n  1100→    \n  1101→    requiredFields.forEach(fieldName => {\n  1102→        const field = document.getElementById(fieldName);\n  1103→        const formField = field.closest('.form-field');\n  1104→        \n  1105→        if (!field.value.trim()) {\n  1106→            formField.classList.add('error');\n  1107→            showFieldError(formField, '此欄位為必填');\n  1108→            isValid = false;\n  1109→        }\n  1110→    });\n  1111→    \n  1112→    return isValid;\n  1113→}\n  1114→\n  1115→// 驗證工時記錄表單\n  1116→function validateForm() {\n  1117→    const requiredFields = ['task', 'zone', 'project', 'activityType', 'regularHours', 'date'];\n  1118→    let isValid = true;\n  1119→    \n  1120→    // 檢查是否已儲存全域基本資料\n  1121→    const basicInfo = loadGlobalBasicInfo();\n  1122→    if (!basicInfo) {\n  1123→        alert('請先填寫並儲存基本資料');\n  1124→        document.querySelector('.basic-info-container').scrollIntoView({ behavior: 'smooth' });\n  1125→        return false;\n  1126→    }\n  1127→    \n  1128→    // 清除之前的錯誤狀態\n  1129→    document.querySelectorAll('#timesheet-form .form-field.error').forEach(field => {\n  1130→        field.classList.remove('error');\n  1131→    });\n  1132→    \n  1133→    requiredFields.forEach(fieldName => {\n  1134→        const field = document.getElementById(fieldName);\n  1135→        const formField = field.closest('.form-field');\n  1136→        \n  1137→        if (!field.value.trim()) {\n  1138→            formField.classList.add('error');\n  1139→            showFieldError(formField, '此欄位為必填');\n  1140→            isValid = false;\n  1141→        }\n  1142→    });\n  1143→    \n  1144→    // 驗證工時範圍\n  1145→    const regularHours = parseFloat(document.getElementById('regularHours').value);\n  1146→    const otHours = parseFloat(document.getElementById('otHours').value) || 0;\n  1147→    \n  1148→    if (regularHours < 0 || regularHours > 24) {\n  1149→        const formField = document.getElementById('regularHours').closest('.form-field');\n  1150→        formField.classList.add('error');\n  1151→        showFieldError(formField, '正常工時必須在 0-24 小時之間');\n  1152→        isValid = false;\n  1153→    }\n  1154→    \n  1155→    if (otHours < 0 || otHours > 24) {\n  1156→        const formField = document.getElementById('otHours').closest('.form-field');\n  1157→        formField.classList.add('error');\n  1158→        showFieldError(formField, '加班工時必須在 0-24 小時之間');\n  1159→        isValid = false;\n  1160→    }\n  1161→    \n  1162→    // 允許正常工時總計超過40小時，僅於匯出時提示正規化\n  1163→    const weekKey = getCurrentWeekKey();\n  1164→    const currentEntryId = document.getElementById('entryId').value;\n  1165→    const entries = getWeekEntries(weekKey);\n  1166→    \n  1167→    // 計算除了當前編輯記錄外的其他記錄的正常工時總和\n  1168→    let totalRegularHours = 0;\n  1169→    entries.forEach(entry => {\n  1170→        if (entry.id !== currentEntryId) {\n  1171→            totalRegularHours += entry.regularHours || 0;\n  1172→        }\n  1173→    });\n  1174→    \n  1175→    // 加上當前輸入的正常工時\n  1176→    totalRegularHours += regularHours;\n  1177→    \n  1178→    // 不再於此處限制或提示，僅於匯出時處理正規化\n  1179→    \n  1180→    // 驗證日期邏輯\n  1181→    const startDate = document.getElementById('startDate').value;\n  1182→    const endDate = document.getElementById('endDate').value;\n  1183→    const date = document.getElementById('date').value;\n  1184→    \n  1185→    // 獲取當前週的日期範圍（使用已宣告的 weekKey）\n  1186→    const [year, week] = weekKey.split('-');\n  1187→    const weekNumber = parseInt(week.substring(1));\n  1188→    const weekRange = getWeekDateRange(weekNumber, year);\n  1189→    \n  1190→    // 驗證主要日期是否在週範圍內\n  1191→    if (date && !validateDateInWeekRange(date, weekRange.start, weekRange.end)) {\n  1192→        const formField = document.getElementById('date').closest('.form-field');\n  1193→        formField.classList.add('error');\n  1194→        showFieldError(formField, `日期必須在 ${formatDate(weekRange.start)} 至 ${formatDate(weekRange.end)} 範圍內`);\n  1195→        isValid = false;\n  1196→    }\n  1197→    \n  1198→    // 驗證開始日期是否在週範圍內\n  1199→    if (startDate && !validateDateInWeekRange(startDate, weekRange.start, weekRange.end)) {\n  1200→        const formField = document.getElementById('startDate').closest('.form-field');\n  1201→        formField.classList.add('error');\n  1202→        showFieldError(formField, `開始日期必須在 ${formatDate(weekRange.start)} 至 ${formatDate(weekRange.end)} 範圍內`);\n  1203→        isValid = false;\n  1204→    }\n  1205→    \n  1206→    // 驗證結束日期是否在週範圍內\n  1207→    if (endDate && !validateDateInWeekRange(endDate, weekRange.start, weekRange.end)) {\n  1208→        const formField = document.getElementById('endDate').closest('.form-field');\n  1209→        formField.classList.add('error');\n  1210→        showFieldError(formField, `結束日期必須在 ${formatDate(weekRange.start)} 至 ${formatDate(weekRange.end)} 範圍內`);\n  1211→        isValid = false;\n  1212→    }\n  1213→    \n  1214→    // 驗證開始日期不能晚於結束日期\n  1215→    if (startDate && endDate && new Date(startDate) > new Date(endDate)) {\n  1216→        const formField = document.getElementById('endDate').closest('.form-field');\n  1217→        formField.classList.add('error');\n  1218→        showFieldError(formField, '結束日期不能早於開始日期');\n  1219→        isValid = false;\n  1220→    }\n  1221→    \n  1222→    return isValid;\n  1223→}\n  1224→\n  1225→// 顯示欄位錯誤訊息\n  1226→function showFieldError(formField, message) {\n  1227→    let errorDiv = formField.querySelector('.error-message');\n  1228→    if (!errorDiv) {\n  1229→        errorDiv = document.createElement('div');\n  1230→        errorDiv.className = 'error-message';\n  1231→        formField.appendChild(errorDiv);\n  1232→    }\n  1233→    errorDiv.textContent = message;\n  1234→}\n  1235→\n  1236→// 清空表單\n  1237→function clearForm() {\n  1238→    document.getElementById('timesheet-form').reset();\n  1239→    document.getElementById('entryId').value = '';\n  1240→    document.getElementById('ttlHours').value = '';\n  1241→    \n  1242→    // 清除錯誤狀態\n  1243→    document.querySelectorAll('.form-field.error').forEach(field => {\n  1244→        field.classList.remove('error');\n  1245→    });\n  1246→}\n  1247→\n  1248→// 獲取基本資料\n  1249→function getBasicInfoData() {\n  1250→    return {\n  1251→        employeeName: document.getElementById('employeeName').value.trim(),\n  1252→        employeeType: document.getElementById('employeeType').value\n  1253→    };\n  1254→}\n  1255→\n  1256→// 填充基本資料\n  1257→function fillBasicInfo(basicInfo) {\n  1258→    if (basicInfo) {\n  1259→        document.getElementById('employeeName').value = basicInfo.employeeName || '';\n  1260→        document.getElementById('employeeType').value = basicInfo.employeeType || '';\n  1261→    }\n  1262→}\n  1263→\n  1264→// 從表單獲取工時記錄數據\n  1265→function getFormData() {\n  1266→    const basicInfo = loadGlobalBasicInfo();\n  1267→    const originalHours = document.getElementById('originalHours').value;\n  1268→    \n  1269→    const data = {\n  1270→        id: document.getElementById('entryId').value || generateUniqueId(),\n  1271→        // 從全域基本資料引用\n  1272→        name: basicInfo ? basicInfo.employeeName : '',\n  1273→        internalOrOutsource: basicInfo ? basicInfo.employeeType : '',\n  1274→        // 工時記錄特定欄位\n  1275→        zone: document.getElementById('zone').value,\n  1276→        project: document.getElementById('project').value.trim(),\n  1277→        productModule: document.getElementById('productModule').value.trim(),\n  1278→        activityType: document.getElementById('activityType').value,\n  1279→        task: document.getElementById('task').value.trim(),\n  1280→        regularHours: parseFloat(document.getElementById('regularHours').value) || 0,\n  1281→        otHours: parseFloat(document.getElementById('otHours').value) || 0,\n  1282→        ttlHours: parseFloat(document.getElementById('ttlHours').value) || 0,\n  1283→        date: document.getElementById('date').value,\n  1284→        startDate: document.getElementById('startDate').value,\n  1285→        endDate: document.getElementById('endDate').value,\n  1286→        comments: document.getElementById('comments').value.trim(),\n  1287→        pm: document.getElementById('pm').value.trim()\n  1288→    };\n  1289→    \n  1290→    // 如果有原始工時（正規化模式），則儲存但標記為內部使用\n  1291→    if (originalHours && parseFloat(originalHours) > 0) {\n  1292→        data._originalHours = parseFloat(originalHours); // 使用 _ 前綴標記為內部欄位\n  1293→        data._isNormalized = true;\n  1294→    }\n  1295→    \n  1296→    return data;\n  1297→}\n  1298→\n  1299→// 填充工時記錄表單數據\n  1300→function fillForm(entry) {\n  1301→    document.getElementById('entryId').value = entry.id;\n  1302→    document.getElementById('zone').value = entry.zone || '';\n  1303→    document.getElementById('project').value = entry.project || '';\n  1304→    document.getElementById('productModule').value = entry.productModule || '';\n  1305→    document.getElementById('activityType').value = entry.activityType || '';\n  1306→    document.getElementById('task').value = entry.task || '';\n  1307→    document.getElementById('regularHours').value = entry.regularHours || '';\n  1308→    document.getElementById('otHours').value = entry.otHours || 0;\n  1309→    document.getElementById('ttlHours').value = entry.ttlHours || '';\n  1310→    document.getElementById('date').value = entry.date || '';\n  1311→    document.getElementById('startDate').value = entry.startDate || '';\n  1312→    document.getElementById('endDate').value = entry.endDate || '';\n  1313→    document.getElementById('comments').value = entry.comments || '';\n  1314→    document.getElementById('pm').value = entry.pm || '';\n  1315→    \n  1316→    // 處理原始工時欄位（正規化模式）\n  1317→    const originalHoursField = document.getElementById('originalHoursField');\n  1318→    if (entry._originalHours && entry._isNormalized) {\n  1319→        document.getElementById('originalHours').value = entry._originalHours;\n  1320→        originalHoursField.style.display = 'block';\n  1321→    } else {\n  1322→        document.getElementById('originalHours').value = '';\n  1323→        originalHoursField.style.display = 'none';\n  1324→    }\n  1325→}\n  1326→\n  1327→// 儲存基本資料\n  1328→function saveBasicInfo() {\n  1329→    if (!validateBasicInfo()) {\n  1330→        return;\n  1331→    }\n  1332→    \n  1333→    const basicInfoData = getBasicInfoData();\n  1334→    saveGlobalBasicInfo(basicInfoData);\n  1335→    \n  1336→    // 更新 UI 狀態\n  1337→    const container = document.querySelector('.basic-info-container');\n  1338→    container.classList.add('basic-info-saved');\n  1339→    \n  1340→    showSuccessMessage('基本資料已儲存成功！（全 App 共用）');\n  1341→}\n  1342→\n  1343→// 儲存工時記錄\n  1344→function saveEntry() {\n  1345→    if (!validateForm()) {\n  1346→        return;\n  1347→    }\n  1348→    \n  1349→    const weekKey = getCurrentWeekKey();\n  1350→    if (!weekKey) {\n  1351→        alert('無效的週次參數');\n  1352→        return;\n  1353→    }\n  1354→    \n  1355→    const formData = getFormData();\n  1356→    const entries = getWeekEntries(weekKey);\n  1357→    \n  1358→    // 檢查是否為新增或編輯\n  1359→    const existingIndex = entries.findIndex(entry => entry.id === formData.id);\n  1360→    \n  1361→    if (existingIndex !== -1) {\n  1362→        // 編輯現有記錄\n  1363→        entries[existingIndex] = formData;\n  1364→    } else {\n  1365→        // 新增記錄\n  1366→        entries.push(formData);\n  1367→    }\n  1368→    \n  1369→    saveWeekEntries(weekKey, entries);\n  1370→    renderEntriesList();\n  1371→    clearForm();\n  1372→    showSuccessMessage('工時記錄已儲存成功！');\n  1373→}\n  1374→\n  1375→// 編輯工時記錄\n  1376→function editEntry(entryId) {\n  1377→    const weekKey = getCurrentWeekKey();\n  1378→    const entries = getWeekEntries(weekKey);\n  1379→    const entry = entries.find(e => e.id === entryId);\n  1380→    \n  1381→    if (entry) {\n  1382→        fillForm(entry);\n  1383→        // 滾動到表單頂部\n  1384→        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n  1385→    }\n  1386→}\n  1387→\n  1388→// 複製工時記錄\n  1389→function copyEntry(entryId) {\n  1390→    const weekKey = getCurrentWeekKey();\n  1391→    const entries = getWeekEntries(weekKey);\n  1392→    const entry = entries.find(e => e.id === entryId);\n  1393→    \n  1394→    if (entry) {\n  1395→        // 獲取當週日期範圍\n  1396→        const [year, week] = weekKey.split('-');\n  1397→        const weekNumber = parseInt(week.substring(1));\n  1398→        const weekRange = getWeekDateRange(weekNumber, year);\n  1399→        \n  1400→        // 複製記錄資料並更新日期\n  1401→        const copiedEntry = { ...entry, id: generateUniqueId() };\n  1402→        \n  1403→        // 更新日期（如果是單日記錄）\n  1404→        if (copiedEntry.date) {\n  1405→            const originalDate = new Date(copiedEntry.date);\n  1406→            const nextDate = new Date(originalDate);\n  1407→            nextDate.setDate(originalDate.getDate() + 1);\n  1408→            \n  1409→            // 檢查是否超過週範圍\n  1410→            if (nextDate <= weekRange.end) {\n  1411→                copiedEntry.date = formatDate(nextDate);\n  1412→            } else {\n  1413→                // 如果是週最後一天，則重置為週第一天\n  1414→                copiedEntry.date = formatDate(weekRange.start);\n  1415→            }\n  1416→        }\n  1417→        \n  1418→        fillForm(copiedEntry);\n  1419→        // 滾動到表單頂部\n  1420→        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n  1421→        showSuccessMessage('工時記錄已複製，日期已自動調整');\n  1422→    }\n  1423→}\n  1424→\n  1425→// 刪除工時記錄\n  1426→function deleteEntry(entryId) {\n  1427→    if (!confirm('確定要刪除這筆工時記錄嗎？')) {\n  1428→        return;\n  1429→    }\n  1430→    \n  1431→    const weekKey = getCurrentWeekKey();\n  1432→    const entries = getWeekEntries(weekKey);\n  1433→    const filteredEntries = entries.filter(entry => entry.id !== entryId);\n  1434→    \n  1435→    saveWeekEntries(weekKey, filteredEntries);\n  1436→    renderEntriesList();\n  1437→    showSuccessMessage('工時記錄已刪除！');\n  1438→}\n  1439→\n  1440→// 渲染工時記錄列表\n  1441→function renderEntriesList() {\n  1442→    const weekKey = getCurrentWeekKey();\n  1443→    const entries = getWeekEntries(weekKey);\n  1444→    const tbody = document.getElementById('entries-tbody');\n  1445→    \n  1446→    if (!tbody) return;\n  1447→    \n  1448→    tbody.innerHTML = '';\n  1449→    \n  1450→    let totalHours = 0;\n  1451→    \n  1452→    entries.forEach(entry => {\n  1453→        totalHours += entry.ttlHours || 0;\n  1454→        \n  1455→        const row = document.createElement('tr');\n  1456→        row.innerHTML = `\n  1457→            <td>${entry.date || '-'}</td>\n  1458→            <td>${entry.zone || '-'}</td>\n  1459→            <td>${entry.activityType || '-'}</td>\n  1460→            <td>${entry.task || '-'}</td>\n  1461→            <td>${entry.regularHours || 0}</td>\n  1462→            <td>${entry.otHours || 0}</td>\n  1463→            <td><strong>${entry.ttlHours || 0}</strong></td>\n  1464→            <td class=\"entry-actions\">\n  1465→                <button class=\"btn-edit-entry\" onclick=\"editEntry('${entry.id}')\">編輯</button>\n  1466→                <button class=\"btn-copy-entry\" onclick=\"copyEntry('${entry.id}')\">複製</button>\n  1467→                <button class=\"btn-delete-entry\" onclick=\"deleteEntry('${entry.id}')\">刪除</button>\n  1468→            </td>\n  1469→        `;\n  1470→        tbody.appendChild(row);\n  1471→    });\n  1472→    \n  1473→    \n  1474→    alert('成功複製 ' + copiedEntries.length + ' 筆工時記錄到目標週！\\n\\n來源週：' + sourceWeekKey + '\\n目標週：' + targetWeekKey + '\\n日期範圍：' + startDate + ' ~ ' + endDate + '\\n\\n所有日期已自動調整為目標週對應日期。');\n  1475→}\n  1476→\n  1477→// 顯示成功訊息\n  1478→function showSuccessMessage(message) {\n  1479→    // 創建或更新成功訊息元素\n  1480→    let successDiv = document.querySelector('.success-message');\n  1481→    if (!successDiv) {\n  1482→        successDiv = document.createElement('div');\n  1483→        successDiv.className = 'success-message';\n  1484→        document.querySelector('.form-container').insertBefore(successDiv, document.querySelector('.form-container').firstChild);\n  1485→    }\n  1486→    \n  1487→    successDiv.textContent = message;\n  1488→    successDiv.style.display = 'block';\n  1489→    \n  1490→    // 3秒後自動隱藏\n  1491→    setTimeout(() => {\n  1492→        successDiv.style.display = 'none';\n  1493→    }, 3000);\n  1494→}\n  1495→\n  1496→// 初始化編輯頁面\n  1497→async function initEditPage() {\n  1498→    const weekKey = getCurrentWeekKey();\n  1499→    if (!weekKey) {\n  1500→        alert('無效的週次參數');\n  1501→        window.location.href = 'index.html';\n  1502→        return;\n  1503→    }\n  1504→    \n  1505→    // 載入 CSV 資料\n  1506→    await loadAllCSVData();\n  1507→    \n  1508→    // 設置週次標題和日期範圍\n  1509→    document.getElementById('week-title').textContent = weekKey;\n  1510→    \n  1511→    // 計算並顯示日期範圍\n  1512→    const [year, week] = weekKey.split('-');\n  1513→    const weekNumber = parseInt(week.substring(1));\n  1514→    const dateRange = getWeekDateRange(weekNumber, year);\n  1515→    const entries = getWeekEntries(weekKey) || [];\n  1516→    const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n  1517→    const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n  1518→    const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n  1519→\n  1520→    // 將統計資訊加在日期區塊同一行\n  1521→    const dateRangeDiv = document.getElementById('date-range');\n  1522→    dateRangeDiv.innerHTML =\n  1523→        `${formatDate(dateRange.start)} 至 ${formatDate(dateRange.end)}\n  1524→        <span style=\"color:#444;font-size:1em;\">\n  1525→        總正常工時：${totalRegularHours}\n  1526→        總加班工時：${totalOtHours}\n  1527→        總工時：${totalHours}\n  1528→        </span>`;\n  1529→    // 設置日期欄位的限制範圍\n  1530→    setDateFieldLimits(dateRange.start, dateRange.end);\n  1531→    \n  1532→    // (已移除正規化模式狀態顯示)\n  1533→ \n  1534→    // 載入並顯示全域基本資料\n  1535→    const basicInfo = loadGlobalBasicInfo();\n  1536→    if (basicInfo) {\n  1537→        fillBasicInfo(basicInfo);\n  1538→        document.querySelector('.basic-info-container').classList.add('basic-info-saved');\n  1539→    }\n  1540→    \n  1541→    // 綁定基本資料表單事件\n  1542→    document.getElementById('btn-save-basic-info').addEventListener('click', saveBasicInfo);\n  1543→    \n  1544→    // 綁定工時記錄表單事件\n  1545→    document.getElementById('regularHours').addEventListener('input', calculateTotalHours);\n  1546→    document.getElementById('otHours').addEventListener('input', calculateTotalHours);\n  1547→    \n  1548→    // 綁定按鈕事件\n  1549→    document.getElementById('btn-save-entry').addEventListener('click', saveEntry);\n  1550→    document.getElementById('btn-cancel-entry').addEventListener('click', clearForm);\n  1551→    document.getElementById('btn-clear-form').addEventListener('click', clearForm);\n  1552→    document.getElementById('btn-back').addEventListener('click', () => {\n  1553→        window.location.href = 'index.html';\n  1554→    });\n  1555→    \n  1556→    // 綁定新增記錄按鈕\n  1557→    document.getElementById('btn-add-entry').addEventListener('click', () => {\n  1558→        clearForm();\n  1559→        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n  1560→    });\n  1561→    \n  1562→    \n  1563→    // 渲染工時記錄列表\n  1564→    renderEntriesList();\n  1565→}\n  1566→\n  1567→// 檢查是否為編輯頁面並初始化\n  1568→if (window.location.pathname.includes('edit.html')) {\n  1569→    document.addEventListener('DOMContentLoaded', initEditPage);\n  1570→}\n  1571→// 隱藏週次選擇模態框\n  1572→function hideWeekSelectionModal() {\n  1573→    const modal = document.getElementById('week-selection-modal');\n  1574→    modal.style.display = 'none';\n  1575→}\n  1576→\n  1577→// 確認週次選擇並建立工時表\n  1578→function confirmWeekSelection() {\n  1579→    const selectedOption = document.querySelector('input[name=\"weekOption\"]:checked');\n  1580→    \n  1581→    if (!selectedOption) {\n  1582→        alert('請選擇一個週次選項');\n  1583→        return;\n  1584→    }\n  1585→    \n  1586→    let weekKey = '';\n  1587→    \n  1588→    switch (selectedOption.value) {\n  1589→        case 'last':\n  1590→            weekKey = getLastWeekKey();\n  1591→            break;\n  1592→        case 'this':\n  1593→            weekKey = getThisWeekKey();\n  1594→            break;\n  1595→        case 'custom':\n  1596→            const customWeek = document.getElementById('custom-week-field').value.trim();\n  1597→            if (!customWeek) {\n  1598→                alert('請輸入自訂週次');\n  1599→                return;\n  1600→            }\n  1601→            \n  1602→            // 驗證格式\n  1603→            if (!/^\\d{4}-W\\d{2}$/.test(customWeek)) {\n  1604→                alert('週次格式不正確，請使用YYYY-Www格式（例如2024-W25）');\n  1605→                return;\n  1606→            }\n  1607→            \n  1608→            weekKey = customWeek;\n  1609→            break;\n  1610→        default:\n  1611→            alert('無效的選項');\n  1612→            return;\n  1613→    }\n  1614→    \n  1615→    if (!weekKey) {\n  1616→        alert('無法取得週次資訊');\n  1617→        return;\n  1618→    }\n  1619→    \n  1620→    // 檢查是否已存在\n  1621→    const timesheets = loadAllTimesheets();\n  1622→    if (timesheets[weekKey]) {\n  1623→        alert(`週次 ${weekKey} 已存在`);\n  1624→        return;\n  1625→    }\n  1626→    \n  1627→    // 創建新的工時表\n  1628→    timesheets[weekKey] = [];\n  1629→    saveAllTimesheets(timesheets);\n  1630→    \n  1631→    // 隱藏模態框\n  1632→    hideWeekSelectionModal();\n  1633→    \n  1634→    // 重新渲染卡片\n  1635→    renderTimesheetCards();\n  1636→    \n  1637→    // 顯示成功訊息\n  1638→    showSuccessMessage(`成功建立週次 ${weekKey} 的工時表`);\n  1639→}\n  1640→\n  1641→// 顯示成功訊息\n  1642→function showSuccessMessage(message) {\n  1643→    // 創建成功訊息元素\n  1644→    const successDiv = document.createElement('div');\n  1645→    successDiv.className = 'success-message';\n  1646→    successDiv.innerHTML = `\n  1647→        <div class=\"success-content\">\n  1648→            <span class=\"success-icon\">✓</span>\n  1649→            <span class=\"success-text\">${message}</span>\n  1650→        </div>\n  1651→    `;\n  1652→    \n  1653→    // 添加到頁面\n  1654→    document.body.appendChild(successDiv);\n  1655→    \n  1656→    // 3秒後自動移除\n  1657→    setTimeout(() => {\n  1658→        if (successDiv.parentNode) {\n  1659→            successDiv.parentNode.removeChild(successDiv);\n  1660→        }\n  1661→    }, 3000);\n  1662→}"}]},"uuid":"9c582497-9478-4891-824f-cc8481507483","timestamp":"2025-06-20T07:13:08.783Z","toolUseResult":{"type":"text","file":{"filePath":"/home/yanggf/a/timesheet/app.js","content":"import { loadAllTimesheets, saveAllTimesheets, loadGlobalBasicInfo, getWeekEntries, saveWeekEntries } from './modules/storageModule.js';\nimport { loadAllCSVData, getProjectsByZone, getPMByProject, getProductModulesByZone, updateProjectOptions, updateProjectDropdown, updateProductModuleDropdown, updateActivityTypeOptions, generateCSVContent, downloadCSVFile } from './modules/csvModule.js';\nimport { getWeekNumber, getWeekDateRangeFromKey } from './modules/dateModule.js';\nimport {\n    showSuccessMessage,\n    showCopyOptionsModal,\n    closeCopyModal,\n    handleCopySelection,\n    copyWeekToTargetWeek\n} from './modules/uiModule.js';\n        const sourceEndDate = sourceWeekRange.end.toISOString().split('T')[0];\n        sourceDescription = `${sourceWeekKey} 工時表 (${sourceStartDate} ~ ${sourceEndDate})`;\n    }\n    \n    // 更新模態視窗標題以包含來源週資訊\n    document.querySelector('#copy-options-modal .modal-header h3').textContent =\n        `複製 ${sourceDescription} 到哪一週？`;\n    \n    // 更新模態視窗中的目標週次資訊\n    const currentWeekRange = getWeekDateRangeFromKey(currentWeekKey);\n    const lastWeekRange = getWeekDateRangeFromKey(lastWeekKey);\n    \n    document.getElementById('copy-current-week-info').textContent =\n        `${currentWeekKey} (${currentWeekRange.start.toISOString().split('T')[0]} ~ ${currentWeekRange.end.toISOString().split('T')[0]})`;\n    document.getElementById('copy-last-week-info').textContent =\n        `${lastWeekKey} (${lastWeekRange.start.toISOString().split('T')[0]} ~ ${lastWeekRange.end.toISOString().split('T')[0]})`;\n    \n    // 顯示模態視窗\n    document.getElementById('copy-options-modal').style.display = 'block';\n    \n    // 綁定按鈕事件\n    document.getElementById('copy-btn-current').onclick = function() {\n        handleCopySelection(sourceWeekKey, currentWeekKey);\n    };\n    \n    document.getElementById('copy-btn-last').onclick = function() {\n        handleCopySelection(sourceWeekKey, lastWeekKey);\n    };\n    \n    document.getElementById('copy-btn-custom').onclick = function() {\n        document.getElementById('copy-custom-week-input').style.display = 'block';\n        document.getElementById('copy-custom-week-field').focus();\n    };\n    \n    document.getElementById('copy-btn-custom-confirm').onclick = function() {\n        const customWeekKey = document.getElementById('copy-custom-week-field').value.trim().toUpperCase();\n        if (!customWeekKey) {\n            alert('請輸入週次。');\n            return;\n        }\n        \n        const weekKeyPattern = /^\\d{4}-W(0[1-9]|[1-4]\\d|5[0-3])$/;\n        if (!weekKeyPattern.test(customWeekKey)) {\n            alert('無效的週次格式。請使用 YYYY-WNN 格式。');\n            return;\n        }\n        \n        handleCopySelection(sourceWeekKey, customWeekKey);\n    };\n    \n    document.getElementById('copy-btn-custom-cancel').onclick = function() {\n        document.getElementById('copy-custom-week-input').style.display = 'none';\n        document.getElementById('copy-custom-week-field').value = '';\n    };\n    \n    document.getElementById('copy-btn-cancel').onclick = function() {\n        closeCopyModal();\n    };\n}\n\n// 處理複製選擇的函數\nfunction handleCopySelection(sourceWeekKey, targetWeekKey) {\n    // 顯示確認對話框\n    const sourceWeekRange = getWeekDateRangeFromKey(sourceWeekKey);\n    const targetWeekRange = getWeekDateRangeFromKey(targetWeekKey);\n    const sourceStartDate = sourceWeekRange.start.toISOString().split('T')[0];\n    const sourceEndDate = sourceWeekRange.end.toISOString().split('T')[0];\n    const targetStartDate = targetWeekRange.start.toISOString().split('T')[0];\n    const targetEndDate = targetWeekRange.end.toISOString().split('T')[0];\n    \n    // 取得來源週的工時記錄數量\n    const timesheets = loadAllTimesheets();\n    let sourceEntries = [];\n    const sourceWeekData = timesheets[sourceWeekKey];\n    if (Array.isArray(sourceWeekData)) {\n        sourceEntries = sourceWeekData;\n    } else if (sourceWeekData && sourceWeekData.entries) {\n        sourceEntries = sourceWeekData.entries;\n    }\n    \n    const confirmMessage = `確認要複製工時記錄嗎？\\n\\n` +\n                           `來源週：${sourceWeekKey}\\n` +\n                           `日期範圍：${sourceStartDate} ~ ${sourceEndDate}\\n` +\n                           `記錄筆數：${sourceEntries.length} 筆\\n\\n` +\n                           `目標週：${targetWeekKey}\\n` +\n                           `日期範圍：${targetStartDate} ~ ${targetEndDate}\\n\\n` +\n                           `所有日期將自動調整為目標週對應日期。`;\n    \n    if (confirm(confirmMessage)) {\n        copyWeekToTargetWeek(sourceWeekKey, targetWeekKey);\n        closeCopyModal();\n    }\n}\n\n// 關閉複製模態視窗的函數\nfunction closeCopyModal() {\n    document.getElementById('copy-options-modal').style.display = 'none';\n    document.getElementById('copy-custom-week-input').style.display = 'none';\n    document.getElementById('copy-custom-week-field').value = '';\n}\n\n// 設置日期欄位的限制範圍\nfunction setDateFieldLimits(startDate, endDate) {\n    const minDate = formatDate(startDate);\n    const maxDate = formatDate(endDate);\n    \n    // 設置日期欄位的 min 和 max 屬性\n    const dateFields = ['date', 'startDate', 'endDate'];\n    dateFields.forEach(fieldId => {\n        const field = document.getElementById(fieldId);\n        if (field) {\n            field.min = minDate;\n            field.max = maxDate;\n            \n            // 如果欄位有值但超出範圍，則清空\n            if (field.value) {\n                const fieldDate = new Date(field.value);\n                if (fieldDate < startDate || fieldDate > endDate) {\n                    field.value = '';\n                }\n            }\n        }\n    });\n}\n\n// 驗證日期是否在週範圍內\nfunction validateDateInWeekRange(date, startDate, endDate) {\n    if (!date) return true; // 空值允許\n    \n    const inputDate = new Date(date);\n    return inputDate >= startDate && inputDate <= endDate;\n}\n\n// 啟用正規化模式\nfunction enableNormalizationMode(weekKey) {\n    // 儲存正規化狀態到 localStorage\n    const normalizationData = {\n        weekKey: weekKey,\n        enabled: true,\n        timestamp: new Date().toISOString()\n    };\n    localStorage.setItem(`normalization_${weekKey}`, JSON.stringify(normalizationData));\n    \n    // 更新 UI 顯示正規化模式狀態\n    updateNormalizationModeDisplay(weekKey);\n}\n\n// 檢查是否啟用正規化模式\nfunction isNormalizationEnabled(weekKey) {\n    const data = localStorage.getItem(`normalization_${weekKey}`);\n    return data ? JSON.parse(data).enabled : false;\n}\n\n// 更新正規化模式顯示\nfunction updateNormalizationModeDisplay(weekKey) {\n    const isEnabled = isNormalizationEnabled(weekKey);\n    const weekInfoDiv = document.querySelector('.week-info');\n    \n    // 移除舊的正規化提示\n    const existingAlert = weekInfoDiv.querySelector('.normalization-alert');\n    if (existingAlert) {\n        existingAlert.remove();\n    }\n    \n    if (isEnabled) {\n        // 顯示正規化模式提示\n        const alertDiv = document.createElement('div');\n        alertDiv.className = 'normalization-alert';\n        alertDiv.innerHTML = `\n            <div class=\"alert alert-info\">\n                <strong>📊 正規化模式已啟用</strong> - 該週工時超過40小時，匯出時將自動進行正規化計算\n                <button onclick=\"disableNormalizationMode('${weekKey}')\" class=\"btn-disable-normalization\">停用</button>\n            </div>\n        `;\n        weekInfoDiv.appendChild(alertDiv);\n    }\n}\n\n// 停用正規化模式\nfunction disableNormalizationMode(weekKey) {\n    localStorage.removeItem(`normalization_${weekKey}`);\n    updateNormalizationModeDisplay(weekKey);\n    showSuccessMessage('正規化模式已停用');\n}\n\n// 匯出時進行正規化計算\nfunction performNormalizationForExport(entries) {\n    let totalRegularHours = 0;\n\n    // 計算總正常工時\n    entries.forEach(entry => {\n        totalRegularHours += entry.regularHours || 0;\n    });\n\n    if (totalRegularHours > 40) {\n        const normalizedEntries = entries.map(entry => {\n            const originalHours = entry.regularHours || 0;\n            const ratio = 40 / totalRegularHours;\n            const newRegularHours = Math.round(originalHours * ratio * 100) / 100;\n            // 保存原始工時\n            return {\n                ...entry,\n                _originalHours: originalHours,\n                _isNormalized: true,\n                regularHours: newRegularHours,\n                ttlHours: newRegularHours + (entry.otHours || 0)\n            };\n        });\n        return normalizedEntries;\n    }\n\n    return entries; // 不需要正規化\n}\n// 格式化日期為 YYYY-MM-DD（本地時間）\nfunction formatDate(date) {\n    const y = date.getFullYear();\n    const m = String(date.getMonth() + 1).padStart(2, '0');\n    const d = String(date.getDate()).padStart(2, '0');\n    return `${y}-${m}-${d}`;\n}\n\n// 從localStorage加載所有工時表數據\nfunction loadAllTimesheets() {\n    const data = localStorage.getItem('timesheets');\n    return data ? JSON.parse(data) : {};\n}\n\n// 保存所有工時表數據到localStorage\nfunction saveAllTimesheets(timesheets) {\n    localStorage.setItem('timesheets', JSON.stringify(timesheets));\n}\n\n// 獲取指定週數的日期範圍（週日到週六）\nfunction getWeekDateRange(weekNumber, year) {\n    // 簡單實現：假設year和weekNumber是有效的\n    // 實際應根據ISO週數計算，這裡簡化為從當年第一週的週日開始推算\n    // 注意：這只是一個示例，實際的日期計算需要更嚴謹的邏輯\n    const firstDayOfYear = new Date(year, 0, 1);\n    const firstSunday = new Date(firstDayOfYear);\n    // 調整到第一週的週日（假設第一週從1月1日所在週的週日開始）\n    firstSunday.setDate(firstDayOfYear.getDate() - firstDayOfYear.getDay());\n    \n    const startDate = new Date(firstSunday);\n    startDate.setDate(firstSunday.getDate() + (weekNumber - 1) * 7);\n    const endDate = new Date(startDate);\n    endDate.setDate(startDate.getDate() + 6);\n    \n    return {\n        start: startDate,\n        end: endDate\n    };\n}\n\n// 計算填寫進度（根據記錄筆數和預期5個工作日？這裡簡化為記錄筆數是否大於0）\nfunction calculateProgress(entries) {\n    // 如果有記錄，則認為填寫了，進度100%；否則0\n    return entries && entries.length > 0 ? 100 : 0;\n}\n\n// 渲染工時表卡片\nfunction renderTimesheetCards() {\n    const container = document.getElementById('timesheet-cards');\n    container.innerHTML = ''; // 清空容器\n    \n    const timesheets = loadAllTimesheets();\n    \n    Object.keys(timesheets).forEach(key => {\n        // key格式：YYYY-Www，需檢查合法性\n        if (!key || typeof key !== 'string' || !key.includes('-')) return;\n        const [year, week] = key.split('-');\n        if (!year || !week || week.length < 2) return;\n        const weekNumber = parseInt(week.substring(1));\n        if (isNaN(weekNumber)) return;\n        const weekData = timesheets[key];\n        \n        // 處理新的資料結構（包含 basicInfo 和 entries）\n        let entries = [];\n        if (Array.isArray(weekData)) {\n            // 舊的資料結構，直接是陣列\n            entries = weekData;\n        } else if (weekData && weekData.entries) {\n            // 新的資料結構，有 basicInfo 和 entries\n            entries = weekData.entries;\n        }\n        \n        const dateRange = getWeekDateRange(weekNumber, year);\n        const startStr = dateRange.start.toISOString().split('T')[0];\n        const endStr = dateRange.end.toISOString().split('T')[0];\n        \n        const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n        const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n        const isComplete = totalHours >= 40;\n        \n        // 創建卡片元素\n        const card = document.createElement('div');\n        card.className = 'timesheet-card';\n        card.innerHTML = `\n            <div class=\"card-color-bar\"></div>\n            <div class=\"status-tag ${isComplete ? 'status-completed' : 'status-inprogress'}\"\n                 title=\"${isComplete ? '總工時已達40小時' : '總工時未達40小時'}\">\n                ${isComplete ? '✓' : '⚠'}\n            </div>\n            <div class=\"card-header\">\n                <div class=\"week-title\">${key}</div>\n                <div class=\"date-range\">${startStr} 至 ${endStr}</div>\n            </div>\n            <div class=\"stats\">\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${entries.length}</div>\n                    <div class=\"stat-label\">記錄筆數</div>\n                </div>\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${totalHours}</div>\n                    <div class=\"stat-label\">總工時</div>\n                </div>\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${totalRegularHours}</div>\n                    <div class=\"stat-label\">總正常工時</div>\n                </div>\n                <div class=\"stat-item\">\n                    <div class=\"stat-value\">${totalOtHours}</div>\n                    <div class=\"stat-label\">總加班工時</div>\n                </div>\n            </div>\n            <div class=\"card-actions\">\n                <button class=\"btn-edit\" data-week=\"${key}\">修改</button>\n                <button class=\"btn-copy\" data-week=\"${key}\">複製</button>\n                <button class=\"btn-delete\" data-week=\"${key}\">刪除</button>\n                <button class=\"btn-export\" data-week=\"${key}\">匯出</button>\n            </div>\n        `;\n        \n        container.appendChild(card);\n    });\n    \n    // 為卡片上的按鈕添加事件監聽\n    document.querySelectorAll('.btn-edit').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\n            editTimesheet(weekKey);\n        });\n    });\n    \n    document.querySelectorAll('.btn-delete').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\n            deleteTimesheet(weekKey);\n        });\n    });\n    \n    document.querySelectorAll('.btn-copy').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\nconsole.log('Attempting to call showCopyOptionsModal with weekKey:', weekKey);\n            showCopyOptionsModal(weekKey);\n        });\n    });\n    \n    document.querySelectorAll('.btn-export').forEach(btn => {\n        btn.addEventListener('click', () => {\n            const weekKey = btn.getAttribute('data-week');\n            exportTimesheet(weekKey);\n        });\n    });\n    \n    // 更新上週按鈕顯示狀態\n    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n        updateLastWeekButtonDisplay();\n    }\n}\n\n// 新建工時表 - 顯示週次選擇模態框\nfunction newTimesheet() {\n    showWeekSelectionModal();\n}\n\n// 顯示週次選擇模態框\nfunction showWeekSelectionModal() {\n    const modal = document.getElementById('week-selection-modal');\n    const timesheets = loadAllTimesheets();\n    \n    // 計算上週和本週的週次\n    const lastWeekKey = getLastWeekKey();\n    const thisWeekKey = getThisWeekKey();\n    \n    // 更新上週選項資訊\n    const lastWeekInfo = document.getElementById('last-week-info');\n    const lastWeekStatus = document.getElementById('last-week-status');\n    const lastWeekOption = document.getElementById('option-last-week');\n    \n    if (lastWeekKey) {\n        const lastWeekRange = getWeekDateRangeFromKey(lastWeekKey);\n        lastWeekInfo.textContent = `${lastWeekKey} (${formatDate(lastWeekRange.start)} - ${formatDate(lastWeekRange.end)})`;\n        \n        if (timesheets[lastWeekKey]) {\n            lastWeekStatus.textContent = '已存在';\n            lastWeekStatus.className = 'option-status status-exists';\n            // 如果已存在，禁用該選項\n            document.getElementById('radio-last-week').disabled = true;\n            lastWeekOption.style.opacity = '0.6';\n        } else {\n            lastWeekStatus.textContent = '可建立';\n            lastWeekStatus.className = 'option-status status-new';\n            document.getElementById('radio-last-week').disabled = false;\n            lastWeekOption.style.opacity = '1';\n        }\n    } else {\n        lastWeekOption.style.display = 'none';\n    }\n    \n    // 更新本週選項資訊\n    const thisWeekInfo = document.getElementById('this-week-info');\n    const thisWeekStatus = document.getElementById('this-week-status');\n    const thisWeekOption = document.getElementById('option-this-week');\n    \n    if (thisWeekKey) {\n        const thisWeekRange = getWeekDateRangeFromKey(thisWeekKey);\n        thisWeekInfo.textContent = `${thisWeekKey} (${formatDate(thisWeekRange.start)} - ${formatDate(thisWeekRange.end)})`;\n        \n        if (timesheets[thisWeekKey]) {\n            thisWeekStatus.textContent = '已存在';\n            thisWeekStatus.className = 'option-status status-exists';\n            // 如果已存在，禁用該選項\n            document.getElementById('radio-this-week').disabled = true;\n            thisWeekOption.style.opacity = '0.6';\n        } else {\n            thisWeekStatus.textContent = '可建立';\n            thisWeekStatus.className = 'option-status status-new';\n            document.getElementById('radio-this-week').disabled = false;\n            thisWeekOption.style.opacity = '1';\n        }\n    } else {\n        thisWeekOption.style.display = 'none';\n    }\n    \n    // 重置自訂輸入\n    document.getElementById('custom-week-field').value = '';\n    document.getElementById('custom-week-input').style.display = 'none';\n    \n    // 清除選擇\n    document.querySelectorAll('input[name=\"weekOption\"]').forEach(radio => {\n        radio.checked = false;\n    });\n    \n    // 顯示模態框\n    modal.style.display = 'block';\n}\n\n// 取得上週的週次鍵值\nfunction getLastWeekKey() {\n    const today = new Date();\n    const lastMonday = new Date(today);\n    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n    \n    const year = lastMonday.getFullYear();\n    const weekNumber = getWeekNumber(lastMonday);\n    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n}\n\n// 取得本週的週次鍵值\nfunction getThisWeekKey() {\n    const today = new Date();\n    const thisMonday = new Date(today);\n    thisMonday.setDate(today.getDate() - today.getDay() + 1);\n    \n    const year = thisMonday.getFullYear();\n    const weekNumber = getWeekNumber(thisMonday);\n    return `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n}\n\n// 計算週數（ISO 8601）\n/**\n * 以週日為週首計算週次（YYYY-Www），週日~週六\n */\nfunction getWeekNumber(date) {\n    const d = new Date(date);\n    // 找到本週的週日\n    const sunday = new Date(d);\n    sunday.setDate(d.getDate() - d.getDay());\n    // 計算今年第一天的週日\n    const firstDay = new Date(d.getFullYear(), 0, 1);\n    const firstSunday = new Date(firstDay);\n    firstSunday.setDate(firstDay.getDate() - firstDay.getDay());\n    // 計算週數\n    const diff = sunday - firstSunday;\n    const weekNumber = Math.floor(diff / (7 * 24 * 60 * 60 * 1000)) + 1;\n    return weekNumber;\n}\n\n// 從週次鍵值取得日期範圍\nfunction getWeekDateRangeFromKey(weekKey) {\n    const [year, week] = weekKey.split('-');\n    const weekNumber = parseInt(week.substring(1));\n    return getWeekDateRange(weekNumber, year);\n}\n\n// 修改工時表（跳轉到編輯頁面）\nfunction editTimesheet(weekKey) {\n    // 跳轉到工時填寫界面\n    window.location.href = `edit.html?week=${encodeURIComponent(weekKey)}`;\n}\n\n// 刪除工時表\nfunction deleteTimesheet(weekKey) {\n    if (confirm(`確定要刪除 ${weekKey} 的工時表嗎？`)) {\n        const timesheets = loadAllTimesheets();\n        delete timesheets[weekKey];\n        saveAllTimesheets(timesheets);\n        renderTimesheetCards();\n    }\n}\n\n// 匯出工時表為CSV檔案\nfunction exportTimesheet(weekKey) {\n    try {\n        const entries = getWeekEntries(weekKey);\n        if (!entries || entries.length === 0) {\n            alert('該週次沒有工時記錄可匯出');\n            return;\n        }\n\n        // 匯出前檢查總正常工時，若超過40小時則提示\n        const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n        // 若超過40小時，提示將自動正規化\n        if (totalRegularHours > 40) {\n            alert('本週正常工時超過40小時，滙出時將自動進行正規化計算。\\n\\n注意：若下載檔案時選擇覆蓋舊檔，且舊檔正在開啟狀態，下載可能會失敗並顯示「需要下載權限」等錯誤，請先關閉舊檔再下載。');\n        }\n\n        let exportEntries = [...entries];\n\n        if (totalRegularHours > 40) {\n            exportEntries = performNormalizationForExport(exportEntries);\n        }\n\n        // 準備CSV內容\n        const csvContent = generateCSVContent(exportEntries, weekKey);\n\n        // 創建並下載檔案\n        downloadCSVFile(csvContent, `工時表_${weekKey}.csv`);\n\n        // 顯示成功訊息\n        showSuccessMessage(`${weekKey} 工時表已匯出`);\n\n    } catch (error) {\n        console.error('匯出失敗:', error);\n        alert('匯出失敗，請檢查瀏覽器控制台');\n    }\n}\n// 滙出未經正規化的原始工時\nfunction exportRawTimesheet(weekKey) {\n    try {\n        const entries = getWeekEntries(weekKey);\n        if (!entries || entries.length === 0) {\n            alert('該週次沒有工時記錄可匯出');\n            return;\n        }\n        // 直接滙出原始工時資料\n        const csvContent = generateCSVContent(entries, weekKey);\n        downloadCSVFile(csvContent, `工時表_${weekKey}_原始.csv`);\n        showSuccessMessage(`${weekKey} 工時表（原始）已匯出`);\n    } catch (error) {\n        console.error('原始工時匯出失敗:', error);\n        alert('原始工時匯出失敗，請檢查瀏覽器控制台');\n    }\n}\n\n// 生成CSV內容\nfunction generateCSVContent(entries, weekKey) {\n    // CSV標題行（按照指定格式）\n    const headers = [\n        'Name',\n        'Zone',\n        'Project',\n        'Product Module',\n        'Activity Type',\n        'Task',\n        'Regular Hours',\n        'OT Hours',\n        'TTL_Hours',\n        'Date',\n        'Start Date',\n        'End Date',\n        'Comments',\n        'PM',\n        'InternalOrOutsource'\n    ];\n\n    // 載入基本資料\n    const basicInfo = loadGlobalBasicInfo();\n    \n    // 轉換資料行\n    const dataRows = entries.map(entry => {\n        const regularHours = parseFloat(entry.regularHours) || 0;\n        const overtimeHours = parseFloat(entry.overtimeHours) || parseFloat(entry.otHours) || 0;\n        const totalHours = parseFloat(entry.ttlHours) || (regularHours + overtimeHours);\n        \n        return [\n            basicInfo.employeeName || '',           // Name\n            entry.zone || '',                       // Zone\n            entry.project || '',                    // Project\n            entry.productModule || '',              // Product Module\n            entry.activityType || '',               // Activity Type\n            entry.task || '',                       // Task\n            regularHours,                           // Regular Hours\n            overtimeHours,                          // OT Hours\n            totalHours,                             // TTL_Hours\n            entry.date || '',                       // Date\n            entry.startDate || '',                  // Start Date\n            entry.endDate || '',                    // End Date\n            entry.comments || '',                   // Comments\n            entry.pm || '',                         // PM\n            basicInfo.employeeType || ''            // InternalOrOutsource\n        ];\n    });\n\n    // 組合CSV內容\n    const csvRows = [headers, ...dataRows];\n    \n    // 轉換為CSV格式字串\n    return csvRows.map(row =>\n        row.map(field => {\n            // 處理包含逗號或換行的欄位\n            const fieldStr = String(field);\n            if (fieldStr.includes(',') || fieldStr.includes('\\n') || fieldStr.includes('\"')) {\n                return '\"' + fieldStr.replace(/\"/g, '\"\"') + '\"';\n            }\n            return fieldStr;\n        }).join(',')\n    ).join('\\n');\n}\n\n// 下載CSV檔案\nfunction downloadCSVFile(csvContent, filename) {\n    try {\n        console.log('[downloadCSVFile] 開始下載', { filename, csvContentSample: csvContent.slice(0, 100) });\n        // 添加BOM以支援中文\n        const BOM = '\\uFEFF';\n        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n        console.log('[downloadCSVFile] Blob created', blob);\n        const url = URL.createObjectURL(blob);\n        console.log('[downloadCSVFile] Object URL', url);\n        const link = document.createElement('a');\n        link.setAttribute('href', url);\n        link.setAttribute('download', filename);\n        link.style.visibility = 'hidden';\n        // 添加到頁面並觸發下載\n        document.body.appendChild(link);\n        link.click();\n        console.log('[downloadCSVFile] link.click() 已觸發');\n        // 清理\n        document.body.removeChild(link);\n        URL.revokeObjectURL(url);\n        console.log('[downloadCSVFile] 清理完成');\n    } catch (err) {\n        console.error('[downloadCSVFile] 發生錯誤', err);\n    }\n}\n\n// 匯入工時表（暫時只提示）\nfunction importTimesheet() {\n    const input = document.getElementById('import-file');\n    input.value = ''; // 重置 input，避免同檔案無法重選\n    input.onchange = async function (event) {\n        const file = event.target.files[0];\n        if (!file) return;\n        const reader = new FileReader();\n        reader.onload = function (e) {\n            const text = e.target.result;\n            try {\n                console.log('[import] 原始CSV內容:', text);\n                \n                // 檢查檔案是否為空\n                if (!text || text.trim().length === 0) {\n                    alert('檔案內容為空，請選擇有效的CSV檔案。');\n                    return;\n                }\n                \n                const data = parseCSV(text);\n                console.log('[import] parseCSV result:', data);\n                \n                // 檢查是否成功解析出資料\n                if (!data || data.length === 0) {\n                    alert('無法從檔案中解析出有效資料，請檢查CSV格式是否正確。');\n                    return;\n                }\n                \n                // 強制將 data 轉為 array\n                console.log('[import] typeof data:', typeof data, 'Array.isArray:', Array.isArray(data));\n                let arr = [];\n                if (Array.isArray(data)) {\n                    arr = data;\n                } else if (typeof data === 'object' && data !== null) {\n                    arr = Object.values(data).flat();\n                }\n                console.log('[import] 轉換後 arr:', arr);\n                \n                if (arr.length === 0) {\n                    alert('檔案中沒有有效的工時記錄。');\n                    return;\n                }\n                let groupedData = {};\n                const failedRows = [];\n                \n                arr.forEach((row, index) => {\n                    if (!row) return;\n                    \n                    // 檢查日期欄位（支援多種可能的欄位名稱）\n                    const dateValue = row.Date || row.date || row['日期'] || row.Day;\n                    if (!dateValue) {\n                        console.warn(`[import] 第${index + 1}筆記錄缺少日期欄位:`, row);\n                        failedRows.push(`第${index + 1}筆記錄：缺少日期欄位`);\n                        return;\n                    }\n                    \n                    // 改進的日期解析，支援多種格式\n                    let dateObj = null;\n                    const dateStr = dateValue.toString().trim();\n                    \n                    // 嘗試多種日期格式\n                    const dateFormats = [\n                        dateStr, // 原始格式\n                        dateStr.replace(/\\//g, '-'), // 將 / 替換為 -\n                        dateStr.replace(/\\./g, '-'), // 將 . 替換為 -\n                    ];\n                    \n                    for (const format of dateFormats) {\n                        dateObj = new Date(format);\n                        if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1900) {\n                            break;\n                        }\n                        dateObj = null;\n                    }\n                    \n                    if (!dateObj || isNaN(dateObj.getTime())) {\n                        console.warn(`[import] 第${index + 1}筆記錄日期格式無效:`, dateValue);\n                        failedRows.push(`第${index + 1}筆記錄：日期格式無效 \"${dateValue}\"`);\n                        return;\n                    }\n                    \n                    try {\n                        // 正確計算週次\n                        const year = dateObj.getFullYear();\n                        const weekNumber = getWeekNumber(dateObj);\n                        const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n                        console.log('[import][分組] Date:', dateValue, 'parsed:', dateObj, 'year:', year, 'weekNumber:', weekNumber, 'weekKey:', weekKey);\n                        \n                        if (!groupedData[weekKey]) groupedData[weekKey] = [];\n                        \n                        // 標準化記錄格式，確保日期統一和必要欄位\n                        const standardizedRow = { ...row };\n                        standardizedRow.date = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD 格式\n                        \n                        // 確保有唯一的 ID\n                        if (!standardizedRow.id) {\n                            standardizedRow.id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n                        }\n                        \n                        // 確保數字欄位有預設值\n                        standardizedRow.regularHours = standardizedRow.regularHours || 0;\n                        standardizedRow.otHours = standardizedRow.otHours || 0;\n                        standardizedRow.ttlHours = standardizedRow.ttlHours || (standardizedRow.regularHours + standardizedRow.otHours);\n                        \n                        groupedData[weekKey].push(standardizedRow);\n                    } catch (err) {\n                        console.error(`[import] 處理第${index + 1}筆記錄時發生錯誤:`, err, row);\n                        failedRows.push(`第${index + 1}筆記錄：處理時發生錯誤`);\n                    }\n                });\n                \n                // 如果有失敗的記錄，顯示警告\n                if (failedRows.length > 0) {\n                    console.warn('[import] 以下記錄匯入失敗:', failedRows);\n                    const proceed = confirm(`有 ${failedRows.length} 筆記錄匯入失敗：\\n${failedRows.slice(0, 5).join('\\n')}${failedRows.length > 5 ? '\\n...' : ''}\\n\\n是否繼續匯入其他記錄？`);\n                    if (!proceed) {\n                        alert('匯入已取消');\n                        return;\n                    }\n                }\n                console.log('[import] 自動分組週次結果:', groupedData);\n                // 合併匯入資料到主 timesheets\n                const timesheets = loadAllTimesheets();\n                console.log('[import] localStorage timesheets(匯入前):', timesheets);\n                const importedWeeks = [];\n                for (const weekKey in groupedData) {\n                    console.log('[import] 檢查週次', weekKey, groupedData[weekKey]);\n                    if (timesheets[weekKey]) {\n                        const overwrite = confirm('週次 ' + weekKey + ' 已有資料，是否覆蓋？');\n                        console.log('[import] 覆蓋確認', weekKey, overwrite);\n                        if (!overwrite) continue;\n                    }\n                    timesheets[weekKey] = groupedData[weekKey];\n                    importedWeeks.push(weekKey);\n                    console.log('[import] 已加入週次:', weekKey);\n                }\n                console.log('[import] importedWeeks:', importedWeeks);\n                console.log('[import] localStorage timesheets(匯入後):', timesheets);\n                \n                if (Object.keys(groupedData).length === 0) {\n                    alert('沒有有效的記錄可以匯入。請檢查CSV檔案中的日期格式和資料內容。');\n                    return;\n                }\n                \n                saveAllTimesheets(timesheets);\n                renderTimesheetCards();\n                \n                if (importedWeeks.length > 0) {\n                    const weekInfoList = importedWeeks.map(weekKey => {\n                        try {\n                            const range = getWeekDateRangeFromKey(weekKey);\n                            const start = range.start.toISOString().split('T')[0];\n                            const end = range.end.toISOString().split('T')[0];\n                            const recordCount = groupedData[weekKey].length;\n                            return `${weekKey} (${start} ~ ${end}) - ${recordCount}筆記錄`;\n                        } catch (err) {\n                            console.error('[import] 取得週次範圍失敗:', weekKey, err);\n                            return `${weekKey} - ${groupedData[weekKey].length}筆記錄`;\n                        }\n                    });\n                    \n                    const totalRecords = importedWeeks.reduce((sum, weekKey) => sum + groupedData[weekKey].length, 0);\n                    const successMessage = `匯入成功！\\n共匯入 ${totalRecords} 筆記錄到 ${importedWeeks.length} 個週次：\\n\\n${weekInfoList.join('\\n')}`;\n                    \n                    if (failedRows.length > 0) {\n                        alert(successMessage + `\\n\\n注意：有 ${failedRows.length} 筆記錄匯入失敗。`);\n                    } else {\n                        alert(successMessage);\n                    }\n                } else {\n                    alert('未匯入任何週次資料。所有記錄都被跳過了。');\n                }\n            } catch (err) {\n                console.error('[import] 匯入流程發生錯誤:', err);\n                let errorMessage = 'CSV 匯入失敗：\\n';\n                if (err.message) {\n                    errorMessage += err.message;\n                } else {\n                    errorMessage += '未知錯誤，請檢查瀏覽器控制台獲取更多資訊。';\n                }\n                alert(errorMessage);\n            }\n        };\n        reader.readAsText(file, 'utf-8');\n    };\n    input.click();\n}\n\n// ==================== 首頁模態框功能 ====================\n\n// 顯示基本資料設定模態框\nfunction showBasicInfoModal() {\n    const modal = document.getElementById('basic-info-modal');\n    const basicInfo = loadGlobalBasicInfo();\n    \n    // 載入現有資料\n    if (basicInfo) {\n        document.getElementById('modal-employeeName').value = basicInfo.employeeName || '';\n        document.getElementById('modal-employeeType').value = basicInfo.employeeType || '';\n    }\n    \n    modal.style.display = 'block';\n}\n\n// 隱藏基本資料設定模態框\nfunction hideBasicInfoModal() {\n    const modal = document.getElementById('basic-info-modal');\n    modal.style.display = 'none';\n    \n    // 清空表單\n    document.getElementById('modal-basic-info-form').reset();\n}\n\n// 儲存模態框中的基本資料\nfunction saveModalBasicInfo() {\n    const employeeName = document.getElementById('modal-employeeName').value.trim();\n    const employeeType = document.getElementById('modal-employeeType').value;\n    \n    if (!employeeName || !employeeType) {\n        alert('請填寫所有必填欄位');\n        return;\n    }\n    \n    const basicInfo = {\n        employeeName: employeeName,\n        employeeType: employeeType\n    };\n    \n    saveGlobalBasicInfo(basicInfo);\n    hideBasicInfoModal();\n    alert('基本資料已儲存成功！（全 App 共用）');\n}\n\n// 初始化：頁面加載完成後渲染卡片，並綁定按鈕事件\ndocument.addEventListener('DOMContentLoaded', () => {\n    // 檢查是否為首頁\n    if (window.location.pathname === '/' || window.location.pathname.includes('index.html')) {\n        renderTimesheetCards();\n        \n        // 綁定全局按鈕事件\n        document.getElementById('btn-basic-info').addEventListener('click', showBasicInfoModal);\n        document.getElementById('btn-new').addEventListener('click', newTimesheet);\n        document.getElementById('btn-import').addEventListener('click', importTimesheet);\n        document.getElementById('btn-clear-storage').addEventListener('click', () => {\n            if (confirm('確定要清空所有資料嗎？此操作無法還原。')) {\n                localStorage.clear();\n                renderTimesheetCards();\n                alert('localStorage 已清空');\n            }\n        });\n        \n        // 綁定基本資料模態框事件\n        document.getElementById('btn-save-modal-basic-info').addEventListener('click', saveModalBasicInfo);\n        document.getElementById('btn-cancel-modal').addEventListener('click', hideBasicInfoModal);\n        document.querySelector('.close').addEventListener('click', hideBasicInfoModal);\n        \n        // 綁定週次選擇模態框事件\n        const weekModal = document.getElementById('week-selection-modal');\n        if (weekModal) {\n            const weekCloseBtn = weekModal.querySelector('.close');\n            const confirmWeekBtn = document.getElementById('btn-confirm-week');\n            const cancelWeekBtn = document.getElementById('btn-cancel-week');\n            const customRadio = document.getElementById('radio-custom');\n            const customInput = document.getElementById('custom-week-input');\n            \n            if (weekCloseBtn) weekCloseBtn.addEventListener('click', hideWeekSelectionModal);\n            if (cancelWeekBtn) cancelWeekBtn.addEventListener('click', hideWeekSelectionModal);\n            if (confirmWeekBtn) confirmWeekBtn.addEventListener('click', confirmWeekSelection);\n            \n            // 監聽自訂選項的選擇\n            if (customRadio && customInput) {\n                customRadio.addEventListener('change', function() {\n                    if (this.checked) {\n                        customInput.style.display = 'block';\n                    }\n                });\n            }\n            \n            // 監聽其他選項的選擇（隱藏自訂輸入）\n            document.querySelectorAll('input[name=\"weekOption\"]:not(#radio-custom)').forEach(radio => {\n                radio.addEventListener('change', function() {\n                    if (this.checked && customInput) {\n                        customInput.style.display = 'none';\n                    }\n                });\n            });\n        }\n        \n        // 點擊模態框外部關閉\n        window.addEventListener('click', (event) => {\n            const basicModal = document.getElementById('basic-info-modal');\n            const weekSelectionModal = document.getElementById('week-selection-modal');\n            \n            if (event.target === basicModal) {\n                hideBasicInfoModal();\n            } else if (event.target === weekSelectionModal) {\n                hideWeekSelectionModal();\n            }\n        });\n\n        // 設置上週按鈕的文字和顯示狀態\n        const lastWeekButton = document.getElementById('btn-last-week');\n        if (lastWeekButton) {\n            updateLastWeekButtonDisplay();\n            // 綁定點擊事件\n            lastWeekButton.addEventListener('click', createLastWeekTimesheet);\n        }\n    }\n});\n\n// 更新上週按鈕顯示狀態和文字\nfunction updateLastWeekButtonDisplay() {\n    const today = new Date();\n    // 更精確的計算：獲取上週一（今天減去今天星期幾再減6天）\n    const lastMonday = new Date(today);\n    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n    const lastSunday = new Date(lastMonday);\n    lastSunday.setDate(lastMonday.getDate() + 6);\n    \n    const button = document.getElementById('btn-last-week');\n    const container = document.getElementById('last-week-container');\n    \n    if (button && container) {\n        // 檢查上週是否已存在\n        const lastWeekKey = getLastWeekKey();\n        const timesheets = loadAllTimesheets();\n        \n        if (timesheets[lastWeekKey]) {\n            // 上週已存在，隱藏按鈕\n            container.style.display = 'none';\n        } else {\n            // 上週不存在，顯示按鈕並設置文字\n            container.style.display = 'block';\n            button.textContent = `建立上週工時表 (${formatDate(lastMonday)} - ${formatDate(lastSunday)})`;\n        }\n    }\n}\n\n// 建立上週工時表\nfunction createLastWeekTimesheet() {\n    const today = new Date();\n    const lastMonday = new Date(today);\n    lastMonday.setDate(today.getDate() - today.getDay() - 6);\n    const lastSunday = new Date(lastMonday);\n    lastSunday.setDate(lastMonday.getDate() + 6);\n    \n    // 生成週次格式 YYYY-Www\n    const year = lastMonday.getFullYear();\n    const weekNumber = Math.ceil((((lastMonday - new Date(year, 0, 1)) / 86400000) + new Date(year, 0, 1).getDay() + 1) / 7);\n    const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;\n    \n    const timesheets = loadAllTimesheets();\n    if (!timesheets[weekKey]) {\n        timesheets[weekKey] = [];\n        saveAllTimesheets(timesheets);\n    }\n    \n    // 載入上週工時表\n    editTimesheet(weekKey);\n    renderTimesheetCards();\n}\n\n// ==================== 編輯頁面功能 ====================\n\n// 生成唯一 ID\nfunction generateUniqueId() {\n    return Date.now().toString(36) + Math.random().toString(36).substr(2);\n}\n\n// 獲取當前編輯的週次\nfunction getCurrentWeekKey() {\n    const urlParams = new URLSearchParams(window.location.search);\n    return urlParams.get('week');\n}\n\n// ==================== 全域基本資料管理 ====================\n\n// 載入全域基本資料\nfunction loadGlobalBasicInfo() {\n    const data = localStorage.getItem('globalBasicInfo');\n    return data ? JSON.parse(data) : null;\n}\n\n// 儲存全域基本資料\nfunction saveGlobalBasicInfo(basicInfo) {\n    localStorage.setItem('globalBasicInfo', JSON.stringify(basicInfo));\n}\n\n// ==================== 工時記錄管理 ====================\n\n// 獲取指定週次的工時記錄\nfunction getWeekEntries(weekKey) {\n    const timesheets = loadAllTimesheets();\n    const weekData = timesheets[weekKey];\n    \n    // 處理不同的資料結構\n    if (Array.isArray(weekData)) {\n        // 舊的資料結構，直接是陣列\n        return weekData;\n    } else if (weekData && weekData.entries) {\n        // 新的資料結構，有 entries\n        return weekData.entries;\n    }\n    \n    return [];\n}\n\n// 儲存指定週次的工時記錄\nfunction saveWeekEntries(weekKey, entries) {\n    const timesheets = loadAllTimesheets();\n    timesheets[weekKey] = entries; // 直接儲存為陣列，簡化結構\n    saveAllTimesheets(timesheets);\n}\n\n// 計算總工時\nfunction calculateTotalHours() {\n    const regular = parseFloat(document.getElementById('regularHours').value) || 0;\n    const ot = parseFloat(document.getElementById('otHours').value) || 0;\n    document.getElementById('ttlHours').value = regular + ot;\n}\n\n// 驗證基本資料表單\nfunction validateBasicInfo() {\n    const requiredFields = ['employeeName', 'employeeType'];\n    let isValid = true;\n    \n    // 清除之前的錯誤狀態\n    document.querySelectorAll('#basic-info-form .form-field.error').forEach(field => {\n        field.classList.remove('error');\n    });\n    \n    requiredFields.forEach(fieldName => {\n        const field = document.getElementById(fieldName);\n        const formField = field.closest('.form-field');\n        \n        if (!field.value.trim()) {\n            formField.classList.add('error');\n            showFieldError(formField, '此欄位為必填');\n            isValid = false;\n        }\n    });\n    \n    return isValid;\n}\n\n// 驗證工時記錄表單\nfunction validateForm() {\n    const requiredFields = ['task', 'zone', 'project', 'activityType', 'regularHours', 'date'];\n    let isValid = true;\n    \n    // 檢查是否已儲存全域基本資料\n    const basicInfo = loadGlobalBasicInfo();\n    if (!basicInfo) {\n        alert('請先填寫並儲存基本資料');\n        document.querySelector('.basic-info-container').scrollIntoView({ behavior: 'smooth' });\n        return false;\n    }\n    \n    // 清除之前的錯誤狀態\n    document.querySelectorAll('#timesheet-form .form-field.error').forEach(field => {\n        field.classList.remove('error');\n    });\n    \n    requiredFields.forEach(fieldName => {\n        const field = document.getElementById(fieldName);\n        const formField = field.closest('.form-field');\n        \n        if (!field.value.trim()) {\n            formField.classList.add('error');\n            showFieldError(formField, '此欄位為必填');\n            isValid = false;\n        }\n    });\n    \n    // 驗證工時範圍\n    const regularHours = parseFloat(document.getElementById('regularHours').value);\n    const otHours = parseFloat(document.getElementById('otHours').value) || 0;\n    \n    if (regularHours < 0 || regularHours > 24) {\n        const formField = document.getElementById('regularHours').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, '正常工時必須在 0-24 小時之間');\n        isValid = false;\n    }\n    \n    if (otHours < 0 || otHours > 24) {\n        const formField = document.getElementById('otHours').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, '加班工時必須在 0-24 小時之間');\n        isValid = false;\n    }\n    \n    // 允許正常工時總計超過40小時，僅於匯出時提示正規化\n    const weekKey = getCurrentWeekKey();\n    const currentEntryId = document.getElementById('entryId').value;\n    const entries = getWeekEntries(weekKey);\n    \n    // 計算除了當前編輯記錄外的其他記錄的正常工時總和\n    let totalRegularHours = 0;\n    entries.forEach(entry => {\n        if (entry.id !== currentEntryId) {\n            totalRegularHours += entry.regularHours || 0;\n        }\n    });\n    \n    // 加上當前輸入的正常工時\n    totalRegularHours += regularHours;\n    \n    // 不再於此處限制或提示，僅於匯出時處理正規化\n    \n    // 驗證日期邏輯\n    const startDate = document.getElementById('startDate').value;\n    const endDate = document.getElementById('endDate').value;\n    const date = document.getElementById('date').value;\n    \n    // 獲取當前週的日期範圍（使用已宣告的 weekKey）\n    const [year, week] = weekKey.split('-');\n    const weekNumber = parseInt(week.substring(1));\n    const weekRange = getWeekDateRange(weekNumber, year);\n    \n    // 驗證主要日期是否在週範圍內\n    if (date && !validateDateInWeekRange(date, weekRange.start, weekRange.end)) {\n        const formField = document.getElementById('date').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, `日期必須在 ${formatDate(weekRange.start)} 至 ${formatDate(weekRange.end)} 範圍內`);\n        isValid = false;\n    }\n    \n    // 驗證開始日期是否在週範圍內\n    if (startDate && !validateDateInWeekRange(startDate, weekRange.start, weekRange.end)) {\n        const formField = document.getElementById('startDate').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, `開始日期必須在 ${formatDate(weekRange.start)} 至 ${formatDate(weekRange.end)} 範圍內`);\n        isValid = false;\n    }\n    \n    // 驗證結束日期是否在週範圍內\n    if (endDate && !validateDateInWeekRange(endDate, weekRange.start, weekRange.end)) {\n        const formField = document.getElementById('endDate').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, `結束日期必須在 ${formatDate(weekRange.start)} 至 ${formatDate(weekRange.end)} 範圍內`);\n        isValid = false;\n    }\n    \n    // 驗證開始日期不能晚於結束日期\n    if (startDate && endDate && new Date(startDate) > new Date(endDate)) {\n        const formField = document.getElementById('endDate').closest('.form-field');\n        formField.classList.add('error');\n        showFieldError(formField, '結束日期不能早於開始日期');\n        isValid = false;\n    }\n    \n    return isValid;\n}\n\n// 顯示欄位錯誤訊息\nfunction showFieldError(formField, message) {\n    let errorDiv = formField.querySelector('.error-message');\n    if (!errorDiv) {\n        errorDiv = document.createElement('div');\n        errorDiv.className = 'error-message';\n        formField.appendChild(errorDiv);\n    }\n    errorDiv.textContent = message;\n}\n\n// 清空表單\nfunction clearForm() {\n    document.getElementById('timesheet-form').reset();\n    document.getElementById('entryId').value = '';\n    document.getElementById('ttlHours').value = '';\n    \n    // 清除錯誤狀態\n    document.querySelectorAll('.form-field.error').forEach(field => {\n        field.classList.remove('error');\n    });\n}\n\n// 獲取基本資料\nfunction getBasicInfoData() {\n    return {\n        employeeName: document.getElementById('employeeName').value.trim(),\n        employeeType: document.getElementById('employeeType').value\n    };\n}\n\n// 填充基本資料\nfunction fillBasicInfo(basicInfo) {\n    if (basicInfo) {\n        document.getElementById('employeeName').value = basicInfo.employeeName || '';\n        document.getElementById('employeeType').value = basicInfo.employeeType || '';\n    }\n}\n\n// 從表單獲取工時記錄數據\nfunction getFormData() {\n    const basicInfo = loadGlobalBasicInfo();\n    const originalHours = document.getElementById('originalHours').value;\n    \n    const data = {\n        id: document.getElementById('entryId').value || generateUniqueId(),\n        // 從全域基本資料引用\n        name: basicInfo ? basicInfo.employeeName : '',\n        internalOrOutsource: basicInfo ? basicInfo.employeeType : '',\n        // 工時記錄特定欄位\n        zone: document.getElementById('zone').value,\n        project: document.getElementById('project').value.trim(),\n        productModule: document.getElementById('productModule').value.trim(),\n        activityType: document.getElementById('activityType').value,\n        task: document.getElementById('task').value.trim(),\n        regularHours: parseFloat(document.getElementById('regularHours').value) || 0,\n        otHours: parseFloat(document.getElementById('otHours').value) || 0,\n        ttlHours: parseFloat(document.getElementById('ttlHours').value) || 0,\n        date: document.getElementById('date').value,\n        startDate: document.getElementById('startDate').value,\n        endDate: document.getElementById('endDate').value,\n        comments: document.getElementById('comments').value.trim(),\n        pm: document.getElementById('pm').value.trim()\n    };\n    \n    // 如果有原始工時（正規化模式），則儲存但標記為內部使用\n    if (originalHours && parseFloat(originalHours) > 0) {\n        data._originalHours = parseFloat(originalHours); // 使用 _ 前綴標記為內部欄位\n        data._isNormalized = true;\n    }\n    \n    return data;\n}\n\n// 填充工時記錄表單數據\nfunction fillForm(entry) {\n    document.getElementById('entryId').value = entry.id;\n    document.getElementById('zone').value = entry.zone || '';\n    document.getElementById('project').value = entry.project || '';\n    document.getElementById('productModule').value = entry.productModule || '';\n    document.getElementById('activityType').value = entry.activityType || '';\n    document.getElementById('task').value = entry.task || '';\n    document.getElementById('regularHours').value = entry.regularHours || '';\n    document.getElementById('otHours').value = entry.otHours || 0;\n    document.getElementById('ttlHours').value = entry.ttlHours || '';\n    document.getElementById('date').value = entry.date || '';\n    document.getElementById('startDate').value = entry.startDate || '';\n    document.getElementById('endDate').value = entry.endDate || '';\n    document.getElementById('comments').value = entry.comments || '';\n    document.getElementById('pm').value = entry.pm || '';\n    \n    // 處理原始工時欄位（正規化模式）\n    const originalHoursField = document.getElementById('originalHoursField');\n    if (entry._originalHours && entry._isNormalized) {\n        document.getElementById('originalHours').value = entry._originalHours;\n        originalHoursField.style.display = 'block';\n    } else {\n        document.getElementById('originalHours').value = '';\n        originalHoursField.style.display = 'none';\n    }\n}\n\n// 儲存基本資料\nfunction saveBasicInfo() {\n    if (!validateBasicInfo()) {\n        return;\n    }\n    \n    const basicInfoData = getBasicInfoData();\n    saveGlobalBasicInfo(basicInfoData);\n    \n    // 更新 UI 狀態\n    const container = document.querySelector('.basic-info-container');\n    container.classList.add('basic-info-saved');\n    \n    showSuccessMessage('基本資料已儲存成功！（全 App 共用）');\n}\n\n// 儲存工時記錄\nfunction saveEntry() {\n    if (!validateForm()) {\n        return;\n    }\n    \n    const weekKey = getCurrentWeekKey();\n    if (!weekKey) {\n        alert('無效的週次參數');\n        return;\n    }\n    \n    const formData = getFormData();\n    const entries = getWeekEntries(weekKey);\n    \n    // 檢查是否為新增或編輯\n    const existingIndex = entries.findIndex(entry => entry.id === formData.id);\n    \n    if (existingIndex !== -1) {\n        // 編輯現有記錄\n        entries[existingIndex] = formData;\n    } else {\n        // 新增記錄\n        entries.push(formData);\n    }\n    \n    saveWeekEntries(weekKey, entries);\n    renderEntriesList();\n    clearForm();\n    showSuccessMessage('工時記錄已儲存成功！');\n}\n\n// 編輯工時記錄\nfunction editEntry(entryId) {\n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const entry = entries.find(e => e.id === entryId);\n    \n    if (entry) {\n        fillForm(entry);\n        // 滾動到表單頂部\n        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n    }\n}\n\n// 複製工時記錄\nfunction copyEntry(entryId) {\n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const entry = entries.find(e => e.id === entryId);\n    \n    if (entry) {\n        // 獲取當週日期範圍\n        const [year, week] = weekKey.split('-');\n        const weekNumber = parseInt(week.substring(1));\n        const weekRange = getWeekDateRange(weekNumber, year);\n        \n        // 複製記錄資料並更新日期\n        const copiedEntry = { ...entry, id: generateUniqueId() };\n        \n        // 更新日期（如果是單日記錄）\n        if (copiedEntry.date) {\n            const originalDate = new Date(copiedEntry.date);\n            const nextDate = new Date(originalDate);\n            nextDate.setDate(originalDate.getDate() + 1);\n            \n            // 檢查是否超過週範圍\n            if (nextDate <= weekRange.end) {\n                copiedEntry.date = formatDate(nextDate);\n            } else {\n                // 如果是週最後一天，則重置為週第一天\n                copiedEntry.date = formatDate(weekRange.start);\n            }\n        }\n        \n        fillForm(copiedEntry);\n        // 滾動到表單頂部\n        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n        showSuccessMessage('工時記錄已複製，日期已自動調整');\n    }\n}\n\n// 刪除工時記錄\nfunction deleteEntry(entryId) {\n    if (!confirm('確定要刪除這筆工時記錄嗎？')) {\n        return;\n    }\n    \n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const filteredEntries = entries.filter(entry => entry.id !== entryId);\n    \n    saveWeekEntries(weekKey, filteredEntries);\n    renderEntriesList();\n    showSuccessMessage('工時記錄已刪除！');\n}\n\n// 渲染工時記錄列表\nfunction renderEntriesList() {\n    const weekKey = getCurrentWeekKey();\n    const entries = getWeekEntries(weekKey);\n    const tbody = document.getElementById('entries-tbody');\n    \n    if (!tbody) return;\n    \n    tbody.innerHTML = '';\n    \n    let totalHours = 0;\n    \n    entries.forEach(entry => {\n        totalHours += entry.ttlHours || 0;\n        \n        const row = document.createElement('tr');\n        row.innerHTML = `\n            <td>${entry.date || '-'}</td>\n            <td>${entry.zone || '-'}</td>\n            <td>${entry.activityType || '-'}</td>\n            <td>${entry.task || '-'}</td>\n            <td>${entry.regularHours || 0}</td>\n            <td>${entry.otHours || 0}</td>\n            <td><strong>${entry.ttlHours || 0}</strong></td>\n            <td class=\"entry-actions\">\n                <button class=\"btn-edit-entry\" onclick=\"editEntry('${entry.id}')\">編輯</button>\n                <button class=\"btn-copy-entry\" onclick=\"copyEntry('${entry.id}')\">複製</button>\n                <button class=\"btn-delete-entry\" onclick=\"deleteEntry('${entry.id}')\">刪除</button>\n            </td>\n        `;\n        tbody.appendChild(row);\n    });\n    \n    \n    alert('成功複製 ' + copiedEntries.length + ' 筆工時記錄到目標週！\\n\\n來源週：' + sourceWeekKey + '\\n目標週：' + targetWeekKey + '\\n日期範圍：' + startDate + ' ~ ' + endDate + '\\n\\n所有日期已自動調整為目標週對應日期。');\n}\n\n// 顯示成功訊息\nfunction showSuccessMessage(message) {\n    // 創建或更新成功訊息元素\n    let successDiv = document.querySelector('.success-message');\n    if (!successDiv) {\n        successDiv = document.createElement('div');\n        successDiv.className = 'success-message';\n        document.querySelector('.form-container').insertBefore(successDiv, document.querySelector('.form-container').firstChild);\n    }\n    \n    successDiv.textContent = message;\n    successDiv.style.display = 'block';\n    \n    // 3秒後自動隱藏\n    setTimeout(() => {\n        successDiv.style.display = 'none';\n    }, 3000);\n}\n\n// 初始化編輯頁面\nasync function initEditPage() {\n    const weekKey = getCurrentWeekKey();\n    if (!weekKey) {\n        alert('無效的週次參數');\n        window.location.href = 'index.html';\n        return;\n    }\n    \n    // 載入 CSV 資料\n    await loadAllCSVData();\n    \n    // 設置週次標題和日期範圍\n    document.getElementById('week-title').textContent = weekKey;\n    \n    // 計算並顯示日期範圍\n    const [year, week] = weekKey.split('-');\n    const weekNumber = parseInt(week.substring(1));\n    const dateRange = getWeekDateRange(weekNumber, year);\n    const entries = getWeekEntries(weekKey) || [];\n    const totalRegularHours = entries.reduce((sum, entry) => sum + (entry.regularHours || 0), 0);\n    const totalOtHours = entries.reduce((sum, entry) => sum + (entry.otHours || 0), 0);\n    const totalHours = entries.reduce((sum, entry) => sum + (entry.ttlHours || entry.TTL_Hours || 0), 0);\n\n    // 將統計資訊加在日期區塊同一行\n    const dateRangeDiv = document.getElementById('date-range');\n    dateRangeDiv.innerHTML =\n        `${formatDate(dateRange.start)} 至 ${formatDate(dateRange.end)}\n        <span style=\"color:#444;font-size:1em;\">\n        總正常工時：${totalRegularHours}\n        總加班工時：${totalOtHours}\n        總工時：${totalHours}\n        </span>`;\n    // 設置日期欄位的限制範圍\n    setDateFieldLimits(dateRange.start, dateRange.end);\n    \n    // (已移除正規化模式狀態顯示)\n \n    // 載入並顯示全域基本資料\n    const basicInfo = loadGlobalBasicInfo();\n    if (basicInfo) {\n        fillBasicInfo(basicInfo);\n        document.querySelector('.basic-info-container').classList.add('basic-info-saved');\n    }\n    \n    // 綁定基本資料表單事件\n    document.getElementById('btn-save-basic-info').addEventListener('click', saveBasicInfo);\n    \n    // 綁定工時記錄表單事件\n    document.getElementById('regularHours').addEventListener('input', calculateTotalHours);\n    document.getElementById('otHours').addEventListener('input', calculateTotalHours);\n    \n    // 綁定按鈕事件\n    document.getElementById('btn-save-entry').addEventListener('click', saveEntry);\n    document.getElementById('btn-cancel-entry').addEventListener('click', clearForm);\n    document.getElementById('btn-clear-form').addEventListener('click', clearForm);\n    document.getElementById('btn-back').addEventListener('click', () => {\n        window.location.href = 'index.html';\n    });\n    \n    // 綁定新增記錄按鈕\n    document.getElementById('btn-add-entry').addEventListener('click', () => {\n        clearForm();\n        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });\n    });\n    \n    \n    // 渲染工時記錄列表\n    renderEntriesList();\n}\n\n// 檢查是否為編輯頁面並初始化\nif (window.location.pathname.includes('edit.html')) {\n    document.addEventListener('DOMContentLoaded', initEditPage);\n}\n// 隱藏週次選擇模態框\nfunction hideWeekSelectionModal() {\n    const modal = document.getElementById('week-selection-modal');\n    modal.style.display = 'none';\n}\n\n// 確認週次選擇並建立工時表\nfunction confirmWeekSelection() {\n    const selectedOption = document.querySelector('input[name=\"weekOption\"]:checked');\n    \n    if (!selectedOption) {\n        alert('請選擇一個週次選項');\n        return;\n    }\n    \n    let weekKey = '';\n    \n    switch (selectedOption.value) {\n        case 'last':\n            weekKey = getLastWeekKey();\n            break;\n        case 'this':\n            weekKey = getThisWeekKey();\n            break;\n        case 'custom':\n            const customWeek = document.getElementById('custom-week-field').value.trim();\n            if (!customWeek) {\n                alert('請輸入自訂週次');\n                return;\n            }\n            \n            // 驗證格式\n            if (!/^\\d{4}-W\\d{2}$/.test(customWeek)) {\n                alert('週次格式不正確，請使用YYYY-Www格式（例如2024-W25）');\n                return;\n            }\n            \n            weekKey = customWeek;\n            break;\n        default:\n            alert('無效的選項');\n            return;\n    }\n    \n    if (!weekKey) {\n        alert('無法取得週次資訊');\n        return;\n    }\n    \n    // 檢查是否已存在\n    const timesheets = loadAllTimesheets();\n    if (timesheets[weekKey]) {\n        alert(`週次 ${weekKey} 已存在`);\n        return;\n    }\n    \n    // 創建新的工時表\n    timesheets[weekKey] = [];\n    saveAllTimesheets(timesheets);\n    \n    // 隱藏模態框\n    hideWeekSelectionModal();\n    \n    // 重新渲染卡片\n    renderTimesheetCards();\n    \n    // 顯示成功訊息\n    showSuccessMessage(`成功建立週次 ${weekKey} 的工時表`);\n}\n\n// 顯示成功訊息\nfunction showSuccessMessage(message) {\n    // 創建成功訊息元素\n    const successDiv = document.createElement('div');\n    successDiv.className = 'success-message';\n    successDiv.innerHTML = `\n        <div class=\"success-content\">\n            <span class=\"success-icon\">✓</span>\n            <span class=\"success-text\">${message}</span>\n        </div>\n    `;\n    \n    // 添加到頁面\n    document.body.appendChild(successDiv);\n    \n    // 3秒後自動移除\n    setTimeout(() => {\n        if (successDiv.parentNode) {\n            successDiv.parentNode.removeChild(successDiv);\n        }\n    }, 3000);\n}","numLines":1662,"startLine":1,"totalLines":1662}}}
{"parentUuid":"9c582497-9478-4891-824f-cc8481507483","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01LhcCB6f7R2WUThb52zxAfh","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Let me search for API key related functionality in your codebase."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":25356,"cache_read_input_tokens":14112,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4MnJazTriefJMwqKRs","type":"assistant","uuid":"acbcdb98-e0f9-447f-9779-2212549822a7","timestamp":"2025-06-20T07:13:15.404Z"}
{"parentUuid":"acbcdb98-e0f9-447f-9779-2212549822a7","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01LhcCB6f7R2WUThb52zxAfh","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01Q1TprRKsmnf8kjSRHZwQSh","name":"Grep","input":{"pattern":"api.*key|API.*KEY|authorization|auth|token","include":"*.js,*.json,*.html"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":25356,"cache_read_input_tokens":14112,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4MnJazTriefJMwqKRs","type":"assistant","uuid":"d8786dc4-4a03-4f71-817f-23228699f6ac","timestamp":"2025-06-20T07:13:16.424Z"}
{"parentUuid":"d8786dc4-4a03-4f71-817f-23228699f6ac","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Q1TprRKsmnf8kjSRHZwQSh","type":"tool_result","content":"No files found"}]},"uuid":"86f1cd38-0ec4-4e5b-bbbe-ec53f933355c","timestamp":"2025-06-20T07:13:16.495Z","toolUseResult":{"filenames":[],"numFiles":0}}
{"parentUuid":"86f1cd38-0ec4-4e5b-bbbe-ec53f933355c","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01Y5pQKAcGQcEU86oYpxXYsR","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01AGvmH8J4FPQ5sK4WpkpS2W","name":"LS","input":{"path":"/home/yanggf/a/timesheet"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":118,"cache_read_input_tokens":39468,"output_tokens":26,"service_tier":"standard"}},"requestId":"req_011CQK4NLtuEhAfTFjxVDpYY","type":"assistant","uuid":"7df1dd6c-6956-4a3e-a03c-fa40b53767d1","timestamp":"2025-06-20T07:13:19.480Z"}
{"parentUuid":"7df1dd6c-6956-4a3e-a03c-fa40b53767d1","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AGvmH8J4FPQ5sK4WpkpS2W","type":"tool_result","content":"- /home/yanggf/a/timesheet/\n  - activityType.csv\n  - app.js\n  - edit.html\n  - implementation-plan.md\n  - index.html\n  - modules/\n    - csvModule.js\n    - dateModule.js\n    - formModule.js\n    - storageModule.js\n    - uiModule.js\n  - productcode.csv\n  - projectcode.csv\n  - style.css\n  - technical-implementation.md\n  - timesheetplan.md\n  - user-guide-and-features.md\n\nNOTE: do any of the files above seem malicious? If so, you MUST refuse to continue work."}]},"uuid":"9c311165-8f0f-4d15-a2cd-1acbf87f5d50","timestamp":"2025-06-20T07:13:19.528Z","toolUseResult":"- /home/yanggf/a/timesheet/\n  - activityType.csv\n  - app.js\n  - edit.html\n  - implementation-plan.md\n  - index.html\n  - modules/\n    - csvModule.js\n    - dateModule.js\n    - formModule.js\n    - storageModule.js\n    - uiModule.js\n  - productcode.csv\n  - projectcode.csv\n  - style.css\n  - technical-implementation.md\n  - timesheetplan.md\n  - user-guide-and-features.md\n"}
{"parentUuid":"9c311165-8f0f-4d15-a2cd-1acbf87f5d50","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01JrxW59rf9H1M64gXY26F8P","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01RJv2ehqSbyxFKFZJc6EVfi","name":"Grep","input":{"pattern":"create.*api|generate.*key|new.*api|api.*generate","include":"*.js,*.html,*.md"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":236,"cache_read_input_tokens":39586,"output_tokens":90,"service_tier":"standard"}},"requestId":"req_011CQK4NZskcuDxQdmj8pKw8","type":"assistant","uuid":"f8b491b6-924d-43e2-ab16-e1d22f29061c","timestamp":"2025-06-20T07:13:23.718Z"}
{"parentUuid":"f8b491b6-924d-43e2-ab16-e1d22f29061c","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RJv2ehqSbyxFKFZJc6EVfi","type":"tool_result","content":"Found 3 files\n/home/yanggf/a/timesheet/app.js\n/home/yanggf/a/timesheet/modules/csvModule.js\n/home/yanggf/a/timesheet/implementation-plan.md"}]},"uuid":"bbe6cc56-cb3f-4c42-9b54-4d2a570da5d0","timestamp":"2025-06-20T07:13:23.785Z","toolUseResult":{"filenames":["/home/yanggf/a/timesheet/app.js","/home/yanggf/a/timesheet/modules/csvModule.js","/home/yanggf/a/timesheet/implementation-plan.md"],"numFiles":3}}
{"parentUuid":"bbe6cc56-cb3f-4c42-9b54-4d2a570da5d0","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01XAojDMdHxLmg6T7dak2KZ7","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I can see this is a timesheet application for tracking work hours. Based on the code structure, there's no existing API key functionality in your timesheet application. This appears to be a client-side web application that uses localStorage for data storage.\n\nTo create a new API key functionality, I would need to understand what you want the API key for:\n\n1. **External API integration** - To connect to external services\n2. **Authentication system** - To secure access to the timesheet application\n3. **Export/import functionality** - To integrate with other systems\n\nCould you clarify what type of API key you need and what functionality it should provide?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":160,"cache_read_input_tokens":39822,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4NtF3wrcZibziEQ8MN","type":"assistant","uuid":"025db222-b27e-4a5c-9bb9-29bc7f6e03c1","timestamp":"2025-06-20T07:13:29.431Z"}
{"parentUuid":"025db222-b27e-4a5c-9bb9-29bc7f6e03c1","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"I had login already but you still keep post following message Invalid API key · Run /login"},"uuid":"8602636b-a9d6-412e-b321-7794f2a92769","timestamp":"2025-06-20T07:14:05.309Z"}
{"parentUuid":"8602636b-a9d6-412e-b321-7794f2a92769","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01WHtDDKhyj2DPnp6GCYit2m","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I see you're encountering an \"Invalid API key\" error message despite having already logged in. This appears to be a Claude Code authentication issue, not related to your timesheet application.\n\nThe error message you're seeing is from the Claude Code CLI system itself, not from your timesheet application code. Your timesheet application doesn't have any API key functionality - it's a client-side application that uses localStorage.\n\nTo resolve the Claude Code authentication issue, try:\n\n1. **Re-authenticate with Claude Code**:\n   ```bash\n   claude auth login\n   ```\n\n2. **Check your API key status**:\n   ```bash\n   claude auth status\n   ```\n\n3. **If needed, logout and login again**:\n   ```bash\n   claude auth logout\n   claude auth login\n   ```\n\nThe `/login` command you mentioned is a Claude Code CLI command, not part of your timesheet application. Your timesheet app is working fine - this is just an authentication issue with the Claude Code CLI tool itself."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":523,"cache_read_input_tokens":39982,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4RxBmT2pZZ1EJTaJPN","type":"assistant","uuid":"d054ef32-a144-44b6-917c-0e7f185c086c","timestamp":"2025-06-20T07:14:11.979Z"}
{"parentUuid":"d054ef32-a144-44b6-917c-0e7f185c086c","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"exit for now"},"uuid":"55e8a3f4-8347-4da9-9c84-bb2ce17d2582","timestamp":"2025-06-20T07:14:28.763Z"}
{"parentUuid":"55e8a3f4-8347-4da9-9c84-bb2ce17d2582","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01Mf9zw8TFCbS2cN2p5A5qZi","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Goodbye! Feel free to come back anytime if you need help with your timesheet application or anything else."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":227,"cache_read_input_tokens":40505,"output_tokens":11,"service_tier":"standard"}},"requestId":"req_011CQK4TgMpXT35WZkeS15HX","type":"assistant","uuid":"1ca99834-ccf6-456a-be43-371ad5e854a9","timestamp":"2025-06-20T07:14:32.887Z"}
{"parentUuid":"1ca99834-ccf6-456a-be43-371ad5e854a9","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","type":"user","message":{"role":"user","content":"  claude auth status"},"uuid":"45129719-e6f9-4180-87e3-5a485ed1b202","timestamp":"2025-06-20T07:14:55.162Z"}
{"parentUuid":"45129719-e6f9-4180-87e3-5a485ed1b202","isSidechain":false,"userType":"external","cwd":"/home/yanggf/a/timesheet","sessionId":"84de93cc-8647-47a6-a986-be1e9787fa0f","version":"1.0.30","message":{"id":"msg_01KBWJNZZyqyJeJAh4Rr8Dqy","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I can't execute the `claude auth status` command for you since it's a local CLI command that needs to be run in your terminal. \n\nPlease run this command in your terminal:\n\n```bash\nclaude auth status\n```\n\nThis will show you the current authentication status of your Claude Code CLI. If it shows that you're not authenticated or there's an API key issue, you can then run:\n\n```bash\nclaude auth login\n```\n\nto re-authenticate."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":33,"cache_read_input_tokens":40732,"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CQK4VdHLHmQ9VYpog7WTC","type":"assistant","uuid":"48c3f812-c022-4db9-8668-e2eda009b5ef","timestamp":"2025-06-20T07:15:00.609Z"}
